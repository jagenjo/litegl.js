(function(C){function ea(){return Array.prototype.slice.call(this)}function Z(g,d){if(g.constructor===d)return g;if(g.constructor!==Array)return d=d||Float32Array,new d(g);d=d||Float32Array;var a=g[0].length;d=new d(g.length*a);for(var b=0;b<g.length;++b)for(var c=0;c<a;++c)d[b*a+c]=g[b][c];return d}function R(g,d,a,b,c){g=g||1024;m.debug&&console.log("GL.Mesh created");null!==c&&(this.gl=c=c||C.gl);this._context_id=c.context_id;this.vertexBuffers={};this.indexBuffers={};this.info={groups:[]};this._bounding=
BBox.create();this.resize(g)}function L(g,d,a,b){this.gl=b=b||C.gl;this._context_id=b.context_id;if(g&&g.constructor!==Array)throw"FBO textures must be an Array";this.handler=null;this.height=this.width=-1;this.color_textures=[];this.depth_texture=null;this.stencil=!!a;this._stencil_enabled=!1;this._num_binded_textures=0;this.order=null;(g&&g.length||d)&&this.setTextures(g,d);this._old_fbo_handler=null;this._old_viewport=new Float32Array(4)}var m=C.GL=C.LiteGL={};if("undefined"==typeof Y){if("undefined"==
typeof self)if("undefined"==typeof window){if("undefined"===typeof SKIP_REQUIRES){console.log("importing glMatrix");C.glMatrix=require("./gl-matrix-min.js");var Y=C.glMatrix,W;for(W in Y)C[W]=Y[W]}}else if("undefined"==typeof Y)throw"litegl.js requires gl-matrix to work. It must be included before litegl.";}else if(!C.vec2)throw"litegl.js does not support gl-matrix 3.0, download 2.8 https://github.com/toji/gl-matrix/releases/tag/v2.8.1";C.requestAnimationFrame=C.requestAnimationFrame||C.mozRequestAnimationFrame||
C.webkitRequestAnimationFrame||function(g){setTimeout(g,1E3/60)};m.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};m.reverse=null;m.LEFT_MOUSE_BUTTON=0;m.MIDDLE_MOUSE_BUTTON=1;m.RIGHT_MOUSE_BUTTON=2;m.LEFT_MOUSE_BUTTON_MASK=1;m.RIGHT_MOUSE_BUTTON_MASK=2;m.MIDDLE_MOUSE_BUTTON_MASK=4;m.last_context_id=0;m.COLOR_BUFFER_BIT=16384;m.DEPTH_BUFFER_BIT=256;m.STENCIL_BUFFER_BIT=1024;m.TEXTURE_2D=3553;m.TEXTURE_CUBE_MAP=34067;m.TEXTURE_3D=32879;m.TEXTURE_MAG_FILTER=10240;m.TEXTURE_MIN_FILTER=10241;m.TEXTURE_WRAP_S=
10242;m.TEXTURE_WRAP_T=10243;m.BYTE=5120;m.UNSIGNED_BYTE=5121;m.SHORT=5122;m.UNSIGNED_SHORT=5123;m.INT=5124;m.UNSIGNED_INT=5125;m.FLOAT=5126;m.HALF_FLOAT_OES=36193;m.HALF_FLOAT=5131;m.DEPTH_COMPONENT16=33189;m.DEPTH_COMPONENT24=33190;m.DEPTH_COMPONENT32F=36012;m.FLOAT_VEC2=35664;m.FLOAT_VEC3=35665;m.FLOAT_VEC4=35666;m.INT_VEC2=35667;m.INT_VEC3=35668;m.INT_VEC4=35669;m.BOOL=35670;m.BOOL_VEC2=35671;m.BOOL_VEC3=35672;m.BOOL_VEC4=35673;m.FLOAT_MAT2=35674;m.FLOAT_MAT3=35675;m.FLOAT_MAT4=35676;m.TYPE_LENGTH=
{};m.TYPE_LENGTH[m.FLOAT]=m.TYPE_LENGTH[m.INT]=m.TYPE_LENGTH[m.BYTE]=m.TYPE_LENGTH[m.BOOL]=1;m.TYPE_LENGTH[m.FLOAT_VEC2]=m.TYPE_LENGTH[m.INT_VEC2]=m.TYPE_LENGTH[m.BOOL_VEC2]=2;m.TYPE_LENGTH[m.FLOAT_VEC3]=m.TYPE_LENGTH[m.INT_VEC3]=m.TYPE_LENGTH[m.BOOL_VEC3]=3;m.TYPE_LENGTH[m.FLOAT_VEC4]=m.TYPE_LENGTH[m.INT_VEC4]=m.TYPE_LENGTH[m.BOOL_VEC4]=4;m.TYPE_LENGTH[m.FLOAT_MAT3]=9;m.TYPE_LENGTH[m.FLOAT_MAT4]=16;m.SAMPLER_2D=35678;m.SAMPLER_3D=35679;m.SAMPLER_CUBE=35680;m.INT_SAMPLER_2D=36298;m.INT_SAMPLER_3D=
36299;m.INT_SAMPLER_CUBE=36300;m.UNSIGNED_INT_SAMPLER_2D=36306;m.UNSIGNED_INT_SAMPLER_3D=36307;m.UNSIGNED_INT_SAMPLER_CUBE=36308;m.DEPTH_COMPONENT=6402;m.ALPHA=6406;m.RGB=6407;m.RGBA=6408;m.LUMINANCE=6409;m.LUMINANCE_ALPHA=6410;m.DEPTH_STENCIL=34041;m.UNSIGNED_INT_24_8=m.UNSIGNED_INT_24_8_WEBGL=34042;m.R8=33321;m.R16F=33325;m.R32F=33326;m.R8UI=33330;m.RG8=33323;m.RG16F=33327;m.RG32F=33328;m.RGB8=32849;m.SRGB8=35905;m.RGB565=36194;m.R11F_G11F_B10F=35898;m.RGB9_E5=35901;m.RGB16F=34843;m.RGB32F=34837;
m.RGB8UI=36221;m.RGBA8=32856;m.RGB5_A1=32855;m.RGBA16F=34842;m.RGBA32F=34836;m.RGBA8UI=36220;m.RGBA16I=36232;m.RGBA16UI=36214;m.RGBA32I=36226;m.RGBA32UI=36208;m.DEPTH24_STENCIL8=35056;m.NEAREST=9728;m.LINEAR=9729;m.NEAREST_MIPMAP_NEAREST=9984;m.LINEAR_MIPMAP_NEAREST=9985;m.NEAREST_MIPMAP_LINEAR=9986;m.LINEAR_MIPMAP_LINEAR=9987;m.REPEAT=10497;m.CLAMP_TO_EDGE=33071;m.MIRRORED_REPEAT=33648;m.ZERO=0;m.ONE=1;m.SRC_COLOR=768;m.ONE_MINUS_SRC_COLOR=769;m.SRC_ALPHA=770;m.ONE_MINUS_SRC_ALPHA=771;m.DST_ALPHA=
772;m.ONE_MINUS_DST_ALPHA=773;m.DST_COLOR=774;m.ONE_MINUS_DST_COLOR=775;m.SRC_ALPHA_SATURATE=776;m.CONSTANT_COLOR=32769;m.ONE_MINUS_CONSTANT_COLOR=32770;m.CONSTANT_ALPHA=32771;m.ONE_MINUS_CONSTANT_ALPHA=32772;m.VERTEX_SHADER=35633;m.FRAGMENT_SHADER=35632;m.FRONT=1028;m.BACK=1029;m.FRONT_AND_BACK=1032;m.NEVER=512;m.LESS=513;m.EQUAL=514;m.LEQUAL=515;m.GREATER=516;m.NOTEQUAL=517;m.GEQUAL=518;m.ALWAYS=519;m.KEEP=7680;m.REPLACE=7681;m.INCR=7682;m.DECR=7683;m.INCR_WRAP=34055;m.DECR_WRAP=34056;m.INVERT=
5386;m.STREAM_DRAW=35040;m.STATIC_DRAW=35044;m.DYNAMIC_DRAW=35048;m.ARRAY_BUFFER=34962;m.ELEMENT_ARRAY_BUFFER=34963;m.POINTS=0;m.LINES=1;m.LINE_LOOP=2;m.LINE_STRIP=3;m.TRIANGLES=4;m.TRIANGLE_STRIP=5;m.TRIANGLE_FAN=6;m.CW=2304;m.CCW=2305;m.CULL_FACE=2884;m.DEPTH_TEST=2929;m.BLEND=3042;m.temp_vec3=vec3.create();m.temp2_vec3=vec3.create();m.temp_vec4=vec4.create();m.temp_quat=quat.create();m.temp_mat3=mat3.create();m.temp_mat4=mat4.create();C.DEG2RAD=.0174532925;C.RAD2DEG=57.295779578552306;C.EPSILON=
1E-6;C.isPowerOfTwo=m.isPowerOfTwo=function(g){return 0==Math.log(g)/Math.log(2)%1};C.nearestPowerOfTwo=m.nearestPowerOfTwo=function(g){return Math.pow(2,Math.round(Math.log(g)/Math.log(2)))};C.nextPowerOfTwo=m.nextPowerOfTwo=function(g){return Math.pow(2,Math.ceil(Math.log(g)/Math.log(2)))};[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(g){g.prototype.toJSON||Object.defineProperty(g.prototype,"toJSON",{value:ea,enumerable:!1,configurable:!0,
writable:!0})});C.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);m.getTime=C.getTime;C.isFunction=function(g){return!!(g&&g.constructor&&g.call&&g.apply)};C.isArray=function(g){return g&&g.constructor===Array};C.isNumber=function(g){return null!=g&&g.constructor===Number};C.getClassName=function(g){if(g){if(g.name)return g.name;if(g.toString&&(g=g.toString().match(/function\s*(\w+)/))&&2==g.length)return g[1]}};C.cloneObject=m.cloneObject=function(g,
d){if(g.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";d=d||{};for(var a in g){var b=g[a];if(null===b)d[a]=null;else switch(b.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:d[a]=new b.constructor(b);break;case Boolean:case Number:case String:d[a]=b;break;case Array:d[a]=b.concat();break;case Object:d[a]=m.cloneObject(b)}}return d};C.regexMap=function(g,d,
a){for(var b;null!=(b=g.exec(d));)a(b)};C.createCanvas=m.createCanvas=function(g,d){var a=document.createElement("canvas");a.width=g;a.height=d;return a};C.cloneCanvas=m.cloneCanvas=function(g){var d=document.createElement("canvas");d.width=g.width;d.height=g.height;d.getContext("2d").drawImage(g,0,0);return d};"undefined"!=typeof Image&&(Image.prototype.getPixels=function(){var g=document.createElement("canvas");g.width=this.width;g.height=this.height;g=g.getContext("2d");g.drawImage(this,0,0);return g.getImageData(0,
0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(g){var d=this,a;for(a in g)d=d.split(a).join(g[a]);return d},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var g=0,d;if(0==this.length)return g;var a=0;for(d=this.length;a<d;++a){var b=this.charCodeAt(a);g=(g<<5)-g+b;g|=0}return g},enumerable:!1});Array.prototype.hasOwnProperty("clone")||
Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1});Float32Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Float32Array.prototype,"clone",{value:function(){return new Float32Array(this)},enumerable:!1});C.wipeObject=function(g){for(var d in g)g.hasOwnProperty(d)&&delete g[d]};C.extendClass=m.extendClass=function(g,d){for(var a in d)g.hasOwnProperty(a)||(g[a]=d[a]);if(d.prototype){var b=Object.getOwnPropertyNames(d.prototype);for(a=0;a<b.length;++a){var c=
b[a];g.prototype.hasOwnProperty(c)||(d.prototype.__lookupGetter__(c)?g.prototype.__defineGetter__(c,d.prototype.__lookupGetter__(c)):g.prototype[c]=d.prototype[c],d.prototype.__lookupSetter__(c)&&g.prototype.__defineSetter__(c,d.prototype.__lookupSetter__(c)))}}g.hasOwnProperty("superclass")||Object.defineProperty(g,"superclass",{get:function(){return d},enumerable:!1})};C.HttpRequest=m.request=function(g,d,a,b,c){var e=!0;c=c||{};void 0!==c.async&&(e=c.async);if(d){var f=null;f=[];for(var h in d)f.push(h+
"="+d[h]);f=f.join("&");g=g+"?"+f}var n=new XMLHttpRequest;n.open("GET",g,e);n.responseType=c.responseType||"text";n.onload=function(l){this.getResponseHeader("Content-Type");200!=this.status?(J.trigger(n,"fail",this.status),b&&b(this.status)):(J.trigger(n,"done",this.response),a&&a(this.response))};n.onerror=function(l){J.trigger(n,"fail",l)};if(c){for(h in c)n[h]=c[h];c.binary&&(n.responseType="arraybuffer")}n.send();return n};C.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||
Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(g){J.bind(this,"done",function(d,a){g(a)});return this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(g){J.bind(this,"fail",function(d,a){g(a)});return this}}));C.getFileExtension=function(g){var d=g.indexOf("?");-1!=d&&(g=g.substr(0,d));d=g.lastIndexOf(".");return-1==d?"":g.substr(d+1).toLowerCase()};C.loadFileAtlas=m.loadFileAtlas=
function(g,d,a){var b=null;HttpRequest(g,null,function(c){c=m.processFileAtlas(c);d&&d(c);b&&b(c)},alert,a);return{done:function(c){b=c}}};C.processFileAtlas=m.processFileAtlas=function(g,d){g=g.split("\n");for(var a={},b=[],c="",e=0,f=g.length;e<f;e++){var h=d?g[e]:g[e].trim();h.length&&("\\"!=h[0]?b.push(h):(b.length&&(a[c]=b.join("\n")),b.length=0,c=h.substr(1)))}b.length&&(a[c]=b.join("\n"));return a};C.typedArrayToArray=function(g){var d=[];d.length=g.length;for(var a=0;a<g.length;a++)d[a]=g[a];
return d};C.RGBToHex=function(g,d,a){g=Math.min(255,255*g)|0;d=Math.min(255,255*d)|0;a=Math.min(255,255*a)|0;return"#"+(16777216+(g<<16)+(d<<8)+a).toString(16).slice(1)};C.HUEToRGB=function(g,d,a){0>a&&(a+=1);1<a&&--a;return a<1/6?g+6*(d-g)*a:.5>a?d:a<2/3?g+(d-g)*(2/3-a)*6:g};C.HSLToRGB=function(g,d,a,b){b=b||vec3.create();if(0==d)a=d=g=a;else{var c=.5>a?a*(1+d):a+d-a*d,e=2*a-c;a=HUEToRGB(e,c,g+1/3);d=HUEToRGB(e,c,g);g=HUEToRGB(e,c,g-1/3)}b[0]=a;b[1]=d;b[2]=g;return b};C.hexColorToRGBA=function(){var g=
{white:[1,1,1],black:[0,0,0],gray:[.501960813999176,.501960813999176,.501960813999176],red:[1,0,0],orange:[1,.6470588445663452,0],pink:[1,.7529411911964417,.7960784435272217],green:[0,.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[.9333333373069763,.5098039507865906,.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[.6470588445663452,.16470588743686676,.16470588743686676],silver:[.7529411911964417,.7529411911964417,.7529411911964417],gold:[1,.843137264251709,0],transparent:[0,
0,0,0]};return function(d,a,b){b=void 0===b?1:b;a=a||new Float32Array(4);a[3]=b;if("string"!=typeof d)return a;var c=g[d];if(void 0!==c)return a.set(c),a[3]=3==a.length?b:a[3]*b,a;c=d.indexOf("rgba(");if(-1!=c)return d=d.substr(5,d.length-2),d=d.split(","),a[0]=parseInt(d[0])/255,a[1]=parseInt(d[1])/255,a[2]=parseInt(d[2])/255,a[3]=parseFloat(d[3])*b,a;c=d.indexOf("hsla(");if(-1!=c)return d=d.substr(5,d.length-2),d=d.split(","),HSLToRGB(parseInt(d[0])/360,parseInt(d[1])/100,parseInt(d[2])/100,a),
a[3]=parseFloat(d[3])*b,a;a[3]=b;c=d.indexOf("rgb(");if(-1!=c)return d=d.substr(4,d.length-2),d=d.split(","),a[0]=parseInt(d[0])/255,a[1]=parseInt(d[1])/255,a[2]=parseInt(d[2])/255,a;c=d.indexOf("hsl(");if(-1!=c)return d=d.substr(4,d.length-2),d=d.split(","),HSLToRGB(parseInt(d[0])/360,parseInt(d[1])/100,parseInt(d[2])/100,a),a;d=d.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,f,h,n){return f+f+h+h+n+n});b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);if(!b)return a;a[0]=parseInt(b[1],
16)/255;a[1]=parseInt(b[2],16)/255;a[2]=parseInt(b[3],16)/255;return a}}();C.toHalfFloat=function(){var g=new Float32Array(1),d=new Int32Array(g.buffer);return function(a){g[0]=a;a=d[0];var b=a>>16&32768,c=(a&2147483647)+4096;if(1199570944<=c)return 1199570944<=(a&2147483647)?2139095040>c?b|31744:b|31744|(a&8388607)>>13:b|31743;if(947912704<=c)return b|c-939524096>>13;if(855638016>c)return b;c=(a&2147483647)>>23;return b|(a&8388607|8388608)+(8388608>>>c-102)>>126-c}}();var aa=function(){function g(l){return l.charCodeAt(0)+
(l.charCodeAt(1)<<8)+(l.charCodeAt(2)<<16)+(l.charCodeAt(3)<<24)}function d(l,k,p,q){for(var t=new Uint16Array(4),x=new Uint16Array(p*q),z,w,r,v,A,y,u=p/4,B=q/4,D=0;D<B;D++)for(var G=0;G<u;G++)q=k+4*(D*u+G),t[0]=l[q],t[1]=l[q+1],z=t[0]&31,w=t[0]&2016,r=t[0]&63488,v=t[1]&31,A=t[1]&2016,y=t[1]&63488,t[2]=5*z+3*v>>3|5*w+3*A>>3&2016|5*r+3*y>>3&63488,t[3]=5*v+3*z>>3|5*A+3*w>>3&2016|5*y+3*r>>3&63488,z=l[q+2],w=4*D*p+4*G,x[w]=t[z&3],x[w+1]=t[z>>2&3],x[w+2]=t[z>>4&3],x[w+3]=t[z>>6&3],w+=p,x[w]=t[z>>8&3],
x[w+1]=t[z>>10&3],x[w+2]=t[z>>12&3],x[w+3]=t[z>>14],z=l[q+3],w+=p,x[w]=t[z&3],x[w+1]=t[z>>2&3],x[w+2]=t[z>>4&3],x[w+3]=t[z>>6&3],w+=p,x[w]=t[z>>8&3],x[w+1]=t[z>>10&3],x[w+2]=t[z>>12&3],x[w+3]=t[z>>14];return x}function a(l){for(var k=0,p=l.length,q;k<p;k+=4)q=l[k],l[k]=l[k+2],l[k+2]=q}function b(l,k,p,q){var t=new Int32Array(p,0,31),x,z;if(542327876!=t[0])return console.error("Invalid magic number in DDS header"),0;if(!t[20]&4)return console.error("Unsupported format, must contain a FourCC code"),
0;var w=t[21];switch(w){case f:var r=8;var v=k?k.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case h:r=16;v=k?k.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case n:r=16;v=k?k.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:r=4,w=null,v=l.RGBA}var A=1;t[2]&131072&&!1!==q&&(A=Math.max(1,t[7]));var y=t[4];var u=t[3];var B=t[1]+4;if(t[28]&512)for(z=0;6>z;++z)for(y=t[4],u=t[3],x=0;x<A;++x)w?(q=Math.max(4,y)/4*Math.max(4,u)/4*r,k=new Uint8Array(p,B,q),l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+z,x,v,
y,u,0,k)):(l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1),q=y*u*r,k=new Uint8Array(p,B,q),a(k),l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+z,x,v,y,u,0,l.RGBA,l.UNSIGNED_BYTE,k)),B+=q,y*=.5,u*=.5;else if(k)for(l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),x=0;x<A;++x)w?(q=Math.max(4,y)/4*Math.max(4,u)/4*r,k=new Uint8Array(p,B,q),l.compressedTexImage2D(l.TEXTURE_2D,x,v,y,u,0,k)):(q=y*u*r,k=new Uint8Array(p,B,q),a(k),l.texImage2D(l.TEXTURE_2D,x,v,y,u,0,v,l.UNSIGNED_BYTE,k)),B+=q,y*=.5,u*=.5;else if(w==f)k=new Uint16Array(p),
p=d(k,B/2,y,u),l.texImage2D(l.TEXTURE_2D,0,l.RGB,y,u,0,l.RGB,l.UNSIGNED_SHORT_5_6_5,p),q&&l.generateMipmap(l.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(w&255,w>>8&255,w>>16&255,w>>24&255),"and no native support"),0;return A}function c(l,k){var p=new Int32Array(l,0,31),q,t;if(542327876!=p[0])return console.error("Invalid magic number in DDS header"),0;if(!p[20]&4)return console.error("Unsupported format, must contain a FourCC code"),0;var x=p[21];switch(x){case f:var z=
8;var w="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case h:z=16;w="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case n:z=16;w="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:z=4,w="RGBA"}var r=1;p[2]&131072&&!1!==loadMipmaps&&(r=Math.max(1,p[7]));var v=p[4];var A=p[3];var y=p[1]+4;var u=[];if(p[28]&512)for(t=0;6>t;++t)for(v=p[4],A=p[3],q=0;q<r;++q){if(x)k=Math.max(4,v)/4*Math.max(4,A)/4*z,new Uint8Array(l,y,k),u.push({tex:"TEXTURE_CUBE_MAP",face:t,mipmap:q,internalFormat:w,width:v,height:A,offset:0,dataOffset:y,dataLength:k});
else{k=v*A*z;var B=new Uint8Array(l,y,k);a(B);u.push({tex:"TEXTURE_CUBE_MAP",face:t,mipmap:q,internalFormat:w,width:v,height:A,offset:0,type:"UNSIGNED_BYTE",dataOffset:y,dataLength:k})}y+=k;v*=.5;A*=.5}else if(k)if(x==f)B=new Uint16Array(l),l=d(B,y/2,v,A),u.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:v,height:A,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:l});else return console.error("No manual decoder for",String.fromCharCode(x&255,x>>8&255,x>>16&255,x>>24&255),"and no native support"),
0;else for(q=0;q<r;++q)k=Math.max(4,v)/4*Math.max(4,A)/4*z,new Uint8Array(l,y,k),u.push({tex:"TEXTURE_2D",mipmap:q,internalFormat:w,width:v,height:A,offset:0,type:"UNSIGNED_BYTE",dataOffset:y,dataLength:k}),y+=k,v*=.5,A*=.5;return u}function e(l,k,p,q,t,x){var z=new XMLHttpRequest;z.open("GET",p,!0);z.responseType="arraybuffer";z.onload=function(){if(200==this.status){var w=new Int32Array(this.response,0,31),r=w[28]&512?l.TEXTURE_CUBE_MAP:l.TEXTURE_2D;l.bindTexture(r,q);var v=b(l,k,this.response,
t);l.texParameteri(r,l.TEXTURE_MAG_FILTER,l.LINEAR);l.texParameteri(r,l.TEXTURE_MIN_FILTER,1<v?l.LINEAR_MIPMAP_LINEAR:l.LINEAR);l.bindTexture(r,null);q.texture_type=r;q.width=w[4];q.height=w[3]}x&&x(q)};z.send(null);return q}var f=g("DXT1"),h=g("DXT3"),n=g("DXT5");return{dxtToRgb565:d,uploadDDSLevels:b,loadDDSTextureEx:e,loadDDSTexture:function(l,k,p,q){var t=l.createTexture();k=l.getExtension("WEBGL_compressed_texture_s3tc");e(l,k,p,t,!0,q);return t},loadDDSTextureFromMemoryEx:function(l,k,p,q,t){var x=
new Int32Array(p,0,31),z=!!(x[28]&512),w=z?l.TEXTURE_CUBE_MAP:l.TEXTURE_2D;l.bindTexture(w,q.handler);k=b(l,k,p,t);l.texParameteri(w,l.TEXTURE_MAG_FILTER,l.LINEAR);l.texParameteri(w,l.TEXTURE_MIN_FILTER,1<k?l.LINEAR_MIPMAP_LINEAR:l.LINEAR);z&&(l.texParameteri(w,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(w,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE));l.bindTexture(w,null);q.handler&&(q.texture_type=w,q.width=x[4],q.height=x[3]);return q},getDDSTextureFromMemoryEx:function(l){var k=new Int32Array(l,0,
31),p=k[28]&512?"TEXTURE_CUBE_MAP":"TEXTURE_2D",q=c(l);return{type:p,buffers:q,data:l,width:k[4],height:k[3]}}}}();"undefined"!=typeof C&&(C.DDS=aa);if("undefined"==typeof Y&&"undefined"!=typeof exports&&exports.vec3)for(W in exports)C[W]=exports[W];Math.clamp=function(g,d,a){return d>g?d:a<g?a:g};Math.lerp=function(g,d,a){return g*(1-a)+d*a};Math.lerp01=function(g,d,a){return Math.clamp(g*(1-a)+d*a,0,1)};Math.iLerp=function(g,d,a){return(a-g)/(d-g)};Math.remap=function(g,d,a,b,c){return Math.lerp(b,
c,Math.iLerp(d,a,g))};vec3.ZERO=vec3.fromValues(0,0,0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=vec3.fromValues(1,0,0);vec2.rotate=function(g,d,a){var b=d[0];d=d[1];var c=Math.cos(a);a=Math.sin(a);g[0]=b*c-d*a;g[1]=b*a+d*c;return g};vec3.zero=function(g){g[0]=g[1]=0;return g};vec2.perpdot=function(g,d){return g[1]*d[0]+-g[0]*d[1]};vec2.computeSignedAngle=function(g,d){return Math.atan2(vec2.perpdot(g,d),vec2.dot(g,d))};vec2.random=function(g,d){d=d||1;g[0]=Math.random()*
d;g[1]=Math.random()*d;return g};vec3.zero=function(g){g[0]=g[1]=g[2]=0;return g};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.maxValue=function(g){return g[0]>g[1]&&g[0]>g[2]?g[0]:g[1]>g[2]?g[1]:g[2]};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.addValue=function(g,d,a){g[0]=d[0]+a;g[1]=d[1]+a;g[2]=d[2]+a};vec3.subValue=function(g,d,a){g[0]=d[0]-a;g[1]=d[1]-a;g[2]=d[2]-a};vec3.toArray=function(g){return[g[0],g[1],g[2]]};
vec3.rotateX=function(g,d,a){var b=d[1],c=d[2],e=Math.cos(a);a=Math.sin(a);g[0]=d[0];g[1]=b*e-c*a;g[2]=b*a+c*e;return g};vec3.rotateY=function(g,d,a){var b=d[0],c=d[2],e=Math.cos(a);a=Math.sin(a);g[0]=b*e-c*a;g[1]=d[1];g[2]=b*a+c*e;return g};vec3.rotateZ=function(g,d,a){var b=d[0],c=d[1],e=Math.cos(a);a=Math.sin(a);g[0]=b*e-c*a;g[1]=b*a+c*e;g[2]=d[2];return g};vec3.angle=function(g,d){return Math.acos(vec3.dot(g,d))};vec3.signedAngle=function(g,d,a){return vec3.angle(g,d)*Math.sign(a[0]*(g[1]*d[2]-
g[2]*d[1])+a[1]*(g[2]*d[0]-g[0]*d[2])+a[2]*(g[0]*d[1]-g[1]*d[0]))};vec3.random=function(g,d){d=d||1;g[0]=Math.random()*d;g[1]=Math.random()*d;g[2]=Math.random()*d;return g};vec3.cartesianToPolar=function(g,d){g=g||vec3.create();var a=d[0],b=d[1];d=d[2];g[0]=Math.sqrt(a*a+b*b+d*d);g[1]=Math.asin(b/g[0]);g[2]=Math.atan2(a,d);return g};vec3.polarToCartesian=function(g,d){var a=d[0],b=d[1];d=d[2];g[0]=a*Math.cos(b)*Math.sin(d);g[1]=a*Math.sin(b);g[2]=a*Math.cos(b)*Math.cos(d);return g};vec3.reflect=function(g,
d,a){var b=d[0],c=d[1],e=d[2];vec3.scale(g,a,-2*vec3.dot(d,a));g[0]+=b;g[1]+=c;g[2]+=e;return g};vec4.random=function(g,d){d=d||1;g[0]=Math.random()*d;g[1]=Math.random()*d;g[2]=Math.random()*d;g[3]=Math.random()*d;return g};vec4.toArray=function(g){return[g[0],g[1],g[2],g[3]]};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(g){return[g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15]]};mat4.setUpAndOrthonormalize=function(g,d,a){d!=
g&&mat4.copy(g,d);d=g.subarray(0,3);vec3.normalize(g.subarray(4,7),a);g=g.subarray(8,11);vec3.cross(d,a,g);vec3.normalize(d,d);vec3.cross(g,d,a);vec3.normalize(g,g)};mat4.multiplyVec3=function(g,d,a){var b=a[0],c=a[1];a=a[2];g[0]=d[0]*b+d[4]*c+d[8]*a+d[12];g[1]=d[1]*b+d[5]*c+d[9]*a+d[13];g[2]=d[2]*b+d[6]*c+d[10]*a+d[14];return g};mat4.projectVec3=function(g,d,a){var b=a[0],c=a[1];a=a[2];var e=d[1]*b+d[5]*c+d[9]*a+d[13],f=d[2]*b+d[6]*c+d[10]*a+d[14],h=d[3]*b+d[7]*c+d[11]*a+d[15];g[0]=((d[0]*b+d[4]*
c+d[8]*a+d[12])/h+1)/2;g[1]=(e/h+1)/2;g[2]=(f/h+1)/2;return g};vec3.project=function(g,d,a,b){b=b||gl.viewport_data;var c=d[0],e=d[1];d=d[2];var f=a[1]*c+a[5]*e+a[9]*d+a[13],h=a[2]*c+a[6]*e+a[10]*d+a[14],n=a[3]*c+a[7]*e+a[11]*d+a[15];g[0]=((a[0]*c+a[4]*e+a[8]*d+a[12])/n+1)/2*b[2]+b[0];g[1]=(1-(f/n+1)/2)*b[3]+b[1];g[2]=(h/n+1)/2;return g};var ba=mat4.create(),P=vec4.create();vec3.unproject=function(g,d,a,b){P[0]=2*(d[0]-b[0])/b[2]-1;P[1]=2*(d[1]-b[1])/b[3]-1;P[2]=2*d[2]-1;P[3]=1;if(!mat4.invert(ba,
a))return null;vec4.transformMat4(P,P,ba);if(0===P[3])return null;g[0]=P[0]/P[3];g[1]=P[1]/P[3];g[2]=P[2]/P[3];return g};mat4.rotateVec3=function(g,d,a){var b=a[0],c=a[1];a=a[2];g[0]=d[0]*b+d[4]*c+d[8]*a;g[1]=d[1]*b+d[5]*c+d[9]*a;g[2]=d[2]*b+d[6]*c+d[10]*a;return g};mat4.fromTranslationFrontTop=function(g,d,a,b){vec3.cross(g.subarray(0,3),a,b);g.set(b,4);g.set(a,8);g.set(d,12);return g};mat4.translationMatrix=function(g){var d=mat4.create();d[12]=g[0];d[13]=g[1];d[14]=g[2];return d};mat4.setTranslation=
function(g,d){g[12]=d[0];g[13]=d[1];g[14]=d[2];return g};mat4.getTranslation=function(g,d){g[0]=d[12];g[1]=d[13];g[2]=d[14];return g};mat4.toRotationMat4=function(g,d){mat4.copy(g,d);g[12]=g[13]=g[14]=0;return g};mat4.swapRows=function(g,d,a,b){if(g!=d)return mat4.copy(g,d),g[4*a]=d[4*b],g[4*a+1]=d[4*b+1],g[4*a+2]=d[4*b+2],g[4*a+3]=d[4*b+3],g[4*b]=d[4*a],g[4*b+1]=d[4*a+1],g[4*b+2]=d[4*a+2],g[4*b+3]=d[4*a+3],g;d=new Float32Array(matrix.subarray(4*a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(d,
4*b);return g};mat4.scaleAndAdd=function(g,d,a,b){g[0]=d[0]+a[0]*b;g[1]=d[1]+a[1]*b;g[2]=d[2]+a[2]*b;g[3]=d[3]+a[3]*b;g[4]=d[4]+a[4]*b;g[5]=d[5]+a[5]*b;g[6]=d[6]+a[6]*b;g[7]=d[7]+a[7]*b;g[8]=d[8]+a[8]*b;g[9]=d[9]+a[9]*b;g[10]=d[10]+a[10]*b;g[11]=d[11]+a[11]*b;g[12]=d[12]+a[12]*b;g[13]=d[13]+a[13]*b;g[14]=d[14]+a[14]*b;g[15]=d[15]+a[15]*b;return g};quat.fromAxisAngle=function(g,d){var a=quat.create();d*=.5;var b=Math.sin(d);a[0]=b*g[0];a[1]=b*g[1];a[2]=b*g[2];a[3]=Math.cos(d);return a};quat.lookRotation=
function(){var g=vec3.create(),d=vec3.create(),a=vec3.create();return function(b,c,e){vec3.normalize(g,c);vec3.cross(d,e,g);vec3.normalize(d,d);vec3.cross(a,g,d);var f=d[0];c=d[1];e=d[2];var h=a[0],n=a[1],l=a[2],k=g[0],p=g[1],q=g[2],t=f+n+q;if(0<t)return f=Math.sqrt(t+1),b[3]=.5*f,f=.5/f,b[0]=(l-p)*f,b[1]=(k-e)*f,b[2]=(c-h)*f,b;if(f>=n&&f>=q)return f=Math.sqrt(1+f-n-q),n=.5/f,b[0]=.5*f,b[1]=(c+h)*n,b[2]=(e+k)*n,b[3]=(l-p)*n,b;if(n>q)return f=Math.sqrt(1+n-f-q),n=.5/f,b[0]=(h+c)*n,b[1]=.5*f,b[2]=(p+
l)*n,b[3]=(k-e)*n,b;f=Math.sqrt(1+q-f-n);n=.5/f;b[0]=(k+e)*n;b[1]=(p+l)*n;b[2]=.5*f;b[3]=(c-h)*n;return b}}();quat.toEuler=function(g,d){var a=Math.atan2(2*d[1]*d[3]-2*d[0]*d[2],1-2*d[1]*d[1]-2*d[2]*d[2]),b=Math.asin(2*d[0]*d[1]+2*d[2]*d[3]);d=Math.atan2(2*d[0]*d[3]-2*d[1]*d[2],1-2*d[0]*d[0]-2*d[2]*d[2]);g||=vec3.create();vec3.set(g,a,b,d);return g};quat.fromEuler=function(g,d){var a=d[0],b=d[1],c=d[2];d=Math.cos(a);var e=Math.cos(b),f=Math.cos(c);a=Math.sin(a);b=Math.sin(b);c=Math.sin(c);var h=.5*
Math.sqrt(1+d*e+d*f-a*b*c+e*f);0==h&&(h=1E-6);quat.set(g,(e*c+d*c+a*b*f)/(4*h),(a*e+a*f+d*b*c)/(4*h),(-a*c+d*b*f+b)/(4*h),h);quat.normalize(g,g);return g};quat.fromMat4=function(g,d){var a=d[0]+d[5]+d[10];if(0<a){var b=Math.sqrt(a+1);g[3]=.5*b;b=.5/b;g[0]=(d[9]-d[6])*b;g[1]=(d[8]-d[2])*b;g[2]=(d[4]-d[1])*b}else{a=0;d[5]>d[0]&&(a=1);d[10]>d[4*a+a]&&(a=2);var c=(a+1)%3,e=(c+1)%3;b=Math.sqrt(d[4*a+a]-d[4*c+c]-d[4*e+e]+1);g[a]=.5*b;b=.5/b;g[3]=(d[4*e+c]-d[4*c+e])*b;g[c]=(d[4*c+a]+d[4*a+c])*b;g[e]=(d[4*
e+a]+d[4*a+e])*b}quat.normalize(g,g)};vec3.getMat3Column=function(g,d,a){g[0]=d[3*a];g[1]=d[3*a+1];g[2]=d[3*a+2];return g};mat3.setColumn=function(g,d,a){g[3*a]=d[0];g[3*a+1]=d[1];g[3*a+2]=d[2];return g};quat.fromMat3AndQuat=function(){var g=mat3.create(),d=quat.create(),a=vec3.create(),b=vec3.create(),c=vec3.create(),e=vec3.create(),f=vec3.create(),h=vec3.create(),n=vec3.create(),l=vec3.create(),k=vec3.create(),p=vec3.create();mat3.create();return function(q,t,x){x=x||25;for(var z=0;z<x;++z){var w=
mat3.fromQuat(g,q);vec3.getMat3Column(a,w,0);vec3.getMat3Column(b,w,1);vec3.getMat3Column(c,w,2);vec3.getMat3Column(e,t,0);vec3.getMat3Column(f,t,1);vec3.getMat3Column(h,t,2);vec3.cross(n,a,e);vec3.cross(l,b,f);vec3.cross(k,c,h);vec3.add(p,n,l);vec3.add(p,p,k);w=1/Math.abs(vec3.dot(a,e)+vec3.dot(b,f)+vec3.dot(c,h))+1E-9;vec3.scale(p,p,w);w=vec3.length(p);if(1E-9>w)break;vec3.scale(p,p,1/w);quat.setAxisAngle(d,p,w);quat.mul(q,d,q);quat.normalize(q,q)}return q}}();quat.rotateToFrom=function(){var g=
vec3.create();return function(d,a,b){d=d||quat.create();var c=vec3.cross(g,a,b);a=vec3.dot(a,b);if(-.99>a)return d[0]=0,d[1]=1,d[2]=0,d[3]=0,d;d[0]=.5*c[0];d[1]=.5*c[1];d[2]=.5*c[2];d[3]=.5*(1+a);quat.normalize(d,d);return d}}();quat.lookAt=function(){var g=vec3.create();return function(d,a,b){b=vec3.dot(vec3.FRONT,a);if(1E-6>Math.abs(b- -1))return d.set(vec3.UP),d[3]=Math.PI,d;if(1E-6>Math.abs(b-1))return quat.identity(d);b=Math.acos(b);vec3.cross(g,vec3.FRONT,a);vec3.normalize(g,g);quat.setAxisAngle(d,
g,b);return d}}();m.Indexer=function(){this.unique=[];this.indices=[];this.map={}};m.Indexer.prototype={add:function(g){var d=JSON.stringify(g);d in this.map||(this.map[d]=this.unique.length,this.unique.push(g));return this.map[d]}};m.Buffer=function(g,d,a,b,c){m.debug&&console.log("GL.Buffer created");null!==c&&(c=c||C.gl);this.gl=c;this.buffer=null;this.target=g;this.attribute=null;this.normalize=!1;this.data=d;this.spacing=a||3;this.data&&this.gl&&this.upload(b)};m.Buffer.prototype.bind=function(g,
d){d=d||this.gl;d.bindBuffer(d.ARRAY_BUFFER,this.buffer);d.enableVertexAttribArray(g);d.vertexAttribPointer(g,this.spacing,this.buffer.gl_type,this.normalize||!1,0,0)};m.Buffer.prototype.unbind=function(g,d){d=d||this.gl;d.disableVertexAttribArray(g)};m.Buffer.prototype.forEach=function(g){for(var d=this.data,a=0,b=this.spacing,c=d.length;a<c;a+=b)g(d.subarray(a,a+b),a);return this};m.Buffer.prototype.applyTransform=function(g){for(var d=this.data,a=0,b=this.spacing,c=d.length;a<c;a+=b){var e=d.subarray(a,
a+b);vec3.transformMat4(e,e,g)}return this};m.Buffer.prototype.upload=function(g){var d=this.spacing||3,a=this.gl;if(a){if(!this.data)throw"No data supplied";var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||a.createBuffer()){this.buffer.length=b.length;this.buffer.spacing=d;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=
a.SHORT;break;case Uint16Array:this.buffer.gl_type=a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=a.INT;break;case Uint32Array:this.buffer.gl_type=a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";}this.target!=a.ARRAY_BUFFER||this.buffer.gl_type!=a.INT&&this.buffer.gl_type!=a.UNSIGNED_INT||(console.warn("WebGL does not support UINT32 or INT32 as vertex buffer types, converting to FLOAT"),this.buffer.gl_type=a.FLOAT,b=new Float32Array(b));
a.bindBuffer(this.target,this.buffer);a.bufferData(this.target,b,g||this.stream_type||a.STATIC_DRAW)}}};m.Buffer.prototype.compile=m.Buffer.prototype.upload;m.Buffer.prototype.setData=function(g,d){if(!g.buffer)throw"Data must be typed array";d=d||0;if(this.data){if(this.data.length<g.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";this.data!=g&&(this.data.length==g.length?(this.data.set(g),this.upload()):(g=new Uint8Array(g.buffer,g.buffer.byteOffset,g.buffer.byteLength),
(new Uint8Array(this.data.buffer)).set(g,d),this.uploadRange(d,g.length)))}else this.data=g,this.upload()};m.Buffer.prototype.uploadRange=function(g,d){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";d=new Uint8Array(this.data.buffer,g,d);var a=this.gl;a.bindBuffer(this.target,this.buffer);a.bufferSubData(this.target,g,d)};m.Buffer.prototype.clone=function(g){var d=new m.Buffer;if(g)for(var a in this)d[a]=this[a];else this.target&&(d.target=
this.target),this.gl&&(d.gl=this.gl),this.spacing&&(d.spacing=this.spacing),this.data&&(d.data=new C[this.data.constructor](this.data),d.upload());return d};m.Buffer.prototype.toJSON=function(){return this.data?{data_type:getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)};m.Buffer.prototype.fromJSON=function(g){this.data=new (C[g.data_type]||Float32Array)(g.data);this.target=
g.target;this.spacing=g.spacing||3;this.attribute=g.attribute;this.upload(m.STATIC_DRAW)};m.Buffer.prototype.delete=function(){this.gl.deleteBuffer(this.buffer);this.buffer=null};C.Mesh=m.Mesh=function(g,d,a,b){m.debug&&console.log("GL.Mesh created");null!==b&&(this.gl=b=b||C.gl);this.gl&&(this._context_id=this.gl.context_id);this.vertexBuffers={};this.indexBuffers={};this.info={groups:[]};this._bounding=BBox.create();(g||d)&&this.addBuffers(g,d,a?a.stream_type:null);if(a)for(var c in a)this[c]=a[c]};
Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal",normalize:!0},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color",normalize:!0},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights",normalize:!0},
extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Object.defineProperty(Mesh.prototype,"bounding",{set:function(g){if(g){if(13>g.length)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(g)}},get:function(){return this._bounding}});Mesh.prototype.addBuffer=function(g,d){d.target==gl.ARRAY_BUFFER?
this.vertexBuffers[g]=d:this.indexBuffers[g]=d;!d.attribute&&(g=m.Mesh.common_buffers[g])&&(d.attribute=g.attribute)};Mesh.prototype.addBuffers=function(g,d,a){var b=0;this.vertexBuffers.vertices&&(b=this.vertexBuffers.vertices.data.length/3);for(var c in g){var e=g[c];if(e){if(e.constructor==m.Buffer||e.data)e=e.data;else if("number"!=typeof e[0]){for(var f=[],h=0,n=1E4;h<e.length;h+=n)f=Array.prototype.concat.apply(f,e.slice(h,h+n));e=f}f=m.Mesh.common_buffers[c];e.constructor===Array&&(h=m.Mesh.default_datatype,
f&&f.type&&(h=f.type),e=new h(e));"vertices"==c&&(b=e.length/3);h=e.length/b;f&&f.spacing&&(h=f.spacing);n="a_"+c;f&&f.attribute&&(n=f.attribute);this.vertexBuffers[c]?this.updateVertexBuffer(c,n,h,e,a):this.createVertexBuffer(c,n,h,e,a)}}if(d)for(c in d)if(e=d[c]){if(e.constructor==m.Buffer||e.data)e=e.data;if("number"!=typeof e[0]){f=[];c=0;for(n=1E4;c<e.length;c+=n)f=Array.prototype.concat.apply(f,e.slice(c,c+n));e=f}e.constructor===Array&&(h=Uint16Array,65536<b&&(h=Uint32Array),e=new h(e));this.createIndexBuffer(c,
e)}};Mesh.prototype.createVertexBuffer=function(g,d,a,b,c){var e=m.Mesh.common_buffers[g];!d&&e&&(d=e.attribute);if(!d)throw"Buffer added to mesh without attribute name";!a&&e&&(a=e&&e.spacing?e.spacing:3);if(!b){b=this.getNumVertices();if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";b=new m.Mesh.default_datatype(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[g]=new m.Buffer(m.ARRAY_BUFFER,b,a,c,this.gl);a.name=
g;a.attribute=d;(b.constructor==Uint8Array||b.constructor==Int8Array||b.constructor==Uint16Array||b.constructor==Int16Array||b.constructor==Uint32Array||b.constructor==Int32Array)&&e&&e.normalize&&(a.normalize=!0);return a};Mesh.prototype.updateVertexBuffer=function(g,d,a,b,c){var e=this.vertexBuffers[g];e?b.length&&(e.attribute=d,e.spacing=a,e.data=b,e.upload(c)):console.log("buffer not found: ",g)};Mesh.prototype.removeVertexBuffer=function(g,d){var a=this.vertexBuffers[g];a&&(d&&a.delete(),delete this.vertexBuffers[g])};
Mesh.prototype.getVertexBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.createIndexBuffer=function(g,d,a){if(d.constructor===Array){var b=Uint16Array,c=this.vertexBuffers.vertices;c&&(65536<c.data.length/3&&(b=Uint32Array),d=new b(d))}return this.indexBuffers[g]=new m.Buffer(m.ELEMENT_ARRAY_BUFFER,d,0,a,this.gl)};Mesh.prototype.getBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.getIndexBuffer=function(g){return this.indexBuffers[g]};Mesh.prototype.removeIndexBuffer=
function(g,d){var a=this.indexBuffers[g];a&&(d&&a.delete(),delete this.indexBuffers[g])};Mesh.prototype.upload=function(g){for(var d in this.vertexBuffers){var a=this.vertexBuffers[d];a.upload(g)}for(var b in this.indexBuffers)a=this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var g in this.vertexBuffers){var d=this.vertexBuffers[g];d.delete()}this.vertexBuffers={};for(g in this.indexBuffers)d=this.indexBuffers[g],d.delete();
this.indexBuffers={}};Mesh.prototype.delete=Mesh.prototype.deleteBuffers;Mesh.prototype.bindBuffers=function(g){for(var d in this.vertexBuffers){var a=this.vertexBuffers[d],b=g.attributes[a.attribute||d];null!=b&&a.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.buffer.spacing,a.buffer.gl_type,a.normalize||!1,0,0))}};Mesh.prototype.unbindBuffers=function(g){for(var d in this.vertexBuffers){var a=this.vertexBuffers[d],b=a.attribute||d;null!=
g.attributes[b]&&a.buffer&&gl.disableVertexAttribArray(g.attributes[b])}};Mesh.prototype.clone=function(g){g=g||C.gl;var d={},a={},b;for(b in this.vertexBuffers){var c=this.vertexBuffers[b];d[b]=new c.data.constructor(c.data)}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=new c.data.constructor(c.data);return new m.Mesh(d,a,void 0,g)};Mesh.prototype.cloneShared=function(g){g=g||C.gl;return new m.Mesh(this.vertexBuffers,this.indexBuffers,void 0,g)};Mesh.prototype.toObject=function(){var g=
{},d={},a;for(a in this.vertexBuffers){var b=this.vertexBuffers[a];g[a]={spacing:b.spacing,data:new b.data.constructor(b.data)}}for(a in this.indexBuffers)b=this.indexBuffers[a],d[a]={data:new b.data.constructor(b.data)};return{vertexBuffers:g,indexBuffers:d,info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()}};Mesh.prototype.toJSON=function(){var g={vertexBuffers:{},indexBuffers:{},info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()},d;for(d in this.vertexBuffers)g.vertexBuffers[d]=
this.vertexBuffers[d].toJSON();for(d in this.indexBuffers)g.indexBuffers[d]=this.indexBuffers[d].toJSON();return g};Mesh.prototype.fromJSON=function(g){this.vertexBuffers={};this.indexBuffers={};for(var d in g.vertexBuffers)if(g.vertexBuffers[d]){var a=new m.Buffer;a.fromJSON(g.vertexBuffers[d]);!a.attribute&&m.Mesh.common_buffers[d]&&(a.attribute=m.Mesh.common_buffers[d].attribute);this.vertexBuffers[d]=a}for(d in g.indexBuffers)g.indexBuffers[d]&&(a=new m.Buffer,a.fromJSON(g.indexBuffers[d]),this.indexBuffers[d]=
a);g.info&&(this.info=cloneObject(g.info));g.bounding&&(this.bounding=g.bounding)};Mesh.prototype.generateMetadata=function(){var g={},d=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;g.vertices=d.length/3;g.faces=a?a.length/3:d.length/9;g.indexed=!!this.metadata.faces;this.metadata=g};Mesh.prototype.computeWireframe=function(){var g=this.indexBuffers.triangles,d=this.vertexBuffers.vertices.data.length/3;if(g){var a=g.data,b=new m.Indexer;for(g=0;g<a.length;g+=3)for(var c=a.subarray(g,
g+3),e=0;e<c.length;e++){var f=c[e],h=c[(e+1)%c.length];b.add([Math.min(f,h),Math.max(f,h)])}a=b.unique;b=65536<d?new Uint32Array(2*a.length):new Uint16Array(2*a.length);g=0;for(d=a.length;g<d;++g)b.set(a[g],2*g)}else for(g=d/3,b=65536<d?new Uint32Array(6*g):new Uint16Array(6*g),g=0;g<d;g+=3)b[2*g]=g,b[2*g+1]=g+1,b[2*g+2]=g+1,b[2*g+3]=g+2,b[2*g+4]=g+2,b[2*g+5]=g;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.flipNormals=function(g){var d=this.vertexBuffers.normals;if(d){for(var a=
d.data,b=a.length,c=0;c<b;++c)a[c]*=-1;d.upload(g);this.indexBuffers.triangles||this.computeIndices();d=this.indexBuffers.triangles;a=d.data;b=a.length;for(c=0;c<b;c+=3){var e=a[c];a[c]=a[c+1];a[c+1]=e}d.upload(g)}};Mesh.prototype.computeIndices=function(){var g=[],d=[],a=[],b=[],c=this.vertexBuffers.normals,e=this.vertexBuffers.coords,f=this.vertexBuffers.vertices.data,h=null;c&&(h=c.data);c=null;e&&(c=e.data);e={};for(var n=f.length/3,l=0;l<n;++l){var k=f.subarray(3*l,3*(l+1)),p=1E3*k[0]|0,q=0,
t=e[p];if(t)for(var x=t.length;q<x;q++)if(.01>vec3.sqrDist(k,g[t[q]])){b.push(q);break}t&&q!=x||(g.push(k),e[p]?e[p].push(q):e[p]=[q],h&&d.push(h.subarray(3*l,3*(l+1))),c&&a.push(c.subarray(2*l,2*(l+1))),b.push(q))}this.vertexBuffers={};this.createVertexBuffer("vertices",m.Mesh.common_buffers.vertices.attribute,3,Z(g));h&&this.createVertexBuffer("normals",m.Mesh.common_buffers.normals.attribute,3,Z(d));c&&this.createVertexBuffer("coords",m.Mesh.common_buffers.coords.attribute,2,Z(a));this.createIndexBuffer("triangles",
b)};Mesh.prototype.explodeIndices=function(g){g=g||"triangles";var d=this.getIndexBuffer(g);if(d){var a=d.data;d={};for(var b in this.vertexBuffers){var c=m.Mesh.common_buffers[b];d[b]=new (c.type||Float32Array)(c.spacing*a.length)}b=0;for(var e=a.length;b<e;++b){var f=a[b];for(n in this.vertexBuffers){var h=this.vertexBuffers[n];c=m.Mesh.common_buffers[n];c=h.spacing||c.spacing;d[n].set(h.data.subarray(f*c,f*c+c),b*c)}}for(b in d){var n=this.vertexBuffers[b];this.createVertexBuffer(b,n.attribute,
n.spacing,d[b])}delete this.indexBuffers[g]}};Mesh.prototype.computeNormals=function(g){if(!this.vertexBuffers.vertices)return console.error("Cannot compute normals of a mesh without vertices");var d=this.vertexBuffers.vertices.data,a=new Float32Array(d.length),b=null;this.indexBuffers.triangles&&(b=this.indexBuffers.triangles.data);for(var c=m.temp_vec3,e=m.temp2_vec3,f,h,n,l,k,p,q=b?b.length:d.length,t=0;t<q;t+=3)b?(f=b[t],h=b[t+1],n=b[t+2],l=d.subarray(3*f,3*f+3),k=d.subarray(3*h,3*h+3),p=d.subarray(3*
n,3*n+3),f=a.subarray(3*f,3*f+3),h=a.subarray(3*h,3*h+3),n=a.subarray(3*n,3*n+3)):(l=d.subarray(3*t,3*t+3),k=d.subarray(3*t+3,3*t+6),p=d.subarray(3*t+6,3*t+9),f=a.subarray(3*t,3*t+3),h=a.subarray(3*t+3,3*t+6),n=a.subarray(3*t+6,3*t+9)),vec3.sub(c,k,l),vec3.sub(e,p,l),vec3.cross(c,c,e),vec3.normalize(c,c),vec3.add(f,f,c),vec3.add(h,h,c),vec3.add(n,n,c);if(b)for(t=0,q=a.length;t<q;t+=3)d=a.subarray(t,t+3),vec3.normalize(d,d);if(q=this.vertexBuffers.normals)q.data=a,q.upload(g);else return this.createVertexBuffer("normals",
m.Mesh.common_buffers.normals.attribute,3,a);return q};Mesh.prototype.computeTangents=function(){var g=this.vertexBuffers.vertices;if(!g)return console.error("Cannot compute tangents of a mesh without vertices");var d=this.vertexBuffers.normals;if(!d)return console.error("Cannot compute tangents of a mesh without normals");var a=this.vertexBuffers.coords;if(!a)return console.error("Cannot compute tangents of a mesh without uvs");var b=this.indexBuffers.triangles;if(!b)return console.error("Cannot compute tangents of a mesh without indices");
g=g.data;d=d.data;var c=a.data,e=b.data;if(g&&d&&c){var f=g.length/3;b=new Float32Array(4*f);a=new Float32Array(6*f);f=a.subarray(3*f);var h,n=vec3.create(),l=vec3.create(),k=vec3.create(),p=vec3.create();var q=0;for(h=e.length;q<h;q+=3){var t=e[q],x=e[q+1],z=e[q+2],w=g.subarray(3*t,3*t+3),r=g.subarray(3*x,3*x+3),v=g.subarray(3*z,3*z+3),A=c.subarray(2*t,2*t+2),y=c.subarray(2*x,2*x+2),u=c.subarray(2*z,2*z+2),B=r[0]-w[0],D=v[0]-w[0],G=r[1]-w[1],F=v[1]-w[1];r=r[2]-w[2];w=v[2]-w[2];v=y[0]-A[0];var H=
u[0]-A[0];y=y[1]-A[1];A=u[1]-A[1];u=v*A-H*y;u=1E-9>Math.abs(u)?0:1/u;vec3.copy(n,[(A*B-y*D)*u,(A*G-y*F)*u,(A*r-y*w)*u]);vec3.copy(l,[(v*D-H*B)*u,(v*F-H*G)*u,(v*w-H*r)*u]);vec3.add(a.subarray(3*t,3*t+3),a.subarray(3*t,3*t+3),n);vec3.add(a.subarray(3*x,3*x+3),a.subarray(3*x,3*x+3),n);vec3.add(a.subarray(3*z,3*z+3),a.subarray(3*z,3*z+3),n);vec3.add(f.subarray(3*t,3*t+3),f.subarray(3*t,3*t+3),l);vec3.add(f.subarray(3*x,3*x+3),f.subarray(3*x,3*x+3),l);vec3.add(f.subarray(3*z,3*z+3),f.subarray(3*z,3*z+
3),l)}q=0;for(h=g.length;q<h;q+=3)g=d.subarray(q,q+3),c=a.subarray(q,q+3),vec3.subtract(k,c,vec3.scale(k,g,vec3.dot(g,c))),vec3.normalize(k,k),g=0>vec3.dot(vec3.cross(p,g,c),f.subarray(q,q+3))?-1:1,b.set([k[0],k[1],k[2],g],q/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,b)}};Mesh.prototype.computeTextureCoordinates=function(g){var d=this.vertexBuffers.vertices;if(!d)return console.error("Cannot compute uvs of a mesh without vertices");this.explodeIndices("triangles");
d=d.data;var a=this.vertexBuffers.coords,b=new Float32Array(d.length/3*2),c=this.indexBuffers.triangles,e=null;c&&(e=c.data);c=vec3.create();var f=vec3.create(),h=vec3.create(),n=this.getBoundingBox(),l=BBox.getCenter(n),k=vec3.create();k.set(BBox.getHalfsize(n));vec3.scale(k,k,2);n=e?e.length:d.length/3;for(var p=0;p<n;p+=3){if(e){var q=e[p],t=e[p+1],x=e[p+2],z=d.subarray(3*q,3*q+3),w=d.subarray(3*t,3*t+3),r=d.subarray(3*x,3*x+3);q=b.subarray(2*q,2*q+2);t=b.subarray(2*t,2*t+2);x=b.subarray(2*x,2*
x+2)}else z=d.subarray(3*p,3*p+3),w=d.subarray(3*(p+1),3*(p+1)+3),r=d.subarray(3*(p+2),3*(p+2)+3),q=b.subarray(2*p,2*p+2),t=b.subarray(2*(p+1),2*(p+1)+2),x=b.subarray(2*(p+2),2*(p+2)+2);vec3.sub(f,z,w);vec3.sub(h,z,r);vec3.cross(c,f,h);c[0]=Math.abs(c[0]);c[1]=Math.abs(c[1]);c[2]=Math.abs(c[2]);c[0]>c[1]&&c[0]>c[2]?(q[0]=(z[2]-l[2])/k[2],q[1]=(z[1]-l[1])/k[1],t[0]=(w[2]-l[2])/k[2],t[1]=(w[1]-l[1])/k[1],x[0]=(r[2]-l[2])/k[2],x[1]=(r[1]-l[1])/k[1]):c[1]>c[2]?(q[0]=(z[0]-l[0])/k[0],q[1]=(z[2]-l[2])/
k[2],t[0]=(w[0]-l[0])/k[0],t[1]=(w[2]-l[2])/k[2],x[0]=(r[0]-l[0])/k[0],x[1]=(r[2]-l[2])/k[2]):(q[0]=(z[0]-l[0])/k[0],q[1]=(z[1]-l[1])/k[1],t[0]=(w[0]-l[0])/k[0],t[1]=(w[1]-l[1])/k[1],x[0]=(r[0]-l[0])/k[0],x[1]=(r[1]-l[1])/k[1])}a?(a.data=b,a.upload(g)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,b)};Mesh.prototype.getNumVertices=function(){var g=this.vertexBuffers.vertices;return g?g.data.length/g.spacing:0};Mesh.prototype.getNumTriangles=function(){var g=this.getIndexBuffer("triangles");
return g?g.data.length/3:this.getNumVertices()/3};Mesh.computeBoundingBox=function(g,d,a){if(g){var b=0;if(a){for(var c=0;c<a.length;++c)if(a[c]){b=c;break}if(b==a.length){console.warn("mask contains only zeros, no vertices marked");return}}var e=vec3.clone(g.subarray(3*b,3*b+3)),f=vec3.clone(g.subarray(3*b,3*b+3));for(c=3*b;c<g.length;c+=3)if(!a||a[c/3])b=g.subarray(c,c+3),vec3.min(e,b,e),vec3.max(f,b,f);if(isNaN(e[0])||isNaN(e[1])||isNaN(e[2])||isNaN(f[0])||isNaN(f[1])||isNaN(f[2]))e[0]=e[1]=e[2]=
0,f[0]=f[1]=f[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices");g=vec3.add(vec3.create(),e,f);vec3.scale(g,g,.5);f=vec3.subtract(vec3.create(),f,g);return BBox.setCenterHalfsize(d||BBox.create(),g,f)}};Mesh.prototype.getBoundingBox=function(){if(this._bounding)return this._bounding;this.updateBoundingBox();return this._bounding};Mesh.prototype.updateBoundingBox=function(){var g=this.vertexBuffers.vertices;g&&(m.Mesh.computeBoundingBox(g.data,this._bounding),this.info&&this.info.groups&&
this.info.groups.length&&this.computeGroupsBoundingBoxes())};Mesh.prototype.computeGroupsBoundingBoxes=function(){var g=null,d=this.getIndexBuffer("triangles");d&&(g=d.data);d=this.getVertexBuffer("vertices");if(!d)return!1;d=d.data;if(!d.length)return!1;var a=this.info.groups;if(a){for(var b=0;b<a.length;++b){var c=a[b];c.bounding=c.bounding||BBox.create();if(g){var e=new Uint8Array(d.length/3);for(var f=c.start,h=0,n=c.length;h<n;h+=3)e[g[f+h]]=1,e[g[f+h+1]]=1,e[g[f+h+2]]=1;m.Mesh.computeBoundingBox(d,
c.bounding,e)}else e=d.subarray(3*c.start,3*(c.start+c.length)),m.Mesh.computeBoundingBox(e,c.bounding)}return!0}};Mesh.prototype.setBoundingBox=function(g,d){BBox.setCenterHalfsize(this._bounding,g,d)};Mesh.prototype.freeData=function(){for(var g in this.vertexBuffers)this.vertexBuffers[g].data=null,delete this[this.vertexBuffers[g].name];for(var d in this.indexBuffers)this.indexBuffers[d].data=null,delete this[this.indexBuffers[d].name]};Mesh.prototype.configure=function(g,d){var a={},b={};d=d||
{};for(var c in g)if(g[c])if("vertexBuffers"==c||"vertex_buffers"==c)for(e in g[c])a[e]=g[c][e];else if("indexBuffers"==c||"index_buffers"==c)for(e in g[c])b[e]=g[c][e];else"indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=g[c]:m.Mesh.common_buffers[c]?a[c]=g[c]:d[c]=g[c];this.addBuffers(a,b,d.stream_type);for(var e in d)this[e]=d[e];d.bounding||this.updateBoundingBox()};Mesh.prototype.totalMemory=function(){var g=0,d;for(d in this.vertexBuffers)g+=this.vertexBuffers[d].data.buffer.byteLength;
for(d in this.indexBuffers)g+=this.indexBuffers[d].data.buffer.byteLength;return g};Mesh.prototype.slice=function(g,d){var a={},b=this.indexBuffers.triangles;if(!b)return console.warn("splice in not indexed not supported yet"),null;b=b.data;var c=[],e=new Int32Array(b.length);e.fill(-1);d=g+d;d>=b.length&&(d=b.length);for(var f=0;g<d;++g){var h=b[g];if(-1!=e[h])c.push(e[h]);else{var n=f++;e[h]=n;c.push(n);for(var l in this.vertexBuffers){var k=this.vertexBuffers[l];n=k.data;k=k.spacing;a[l]||(a[l]=
[]);for(var p=a[l],q=0;q<k;++q)p.push(n[q+h*k])}}}a=new m.Mesh(a,{triangles:c},null,gl);a.updateBoundingBox();return a};Mesh.prototype.simplify=function(){var g=this.getBoundingBox(),d=BBox.getMin(g);g=BBox.getHalfsize(g);g=vec3.scale(vec3.create(),g,2);var a=new m.Mesh,b=vec3.create(),c;for(c in this.vertexBuffers){var e=this.vertexBuffers[c].data,f=new Float32Array(e.length);if("vertices"==c)for(var h=0,n=e.length;h<n;h+=3){var l=e.subarray(h,h+3);vec3.sub(b,l,d);vec3.div(b,b,g);b[0]=Math.round(256*
b[0])/256;b[1]=Math.round(256*b[1])/256;b[2]=Math.round(256*b[2])/256;vec3.mul(b,b,g);vec3.add(b,b,d);f.set(b,h)}a.addBuffer()}};Mesh.load=function(g,d,a,b){d=d||{};d.no_gl&&(b=null);a=a||new m.Mesh(null,null,null,b);a.configure(g,d);return a};Mesh.mergeMeshes=function(g,d){function a(D,G,F,H){for(F=G+F;G<F;G+=3){var M=D.subarray(G,G+3);vec3.transformMat4(M,M,H)}}function b(D,G,F,H){for(F=G+F;G<F;G+=2){var M=D.subarray(G,G+2);vec2.transformMat3(M,M,H)}}function c(D,G,F,H){if(H)for(F=G+F;G<F;++G)D[G]+=
H}d=d||{};for(var e={},f={},h={},n=[],l=0,k=0,p=[],q=[],t={},x=0,z=null,w=0;w<g.length;++w){var r=g[w],v=r.mesh,A=l;n.push(A);var y=v.vertexBuffers.vertices.data.length/3;l+=y;for(var u in v.vertexBuffers)e[u]=e[u]?e[u]+v.vertexBuffers[u].data.length:v.vertexBuffers[u].data.length;for(u in v.indexBuffers)f[u]=f[u]?f[u]+v.indexBuffers[u].data.length:v.indexBuffers[u].data.length;A={name:"mesh_"+w,start:A,length:y,material:""};if(v.bones){r={};for(u=0;u<v.bones.length;++u)y=v.bones[u],t[y[0]]||(t[y[0]]=
q.length,q.push(y)),r[u]=t[y[0]];y=v.vertexBuffers.bone_indices.data;for(u=0;u<y.length;u+=1)y[u]=r[y[u]]}else if(q.length)throw"cannot merge meshes, one contains bones, the other doesnt";p.push(A);if(v.morphs)if(A=Object.values(v.morphs).length,0==x)x=A;else if(x!==A)throw"cannot merge meshes with and without morph targets";}for(u in e)if(w=d[u],null===w)delete e[u];else{if(!w){if(t=v.vertexBuffers[u])t.data&&(t=t.data),t.constructor!==Array&&(w=t.constructor);w||=Float32Array}e[u]=new w(e[u]);h[u]=
0;"vertices"===u&&(k=e[u].length/3)}if(x)for(z=[],w=0;w<x;++w)v=g[0].mesh,t={name:v.morphs[w].name,weight:v.morphs[w].weight,buffers:{vertices:new Float32Array(3*k),normals:new Float32Array(3*k)}},z.push(t);for(u in f)w=65536>l?Uint16Array:Uint32Array,f[u]=new w(f[u]),h[u]=0;for(w=0;w<g.length;++w){r=g[w];v=r.mesh;A=h.vertices;y=0;for(u in v.vertexBuffers)e[u]&&("vertices"==u&&(y=v.vertexBuffers[u].data.length/3),e[u].set(v.vertexBuffers[u].data,h[u]),r[u+"_matrix"]&&(l=r[u+"_matrix"],16==l.length?
a(e[u],h[u],v.vertexBuffers[u].data.length,l):9==l.length&&b(e[u],h[u],v.vertexBuffers[u].data.length,l)),h[u]+=v.vertexBuffers[u].data.length);for(u in v.indexBuffers)f[u].set(v.indexBuffers[u].data,h[u]),c(f[u],h[u],v.indexBuffers[u].data.length,n[w]),h[u]+=v.indexBuffers[u].data.length;if(x)for(u=0;u<v.morphs.length;++u){l=v.morphs[u];for(var B in l.buffers)t=l.buffers[B],z[u].buffers[B].set(t,A)}}g={info:{groups:p}};q.length&&(g.bones=q);return d.only_data?{vertexBuffers:e,indexBuffers:f,info:{groups:p},
morphs:z}:(v=new m.Mesh(e,f,g),v.updateBoundingBox(),z&&(v.morphs=z),v)};Mesh.parsers={};Mesh.encoders={};Mesh.binary_file_formats={};Mesh.compressors={};Mesh.decompressors={};Mesh.fromURL=function(g,d,a,b){b=b||{};a=a||C.gl;var c=g.lastIndexOf("."),e=g.substr(c+1).toLowerCase();b.extension&&(e=b.extension);if(!m.Mesh.parsers[e.toLowerCase()])return console.error("No parser available in litegl to parse mesh of type",e),null;var f=new m.Mesh(void 0,void 0,void 0,a);f.ready=!1;b.binary=Mesh.binary_file_formats[e];
HttpRequest(g,null,function(h){f.parse(h,e,b);delete f.ready;d&&d.call(f,f,g,b)},function(h){d&&d(null)},b);return f};Mesh.prototype.parse=function(g,d,a){a=a||{};a.mesh=this;d=d.toLowerCase();var b=m.Mesh.parsers[d];if(b)return b.call(null,g,a);throw"GL.Mesh.parse: no parser found for format "+d;};Mesh.prototype.encode=function(g,d){g=g.toLowerCase();var a=m.Mesh.encoders[g];if(a)return a.call(null,this,d);throw"GL.Mesh.encode: no encoder found for format "+g;};Mesh.getScreenQuad=function(g){g=g||
C.gl;var d=g.meshes[":screen_quad"];if(d)return d;d=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]);var a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);d=new m.Mesh({vertices:d,coords:a},void 0,void 0,g);return g.meshes[":screen_quad"]=d};m.linearizeArray=Z;m.Mesh.EXTENSION="wbin";m.Mesh.enable_wbin_compression=!0;R.DEFAULT_NORMAL=vec3.fromValues(0,1,0);R.DEFAULT_COORD=vec2.fromValues(.5,.5);R.DEFAULT_COLOR=vec4.fromValues(1,1,1,1);R.prototype.resize=function(g){var d={};this._vertex_data=new Float32Array(3*
g);d.vertices=this._vertex_data;normals&&(d.normals=this._normal_data=new Float32Array(3*g));coords&&(d.coords=this._coord_data=new Float32Array(2*g));colors&&(d.colors=this._color_data=new Float32Array(4*g));this.addBuffers(d);this.current_pos=0;this.max_size=g;this._must_update=!0};R.prototype.clear=function(){this.current_pos=0};R.prototype.addPoint=function(g,d,a,b){if(c>=this.max_size)return console.warn("DynamicMesh: not enough space, reserve more"),!1;var c=this.current_pos++;this._vertex_data.set(g,
3*c);this._normal_data&&this._normal_data.set(d||R.DEFAULT_NORMAL,3*c);this._coord_data&&this._coord_data.set(a||R.DEFAULT_COORD,2*c);this._color_data&&this._color_data.set(b||R.DEFAULT_COLOR,4*c);return this._must_update=!0};R.prototype.update=function(g){if(!this._must_update&&!g)return this.current_pos;this._must_update=!1;this.getBuffer("vertices").upload(gl.STREAM_DRAW);this._normal_data&&this.getBuffer("normal").upload(gl.STREAM_DRAW);this._coord_data&&this.getBuffer("coord").upload(gl.STREAM_DRAW);
this._color_data&&this.getBuffer("color").upload(gl.STREAM_DRAW);return this.current_pos};extendClass(R,Mesh);Mesh.plane=function(g,d){g=g||{};g.triangles=[];var a=g.detailX||g.detail||1,b=g.detailY||g.detail||1,c=g.width||g.size||1,e=g.height||g.size||1,f=g.xz;c*=.5;e*=.5;g=[];var h=[],n=[],l=[],k=vec3.fromValues(0,0,1);f&&k.set([0,1,0]);for(var p=0;p<=b;p++)for(var q=p/b,t=0;t<=a;t++){var x=t/a;f?h.push((2*x-1)*c,0,-(2*q-1)*e):h.push((2*x-1)*c,(2*q-1)*e,0);n.push(x,q);l.push(k[0],k[1],k[2]);t<a&&
p<b&&(x=t+p*(a+1),f?(g.push(x+1,x+a+1,x),g.push(x+1,x+a+2,x+a+1)):(g.push(x,x+1,x+a+1),g.push(x+a+1,x+1,x+a+2)))}a=BBox.fromCenterHalfsize([0,0,0],f?[c,0,e]:[c,e,0]);return m.Mesh.load({vertices:h,normals:l,coords:n,triangles:g},{bounding:a},d)};Mesh.plane2D=function(g,d){var a=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),b=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(g&&g.size){g=.5*g.size;for(var c=0;c<a.length;++c)a[c]*=g}return new m.Mesh({vertices2D:a,coords:b},null,d)};Mesh.point=function(g){return new m.Mesh({vertices:[0,
0,0]})};Mesh.cube=function(g,d){g=g||{};var a=.5*(g.size||1),b={};b.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var c=0,e=b.vertices.length;c<e;++c)b.vertices[c]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,
0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,0],
[a,a,a]);return m.Mesh.load(b,g,d)};Mesh.box=function(g,d){g=g||{};var a=g.sizex||1,b=g.sizey||1,c=g.sizez||1;a*=.5;b*=.5;c*=.5;var e={};e.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var f=0,h=e.vertices.length;f<h;f+=3)e.vertices[f]*=a,e.vertices[f+
1]*=b,e.vertices[f+2]*=c;e.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);e.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(e.wireframe=new Uint16Array([0,
2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,b,c]);return m.Mesh.load(e,g,d)};Mesh.circle=function(g,d){g=g||{};var a=g.size||g.radius||1,b=Math.ceil(g.slices||24),c=g.xz||!1,e=g.empty||!1;3>b&&(b=3);var f=2*Math.PI/b,h=vec3.create(),n=vec3.create(),l=vec3.fromValues(0,0,1),k=vec2.fromValues(.5,.5),p=vec2.create();c&&l.set([0,1,0]);var q=c?2:1,t=new Float32Array(3*(b+1)),x=new Float32Array(3*(b+1)),z=new Float32Array(2*(b+1));t.set(h,0);x.set(l,
0);z.set(k,0);for(h=0;h<b;++h){k=Math.sin(f*h);var w=Math.cos(f*h);n[0]=k*a;n[q]=w*a;p[0]=.5*k+.5;p[1]=.5*w+.5;t.set(n,3*h+3);x.set(l,3*h+3);z.set(p,2*h+2)}if(e)t=t.subarray(3),x=t.subarray(3),z=t.subarray(2),e=null;else{e=new Uint16Array(3*b);f=2;n=1;c&&(f=1,n=2);for(h=0;h<b-1;++h)e[3*h]=0,e[3*h+1]=h+f,e[3*h+2]=h+n;e[3*h]=0;c?(e[3*h+1]=h+1,e[3*h+2]=1):(e[3*h+1]=1,e[3*h+2]=h+1)}g.bounding=BBox.fromCenterHalfsize([0,0,0],c?[a,0,a]:[a,a,0]);a={vertices:t,normals:x,coords:z,triangles:e};if(g.wireframe){c=
new Uint16Array(2*b);for(h=0;h<b;h++)c[2*h]=h,c[2*h+1]=h+1;c[0]=b;a.wireframe=c}return m.Mesh.load(a,g,d)};Mesh.ring=function(g,d){g=g||{};var a=g.size||g.radius||1,b=g.thickness||.1*a,c=Math.ceil(g.slices||24),e=g.xz||!1,f=g.empty||!1;3>c&&(c=3);var h=2*Math.PI/c;vec3.create();var n=vec3.create(),l=vec3.create(),k=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);var p=vec2.create();e&&k.set([0,1,0]);for(var q=e?2:1,t=new Float32Array(3*(2*c+2)),x=new Float32Array(3*(2*c+2)),z=new Float32Array(2*(2*
c+2)),w,r,v=0;v<=c;++v)w=Math.sin(h*v),r=Math.cos(h*v),n[0]=w*(a-b),n[q]=r*(a-b),p[0]=v/c,p[1]=0,t.set(n,6*v),x.set(k,6*v),z.set(p,4*v),l[0]=w*(a+b),l[q]=r*(a+b),p[1]=1,t.set(l,6*v+3),x.set(k,6*v+3),z.set(p,4*v+2);if(f)t=t.subarray(3),x=t.subarray(3),z=t.subarray(2),f=null;else for(f=new Uint16Array(6*c),h=2,n=1,e&&(h=1,n=2),v=0;v<c;++v)f[6*v]=2*v,f[6*v+1]=2*v+h,f[6*v+2]=2*v+n,f[6*v+3]=2*v+n,f[6*v+4]=2*v+h,f[6*v+5]=2*v+3;g.bounding=BBox.fromCenterHalfsize([0,0,0],e?[a+b,0,a+b]:[a+b,a+b,0]);a={vertices:t,
normals:x,coords:z,triangles:f};if(g.wireframe){b=new Uint16Array(4*c);for(v=0;v<c;v++)b[4*v]=2*v,b[4*v+1]=2*v+2,b[4*v+2]=2*v+1,b[4*v+3]=2*v+3;a.wireframe=b}return m.Mesh.load(a,g,d)};Mesh.cylinder=function(g,d){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||64,e=new Float32Array(36*c),f=new Float32Array(36*c),h=new Float32Array(24*c),n=2*Math.PI/c,l,k=0;k<c;++k){var p=k*n;l=[Math.sin(p),0,Math.cos(p)];e.set([l[0]*a,.5*b,l[2]*a],18*k);f.set(l,18*k);h.set([k/c,1],12*
k);l=[Math.sin(p),0,Math.cos(p)];e.set([l[0]*a,-.5*b,l[2]*a],18*k+3);f.set(l,18*k+3);h.set([k/c,0],12*k+2);l=[Math.sin(p+n),0,Math.cos(p+n)];e.set([l[0]*a,-.5*b,l[2]*a],18*k+6);f.set(l,18*k+6);h.set([(k+1)/c,0],12*k+4);l=[Math.sin(p+n),0,Math.cos(p+n)];e.set([l[0]*a,.5*b,l[2]*a],18*k+9);f.set(l,18*k+9);h.set([(k+1)/c,1],12*k+6);l=[Math.sin(p),0,Math.cos(p)];e.set([l[0]*a,.5*b,l[2]*a],18*k+12);f.set(l,18*k+12);h.set([k/c,1],12*k+8);l=[Math.sin(p+n),0,Math.cos(p+n)];e.set([l[0]*a,-.5*b,l[2]*a],18*k+
15);f.set(l,18*k+15);h.set([(k+1)/c,0],12*k+10)}l=18*k;var q=12*k;if(!1===g.caps)e=e.subarray(0,l),f=f.subarray(0,l),h=h.subarray(0,q);else{var t=vec3.fromValues(0,.5*b,0),x=vec3.fromValues(0,-.5*b,0),z=vec3.fromValues(0,1,0),w=vec3.fromValues(0,-1,0);for(k=0;k<c;++k){p=k*n;var r=vec3.fromValues(Math.sin(p),0,Math.cos(p));p=vec3.fromValues(Math.sin(p+n),0,Math.cos(p+n));e.set([r[0]*a,.5*b,r[2]*a],l+18*k);f.set(z,l+18*k);h.set([.5*-r[0]+.5,.5*r[2]+.5],q+12*k);e.set([p[0]*a,.5*b,p[2]*a],l+18*k+3);f.set(z,
l+18*k+3);h.set([.5*-p[0]+.5,.5*p[2]+.5],q+12*k+2);e.set(t,l+18*k+6);f.set(z,l+18*k+6);h.set([.5,.5],q+12*k+4);e.set([p[0]*a,-.5*b,p[2]*a],l+18*k+9);f.set(w,l+18*k+9);h.set([.5*p[0]+.5,.5*p[2]+.5],q+12*k+6);e.set([r[0]*a,-.5*b,r[2]*a],l+18*k+12);f.set(w,l+18*k+12);h.set([.5*r[0]+.5,.5*r[2]+.5],q+12*k+8);e.set(x,l+18*k+15);f.set(w,l+18*k+15);h.set([.5,.5],q+12*k+10)}}c={vertices:e,normals:f,coords:h};g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,.5*b,a]);g.info={groups:[]};!1!==g.caps&&(g.info.groups.push({name:"side",
start:0,length:l/3}),g.info.groups.push({name:"caps",start:l/3,length:(e.length-l)/3}));return Mesh.load(c,g,d)};Mesh.cone=function(g,d){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||64,e=new Float32Array(18*c),f=new Float32Array(18*c),h=new Float32Array(12*c),n=2*Math.PI/c,l,k=a/b,p=0;p<c;++p){var q=p*n;l=[Math.sin(q+.5*n),k,Math.cos(q+.5*n)];vec3.normalize(l,l);e.set([0,b,0],18*p);f.set(l,18*p);h.set([p/c,1],12*p);l=[Math.sin(q),k,Math.cos(q)];e.set([l[0]*a,0,l[2]*
a],18*p+3);vec3.normalize(l,l);f.set(l,18*p+3);h.set([p/c,0],12*p+2);l=[Math.sin(q+n),k,Math.cos(q+n)];e.set([l[0]*a,0,l[2]*a],18*p+6);vec3.normalize(l,l);f.set(l,18*p+6);h.set([(p+1)/c,0],12*p+4)}l=vec3.fromValues(0,0,0);k=vec3.fromValues(0,-1,0);for(p=0;p<c;++p){q=p*n;var t=vec3.fromValues(Math.sin(q),0,Math.cos(q));q=vec3.fromValues(Math.sin(q+n),0,Math.cos(q+n));e.set([q[0]*a,0,q[2]*a],18*p+9);f.set(k,18*p+9);h.set([.5*q[0]+.5,.5*q[2]+.5],12*p+6);e.set([t[0]*a,0,t[2]*a],18*p+12);f.set(k,18*p+
12);h.set([.5*t[0]+.5,.5*t[2]+.5],12*p+8);e.set(l,18*p+15);f.set(k,18*p+15);h.set([.5,.5],12*p+10)}c={vertices:e,normals:f,coords:h};g.bounding=BBox.fromCenterHalfsize([0,.5*b,0],[a,.5*b,a]);return Mesh.load(c,g,d)};Mesh.torus=function(g,d){g=g||{};var a=g.outerradius||g.radius||1,b=Math.ceil(g.outerslices||g.slices||24),c=g.innerradius||.1*a,e=Math.ceil(g.innerslices||b),f=g.angle||2*Math.PI,h=2*Math.PI/e,n=f/b;vec3.create();var l=vec3.create(),k=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);var p=
vec2.create();f=f==2*Math.PI;for(var q=new Float32Array(3*e),t=new Float32Array(3*e),x,z,w=0;w<e;++w)x=Math.sin(h*w),z=Math.cos(h*w),l[0]=x*c,l[1]=z*c,p[0]=.5*x+.5,p[1]=.5*z+.5,q.set(l,3*w),vec3.normalize(k,l),t.set(k,3*w);h=new Float32Array(3*b*e);p=new Float32Array(3*b*e);x=new Float32Array(2*b*e);var r=mat4.create(),v=vec3.fromValues(-a,0,0),A=vec3.fromValues(0,1,0);vec3.create();z=[];for(w=0;w<b;++w){mat4.identity(r);mat4.rotate(r,r,w*n,A);mat4.translate(r,r,v);var y=w*e;var u=e;w>=b-1&&(u=(b-
1)*-e,f||(u=0));for(var B=0;B<e;++B){var D=q.subarray(3*B,3*B+3),G=t.subarray(3*B,3*B+3);mat4.multiplyVec3(l,r,D);mat4.rotateVec3(k,r,G);h.set(l,3*B+3*w*e);p.set(k,3*B+3*w*e);x.set([w/b,B/e],2*B+2*w*e);D=y+B;G=y+(B+1)%e;z.push(G,D,D+u,G,D+u,G+u)}}a=c+a;g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,c]);return m.Mesh.load({vertices:h,normals:p,coords:x,triangles:z},g,d)};Mesh.sphere=function(g,d){g=g||{};for(var a=g.radius||g.size||1,b=g.lat||g.subdivisions||16,c=g["long"]||g.subdivisions||16,e=new Float32Array((b+
1)*(c+1)*3),f=new Float32Array((b+1)*(c+1)*3),h=new Float32Array((b+1)*(c+1)*2),n=new Uint16Array(b*c*6),l=g.hemi?.5*Math.PI:Math.PI,k=0,p=0,q=0;q<=b;q++){var t=q*l/b,x=Math.sin(t),z=Math.cos(t);for(t=0;t<=c;t++){var w=2*t*Math.PI/c,r=Math.cos(w)*x,v=z;w=Math.sin(w)*x;var A=1-t/c,y=1-q/b;e.set([a*r,a*v,a*w],k);f.set([r,v,w],k);h.set([A,y],p);k+=3;p+=2}}for(q=k=0;q<b;q++)for(t=0;t<c;t++)l=q*(c+1)+t,p=l+c+1,n.set([p,l,l+1],k),n.set([p+1,p,l+1],k+3),k+=6;e={vertices:e,normals:f,coords:h,triangles:n};
if(g.wireframe){f=new Uint16Array(c*b*4);for(k=h=0;k<b;k++){for(n=0;n<c;n++)f[h]=k*(c+1)+n,f[h+1]=k*(c+1)+n+1,h+=2;f[h-2*c]=k*(c+1)+n}for(k=0;k<c;k++)for(n=0;n<b;n++)f[h]=n*(c+1)+k,f[h+1]=(n+1)*(c+1)+k,h+=2;e.wireframe=f}g.bounding=g.hemi?BBox.fromCenterHalfsize([0,.5*a,0],[a,.5*a,a],a):BBox.fromCenterHalfsize([0,0,0],[a,a,a],a);return m.Mesh.load(e,g,d)};Mesh.grid=function(g,d){g=g||{};var a=g.lines||11;0>a&&(a=1);var b=g.size||10,c=new Float32Array(12*a),e=.5*b,f=0,h=-e;b/=a-1;for(var n=0;n<a;n++)c[f]=
h,c[f+2]=-e,c[f+3]=h,c[f+5]=e,c[f+6]=e,c[f+8]=h,c[f+9]=-e,c[f+11]=h,h+=b,f+=12;return new m.Mesh({vertices:c},g,d)};Mesh.icosahedron=function(g,d){function a(r,v){var A=l[r]<l[v]?l[r]+":"+l[v]:l[v]+":"+l[r],y=z[A];if(y)return y;y=f.length/3;f.push(.5*(f[3*l[r]]+f[3*l[v]]),.5*(f[3*l[r]+1]+f[3*l[v]+1]),.5*(f[3*l[r]+2]+f[3*l[v]+2]));r=Math.sqrt(f[3*y]*f[3*y]+f[3*y+1]*f[3*y+1]+f[3*y+2]*f[3*y+2]);v=f[3*y]/r;var u=f[3*y+1]/r,B=f[3*y+2]/r;h.push(v,u,B);n.push(Math.atan2(v,B)/Math.PI*.5,Math.acos(u)/Math.PI);
f[3*y]*=b/r;f[3*y+1]*=b/r;f[3*y+2]*=b/r;return z[A]=y}g=g||{};var b=g.radius||g.size||1,c=void 0===g.subdivisions?0:g.subdivisions;6<c&&(c=6);var e=(1+Math.sqrt(5))/2,f=[-1,e,0,1,e,0,-1,-e,0,1,-e,0,0,-1,e,0,1,e,0,-1,-e,0,1,-e,e,0,-1,e,0,1,-e,0,-1,-e,0,1],h=[],n=[],l=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];e=f.length;for(var k=0;k<e;k+=3){var p=Math.sqrt(f[k]*f[k]+f[k+1]*f[k+1]+f[k+2]*f[k+2]),q=f[k]/p,t=f[k+
1]/p,x=f[k+2]/p;h.push(q,t,x);n.push(Math.atan2(q,x),Math.acos(t));f[k]*=b/p;f[k+1]*=b/p;f[k+2]*=b/p}var z={};for(p=0;p<c;++p){q=[];e=l.length;for(k=0;k<e;k+=3){t=a(k,k+1);x=a(k+1,k+2);var w=a(k+2,k);q.push(l[k],t,w);q.push(l[k+1],x,t);q.push(l[k+2],w,x);q.push(t,x,w)}l=q}g.bounding=BBox.fromCenterHalfsize([0,0,0],[b,b,b],b);return new m.Mesh.load({vertices:f,coords:n,normals:h,triangles:l},g,d)};Mesh.shape=function(g,d,a){function b(F,H){var M=F[H+1];F[H+1]=F[H+2];F[H+2]=-M}d=d||{};if("undefined"===
typeof earcut)throw"To use GL.Mesh.shape you must download and include earcut.js (do not link it directly!): https://raw.githubusercontent.com/mapbox/earcut/master/src/earcut.js";if(!g||!g.length||1==g.length%2)throw"GL.Mesh.shape line missing, must be an array of 2D vertices";var c=d.extrude||0;g[0].constructor===Array&&(g=earcut.flatten(g));var e=earcut(g).reverse();console.log(e);for(var f=[],h=[],n=[],l=[g[0],g[1]],k=[g[0],g[1]],p=0;p<g.length;p+=2)l[0]=Math.min(l[0],g[p]),l[1]=Math.max(l[1],
g[p]),k[0]=Math.min(k[0],g[p+1]),k[1]=Math.max(k[1],g[p+1]);var q=l[1]-l[0],t=k[1]-k[0],x=[],z=null;if(c){z=[];var w=vec3.create(),r=g.length;for(p=0;p<g.length;p+=2){var v=g[p],A=g[p+1],y=g[(p+2)%r],u=g[(p+3)%r],B=f.length/3;f.push(v,.5*c,A);f.push(v,-.5*c,A);f.push(y,.5*c,u);f.push(y,-.5*c,u);vec3.normalize(w,vec3.cross(w,[0,1,0],[y-v,0,u-A]));h.push(w[0],w[1],w[2],w[0],w[1],w[2],w[0],w[1],w[2],w[0],w[1],w[2]);var D=(v-l[0])/q,G=(A-k[0])/t;v=(y-l[0])/q;A=(u-k[0])/t;n.push(D,G,D,G,v,A,v,A);z.push(B,
B+2,B+1,B+2,B+3,B+1)}x.push({name:"side",start:0,length:z.length});w=f.length/3;r=z.length;for(p=0;p<g.length;p+=2)v=g[p],A=g[p+1],D=(v-l[0])/q,G=(A-k[0])/t,f.push(v,.5*c,A),f.push(v,-.5*c,A),h.push(0,1,0,0,-1,0),n.push(D,G,D,G);for(p=0;p<e.length;p+=3)z.push(w+2*e[p],w+2*e[p+1],w+2*e[p+2]),z.push(w+2*e[p]+1,w+2*e[p+2]+1,w+2*e[p+1]+1);x.push({name:"caps",start:r,length:z.length});d.bounding=BBox.fromCenterHalfsize([.5*(l[0]+l[1]),0,.5*(k[0]+k[1])],[.5*q,.5*c,.5*t],vec2.len([.5*q,.5*c,.5*t]))}else{for(p=
0;p<g.length;p+=2)f.push(g[p],0,g[p+1]),h.push(0,1,0),n.push((g[p]-l[0])/q,(g[p+1]-k[0])/t);z=e;x.push({name:"side",start:0,length:z.length});d.bounding=BBox.fromCenterHalfsize([.5*(l[0]+l[1]),0,.5*(k[0]+k[1])],[.5*q,0,.5*t],vec2.len([.5*q,0,.5*t]))}if(d.xy){for(p=0;p<f.length;p+=3)b(f,p),b(h,p);d.bounding=c?BBox.fromCenterHalfsize([.5*(l[0]+l[1]),.5*(k[0]+k[1]),0],[.5*q,.5*t,.5*c],vec2.len([.5*q,.5*t,.5*c])):BBox.fromCenterHalfsize([.5*(l[0]+l[1]),.5*(k[0]+k[1]),0],[.5*q,.5*t,0],vec2.len([.5*q,.5*
t,0]))}d.info={groups:x};return new m.Mesh.load({vertices:f,coords:n,normals:h,triangles:z},d,a)};C.Texture=m.Texture=function e(d,a,b,c){function f(k){return k.constructor!==Array?k:h==m.FLOAT?new Float32Array(k):h==m.HALF_FLOAT_OES?new Uint16Array(k):new Uint8Array(k)}b=b||{};this.gl=c=c||C.gl;this._context_id=c.context_id;d=parseInt(d);a=parseInt(a);m.debug&&console.log("GL.Texture created: ",d,a);this.handler=c.createTexture();this.width=d;this.height=a;b.depth&&(this.depth=b.depth);this.texture_type=
b.texture_type||c.TEXTURE_2D;this.format=b.format||e.DEFAULT_FORMAT;this.internalFormat=b.internalFormat;this.type=b.type||e.DEFAULT_TYPE;this.magFilter=b.magFilter||b.filter||e.DEFAULT_MAG_FILTER;this.minFilter=b.minFilter||b.filter||e.DEFAULT_MIN_FILTER;this.wrapS=b.wrap||b.wrapS||e.DEFAULT_WRAP_S;this.wrapT=b.wrap||b.wrapT||e.DEFAULT_WRAP_T;this.data=null;e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==c.DEPTH_COMPONENT&&
1==c.webgl_version&&!c.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==c.FLOAT&&!c.extensions.OES_texture_float&&1==c.webgl_version)throw"Float Texture not supported";if(this.type==c.HALF_FLOAT_OES){if(!c.extensions.OES_texture_half_float&&1==c.webgl_version)throw"Half Float Texture extension not supported.";1<c.webgl_version&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),this.type=this.format==c.RGB?c.RGB16F:c.RGBA16F)}if(!(isPowerOfTwo(this.width)&&
isPowerOfTwo(this.height)||(this.minFilter==c.NEAREST||this.minFilter==c.LINEAR)&&this.wrapS==c.CLAMP_TO_EDGE&&this.wrapT==c.CLAMP_TO_EDGE))if(b.ignore_pot)this.minFilter=this.magFilter=c.LINEAR,this.wrapS=this.wrapT=c.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(d&&a){this.internalFormat||this.computeInternalFormat();c.activeTexture(c.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1);c.bindTexture(this.texture_type,this.handler);c.texParameteri(this.texture_type,
c.TEXTURE_MAG_FILTER,this.magFilter);c.texParameteri(this.texture_type,c.TEXTURE_MIN_FILTER,this.minFilter);c.texParameteri(this.texture_type,c.TEXTURE_WRAP_S,this.wrapS);c.texParameteri(this.texture_type,c.TEXTURE_WRAP_T,this.wrapT);b.anisotropic&&c.extensions.EXT_texture_filter_anisotropic&&c.texParameterf(m.TEXTURE_2D,c.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,b.anisotropic);var h=this.type,n=b.pixel_data;if(n&&!n.buffer){if(this.texture_type==m.TEXTURE_CUBE_MAP)if(n[0].constructor===
Number)n=f(n),n=[n,n,n,n,n,n];else for(var l=0;l<n.length;++l)n[l]=f(n[l]);else n=f(n);this.data=n}e.setUploadOptions(b);if(this.texture_type==m.TEXTURE_2D)c.texImage2D(m.TEXTURE_2D,0,this.internalFormat,d,a,0,this.format,this.type,n||null),m.isPowerOfTwo(d)&&m.isPowerOfTwo(a)&&b.minFilter&&b.minFilter!=c.NEAREST&&b.minFilter!=c.LINEAR&&(c.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==m.TEXTURE_CUBE_MAP)for(d=d*d*(this.format==m.RGBA?4:3),l=0;6>l;++l)(a=n)&&(a.constructor===
Array?a=a[l]:a.subarray(d*l,d*(l+1))),c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this.internalFormat,this.width,this.height,0,this.format,this.type,a||null);else if(this.texture_type==m.TEXTURE_3D){if(1==this.gl.webgl_version)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by passing webgl2:true to the context";if(!b.depth)throw"3d texture depth must be set in the options.depth";c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1);
c.texImage3D(m.TEXTURE_3D,0,this.internalFormat,d,a,b.depth,0,this.format,this.type,n||null)}c.bindTexture(this.texture_type,null);c.activeTexture(c.TEXTURE0)}};Texture.DEFAULT_TYPE=m.UNSIGNED_BYTE;Texture.DEFAULT_FORMAT=m.RGBA;Texture.DEFAULT_MAG_FILTER=m.LINEAR;Texture.DEFAULT_MIN_FILTER=m.LINEAR;Texture.DEFAULT_WRAP_S=m.CLAMP_TO_EDGE;Texture.DEFAULT_WRAP_T=m.CLAMP_TO_EDGE;Texture.EXTENSION="png";Texture.framebuffer=null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);
Texture.use_renderbuffer_pool=!0;Texture.CROSS_ORIGIN_CREDENTIALS="Anonymous";Texture.prototype.computeInternalFormat=function(){this.internalFormat=this.format;1==gl.webgl_version?this.type==m.HALF_FLOAT&&(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=m.HALF_FLOAT_OES):this.type==m.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),this.type=m.HALF_FLOAT);if(this.format==m.DEPTH_COMPONENT||this.format===m.DEPTH_STENCIL)if(this.minFilter=
m.NEAREST,2==gl.webgl_version)if(this.type===m.UNSIGNED_INT_24_8&&this.format===m.DEPTH_STENCIL)this.internalFormat=m.DEPTH24_STENCIL8;else if(this.type===m.FLOAT&&this.format===m.DEPTH_STENCIL)this.internalFormat=gl.FLOAT_32_UNSIGNED_INT_24_8_REV;else if(this.type==m.UNSIGNED_SHORT)this.internalFormat=m.DEPTH_COMPONENT16;else if(this.type==m.UNSIGNED_INT)this.internalFormat=m.DEPTH_COMPONENT24;else if(this.type==m.FLOAT)this.internalFormat=m.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";
else{if(1==gl.webgl_version){if(this.type==m.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=m.DEPTH_COMPONENT}}else if(this.format==gl.RGBA)2==gl.webgl_version&&(this.type==m.FLOAT?this.internalFormat=m.RGBA32F:this.type==m.HALF_FLOAT&&(this.internalFormat=m.RGBA16F));else if(this.format==gl.RGB&&2==gl.webgl_version)if(this.type==m.FLOAT)this.internalFormat=m.RGB32F;else if(this.type==m.HALF_FLOAT)throw"GL.RGB HALF_FLOAT is not supported, use RGBA instead";};Texture.prototype.delete=
function(){gl.deleteTexture(this.handler);this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.hasSameProperties=function(d){return d?d.width==this.width&&d.height==this.height&&d.type==this.type&&d.format==this.format&&d.texture_type==this.texture_type:!1};Texture.prototype.hasSameSize=
function(d){return d?d.width==this.width&&d.height==this.height:!1};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(d){void 0==d&&(d=0);var a=this.gl;a.activeTexture(a.TEXTURE0+d);a.bindTexture(this.texture_type,this.handler);return d};Texture.prototype.unbind=function(d){void 0===d&&(d=0);var a=this.gl;a.activeTexture(a.TEXTURE0+d);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=
function(d,a){this.bind(0);this.gl.texParameteri(this.texture_type,d,a);switch(d){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=a;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=a;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=a;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=a}};Texture.setUploadOptions=function(d,a){a=a||C.gl;Texture.disable_deprecated||(d?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!d.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!d.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,
!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0)));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.flipYData=function(d,a,b,c){var e=new d.constructor(a*c),f=0,h=a*(b-1)*c;b=Math.floor(.5*b);for(var n=0;n<b;++n){var l=d.subarray(f,f+a*c),k=d.subarray(h,h+a*c);e.set(l);l.set(k);k.set(e);f+=a*c;h-=a*c;if(f>h)break}};Texture.prototype.uploadImage=function(d,a){this.bind();var b=this.gl;if(!d)throw"uploadImage parameter must be Image";Texture.setUploadOptions(a,b);try{if(a&&a.subimage)1==b.webgl_version?b.texSubImage2D(b.TEXTURE_2D,
0,0,0,this.format,this.type,d):b.texSubImage2D(b.TEXTURE_2D,0,0,0,d.videoWidth||d.width,d.videoHeight||d.height,this.format,this.type,d);else{var c=d.videoWidth||d.width,e=d.videoHeight||d.height;c==this.width&&e==this.height||1==this.width||1==this.height||console.warn("image uploaded has a different size than texture, resizing it.");b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,d);this.width=c;this.height=e}this.data=d}catch(f){console.error(f);if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';
throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(d,a,b){a=a||{};if(!d)throw"no data passed";var c=this.gl;this.bind();Texture.setUploadOptions(a,c);var e=a.mipmap_level||0,f=this.width,h=this.height;f>>=e;h>>=
e;var n=this.internalFormat||this.format;this.type==m.HALF_FLOAT_OES&&d.constructor===Float32Array&&console.warn("cannot uploadData to a HALF_FLOAT texture from a Float32Array, must be Uint16Array. To upload it we recomment to create a FLOAT texture, upload data there and copy to your HALF_FLOAT.");if(this.texture_type==m.TEXTURE_2D)1==c.webgl_version?d.buffer&&d.buffer.constructor==ArrayBuffer?c.texImage2D(this.texture_type,e,n,f,h,0,this.format,this.type,d):c.texImage2D(this.texture_type,e,n,this.format,
this.type,d):2==c.webgl_version&&c.texImage2D(this.texture_type,e,n,f,h,0,this.format,this.type,d);else if(this.texture_type==m.TEXTURE_3D)c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),c.texImage3D(this.texture_type,e,n,f,h,this.depth>>e,0,this.format,this.type,d);else if(this.texture_type==m.TEXTURE_CUBE_MAP)c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+(a.cubemap_face||0),e,n,f,h,0,this.format,this.type,d);else throw"cannot uploadData for this texture type";
this.data=d;!b&&this.minFilter&&this.minFilter!=c.NEAREST&&this.minFilter!=c.LINEAR&&(c.generateMipmap(this.texture_type),this.has_mipmaps=!0);c.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,
0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}];Texture.prototype.drawTo=function(d,a){function b(){6E4<=m.getTime()-this.time?(c.deleteRenderbuffer(c._renderbuffers_pool[k]),delete c._renderbuffers_pool[k]):setTimeout(b.bind(this),6E4)}var c=this.gl,
e=c.getViewport(),f=m.getTime(),h=c.getParameter(c.FRAMEBUFFER_BINDING),n=c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,n);var l=null;if(Texture.use_renderbuffer_pool){c._renderbuffers_pool||(c._renderbuffers_pool={});var k=this.width+":"+this.height;c._renderbuffers_pool[k]?(l=c._renderbuffers_pool[k],l.time=f,c.bindRenderbuffer(c.RENDERBUFFER,l)):(c._renderbuffers_pool[k]=l=c.createRenderbuffer(),l.time=f,l.width=this.width,l.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,
l),setTimeout(b.bind(l),6E4))}else l=c._renderbuffer=c._renderbuffer||c.createRenderbuffer(),l.width=this.width,l.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,l);this.format===c.DEPTH_COMPONENT?c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,this.width,this.height):c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,this.width,this.height);c.viewport(0,0,this.width,this.height);c._current_texture_drawto=this;c._current_fbo_color=n;c._current_fbo_depth=l;if(this.texture_type==c.TEXTURE_2D)this.format!==
c.DEPTH_COMPONENT?(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,l)):(c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,l),c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_2D,this.handler,0)),d(this,a);else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(this.format!==c.DEPTH_COMPONENT?c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,
l):c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,l),f=0;6>f;f++)this.format!==c.DEPTH_COMPONENT?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0):c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0),d(this,f,a);this.data=null;c._current_texture_drawto=null;c._current_fbo_color=null;c._current_fbo_depth=null;c.bindFramebuffer(c.FRAMEBUFFER,h);c.bindRenderbuffer(c.RENDERBUFFER,
null);c.viewport(e[0],e[1],e[2],e[3]);return this};Texture.prototype.copyTo=function(d,a,b){var c=this.gl;if(!d)throw"target_texture required";var e=c.getParameter(c.FRAMEBUFFER_BINDING),f=c.getViewport();a||=this.texture_type==c.TEXTURE_2D?m.Shader.getScreenShader():m.Shader.getCubemapCopyShader();c.disable(c.BLEND);c.disable(c.DEPTH_TEST);a&&b&&a.uniforms(b);b=c.__copy_fbo;b||(b=c.__copy_fbo=c.createFramebuffer());c.bindFramebuffer(c.FRAMEBUFFER,b);c.viewport(0,0,d.width,d.height);if(this.texture_type==
c.TEXTURE_2D)if(this.format!==c.DEPTH_COMPONENT&&this.format!==c.DEPTH_STENCIL)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,d.handler,0),this.toViewport(a);else{a=c._color_renderbuffer=c._color_renderbuffer||c.createRenderbuffer();b=a.width=d.width;var h=a.height=d.height;c.bindRenderbuffer(c.RENDERBUFFER,a);c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,b,h);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,a);b=d.format==c.DEPTH_STENCIL?c.DEPTH_STENCIL_ATTACHMENT:
c.DEPTH_ATTACHMENT;c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,d.handler,0);a=c.checkFramebufferStatus(c.FRAMEBUFFER);if(a!==c.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+a;c.enable(c.DEPTH_TEST);c.depthFunc(c.ALWAYS);c.colorMask(!1,!1,!1,!1);a=m.Shader.getCopyDepthShader();this.toViewport(a);c.colorMask(!0,!0,!0,!0);c.disable(c.DEPTH_TEST);c.depthFunc(c.LEQUAL);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,null);c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,
null,0)}else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(a.uniforms({u_texture:0}),b=m.temp_mat3,h=0;6>h;h++){c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+h,d.handler,0);var n=m.Texture.cubemap_camera_parameters[h];mat3.identity(b);b.set(n.right,0);b.set(n.up,3);b.set(n.dir,6);this.toViewport(a,{u_rotation:b})}c.setViewport(f);c.bindFramebuffer(c.FRAMEBUFFER,e);d.minFilter&&d.minFilter!=c.NEAREST&&d.minFilter!=c.LINEAR&&(d.bind(),c.generateMipmap(d.texture_type),
d.has_mipmaps=!0);d.data=null;c.bindTexture(d.texture_type,null);return this};Texture.prototype.blit=function(){var d=new Float32Array(4);return function(a,b,c){var e=this.gl;if(this.texture_type!=e.TEXTURE_2D||this.format===e.DEPTH_COMPONENT||this.format===e.DEPTH_STENCIL)throw"blit only support TEXTURE_2D of RGB or RGBA. use copyTo instead";var f=e.getParameter(e.FRAMEBUFFER_BINDING);d.set(e.viewport_data);(b=b||m.Shader.getScreenShader())&&c&&b.uniforms(c);c=e.__copy_fbo;c||(c=e.__copy_fbo=e.createFramebuffer());
e.bindFramebuffer(e.FRAMEBUFFER,c);e.viewport(0,0,a.width,a.height);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a.handler,0);this.bind(0);b.draw(m.Mesh.getScreenQuad(),e.TRIANGLES);e.setViewport(d);e.bindFramebuffer(e.FRAMEBUFFER,f);a.data=null;e.bindTexture(a.texture_type,null);return this}}();Texture.prototype.toViewport=function(d,a){d=d||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);a&&d.uniforms(a);d.draw(b,gl.TRIANGLES)};Texture.prototype.fill=function(d,
a){if(d.constructor===m.Shader)this.drawTo(function(){d.toViewport()});else{var b=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(d[0],d[1],d[2],d[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(b[0],b[1],b[2],b[3])}!a&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),this.has_mipmaps=!0)};Texture.prototype.renderQuad=function(){var d=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,
1,1,1);return function(e,f,h,n,l,k){a[0]=e;a[1]=f;b[0]=h;b[1]=n;l=l||Shader.getQuadShader(this.gl);e=Mesh.getScreenQuad(this.gl);this.bind(0);l.uniforms({u_texture:0,u_position:a,u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:d});k&&l.uniforms(k);l.draw(e,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(d,a,b,c,e){var f=this.gl;void 0===d&&(d=1);void 0===a&&(a=1);f.disable(f.DEPTH_TEST);f.disable(f.BLEND);c=c||this;var h=!e;if(e===c)throw"cannot use applyBlur in a texture using as temporary itself";
if(c&&this.texture_type!==c.texture_type)throw"cannot use applyBlur with textures of different texture_type";var n=f.getParameter(f.FRAMEBUFFER_BINDING),l=f.getViewport(),k=f.__copy_fbo;k||(k=f.__copy_fbo=f.createFramebuffer());f.bindFramebuffer(f.FRAMEBUFFER,k);f.viewport(0,0,this.width,this.height);if(this.texture_type===f.TEXTURE_2D)k=m.Shader.getBlurShader(),e||=m.Texture.getTemporary(this.width,this.height,this),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,e.handler,
0),this.toViewport(k,{u_texture:0,u_intensity:b,u_offset:[0,a/this.height]}),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,c.handler,0),f.viewport(0,0,c.width,c.height),e.toViewport(k,{u_intensity:b,u_offset:[d/e.width,0]}),h&&m.Texture.releaseTemporary(e);else if(this.texture_type===f.TEXTURE_CUBE_MAP){k=m.Shader.getCubemapBlurShader();k.uniforms({u_texture:0,u_intensity:b,u_offset:[d/this.width,a/this.height]});this.bind(0);d=Mesh.getScreenQuad();d.bindBuffers(k);k.bind();
a=e||c!=this?c:e=m.Texture.getTemporary(c.width,c.height,c);b=m.temp_mat3;for(var p=0;6>p;++p){f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+p,a.handler,0);var q=m.Texture.cubemap_camera_parameters[p];mat3.identity(b);b.set(q.right,0);b.set(q.up,3);b.set(q.dir,6);k._setUniform("u_rotation",b);f.drawArrays(f.TRIANGLES,0,6)}d.unbindBuffers(k);e&&e.copyTo(c);e&&h&&m.Texture.releaseTemporary(e)}f.setViewport(l);f.bindFramebuffer(f.FRAMEBUFFER,n);c.data=null;c.minFilter&&
c.minFilter!=f.NEAREST&&c.minFilter!=f.LINEAR&&(c.bind(),f.generateMipmap(c.texture_type),c.has_mipmaps=!0);f.bindTexture(c.texture_type,null)};Texture.fromURL=function(d,a,b,c){c=c||C.gl;a=a||{};a=Object.create(a);var e=a.texture||new m.Texture(1,1,a,c);64>d.length&&(e.url=d);e.bind();var f=a.temp_color||Texture.loading_color;c.pixelStorei(c.UNPACK_ALIGNMENT,4);f=a.type==c.FLOAT?new Float32Array(f):new Uint8Array(f);c.texImage2D(c.TEXTURE_2D,0,e.format,e.width,e.height,0,e.format,e.type,f);c.bindTexture(e.texture_type,
null);e.ready=!1;f=null;a.extension&&(f=a.extension);if(!f&&512>d.length){var h=d,n=d.indexOf("?");-1!=n&&(h=d.substr(0,n));n=h.lastIndexOf(".");-1!=n&&(f=h.substr(n+1).toLowerCase())}"dds"==f?(f=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),h=new m.Texture(0,0,a,c),aa.loadDDSTextureEx(c,f,d,h.handler,!0,function(l){e.texture_type=l.texture_type;e.handler=l;delete e.ready;b&&b(e,d)})):"tga"==f?HttpRequest(d,null,function(l){if(l=m.Texture.parseTGA(l))a.texture=
e,l.flipY&&(a.no_flip=!0),"RGB"==l.format&&(e.format=c.RGB),e=m.Texture.fromMemory(l.width,l.height,l.pixels,a),delete e.ready,b&&b(e,d)},null,{binary:!0}):(f=new Image,f.src=d,f.crossOrigin=Texture.CROSS_ORIGIN_CREDENTIALS,f.onload=function(){a.texture=e;m.Texture.fromImage(this,a);delete e.ready;b&&b(e,d)},f.onerror=function(){b&&b(null)});return e};Texture.parseTGA=function(d){if(!d||d.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";d=new Uint8Array(d);for(var a=new Uint8Array([0,
0,2,0,0,0,0,0,0,0,0,0]),b=d.subarray(0,12),c=0;c<b.length;c++)if(a[c]!=b[c])return console.error("TGA header is not valid"),null;c=d.subarray(12,18);a={};a.width=256*c[1]+c[0];a.height=256*c[3]+c[2];a.bpp=c[4];a.bytesPerPixel=a.bpp/8;a.imageSize=a.width*a.height*a.bytesPerPixel;a.pixels=d.subarray(18,18+a.imageSize);a.pixels=new Uint8Array(a.pixels);a.flipY=0==(c[5]&32);for(c=0;c<a.imageSize;c+=a.bytesPerPixel)d=a.pixels[c],a.pixels[c]=a.pixels[c+2],a.pixels[c+2]=d;a.format=32==a.bpp?"RGBA":"RGB";
return a};Texture.fromImage=function(d,a){a=a||{};var b=a.texture||new m.Texture(d.width,d.height,a);b.uploadImage(d,a);b.bind();gl.texParameteri(b.texture_type,gl.TEXTURE_MAG_FILTER,b.magFilter||Texture.DEFAULT_MAG_FILTER);gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,b.minFilter||Texture.DEFAULT_MIN_FILTER);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,b.wrapS||Texture.DEFAULT_WRAP_S);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,b.wrapT||Texture.DEFAULT_WRAP_T);m.isPowerOfTwo(b.width)&&
m.isPowerOfTwo(b.height)||1<gl.webgl_version?a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0):(gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,m.LINEAR),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE),b.has_mipmaps=!1);gl.bindTexture(b.texture_type,null);b.data=d;a.keep_image&&(b.img=d);return b};Texture.fromVideo=function(d,a){a=a||
{};var b=a.texture||new m.Texture(d.videoWidth,d.videoHeight,a);b.bind();b.uploadImage(d,a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0,b.data=d);gl.bindTexture(b.texture_type,null);return b};Texture.fromTexture=function(d,a){a=a||{};a=new m.Texture(d.width,d.height,a);d.copyTo(a);return a};Texture.prototype.clone=function(d){var a=this.getProperties();if(d)for(var b in d)a[b]=d[b];return Texture.fromTexture(this,a)};Texture.fromMemory=
function(d,a,b,c){c=c||{};var e=c.texture||new m.Texture(d,a,c);Texture.setUploadOptions(c);e.bind();b.constructor===Array&&(b=c.type==gl.FLOAT?new Float32Array(b):c.type==m.HALF_FLOAT||c.type==m.HALF_FLOAT_OES?new Uint16Array(b):new Uint8Array(b));gl.texImage2D(gl.TEXTURE_2D,0,e.format,d,a,0,e.format,e.type,b);e.width=d;e.height=a;e.data=b;c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),e.has_mipmaps=!0);gl.bindTexture(e.texture_type,null);return e};
Texture.fromDDSInMemory=function(d,a){a=a||{};var b=a.texture||new m.Texture(0,0,a);m.Texture.setUploadOptions(a);b.bind();a=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");aa.loadDDSTextureFromMemoryEx(gl,a,d,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=function(d,a,b,c){c=c||{};d=new m.Texture(d,a,c);d.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var e=Mesh.getScreenQuad();
b.draw(e)});return d};Texture.cubemapFromImages=function(d,a){a=a||{};if(6!=d.length)throw"missing images to create cubemap";var b=d[0].width,c=d[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;if(a.texture){var e=a.texture;e.width=b;e.height=c}else e=new m.Texture(b,c,a);Texture.setUploadOptions(a);e.bind();try{for(b=0;6>b;b++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+b,0,e.format,e.format,e.type,d[b]);e.data=d}catch(f){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';
throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),e.has_mipmaps=!0);e.unbind();return e};Texture.cubemapFromImage=function(d,a){a=a||{};if(d.width!=d.height/6&&0!=d.height%6&&!a.faces&&!a.is_polar)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",d.width,
d.height),null;var b=d.width,c=d.height;if(a.is_polar){var e=a.size||m.nearestPowerOfTwo(d.height),f=m.Texture.fromImage(d,{ignore_pot:!0,wrap:gl.REPEAT,filter:gl.LINEAR});b=new m.Texture(e,e,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGBA});if(a.texture){c=a.texture;for(var h in b)c[h]=b[h];b=c}var n=mat3.create(),l={u_texture:0,u_rotation:n};gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var k=m.Shader.getPolarToCubemapShader();b.drawTo(function(x,z){x=m.Texture.cubemap_camera_parameters[z];mat3.identity(n);
n.set(x.right,0);n.set(x.up,3);n.set(x.dir,6);f.toViewport(k,l)});a.keep_image&&(b.img=d);return b}void 0!==a.is_cross?(a.faces=Texture.generateCubemapCrossFacesInfo(d.width,a.is_cross),b=c=d.width/4):a.faces?(b=a.width||a.faces[0].width,c=a.height||a.faces[0].height):c/=6;if(b!=c)return console.log("Texture not valid, width and height for every face must be square"),null;e=b;a.no_flip=!0;var p=[];for(h=0;6>h;h++){var q=createCanvas(e,e),t=q.getContext("2d");a.faces?t.drawImage(d,a.faces[h].x,a.faces[h].y,
a.faces[h].width||e,a.faces[h].height||e,0,0,e,e):t.drawImage(d,0,c*h,b,c,0,0,e,e);p.push(q)}h=Texture.cubemapFromImages(p,a);a.keep_image&&(h.img=d);return h};Texture.generateCubemapCrossFacesInfo=function(d,a){void 0===a&&(a=1);d/=4;return[{x:2*d,y:d,width:d,height:d},{x:0,y:d,width:d,height:d},{x:a*d,y:0,width:d,height:d},{x:a*d,y:2*d,width:d,height:d},{x:d,y:d,width:d,height:d},{x:3*d,y:d,width:d,height:d}]};Texture.cubemapFromURL=function(d,a,b){a=a||{};a=Object.create(a);a.texture_type=gl.TEXTURE_CUBE_MAP;
var c=a.texture||new m.Texture(1,1,a);c.bind();Texture.setUploadOptions(a);var e=a.temp_color||[0,0,0,255];e=a.type==gl.FLOAT?new Float32Array(e):new Uint8Array(e);for(var f=0;6>f;f++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,c.format,1,1,0,c.format,c.type,e);gl.bindTexture(c.texture_type,null);c.ready=!1;e=new Image;e.src=d;e.onload=function(){a.texture=c;(c=m.Texture.cubemapFromImage(this,a))&&delete c.ready;b&&b(c)};return c};Texture.prototype.getPixels=function(d,a){a=a||0;var b=this.gl,
c=b.getViewport(),e=b.getParameter(b.FRAMEBUFFER_BINDING);if(this.format==b.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";b.disable(b.DEPTH_TEST);var f=b.__copy_fbo;f||(f=b.__copy_fbo=b.createFramebuffer());b.bindFramebuffer(b.FRAMEBUFFER,f);f=this.width>>a;var h=this.height>>a;b.viewport(0,0,f,h);this.texture_type==b.TEXTURE_2D?b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.handler,a):this.texture_type==b.TEXTURE_CUBE_MAP&&b.framebufferTexture2D(b.FRAMEBUFFER,
b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+(d||0),this.handler,a);a=this.type;d=a==b.UNSIGNED_BYTE?new Uint8Array(f*h*4):a==m.HALF_FLOAT||a==m.HALF_FLOAT_OES?new Uint16Array(f*h*4):new Float32Array(f*h*4);b.readPixels(0,0,f,h,b.RGBA,a,d);b.bindFramebuffer(b.FRAMEBUFFER,e);b.viewport(c[0],c[1],c[2],c[3]);return d};Texture.prototype.setPixels=function(d,a,b,c){a={no_flip:a};c&&(a.cubemap_face=c);this.uploadData(d,a,b)};Texture.prototype.getCubemapPixels=function(){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap";
return[this.getPixels(0),this.getPixels(1),this.getPixels(2),this.getPixels(3),this.getPixels(4),this.getPixels(5)]};Texture.prototype.setCubemapPixels=function(d,a){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap, it should be created with { texture_type: gl.TEXTURE_CUBE_MAP }";for(var b=0;6>b;++b)this.setPixels(d[b],a,5!=b,b)};Texture.prototype.toCanvas=function(d,a,b){b=b||8192;var c=this.gl,e=Math.min(this.width,b),f=Math.min(this.height,b);this.texture_type==c.TEXTURE_CUBE_MAP&&
(e*=4,f*=3);d=d||createCanvas(e,f);d.width!=e&&(d.width=e);d.height!=f&&(d.height=f);if(this.texture_type==c.TEXTURE_2D){this.width!=e||this.height!=f||this.type!=c.UNSIGNED_BYTE?(c=new m.Texture(e,f,{format:c.RGBA,filter:c.NEAREST}),this.copyTo(c),c=c.getPixels()):c=this.getPixels();b=d.getContext("2d");var h=b.getImageData(0,0,e,f);h.data.set(c);b.putImageData(h,0,0);a&&(c=createCanvas(e,f),a=c.getContext("2d"),a.translate(0,c.height),a.scale(1,-1),a.drawImage(d,0,0,c.width,c.height),b.clearRect(0,
0,b.canvas.width,b.canvas.height),b.drawImage(c,0,0))}else if(this.texture_type==c.TEXTURE_CUBE_MAP){e=createCanvas(this.width,this.height);a=e.getContext("2d");f=m.Texture.generateCubemapCrossFacesInfo(d.width,1);b=d.getContext("2d");b.fillStyle="black";b.fillRect(0,0,d.width,d.height);var n=this;this.type!=c.UNSIGNED_BYTE&&(n=new m.Texture(this.width,this.height,{format:c.RGBA,texture_type:c.TEXTURE_CUBE_MAP,filter:c.NEAREST,type:c.UNSIGNED_BYTE}),this.copyTo(n));for(var l=0;6>l;l++)h=a.getImageData(0,
0,e.width,e.height),c=n.getPixels(l),h.data.set(c),a.putImageData(h,0,0),b.drawImage(e,f[l].x,f[l].y,e.width,e.height)}return d};Texture.binary_extension="png";Texture.prototype.toBinary=function(d,a){d=this.toCanvas(null,d).toDataURL(a);a=d.indexOf(",");d=d.substr(a+1);d=atob(d);a=d.length;for(var b=new Uint8Array(a),c=0;c<a;++c)b[c]=d.charCodeAt(c);return b};Texture.prototype.toBlob=function(d,a){d=this.toBinary(d);return new Blob([d],{type:a||"image/png"})};Texture.prototype.toBlobAsync=function(d,
a,b){var c=this.toCanvas(null,d);c.toBlob?c.toBlob(b,a):(d=this.toBlob(d,a),b&&b(d))};Texture.prototype.toBase64=function(d){var a=this.width,b=this.height,c=this.getPixels(),e=createCanvas(a,b),f=e.getContext("2d"),h=f.getImageData(0,0,a,b);h.data.set(c);f.putImageData(h,0,0);d&&(d=createCanvas(a,b),a=d.getContext("2d"),a.translate(0,b),a.scale(1,-1),a.drawImage(e,0,0),e=d);return e.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var d={};d.width=this.width;d.height=this.height;
this.metadata=d};Texture.compareFormats=function(d,a){return d&&a?d==a?!0:d.width!=a.width||d.height!=a.height||d.type!=a.type||d.format!=a.format||d.texture_type!=a.texture_type?!1:!0:!1};Texture.blend=function(d,a,b,c){if(!d||!a)return!1;if(d==a)return c?d.copyTo(c):d.toViewport(),!0;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var e=m.Shader.getBlendShader(),f=m.Mesh.getScreenQuad();a.bind(1);e.uniforms({u_texture:0,u_texture2:1,u_factor:b});if(c)return c.drawTo(function(){if(d==
c||a==c)throw"Blend output cannot be the same as the input";d.bind(0);e.draw(f,gl.TRIANGLES)}),!0;d.bind(0);e.draw(f,gl.TRIANGLES);return!0};Texture.cubemapToTexture2D=function(d,a,b,c,e){if(!d||d.texture_type!=gl.TEXTURE_CUBE_MAP)throw"No cubemap in convert";a=a||d.width;c=c?d.type:gl.UNSIGNED_BYTE;e=e||0;b||=new m.Texture(2*a,a,{minFilter:gl.NEAREST,type:c});var f=gl.shaders.cubemap_to_texture2D;f||=gl.shaders.cubemap_to_texture2D=new m.Shader(m.Shader.SCREEN_VERTEX_SHADER,"\t\tprecision mediump float;\n\t\t#define PI 3.14159265358979323846264\n\t\tuniform samplerCube texture;\t\tvarying vec2 v_coord;\t\tuniform float u_yaw;\n\t\tvoid main() {\t\t\tfloat alpha = ((1.0 - v_coord.x) * 2.0) * PI + u_yaw;\t\t\tfloat beta = (v_coord.y * 2.0 - 1.0) * PI * 0.5;\t\t\tvec3 N = vec3( -cos(alpha) * cos(beta), sin(beta), sin(alpha) * cos(beta) );\t\t\tgl_FragColor = textureCube(texture,N);\t\t}");
f.setUniform("u_yaw",e);b.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);d.toViewport(f)});return b};Texture.getWhiteTexture=function(d){d=d||C.gl;var a=d.textures[":white"];if(a)return a;a=new Uint8Array([255,255,255,255]);return d.textures[":white"]=new m.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(d){d=d||C.gl;var a=d.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,255]);return d.textures[":black"]=new m.Texture(1,1,{pixel_data:a})};
Texture.getTemporary=function(d,a,b,c){c=c||C.gl;c._texture_pool||(c._texture_pool=[]);var e=m.TEXTURE_2D,f=Texture.DEFAULT_TYPE,h=Texture.DEFAULT_FORMAT;b&&(b.texture_type&&(e=b.texture_type),b.type&&(f=b.type),b.format&&(h=b.format));b=e+":"+f+":"+d+"x"+a+":"+h;for(var n=c._texture_pool,l=0;l<n.length;++l){var k=n[l];if(k._key==b)return n.splice(l,1),k._pool=0,k}k=new m.Texture(d,a,{type:f,texture_type:e,format:h,filter:c.LINEAR});k._key=b;k._pool=0;return k};Texture.releaseTemporary=function(d,
a){a=a||C.gl;a._texture_pool||(a._texture_pool=[]);0<d._pool&&console.warn("this texture is already in the textures pool");var b=a._texture_pool;b||(b=a._texture_pool=[]);d._pool=getTime();b.push(d);20<b.length&&(b.sort(function(c,e){return e._pool-c._pool}),d=b.pop(),d._pool=0,d.delete())};Texture.nextPOT=function(d){return Math.pow(2,Math.ceil(Math.log(d)/Math.log(2)))};m.FBO=L;L.prototype.setTextures=function(d,a,b){if(a&&a.constructor===m.Texture){if(a.format!==m.DEPTH_COMPONENT&&a.format!==m.DEPTH_STENCIL&&
a.format!==m.DEPTH_COMPONENT16&&a.format!==m.DEPTH_COMPONENT24&&a.format!==m.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";if(a.type!=m.UNSIGNED_SHORT&&a.type!=m.UNSIGNED_INT&&a.type!=m.UNSIGNED_INT_24_8_WEBGL&&a.type!=m.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL";}var c=this.depth_texture==a;if(c&&d){if(d.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";
if(d.length==this.color_textures.length)for(var e=0;e<d.length;++e){if(d[e]!=this.color_textures[e]){c=!1;break}}else c=!1}this._stencil_enabled!==this.stencil&&(c=!1);if(!c){this.color_textures.length=d?d.length:0;if(d)for(e=0;e<d.length;++e)this.color_textures[e]=d[e];this.depth_texture=a;this.update(b)}};L.prototype.update=function(d){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler||(this.handler=gl.createFramebuffer());var a=-1,b=-1,c=null,e=null,f=this.color_textures,
h=this.depth_texture;if(f&&f.length)for(var n=0;n<f.length;n++){var l=f[n];if(l.constructor!==m.Texture)throw"FBO can only bind instances of GL.Texture";if(-1==a)a=l.width;else if(a!=l.width)throw"Cannot bind textures with different dimensions";if(-1==b)b=l.height;else if(b!=l.height)throw"Cannot bind textures with different dimensions";if(null==c)c=l.type,e=l.format;else if(c!=l.type)throw"Cannot bind textures to a FBO with different pixel formats";if(l.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO";
}else a=h.width,b=h.height;this.width=a;this.height=b;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var k=gl.extensions.WEBGL_draw_buffers;if(1==gl.webgl_version&&!k&&f&&1<f.length)throw"Rendering to several textures not supported by your browser";var p=1==gl.webgl_version?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;gl.framebufferRenderbuffer(p,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null);gl.framebufferRenderbuffer(p,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null);if(h&&h.constructor===m.Texture){if(1==gl.webgl_version&&
!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&h.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format");h.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(p,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,h.handler,0):gl.framebufferTexture2D(p,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,h.handler,0)}else h&&h.constructor===WebGLRenderbuffer&&h.width==a&&h.height==b?n=this._depth_renderbuffer=
h:(n=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),n.width=a,n.height=b),gl.bindRenderbuffer(gl.RENDERBUFFER,n),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,a,b),gl.framebufferRenderbuffer(p,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,n)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b),gl.framebufferRenderbuffer(p,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,n));if(f&&f.length)for(this.order=[],n=0;n<f.length;n++)l=f[n],gl.framebufferTexture2D(p,
gl.COLOR_ATTACHMENT0+n,gl.TEXTURE_2D,l.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+n);else n=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer(),n.width=a,n.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,n),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,b),gl.framebufferRenderbuffer(p,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,n);for(n=a=f?f.length:0;n<this._num_binded_textures;++n)gl.framebufferTexture2D(p,gl.COLOR_ATTACHMENT0+n,gl.TEXTURE_2D,null,0);this._num_binded_textures=
a;this._stencil_enabled=this.stencil;f&&1<f.length&&(k?k.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));f=gl.checkFramebufferStatus(p);if(f!==gl.FRAMEBUFFER_COMPLETE)throw e!=m.RGB||c!=m.FLOAT&&c!=m.HALF_FLOAT_OES||console.error("Tip: Firefox does not support RGB channel float/half_float textures, you must use RGBA"),"FBO not complete: "+f;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);d||gl.bindFramebuffer(p,this._old_fbo_handler)};L.prototype.bind=function(d){if(this.multi_sample)this._old_fbo_handler=
gl.getParameter(gl.FRAMEBUFFER_BINDING),this._old_viewport.set(gl.viewport_data),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer);else{if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo_handler=d?gl.getParameter(gl.FRAMEBUFFER_BINDING):
null;this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(d=0;d<this.color_textures.length;++d)this.color_textures[d]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0)}gl.viewport(0,0,this.width,this.height);L.current=this};L.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport);for(var d=0;d<this.color_textures.length;++d)this.color_textures[d]._in_current_fbo=
!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);L.current=null};L.prototype.switchTo=function(d){d._old_fbo_handler=this._old_fbo_handler;d._old_viewport.set(this._old_viewport);gl.bindFramebuffer(gl.FRAMEBUFFER,d.handler);this._old_fbo_handler=null;gl.viewport(0,0,this.width,this.height);for(var a=0;a<this.color_textures.length;++a)this.color_textures[a]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(a=0;a<d.color_textures.length;++a)d.color_textures[a]._in_current_fbo=
!0;d.depth_texture&&(d.depth_texture._in_current_fbo=!0);L.current=d};L.prototype.delete=function(){gl.deleteFramebuffer(this.handler);this.handler=null};L.supported={};L.testSupport=function(d,a){var b=d+":"+a;if(null!=L.supported[b])return L.supported[b];var c=new m.Texture(1,1,{format:a,type:d});try{new m.FBO([c])}catch(e){return console.warn("This browser WEBGL implementation doesn't support this FBO format: "+m.reverse[d]+" "+m.reverse[a]),L.supported[b]=!1}return L.supported[b]=!0};L.prototype.toSingle=
function(d){d=d||0;if(!(2>this.color_textures.length)){var a=gl.extensions.WEBGL_draw_buffers;a?a.drawBuffersWEBGL([this.order[d]]):gl.drawBuffers([this.order[d]])}};L.prototype.toMulti=function(){if(!(2>this.color_textures.length)){var d=gl.extensions.WEBGL_draw_buffers;d?d.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}};L.prototype.clearSecondary=function(d){if(this.order&&!(2>this.order.length)){for(var a=gl.extensions.WEBGL_draw_buffers,b=[gl.NONE],c=1;c<this.order.length;++c)b.push(this.order[c]);
a?a.drawBuffersWEBGL(b):gl.drawBuffers(b);gl.clearColor(d[0],d[1],d[2],d[3]);gl.clear(gl.COLOR_BUFFER_BIT);a?a.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}};L.prototype.makeMultiSample=function(d,a,b,c){if(1==this.gl.webgl_version)throw"cannot use makeMultiSample in webgl 1.0";this.width=d;this.height=a;b=b||4;c=c||{};d=c.format||gl.RGBA8;a=gl.DEPTH_COMPONENT16;this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,
this.handler);this.colorRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.colorRenderbuffer);gl.renderbufferStorageMultisample(gl.RENDERBUFFER,b,d,this.width,this.height);this.depthRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthRenderbuffer);gl.renderbufferStorageMultisample(gl.RENDERBUFFER,b,a,this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,
this.colorRenderbuffer);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;this.multi_sample=!0};L.prototype.blitMultisample=function(d){if(!d||d.constructor!==m.FBO)throw"parameter must be GL.FBO";gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this.handler);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,d.handler);gl.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,
gl.COLOR_BUFFER_BIT,gl.LINEAR);gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport)};C.Shader=m.Shader=function e(a,b,c){m.debug&&console.log("GL.Shader created");if(!a||!b)throw"GL.Shader source code parameter missing";this._context_id=C.gl.context_id;var f=this.gl=C.gl,h=e.expandMacros(c);c=a.constructor===String?e.injectCode(h,a,f):a;h=b.constructor===
String?e.injectCode(h,b,f):b;this.program=f.createProgram();a=a.constructor===String?m.Shader.compileSource(f.VERTEX_SHADER,c):a;b=b.constructor===String?m.Shader.compileSource(f.FRAGMENT_SHADER,h):b;f.attachShader(this.program,a,f);f.attachShader(this.program,b,f);f.linkProgram(this.program);this.vs_shader=a;this.fs_shader=b;this.attributes={};this.uniformInfo={};this.samplers={};e.use_async?this._first_use=!0:this.checkLink()};Shader.use_async=!0;Shader.expandMacros=function(a){var b="";if(a)for(var c in a)b+=
"#define "+c+" "+(a[c]?a[c]:"")+"\n";return b};Shader.injectCode=function(a,b,c){var e=b.indexOf("\n");c=c?"#define WEBGL"+c.webgl_version+"\n":"";var f=b.substr(0,e).trim();return-1==f.indexOf("#version")?c+a+b:f+"\n"+c+a+b.substr(e)};Shader.compileSource=function(a,b,c,e){c=c||C.gl;e=e||c.createShader(a);c.shaderSource(e,b);c.compileShader(e);return e};Shader.parseError=function(a,b,c){if(!a)return null;var e=a.split(" "),f=e[5].split(":");return{type:e[0],line_number:parseInt(f[1]),line_pos:parseInt(f[0]),
line_code:("Fragment"==e[0]?c:b).split("\n")[parseInt(f[1])],err:a}};Shader.prototype.delete=function(){this.program&&this.gl.deleteProgram(this.program);this.vs_shader&&this.gl.deleteShader(this.vs_shader);this.fs_shader&&this.gl.deleteShader(this.fs_shader);this.gl=null;this.attributes={};this.uniformInfo={};this.samplers={}};Shader.prototype.updateShader=function(a,b,c){var e=this.gl||C.gl;Shader.expandMacros(c);this.program?(e.detachShader(this.program,this.vs_shader),e.detachShader(this.program,
this.fs_shader)):this.program=e.createProgram();var f=Shader.expandMacros(c);c=a.constructor===String?Shader.injectCode(f,a,e):a;f=b.constructor===String?Shader.injectCode(f,b,e):b;a=a.constructor===String?m.Shader.compileSource(e.VERTEX_SHADER,c):a;b=b.constructor===String?m.Shader.compileSource(e.FRAGMENT_SHADER,f):b;e.attachShader(this.program,a,e);e.attachShader(this.program,b,e);e.linkProgram(this.program);this.vs_shader=a;this.fs_shader=b;this.attributes={};this.uniformInfo={};this.samplers=
{};Shader.use_async?this._first_use=!0:this.checkLink()};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS),c=0;c<b;++c){var e=a.getActiveUniform(this.program,c);if(!e)break;var f=e.name,h=f.indexOf("[");-1!=h&&-1==f.indexOf("].")&&(f=f.substr(0,h));if(e.type==m.SAMPLER_2D||e.type==m.SAMPLER_CUBE||e.type==m.SAMPLER_3D||e.type==m.INT_SAMPLER_2D||e.type==m.INT_SAMPLER_CUBE||e.type==m.INT_SAMPLER_3D||e.type==m.UNSIGNED_INT_SAMPLER_2D||
e.type==m.UNSIGNED_INT_SAMPLER_CUBE||e.type==m.UNSIGNED_INT_SAMPLER_3D)this.samplers[f]=e.type;h=Shader.getUniformFunc(e);var n=!1;if(e.type==a.FLOAT_MAT2||e.type==a.FLOAT_MAT3||e.type==a.FLOAT_MAT4)n=!0;var l=m.TYPE_LENGTH[e.type]||1;this.uniformInfo[f]={type:e.type,func:h,size:e.size,type_length:l,is_matrix:n,loc:a.getUniformLocation(this.program,f),data:new Float32Array(l*e.size)}}c=0;for(b=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);c<b;++c){e=a.getActiveAttrib(this.program,c);if(!e)break;
h=Shader.getUniformFunc(e);l=m.TYPE_LENGTH[e.type]||1;this.uniformInfo[e.name]={type:e.type,func:h,type_length:l,size:e.size,loc:null};"gl_VertexID"!==e.name&&(this.attributes[e.name]=a.getAttribLocation(this.program,e.name))}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){switch(a.type){case m.FLOAT:a=1==a.size?gl.uniform1f:gl.uniform1fv;break;case m.FLOAT_MAT2:a=gl.uniformMatrix2fv;
break;case m.FLOAT_MAT3:a=gl.uniformMatrix3fv;break;case m.FLOAT_MAT4:a=gl.uniformMatrix4fv;break;case m.FLOAT_VEC2:a=gl.uniform2fv;break;case m.FLOAT_VEC3:a=gl.uniform3fv;break;case m.FLOAT_VEC4:a=gl.uniform4fv;break;case m.UNSIGNED_INT:case m.INT:a=1==a.size?gl.uniform1i:gl.uniform1iv;break;case m.INT_VEC2:a=gl.uniform2iv;break;case m.INT_VEC3:a=gl.uniform3iv;break;case m.INT_VEC4:a=gl.uniform4iv;break;case m.SAMPLER_2D:case m.SAMPLER_3D:case m.SAMPLER_CUBE:case m.INT_SAMPLER_2D:case m.INT_SAMPLER_3D:case m.INT_SAMPLER_CUBE:case m.UNSIGNED_INT_SAMPLER_2D:case m.UNSIGNED_INT_SAMPLER_3D:case m.UNSIGNED_INT_SAMPLER_CUBE:a=
gl.uniform1i;break;default:a=gl.uniform1f}return a};Shader.fromURL=function(a,b,c){function e(){var l=new m.Shader(h,n),k;for(k in l)f[k]=l[k];f.ready=!0}var f=new m.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");f.ready=!1;var h=null,n=
null;HttpRequest(a,null,function(l){h=l;n&&e()});HttpRequest(b,null,function(l){n=l;h&&e()});return f};Shader.prototype.checkLink=function(){this._first_use=!1;if(!gl.getShaderParameter(this.vs_shader,gl.COMPILE_STATUS))throw"Vertex shader compile error: "+gl.getShaderInfoLog(this.vs_shader);if(!gl.getShaderParameter(this.fs_shader,gl.COMPILE_STATUS))throw"Fragment shader compile error: "+gl.getShaderInfoLog(this.fs_shader);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+
gl.getProgramInfoLog(this.program);this.extractShaderInfo()};Shader.prototype.bind=function(){var a=this.gl;Shader.use_async&&this._first_use&&(this.checkLink(),this._first_use=!1);a.useProgram(this.program);a._current_shader=this};Shader.prototype.getLocation=function(a){return this.uniformInfo[a]?this.uniformInfo[a].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;this._first_use&&this.checkLink();b.useProgram(this.program);b._current_shader=
this;for(var c in a)this.uniformInfo[c]&&this._setUniform(c,a[c]);return this};Shader.prototype.uniformsArray=function(a){var b=this.gl;this._first_use&&this.checkLink();b.useProgram(this.program);b._current_shader=this;b=0;for(var c=a.length;b<c;++b){var e=a[b],f;for(f in e)this._setUniform(f,e[f])}return this};Shader.prototype.setUniform=function(){return function(a,b){this.gl._current_shader!=this&&this.bind();(a=this.uniformInfo[a])&&null!==a.loc&&null!=b&&(b.constructor===Array&&(a.data.set(b),
b=a.data),a.is_matrix?a.func.call(this.gl,a.loc,!1,b):a.func.call(this.gl,a.loc,b))}}();Shader.prototype._setUniform=function(){return function(a,b){this._first_use&&this.checkLink();(a=this.uniformInfo[a])&&null!==a.loc&&null!=b&&(b.constructor===Array&&(a.data.set(b),b=a.data),a.is_matrix?a.func.call(this.gl,a.loc,!1,b):a.func.call(this.gl,a.loc,b))}}();Shader.prototype.draw=function(a,b,c){c=void 0===c?b==gl.LINES?"lines":"triangles":c;this.drawBuffers(a.vertexBuffers,c?a.indexBuffers[c]:null,
2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,e,f){f=void 0===f?b==gl.LINES?"lines":"triangles":f;this.drawBuffers(a.vertexBuffers,f?a.indexBuffers[f]:null,b,c,e)};var X=new Uint8Array(16),ca=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,e,f){if(0!=f){var h=this.gl;this._first_use&&this.checkLink();h.useProgram(this.program);var n=0;X.set(ca);for(var l in a){var k=a[l],p=k.attribute||l,q=this.attributes[p];null!=q&&k.buffer&&(X[q]=1,h.bindBuffer(h.ARRAY_BUFFER,
k.buffer),h.enableVertexAttribArray(q),h.vertexAttribPointer(q,k.buffer.spacing,k.buffer.gl_type,k.normalize,0,0),n=k.buffer.length/k.buffer.spacing)}a=0;0<e&&(a=e);b&&(n=b.buffer.length-a);0<f&&f<n&&(n=f);a*=b&&b.data?b.data.constructor.BYTES_PER_ELEMENT:1;for(p in this.attributes)q=this.attributes[p],X[q]||h.disableVertexAttribArray(this.attributes[p]);!n||b&&!b.buffer||(b?(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,b.buffer),h.drawElements(c,n,b.buffer.gl_type,a),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)):
h.drawArrays(c,a,n),h.draw_calls++);return this}};Shader._instancing_arrays=[];Shader.prototype.drawInstanced=function(a,b,c,e,f,h,n){if(0!==h){var l=this.gl;if(1==l.webgl_version&&!l.extensions.ANGLE_instanced_arrays)throw"instancing not supported";this._first_use&&this.checkLink();l.useProgram(this.program);var k=0;X.set(ca);var p=a.vertexBuffers;for(w in p){var q=p[w],t=q.attribute||w,x=this.attributes[t];null!=x&&q.buffer&&(X[x]=1,l.bindBuffer(l.ARRAY_BUFFER,q.buffer),l.enableVertexAttribArray(x),
l.vertexAttribPointer(x,q.buffer.spacing,q.buffer.gl_type,q.normalize,0,0),k=q.buffer.length/q.buffer.spacing)}p=null;c&&(c.constructor===String?p=a.getIndexBuffer(c):c.constructor===m.Buffer&&(p=c));a=0;0<f&&(a=f);p&&(k=p.buffer.length-a);0<h&&h<k&&(k=h);a*=p&&p.data?p.data.constructor.BYTES_PER_ELEMENT:1;for(t in this.attributes)x=this.attributes[t],X[x]||l.disableVertexAttribArray(this.attributes[t]);f=l.extensions.ANGLE_instanced_arrays;h=x=0;for(var z in e){var w=e[z];x=w.length;t=this.attributes[z];
if(null==t)return;if(w.constructor===Array){c=w[0].constructor===Number?1:w[0].length;var r=c*w.length}else c=this.uniformInfo[z].type_length,r=w.length,x=r/c;q=Shader._instancing_arrays[h];if(!q||q.data.length<r)q=Shader._instancing_arrays[h]={data:new Float32Array(r),buffer:l.createBuffer()};q.uniform=z;q.element_size=c;if(w.constructor===Array)for(r=0;r<w.length;++r)q.data.set(w[r],r*c);else q.data.set(w);l.bindBuffer(l.ARRAY_BUFFER,q.buffer);l.bufferData(l.ARRAY_BUFFER,q.data,l.STREAM_DRAW);if(16==
c)for(c=0;4>c;++c)l.enableVertexAttribArray(t+c),l.vertexAttribPointer(t+c,4,l.FLOAT,!1,64,16*c),f?f.vertexAttribDivisorANGLE(t+c,1):l.vertexAttribDivisor(t+c,1);else l.enableVertexAttribArray(t),l.vertexAttribPointer(t,c,l.FLOAT,!1,4*c,0),f?f.vertexAttribDivisorANGLE(t,1):l.vertexAttribDivisor(t,1);h+=1}n&&(x=n);f?p?(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,p.buffer),f.drawElementsInstancedANGLE(b,k,p.buffer.gl_type,a,x),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)):f.drawArraysInstancedANGLE(b,a,k,x):p?
(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,p.buffer),l.drawElementsInstanced(b,k,p.buffer.gl_type,a,x),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)):l.drawArraysInstanced(b,a,k,x);for(b=0;b<h;++b)if(e=Shader._instancing_arrays[b],t=this.attributes[e.uniform],c=e.element_size,16==c)for(c=0;4>c;++c)l.disableVertexAttribArray(t+c),f?f.vertexAttribDivisorANGLE(t+c,0):l.vertexAttribDivisor(t+c,0);else l.enableVertexAttribArray(t),f?f.vertexAttribDivisorANGLE(t,0):l.vertexAttribDivisor(t,0);return this}};Shader.expandImports=
function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";return a.replace(/#import\s+"([a-zA-Z0-9_\.]+)"\s*\n/g,function(e){e=e.split('"')[1];if(c[e])return"//already imported: "+e+"\n";var f=b[e];c[e]=!0;return f?f+"\n":"//import code not found: "+e+"\n"})};Shader.dumpErrorToConsole=function(a,b,c){console.error(a);a=(-1!=a.indexOf("Fragment")?c:b).split("\n");for(var e in a)a[e]=e+"| "+a[e];console.groupCollapsed("Shader code");console.log(a.join("\n"));
console.groupEnd()};Shader.convertTo100=function(a,b){};Shader.convertTo300=function(a,b){};Shader.validateValue=function(a,b){if(null===a||void 0===a)return!1;switch(b.type){case m.INT:case m.FLOAT:case m.SAMPLER_2D:case m.SAMPLER_3D:case m.SAMPLER_CUBE:case m.INT_SAMPLER_2D:case m.INT_SAMPLER_3D:case m.INT_SAMPLER_CUBE:case m.UNSIGNED_INT_SAMPLER_2D:case m.UNSIGNED_INT_SAMPLER_3D:case m.UNSIGNED_INT_SAMPLER_CUBE:return isNumber(a);case m.INT_VEC2:case m.FLOAT_VEC2:return 2===a.length;case m.INT_VEC3:case m.FLOAT_VEC3:return 3===
a.length;case m.INT_VEC4:case m.FLOAT_VEC4:case m.FLOAT_MAT2:return 4===a.length;case m.FLOAT_MAT3:return 8===a.length;case m.FLOAT_MAT4:return 16===a.length}return!0};Shader.DEFAULT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec3 v_position;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";Shader.SCREEN_300_VERTEX_SHADER="#version 300 es\n\t\t\tprecision highp float;\n\t\t\tin vec3 a_vertex;\n\t\t\tin vec2 a_coord;\n\t\t\tout vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";
Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t";
Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.SCREEN_FLAT_FRAGMENT_SHADER=Shader.FLAT_FRAGMENT_SHADER;Shader.createFX=function(a,b,c){a=m.Shader.removeComments(a,!0);b=m.Shader.removeComments(b,!0);a={FX_CODE:a,FX_UNIFORMS:b||""};if(!c)return new m.Shader(m.Shader.SCREEN_VERTEX_SHADER,m.Shader.SCREEN_FRAGMENT_FX,a);c.updateShader(m.Shader.SCREEN_VERTEX_SHADER,m.Shader.SCREEN_FRAGMENT_FX,
a);return c};Shader.replaceCodeUsingContext=function(a,b){return a.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(c){c=c.replace(/[\{\}]/g,"");return b[c]||""})};Shader.removeComments=function(a,b){if(!a)return"";a=a.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,"");a=a.split("\n");for(var c=[],e=0;e<a.length;++e){var f=a[e],h=f.indexOf("//");-1!=h&&(f=a[e].substr(0,h));f=f.trim();f.length&&c.push(f)}return c.join(b?"":"\n")};Shader.prototype.toViewport=function(a){var b=m.Mesh.getScreenQuad();
a&&this.uniforms(a);this.draw(b)};Shader.getScreenShader=function(a){a=a||C.gl;var b=a.shaders[":screen"];if(b)return b;b=a.shaders[":screen"]=new m.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return b.uniforms({u_texture:0})};Shader.getFlatScreenShader=function(a){a=a||C.gl;var b=a.shaders[":flat_screen"];if(b)return b;b=a.shaders[":flat_screen"]=new m.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);return b.uniforms({u_color:[1,1,1,1]})};Shader.getColoredScreenShader=
function(a){a=a||C.gl;var b=a.shaders[":colored_screen"];if(b)return b;b=a.shaders[":colored_screen"]=new m.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return b.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=function(a){a=a||C.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new m.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(a){a=a||C.gl;var b=a.shaders[":quad2"];return b?
b:a.shaders[":quad2"]=new m.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlendShader=function(a){a=a||C.gl;var b=a.shaders[":blend"];return b?b:a.shaders[":blend"]=new m.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER)};Shader.getBlurShader=function(a){a=a||C.gl;var b=a.shaders[":blur"];if(b)return b;b=new m.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.getCopyDepthShader=function(a){a=a||C.gl;var b=a.shaders[":copy_depth"];if(b)return b;b=new m.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_EXT_frag_depth : enable\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;\n\t\t\t   gl_FragColor = vec4(1.0);\n\t\t\t}\n\t\t\t");return a.shaders[":copy_depth"]=b};Shader.getCubemapShowShader=
function(a){a=a||C.gl;var b=a.shaders[":show_cubemap"];if(b)return b;b=new m.Shader(Shader.DEFAULT_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = textureCube( u_texture, v_normal );\n\t\t\t}\n\t\t\t");b.uniforms({u_texture:0});return a.shaders[":show_cubemap"]=b};Shader.getPolarToCubemapShader=function(a){a=a||C.gl;var b=a.shaders[":polar_to_cubemap"];if(b)return b;b=new m.Shader(Shader.SCREEN_VERTEX_SHADER,
"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = normalize( vec3( uv - vec2(0.5), 0.5 ));\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t\tfloat u = atan(dir.x,dir.z) / 6.28318531;\n\t\t\t\tfloat v = (asin(dir.y) / 1.57079633) * 0.5 + 0.5;\n\t\t\t\tu = mod(u,1.0);\n\t\t\t\tv = mod(v,1.0);\n\t\t\t   gl_FragColor = texture2D( u_texture, vec2(u,v) );\n\t\t\t}\n\t\t\t");
return a.shaders[":polar_to_cubemap"]=b};Shader.getCubemapCopyShader=function(a){a=a||C.gl;var b=a.shaders[":copy_cubemap"];if(b)return b;b=new m.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t");
return a.shaders[":copy_cubemap"]=b};Shader.getCubemapBlurShader=function(a){a=a||C.gl;var b=a.shaders[":blur_cubemap"];if(b)return b;b=new m.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur_cubemap"]=b};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t/* fragCoord MUST BE IN PIXELS */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\t//return vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(a){a=a||C.gl;var b=a.shaders[":fxaa"];if(b)return b;b=new m.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t");var c=vec2.fromValues(a.viewport_data[2],a.viewport_data[3]),e=vec2.fromValues(1/a.viewport_data[2],1/a.viewport_data[3]);b.setup=
function(){c[0]=a.viewport_data[2];c[1]=a.viewport_data[3];e[0]=1/a.viewport_data[2];e[1]=1/a.viewport_data[3];this.uniforms({u_viewportSize:c,u_iViewportSize:e})};return a.shaders[":fxaa"]=b};Shader.getFlatShader=function(a){a=a||C.gl;var b=a.shaders[":flat"];if(b)return b;b=new m.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);b.uniforms({u_color:[1,1,1,1]});return a.shaders[":flat"]=b};m.create=function(a){function b(r){if(!k.ignore_events){var v=k.mouse.buttons;m.augmentEvent(r,
h);r.eventType=r.eventType||r.type;var A=getTime();q.dragging=r.dragging;q.position[0]=r.canvasx;q.position[1]=r.canvasy;q.x=r.canvasx;q.y=r.canvasy;q.mousex=r.mousex;q.mousey=r.mousey;q.canvasx=r.canvasx;q.canvasy=r.canvasy;q.clientx=r.mousex;q.clienty=r.mousey;q.buttons=r.buttons;q.left_button=!!(q.buttons&m.LEFT_MOUSE_BUTTON_MASK);q.middle_button=!!(q.buttons&m.MIDDLE_MOUSE_BUTTON_MASK);q.right_button=!!(q.buttons&m.RIGHT_MOUSE_BUTTON_MASK);if("mousedown"==r.eventType){0==v&&(h.removeEventListener("mousemove",
b),v=h.ownerDocument,v.addEventListener("mousemove",b),v.addEventListener("mouseup",b));p=A;if(k.onmousedown)k.onmousedown(r);J.trigger(k,"mousedown")}else if("mousemove"==r.eventType){if(k.onmousemove)k.onmousemove(r);J.trigger(k,"mousemove",r)}else if("mouseup"==r.eventType){0==k.mouse.buttons&&(h.addEventListener("mousemove",b),v=h.ownerDocument,v.removeEventListener("mousemove",b),v.removeEventListener("mouseup",b));r.click_time=A-p;if(k.onmouseup)k.onmouseup(r);J.trigger(k,"mouseup",r)}else if("mousewheel"==
r.eventType||"wheel"==r.eventType||"DOMMouseScroll"==r.eventType){r.eventType="mousewheel";r.wheel="wheel"==r.type?-r.deltaY:null!=r.wheelDeltaY?r.wheelDeltaY:-60*r.detail;r.delta=void 0!==r.wheelDelta?r.wheelDelta/40:r.deltaY?-r.deltaY/3:0;if(k.onmousewheel)k.onmousewheel(r);J.trigger(k,"mousewheel",r)}else if("dragstart"==r.eventType){if(k.ondragstart)k.ondragstart(r);J.trigger(k,"dragstart",r)}if(k.onmouse)k.onmouse(r);if(!r.skip_preventDefault)return"mousemove"!=r.eventType&&r.stopPropagation(),
r.preventDefault(),!1}}function c(r){var v=r.srcEvent,A=document.createEvent("MouseEvent");A.initMouseEvent("wheel",!0,!0,window,1,v.screenX,v.screenY,v.clientX,v.clientY,!1,!1,!1,!1,0,null);A.originalEvent=A;A.is_touch=!0;var y=!1;"pinchin"===r.additionalEvent?(A.deltaY=1,y=!0):"pinchout"===r.additionalEvent&&(A.deltaY=-1,y=!0);y&&(A.pinchScaling=.0312*r.distance,v.target.dispatchEvent(A));v.preventDefault()}function e(r){var v=r.changedTouches,A=v[0];if(!(k.ontouch&&!0===k.ontouch(r)||!0===J.trigger(k,
r.type,r)||!x||r.touches.length&&r.changedTouches[0].identifier!==r.touches[0].identifier||1<v)){switch(r.type){case "touchstart":v="mousedown";break;case "touchmove":v="mousemove";break;case "touchend":v="mouseup";break;default:return}var y=document.createEvent("MouseEvent");y.initMouseEvent(v,!0,!0,window,1,A.screenX,A.screenY,A.clientX,A.clientY,!1,!1,!1,!1,0,null);y.originalEvent=y;y.is_touch=!0;A.target.dispatchEvent(y);r.preventDefault()}}function f(r){r.eventType=r.type;k.ongesture&&!1===k.ongesture(r)||
!1!==J.trigger(k,r.type,r)&&r.preventDefault()}a=a||{};var h=null;if(a.canvas)if("string"==typeof a.canvas){if(h=document.getElementById(a.canvas),!h)throw"Canvas element not found: "+a.canvas;}else h=a.canvas;else{var n=null;a.container&&(n=a.container.constructor===String?document.querySelector(a.container):a.container);if(n&&!a.width){var l=n.getBoundingClientRect();a.width=l.width;a.height=l.height}h=createCanvas(a.width||800,a.height||600);n&&n.appendChild(h)}"alpha"in a||(a.alpha=!1);var k=
null;n=null;2==a.version?n=["webgl2","experimental-webgl2"]:1==a.version||void 0===a.version?n=["webgl","experimental-webgl"]:0===a.version&&(n=["webgl2","experimental-webgl2","webgl","experimental-webgl"]);if(!n)throw"Incorrect WebGL version, must be 1 or 2";l={alpha:void 0===a.alpha?!0:a.alpha,depth:void 0===a.depth?!0:a.depth,stencil:void 0===a.stencil?!0:a.stencil,antialias:void 0===a.antialias?!0:a.antialias,premultipliedAlpha:void 0===a.premultipliedAlpha?!0:a.premultipliedAlpha,preserveDrawingBuffer:void 0===
a.preserveDrawingBuffer?!0:a.preserveDrawingBuffer};for(a=0;a<n.length;++a){try{k=h.getContext(n[a],l)}catch(r){}if(k)break}if(!k){if(h.getContext("webgl"))throw"WebGL supported but not with those parameters";throw"WebGL not supported";}k.webgl_version="WebGL2RenderingContext"===k.constructor.name?2:1;C.gl=k;h.is_webgl=!0;h.gl=k;k.context_id=this.last_context_id++;k.extensions={};n=k.getSupportedExtensions();for(a=0;a<n.length;++a)k.extensions[n[a]]=k.getExtension(n[a]);k.HIGH_PRECISION_FORMAT=1==
k.webgl_version?k.extensions.OES_texture_half_float?m.HALF_FLOAT_OES:k.extensions.OES_texture_float?m.FLOAT:m.UNSIGNED_BYTE:m.HALF_FLOAT_OES;k.max_texture_units=k.getParameter(k.MAX_TEXTURE_IMAGE_UNITS);k._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):(k._viewport_func=k.viewport,k.viewport_data=new Float32Array([0,0,k.canvas.width,k.canvas.height]),k.viewport=function(r,v,A,y){var u=this.viewport_data;u[0]=r|0;u[1]=v|0;u[2]=A|0;u[3]=y|0;this._viewport_func(r,v,
A,y)},k.getViewport=function(r){return r?(r[0]=k.viewport_data[0],r[1]=k.viewport_data[1],r[2]=k.viewport_data[2],r[3]=k.viewport_data[3],r):new Float32Array(k.viewport_data)},k.setViewport=function(r,v){k.viewport_data.set(r);v&&(k.viewport_data[1]=this.drawingBufferHeight-r[1]-r[3]);this._viewport_func(r[0],k.viewport_data[1],r[2],r[3])});if(!m.reverse)for(a in m.reverse={},k)k[a]&&k[a].constructor===Number&&(m.reverse[k[a]]=a);if(void 0==window.glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";
var p=0;k.shaders={};k.textures={};k.meshes={};k.draw_calls=0;k.makeCurrent=function(){C.gl=this};k.execute=function(r){var v=C.gl;C.gl=this;r();C.gl=v};k.animate=function(r){function v(){if(!k.destroyed){u._requestFrame_id=A(v);var D=getTime(),G=.001*(D-y);u.mouse&&(u.mouse.last_buttons=B);B=u.mouse.buttons;if(u.onupdate)u.onupdate(G);J.trigger(u,"update",G);u.ondraw&&(G=C.gl,C.gl=u,u.ondraw(),J.trigger(u,"draw"),C.gl=G);y=D}}if(!1===r)C.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=
null;else{var A=C.requestAnimationFrame,y=getTime(),u=this,B=0;this._requestFrame_id=A(v)}};k.destroy=function(){z&&(document.removeEventListener("keydown",z),document.removeEventListener("keyup",z));t&&(this.canvas.removeEventListener("mousedown",t),this.canvas.removeEventListener("mousemove",t),this.canvas.removeEventListener("mouseup",t),this.canvas.addEventListener("drag",t),this.canvas.addEventListener("dragstart",t),this.canvas.addEventListener("wheel",t));for(var r in this.shaders)this.shaders[r].delete(),
this.shaders[r]=null;this.shaders={};for(r in this.meshes)this.meshes[r].deleteBuffers(),this.meshes[r]=null;this.meshes={};for(r in this.textures)this.textures[r].delete(),this.textures[r]=null;this.textures={};this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;C.gl==this&&(C.gl=null)};var q=k.mouse={buttons:0,last_buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(r,
v,A,y,u){var B=this.y;u&&(B=k.canvas.height-B);return this.x>r&&this.x<r+A&&B>v&&B<v+y?!0:!1},isButtonPressed:function(r){if(r==m.LEFT_MOUSE_BUTTON)return this.buttons&m.LEFT_MOUSE_BUTTON_MASK;if(r==m.MIDDLE_MOUSE_BUTTON)return this.buttons&m.MIDDLE_MOUSE_BUTTON_MASK;if(r==m.RIGHT_MOUSE_BUTTON)return this.buttons&m.RIGHT_MOUSE_BUTTON_MASK},wasButtonPressed:function(r){var v=0;r==m.LEFT_MOUSE_BUTTON?v=m.LEFT_MOUSE_BUTTON_MASK:r==m.MIDDLE_MOUSE_BUTTON?v=m.MIDDLE_MOUSE_BUTTON_MASK:r==m.RIGHT_MOUSE_BUTTON&&
(v=m.RIGHT_MOUSE_BUTTON_MASK);return this.buttons&v&&!(this.last_buttons&v)}};k.captureMouse=function(r,v){h.addEventListener("mousedown",b);h.addEventListener("mousemove",b);h.addEventListener("drag",b);h.addEventListener("dragstart",b);r&&(h.addEventListener("mousewheel",b,!1),h.addEventListener("wheel",b,!1));h.addEventListener("contextmenu",function(A){A.preventDefault();return!1});v&&this.captureTouch(!0)};var t=b,x=!1;"undefined"!==typeof Hammer&&(a=new Hammer.Manager(h),n=new Hammer.Pinch({threshold:.3}),
a&&n&&(a.add(n),a.on("pinch",c)));k.captureTouch=function(r){x=r;h.addEventListener("touchstart",e,!0);h.addEventListener("touchmove",e,!0);h.addEventListener("touchend",e,!0);h.addEventListener("touchcancel",e,!0);h.addEventListener("gesturestart",f);h.addEventListener("gesturechange",f);h.addEventListener("gestureend",f)};k.keys={};var z=null;k.captureKeys=function(r,v){function A(y){y.eventType=y.type;var u=y.target.nodeName.toLowerCase();if("input"!==u&&"textarea"!==u&&"select"!==u&&"true"!==
y.target.contentEditable){y.character=String.fromCharCode(y.keyCode).toLowerCase();u=!1;var B=m.mapKeyCode(y.keyCode);B||(B=y.character);var D=y.altKey||y.ctrlKey||y.metaKey;D||(B&&(k.keys[B]="keydown"==y.type),u=k.keys[y.keyCode],k.keys[y.keyCode]="keydown"==y.type);if(u!=k.keys[y.keyCode]||D){if("keydown"==y.type&&k.onkeydown)k.onkeydown(y);else if("keyup"==y.type&&k.onkeyup)k.onkeyup(y);J.trigger(k,y.type,y)}if(k.onkey)k.onkey(y);r&&(y.isChar||m.blockable_keys[y.keyIdentifier||y.key])&&y.preventDefault()}}
z||(k.keys={},document.addEventListener("keydown",A),document.addEventListener("keyup",A),z=A)};k.gamepads=null;k.captureGamepads=function(){var r=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;r&&(this.gamepads=r.call(navigator))};k.getGamepads=function(r){var v=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(v){v=v.call(navigator);this.gamepads||(this.gamepads=[]);for(var A=0;4>A;A++){var y=v[A];if(y&&!r){var u=y,B=u.xbox||{axes:[],buttons:{},
hat:""};B.axes.lx=u.axes[0];B.axes.ly=u.axes[1];B.axes.rx=u.axes[2];B.axes.ry=u.axes[3];B.axes.triggers=u.axes[4];for(var D=0;D<u.buttons.length;D++)switch(D){case 0:B.buttons.a=u.buttons[D].pressed;break;case 1:B.buttons.b=u.buttons[D].pressed;break;case 2:B.buttons.x=u.buttons[D].pressed;break;case 3:B.buttons.y=u.buttons[D].pressed;break;case 4:B.buttons.lb=u.buttons[D].pressed;break;case 5:B.buttons.rb=u.buttons[D].pressed;break;case 6:B.buttons.lt=u.buttons[D].pressed;break;case 7:B.buttons.rt=
u.buttons[D].pressed;break;case 8:B.buttons.back=u.buttons[D].pressed;break;case 9:B.buttons.start=u.buttons[D].pressed;break;case 10:B.buttons.ls=u.buttons[D].pressed;break;case 11:B.buttons.rs=u.buttons[D].pressed;break;case 12:u.buttons[D].pressed&&(B.hat+="up");break;case 13:u.buttons[D].pressed&&(B.hat+="down");break;case 14:u.buttons[D].pressed&&(B.hat+="left");break;case 15:u.buttons[D].pressed&&(B.hat+="right");break;case 16:B.buttons.home=u.buttons[D].pressed}u.xbox=B}if(y&&!y.prev_buttons){y.prev_buttons=
new Uint8Array(32);u=new CustomEvent("gamepadconnected");u.eventType=u.type;u.gamepad=y;if(this.ongamepadconnected)this.ongamepadconnected(u);J.trigger(k,"gamepadconnected",u)}if(y)for(B=0;B<y.buttons.length;++B){D=y.buttons[B];D.was_pressed=!1;if(D.pressed&&!y.prev_buttons[B]){D.was_pressed=!0;u=new CustomEvent("gamepadButtonDown");u.eventType=u.type;u.button=D;u.which=B;u.gamepad=y;if(k.onbuttondown)k.onbuttondown(u);J.trigger(k,"buttondown",u)}else if(!D.pressed&&y.prev_buttons[B]){u=new CustomEvent("gamepadButtonUp");
u.eventType=u.type;u.button=D;u.which=B;u.gamepad=y;if(k.onbuttondown)k.onbuttondown(u);J.trigger(k,"buttonup",u)}y.prev_buttons[B]=D.pressed?1:0}}return this.gamepads=v}};k.fullscreen=function(){var r=this.canvas;r.requestFullScreen?r.requestFullScreen():r.webkitRequestFullScreen?r.webkitRequestFullScreen():r.mozRequestFullScreen?r.mozRequestFullScreen():console.error("Fullscreen not supported")};k.snapshot=function(r,v,A,y,u){var B=createCanvas(A,y),D=B.getContext("2d"),G=D.getImageData(0,0,B.width,
B.height),F=new Uint8Array(A*y*4);k.readPixels(r,v,B.width,B.height,k.RGBA,k.UNSIGNED_BYTE,F);G.data.set(F);D.putImageData(G,0,0);if(u)return B;r=createCanvas(A,y);D=r.getContext("2d");D.translate(0,y);D.scale(1,-1);D.drawImage(B,0,0);return r};var w={};k.loadTexture=function(r,v,A){if(this.textures[r])return this.textures[r];if(w[r])return null;var y=new Image;y.url=r;y.onload=function(){var u=m.Texture.fromImage(this,v);u.img=this;k.textures[this.url]=u;delete w[this.url];A&&A(u)};y.src=r;w[r]=
!0;return null};k.drawTexture=function(){var r=mat3.create(),v=vec2.create(),A=vec2.create(),y=vec4.create(),u=vec4.fromValues(1,1,1,1),B=vec2.create(),D={u_texture:0,u_position:v,u_color:u,u_size:A,u_texture_area:y,u_viewport:B,u_transform:r};return function(G,F,H,M,T,Q,I,K,O,U,S){v[0]=F;v[1]=H;void 0===M&&(M=G.width);void 0===T&&(T=G.height);A[0]=M;A[1]=T;void 0===Q&&(Q=0);void 0===I&&(I=0);void 0===K&&(K=G.width);void 0===O&&(O=G.height);y[0]=Q/G.width;y[1]=I/G.height;y[2]=(Q+K)/G.width;y[3]=(I+
O)/G.height;B[0]=this.viewport_data[2];B[1]=this.viewport_data[3];U=U||Shader.getPartialQuadShader(this);F=Mesh.getScreenQuad(this);G.bind(0);U.uniforms(D);S&&U.uniforms(S);U.draw(F,k.TRIANGLES)}}();k.canvas.addEventListener("webglcontextlost",function(r){r.preventDefault();k.context_lost=!0;if(k.onlosecontext)k.onlosecontext(r)},!1);k.reset=function(){k.viewport(0,0,this.canvas.width,this.canvas.height);k.disable(k.BLEND);k.disable(k.CULL_FACE);k.disable(k.DEPTH_TEST);k.frontFace(k.CCW);k._current_texture_drawto=
null;k._current_fbo_color=null;k._current_fbo_depth=null};k.dump=function(){console.log("userAgent: ",navigator.userAgent);console.log("Supported extensions:");var r=k.getSupportedExtensions();console.log(r.join(","));r="VENDOR VERSION MAX_VERTEX_ATTRIBS MAX_VARYING_VECTORS MAX_VERTEX_UNIFORM_VECTORS MAX_VERTEX_TEXTURE_IMAGE_UNITS MAX_FRAGMENT_UNIFORM_VECTORS MAX_TEXTURE_SIZE MAX_TEXTURE_IMAGE_UNITS".split(" ");console.log("WebGL info:");for(var v in r)console.log(" * "+r[v]+": "+k.getParameter(k[r[v]]));
console.log("*************************************************")};k.reset();return k};m.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",33:"PAGEUP",34:"PAGEDOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};m.dragging=!1;m.last_pos=[0,0];m.augmentEvent=function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.clientX-c.left;a.mousey=a.clientY-c.top;
a.canvasx=a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;a.is_touch&&(gl.mouse.buttons=a.which);document.pointerLockElement===b&&(a.canvasx=a.mousex=.5*c.width,a.canvasy=a.mousey=.5*c.height);"mousedown"==a.type?this.dragging=!0:"mousemove"!=a.type&&"mouseup"==a.type&&0==a.buttons&&(this.dragging=!1);void 0===a.movementX||a.is_touch||m.isMobile()?(a.deltax=a.mousex-this.last_pos[0],a.deltay=a.mousey-this.last_pos[1]):(a.deltax=a.movementX,a.deltay=a.movementY);this.last_pos[0]=a.mousex;
this.last_pos[1]=a.mousey;a.dragging=this.dragging;a.leftButton=!!(gl.mouse.buttons&m.LEFT_MOUSE_BUTTON_MASK);a.middleButton=!!(gl.mouse.buttons&m.MIDDLE_MOUSE_BUTTON_MASK);a.rightButton=!!(gl.mouse.buttons&m.RIGHT_MOUSE_BUTTON_MASK);a.buttons_mask=0;a.leftButton&&(a.buttons_mask=1);a.middleButton&&(a.buttons_mask|=2);a.rightButton&&(a.buttons_mask|=4);a.isButtonPressed=function(e){return this.buttons_mask&1<<e}};m.isMobile=function(){return void 0!==this.mobile?this.mobile:C.navigator?navigator.userAgent.match(/iPhone/i)||
navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/SamsungBrowser/i)||navigator.userAgent.match(/Mobile VR/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1};var J=C.LEvent=m.LEvent={bind:function(a,b,c,e){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";var f=a.__levents;f||(Object.defineProperty(a,"__levents",{value:{},
enumerable:!1}),f=a.__levents);f.hasOwnProperty(b)?f[b].push([c,e]):f[b]=[[c,e]];if(a.onLEventBinded)a.onLEventBinded(b,c,e)},unbind:function(a,b,c,e){if(!a)throw"cannot unbind event to null";if(!c)throw"cannot unbind from null callback";if(a.constructor===String)throw"cannot bind event to a string";var f=a.__levents;if(f&&f.hasOwnProperty(b)){for(var h=0,n=f[b].length;h<n;++h){var l=f[b][h];if(l[0]===c&&l[1]===e){f[b].splice(h,1);break}}0==f[b].length&&delete f[b];if(a.onLEventUnbinded)a.onLEventUnbinded(b,
c,e)}},unbindAll:function(a,b,c){if(!a)throw"cannot unbind events in null";var e=a.__levents;if(e){if(a.onLEventUnbindAll)a.onLEventUnbindAll(b,c);if(b)for(var f in e){a=e[f];for(var h=a.length-1;0<=h;--h)a[h][1]!=b||c&&c!==a[h][0]||a.splice(h,1)}else delete a.__levents}},unbindAllEvent:function(a,b){if(!a)throw"cannot unbind events in null";var c=a.__levents;if(c&&(delete c[b],a.onLEventUnbindAll))a.onLEventUnbindAll(b,target_instance,callback)},isBind:function(a,b,c,e){if(!a)throw"LEvent cannot have null as instance";
if(a=a.__levents){if(!a.hasOwnProperty(b))return!1;for(var f=0,h=a[b].length;f<h;++f){var n=a[b][f];if(n[0]===c&&n[1]===e)return!0}return!1}},hasBind:function(a,b){if(!a)throw"LEvent cannot have null as instance";return(a=a.__levents)&&a.hasOwnProperty(b)&&a[b].length?!0:!1},hasBindTo:function(a,b){if(!a)throw"LEvent cannot have null as instance";a=a.__levents;if(!a)return!1;for(var c in a)for(var e=a[c],f=0;f<e.length;++f)if(e[f][1]===b)return!0;return!1},trigger:function(a,b,c,e,f){if(!a)throw"cannot trigger event from null";
if(a.constructor===String)throw"cannot bind event to a string";a=a.__levents;if(!a||!a.hasOwnProperty(b))return!1;a=a[b];if(e)for(e=a.length-1;0<=e;--e){var h=a[e];if(f){if(h&&!0===h[0].apply(h[1],c))return!0}else if(h&&!0===h[0].call(h[1],b,c))return!0}else{e=0;for(var n=a.length;e<n;++e)if(h=a[e],f){if(h&&!0===h[0].apply(h[1],c))return!0}else if(h&&!0===h[0].call(h[1],b,c))return!0}return!1},triggerArray:function(a,b,c,e,f){for(var h=!1,n=0,l=a.length;n<l;++n){var k=a[n];if(!k)throw"cannot trigger event from null";
if(k.constructor===String)throw"cannot bind event to a string";if((k=k.__levents)&&k.hasOwnProperty(b))if(e)for(var p=k[b].length-1;0<=p;--p){var q=k[b][p];if(f){if(!0===q[0].apply(q[1],c)){h=!0;break}}else if(!0===q[0].call(q[1],b,c)){h=!0;break}}else{p=0;for(var t=k[b].length;p<t;++p)if(q=k[b][p],f){if(!0===q[0].apply(q[1],c)){h=!0;break}}else if(!0===q[0].call(q[1],b,c)){h=!0;break}}}return h},extendObject:function(a){a.bind=function(b,c,e){return J.bind(this,b,c,e)};a.trigger=function(b,c){return J.trigger(this,
b,c)};a.unbind=function(b,c,e){return J.unbind(this,b,c,instance)};a.unbindAll=function(b,c){return J.unbindAll(this,b,c)}},extendClass:function(a){this.extendObject(a.prototype)}};C.CLIP_INSIDE=m.CLIP_INSIDE=0;C.CLIP_OUTSIDE=m.CLIP_OUTSIDE=1;C.CLIP_OVERLAP=m.CLIP_OVERLAP=2;C.geo={last_t:-1,createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},planeFromTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(e,f,h,n){vec3.sub(a,h,f);vec3.sub(b,
n,f);vec3.cross(c,a,b);vec3.normalize(c,c);e[0]=c[0];e[1]=c[1];e[2]=c[2];e[3]=-vec3.dot(f,c);return e}}(),computeTriangleNormal:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(e,f,h,n){vec3.sub(a,h,f);vec3.sub(b,n,f);vec3.cross(c,a,b);vec3.normalize(c,c);e[0]=c[0];e[1]=c[1];e[2]=c[2];return e}}(),distancePointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*
b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnLine:function(){var a=vec3.create(),b=vec3.create();return function(c,e,f,h){h=h||vec3.create();vec3.sub(a,c,e);vec3.sub(b,f,e);c=vec3.dot(a,b)/vec3.dot(b,b);h[0]=e[0]+c*b[0];h[1]=e[1]+c*b[1];h[2]=e[2]+c*b[2];return h}}(),project2DPointOnLine:function(a,b,c,e){e=e||vec2.create();a=vec2.fromValues(a[0]-b[0],a[1]-b[1]);c=vec2.fromValues(c[0]-b[0],c[1]-b[1]);a=vec2.dot(a,c)/vec2.dot(c,c);e[0]=b[0]+a*c[0];e[1]=b[1]+a*c[1];return e},closestPointToSegment:function(){var a=
vec3.create(),b=vec3.create();return function(c,e,f,h){h=h||vec3.create();vec3.sub(a,c,e);vec3.sub(b,f,e);c=vec3.dot(a,b)/vec3.dot(b,b);c=Math.min(1,Math.max(0,c));h[0]=e[0]+c*b[0];h[1]=e[1]+c*b[1];h[2]=e[2]+c*b[2];return h}}(),projectPointOnPlane:function(){var a=vec3.create();return function(b,c,e,f){f=f||vec3.create();vec3.sub(a,b,c);c=vec3.dot(a,e);vec3.scale(a,e,c);return vec3.sub(f,b,a)}}(),isPointInsideTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),e=vec3.create(),
f=vec3.create(),h=vec3.create();return function(n,l,k,p){vec3.sub(a,l,n);vec3.sub(b,k,n);vec3.sub(c,p,n);vec3.cross(e,b,c);vec3.cross(f,c,a);vec3.cross(h,a,b);return 0>vec3.dot(e,f)||0>vec3.dot(e,h)?!1:!0}}(),reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,e,f){c=vec3.dot(c,e)-vec3.dot(e,a);e=vec3.dot(e,b);if(Math.abs(e)<
EPSILON)return!1;e=this.last_t=c/e;if(0>e)return!1;f&&vec3.add(f,a,vec3.scale(f,b,e));return!0},testSegmentPlane:function(){var a=vec3.create();return function(b,c,e,f,h){e=vec3.dot(e,f)-vec3.dot(f,b);c=vec3.sub(a,c,b);f=vec3.dot(f,c);if(Math.abs(f)<EPSILON)return!1;f=this.last_t=e/f;if(0>f||1<f)return!1;h&&vec3.add(h,b,vec3.scale(h,c,f));return!0}}(),testRaySphere:function(){var a=vec3.create();return function(b,c,e,f,h,n){var l=vec3.subtract(a,b,e),k=c[0]*c[0]+c[1]*c[1]+c[2]*c[2];e=2*l[0]*c[0]+
2*l[1]*c[1]+2*l[2]*c[2];f=e*e-4*k*(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-f*f);if(0>f)return!1;if(h){f=Math.sqrt(f);l=1/(2*k);k=(-e+f)*l;e=(-e-f)*l;e=k<e?k:e;if(void 0!==n&&e>n)return!1;this.last_t=e;vec3.add(h,b,vec3.scale(h,c,e))}return!0}}(),hitTestTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),e=vec3.create(),f=vec3.create();return function(h,n,l,k,p,q){vec3.subtract(a,k,l);vec3.subtract(b,p,l);vec3.cross(c,a,b);vec3.normalize(c,c);k=vec3.dot(c,vec3.subtract(e,l,h))/vec3.dot(c,
n);if(0<k){vec3.add(f,h,vec3.scale(e,n,k));var t=vec3.subtract(e,e,l);l=vec3.dot(b,b);p=vec3.dot(b,a);var x=vec3.dot(b,t),z=vec3.dot(a,a);t=vec3.dot(a,t);var w=l*z-p*p;z=(z*x-p*t)/w;l=(l*t-p*x)/w;if(0<=z&&0<=l&&1>=z+l)return this.last_t=k,q&&vec3.add(q,h,vec3.scale(e,n,k)),!0}return!1}}(),testRayCylinder:function(a,b,c,e,f,h){var n=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));b=vec3.subtract(vec3.create(),e,c);var l=vec3.subtract(vec3.create(),n,c);c=vec3.subtract(vec3.create(),
a,n);e=vec3.dot(l,b);a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>e&&0>e+a||e>b&&e+a>b)return!1;var k=vec3.dot(c,c),p=vec3.dot(l,c);var q=b*k-a*a;f=vec3.dot(l,l)-f*f;var t=b*f-e*e;if(Math.abs(q)<EPSILON){if(0<t)return!1;h&&vec3.add(h,n,vec3.scale(h,c,0>e?-p/k:e>b?(a-p)/k:0));return!0}l=b*p-a*e;t=l*l-q*t;if(0>t)return!1;q=(-l-Math.sqrt(t))/q;if(0>q||1<q)return!1;if(0>e+q*a){if(0>=a)return!1;q=-e/a;h&&vec3.add(h,n,vec3.scale(h,c,q));return 0>=f+2*q*(p+q*k)}if(e+q*a>b){if(0<=a)return!1;q=(b-e)/a;h&&vec3.add(h,
n,vec3.scale(h,c,q));return 0>=f+b-2*e+q*(2*(p-a)+q*k)}this.last_t=q;h&&vec3.add(h,n,vec3.scale(h,c,q));return!0},testRayBox:function(){var a=new Float32Array(3),b=new Float32Array(3),c=new Float32Array(3);return function(e,f,h,n,l,k){k=k||Number.MAX_VALUE;var p=!0,q;a.fill(0);c.fill(0);b.fill(0);for(q=0;3>q;++q)e[q]<h[q]?(a[q]=1,b[q]=h[q],p=!1):e[q]>n[q]?(a[q]=0,b[q]=n[q],p=!1):a[q]=2;if(p)return this.last_t=0,l&&vec3.copy(l,e),!0;for(q=0;3>q;++q)c[q]=2!=a[q]&&0!=f[q]?(b[q]-e[q])/f[q]:-1;p=0;for(q=
1;3>q;q++)c[p]<c[q]&&(p=q);if(0>c[p]||c[p]>k)return!1;this.last_t=c[p];for(q=0;3>q;++q)if(p!=q){k=e[q]+c[p]*f[q];if(k<h[q]||k>n[q])return!1;l&&(l[q]=k)}else l&&(l[q]=b[q]);return!0}}(),testRayBBox:function(){var a=mat4.create(),b=vec3.create(),c=vec3.create();return function(e,f,h,n,l,k,p){if(!e||!f||!h)throw"parameters missing";n&&(mat4.invert(a,n),vec3.add(b,e,f),e=vec3.transformMat4(c,e,a),vec3.transformMat4(b,b,a),vec3.sub(b,b,e),f=vec3.normalize(b,b));e=this.testRayBox(e,f,h.subarray(6,9),h.subarray(9,
12),l,k);!p&&n&&l&&vec3.transformMat4(l,l,n);return e}}(),testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(b=BBox.getMax(b),geo.testPointBBox(b,a));return!0},testSphereBBox:function(a,b,c){for(var e=0,f=BBox.getMin(c),h=BBox.getMax(c),n=0;3>n;++n)a[n]<f[n]?(c=a[n]-
f[n],e+=c*c):a[n]>h[n]&&(c=a[n]-h[n],e+=c*c);return e<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,e,f,h){b=vec3.subtract(vec3.create(),b,a);e=vec3.subtract(vec3.create(),e,c);var n=vec3.subtract(vec3.create(),a,c),l=vec3.dot(b,b),k=vec3.dot(b,e),p=vec3.dot(e,e),q=vec3.dot(b,n),t=vec3.dot(e,n),x=l*p-k*k;if(x<EPSILON){var z=0;l=k>p?q/k:t/p}else z=(k*t-p*q)/x,l=(l*t-k*q)/x;f&&vec3.add(f,a,vec3.scale(vec3.create(),b,z));h&&vec3.add(h,c,vec3.scale(vec3.create(),e,l));a=vec3.add(vec3.create(),n,
vec3.subtract(vec3.create(),vec3.scale(vec3.create(),b,z),vec3.scale(vec3.create(),e,l)));return vec3.length(a)},extractPlanes:function(a,b){function c(e){var f=b.subarray(e,e+3);f=vec3.length(f);0!==f&&(f=1/f,b[e]*=f,b[e+1]*=f,b[e+2]*=f,b[e+3]*=f)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],
12);c(12);b.set([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,b){var c=0;var e=planeBoxOverlap(a.subarray(0,4),b);if(e==CLIP_OUTSIDE)return CLIP_OUTSIDE;c+=e;e=planeBoxOverlap(a.subarray(4,8),b);if(e==CLIP_OUTSIDE)return CLIP_OUTSIDE;c+=e;e=planeBoxOverlap(a.subarray(8,12),b);if(e==CLIP_OUTSIDE)return CLIP_OUTSIDE;c+=e;e=planeBoxOverlap(a.subarray(12,16),b);if(e==CLIP_OUTSIDE)return CLIP_OUTSIDE;
c+=e;e=planeBoxOverlap(a.subarray(16,20),b);if(e==CLIP_OUTSIDE)return CLIP_OUTSIDE;c+=e;e=planeBoxOverlap(a.subarray(20,24),b);return e==CLIP_OUTSIDE?CLIP_OUTSIDE:0==c+e?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,b,c){var e=!1;var f=distanceToPlane(a.subarray(0,4),b);if(f<-c)return CLIP_OUTSIDE;f>=-c&&f<=c&&(e=!0);f=distanceToPlane(a.subarray(4,8),b);if(f<-c)return CLIP_OUTSIDE;f>=-c&&f<=c&&(e=!0);f=distanceToPlane(a.subarray(8,12),b);if(f<-c)return CLIP_OUTSIDE;f>=-c&&f<=c&&(e=!0);f=
distanceToPlane(a.subarray(12,16),b);if(f<-c)return CLIP_OUTSIDE;f>=-c&&f<=c&&(e=!0);f=distanceToPlane(a.subarray(16,20),b);if(f<-c)return CLIP_OUTSIDE;f>=-c&&f<=c&&(e=!0);f=distanceToPlane(a.subarray(20,24),b);if(f<-c)return CLIP_OUTSIDE;f>=-c&&f<=c&&(e=!0);return e?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,b){for(var c=!1,e=-1,f=a.length,h=f-1;++e<f;h=e)(a[e][1]<=b[1]&&b[1]<a[h][1]||a[h][1]<=b[1]&&b[1]<a[e][1])&&b[0]<(a[h][0]-a[e][0])*(b[1]-a[e][1])/(a[h][1]-a[e][1])+a[e][0]&&(c=
!c);return c}};C.BBox=m.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:[vec3.fromValues(1,1,1),vec3.fromValues(1,1,-1),vec3.fromValues(1,-1,1),vec3.fromValues(1,-1,-1),vec3.fromValues(-1,1,1),vec3.fromValues(-1,1,-1),vec3.fromValues(-1,-1,1),vec3.fromValues(-1,-1,-1)],create:function(){return new Float32Array(13)},clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},
fromMinMax:function(a,b){var c=this.create();this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,b){var c=this.create();this.setCenterHalfsize(c,a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=a.subarray(6,9),e=a.subarray(9,12);c[0]=b[0];c[1]=b[1];c[2]=b[2];e.set(c);for(var f=3,h=b.length;f<h;f+=3){var n=b[f],l=b[f+1],k=b[f+2];n<c[0]?c[0]=n:n>e[0]&&(e[0]=n);l<c[1]?c[1]=l:l>e[1]&&(e[1]=l);k<c[2]?c[2]=k:k>e[2]&&
(e[2]=k)}a[0]=.5*(c[0]+e[0]);a[1]=.5*(c[1]+e[1]);a[2]=.5*(c[2]+e[2]);a[3]=e[0]-a[0];a[4]=e[1]-a[1];a[5]=e[2]-a[2];a[12]=Math.sqrt(a[3]*a[3]+a[4]*a[4]+a[5]*a[5]);return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];var e=a.subarray(3,6);vec3.sub(e,c,b);vec3.scale(e,e,.5);a[0]=c[0]-e[0];a[1]=c[1]-e[1];a[2]=c[2]-e[2];a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,e){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];
a[6]=a[0]-a[3];a[7]=a[1]-a[4];a[8]=a[2]-a[5];a[9]=a[0]+a[3];a[10]=a[1]+a[4];a[11]=a[2]+a[5];a[12]=e?e:vec3.length(c);return a},transformMat4:function(){for(var a=0,b=0,c=0,e=new Float32Array(24),f=[],h=0;24>h;h+=3)f.push(e.subarray(h,h+3));return function(n,l,k){var p=l[0],q=l[1],t=l[2];a=l[3];b=l[4];c=l[5];l=this.corners;for(var x=0;8>x;++x){var z=l[x],w=f[x];w[0]=a*z[0]+p;w[1]=b*z[1]+q;w[2]=c*z[2]+t;mat4.multiplyVec3(w,k,w)}return this.setFromPoints(n,e)}}(),getCorners:function(a,b){var c=a.subarray(3,
6);b?b.set(this.corners):b=new Float32Array(this.corners);for(var e=0;8>e;++e){var f=b.subarray(3*e,3*e+3);vec3.multiply(f,c,f);vec3.add(f,f,a)}return b},merge:function(a,b,c){var e=a.subarray(6,9),f=a.subarray(9,12);vec3.min(e,b.subarray(6,9),c.subarray(6,9));vec3.max(f,b.subarray(9,12),c.subarray(9,12));return BBox.setMinMax(a,e,f)},extendToPoint:function(a,b){b[0]<a[6]?a[6]=b[0]:b[0]>a[9]&&(a[9]=b[0]);b[1]<a[7]?a[7]=b[1]:b[1]>a[10]&&(a[10]=b[1]);b[2]<a[8]?a[8]=b[2]:b[2]>a[11]&&(a[11]=b[2]);var c=
a.subarray(6,9);b=a.subarray(9,12);c=vec3.add(a.subarray(0,3),c,b);vec3.scale(c,c,.5);vec3.subtract(a.subarray(3,6),b,c);a[12]=vec3.length(a.subarray(3,6));return a},clampPoint:function(a,b,c){a[0]=Math.clamp(c[0],b[0]-b[3],b[0]+b[3]);a[1]=Math.clamp(c[1],b[1]-b[4],b[1]+b[4]);a[2]=Math.clamp(c[2],b[2]-b[5],b[2]+b[5])},isPointInside:function(a,b){return a[0]-a[3]>b[0]||a[1]-a[4]>b[1]||a[2]-a[5]>b[2]||a[0]+a[3]<b[0]||a[1]+a[4]<b[1]||a[2]+a[5]<b[2]?!1:!0},getCenter:function(a){return a.subarray(0,3)},
getHalfsize:function(a){return a.subarray(3,6)},getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,12)},getRadius:function(a){return a[12]}};C.distanceToPlane=m.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};C.planeBoxOverlap=m.planeBoxOverlap=function(a,b){var c=a[3],e=Math.abs(b[3]*a[0])+Math.abs(b[4]*a[1])+Math.abs(b[5]*a[2]);a=vec3.dot(a,b)+c;return a<=-e?CLIP_OUTSIDE:a<=e?CLIP_OVERLAP:CLIP_INSIDE};class da{constructor(a,b){this.faces=this.size=this.max=
this.min=null;this.inside=0;this.c=null;this.min=a;this.max=b;this.size=vec3.sub(vec3.create(),b,a)}}class E{constructor(a,b,c){this.root=null;this.total_nodes=this.total_depth=0;a&&this.buildFromMesh(a,b,c)}}C.Octree=m.Octree=E;E.MAX_NODE_TRIANGLES_RATIO=.05;E.MAX_OCTREE_DEPTH=8;E.OCTREE_MARGIN_RATIO=.01;E.OCTREE_MIN_MARGIN=.1;E.NEAREST=0;E.FIRST=1;E.ALL=2;E.prototype.buildFromMesh=function(a,b,c){this.total_nodes=this.total_depth=0;b=b||0;var e=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=
a.data;c||=a?a.length:e.length/3;var f=a?this.computeAABBFromIndices(e,a,b,c):this.computeAABB(e);this.root=f=new da(f.min,f.max);this.total_nodes=1;this.total_triangles=a?a.length/3:e.length/9;this.max_node_triangles=this.total_triangles*E.MAX_NODE_TRIANGLES_RATIO;var h=vec3.create();vec3.scale(h,f.size,E.OCTREE_MARGIN_RATIO);h[0]<E.OCTREE_MIN_MARGIN&&(h[0]=E.OCTREE_MIN_MARGIN);h[1]<E.OCTREE_MIN_MARGIN&&(h[1]=E.OCTREE_MIN_MARGIN);h[2]<E.OCTREE_MIN_MARGIN&&(h[2]=E.OCTREE_MIN_MARGIN);vec3.sub(f.min,
f.min,h);vec3.add(f.max,f.max,h);f.faces=[];h=b+c;if(a)for(;b<h;b+=3){var n=new Float32Array([e[3*a[b]],e[3*a[b]+1],e[3*a[b]+2],e[3*a[b+1]],e[3*a[b+1]+1],e[3*a[b+1]+2],e[3*a[b+2]],e[3*a[b+2]+1],e[3*a[b+2]+2],b/3]);E.isValidFace(n)&&this.addToNode(n,f,0)}else for(b*=3;b<3*c;b+=9)n=new Float32Array(10),n.set(e.subarray(b,b+9)),n[9]=b/9,E.isValidFace(n)&&this.addToNode(n,f,0);this.total_nodes=this.trim();return f};E.isValidFace=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(e){var f=
e.subarray(0,3),h=e.subarray(3,6);e=e.subarray(6,9);vec3.sub(a,h,f);vec3.sub(b,e,f);vec3.cross(c,a,b);return 0<vec3.length(c)}}();E.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){for(var e=this.computeAABB(a),f=!1,h=0;h<b.c.length;++h){var n=b.c[h];if(E.isInsideAABB(e,n)){this.addToNode(a,n,c+1);f=!0;break}}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<E.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<
c+1&&(this.total_depth=c+1);var l=b.faces;b.faces=null;for(h=0;h<l.length;++h){a=l[h];e=this.computeAABB(a);f=!1;for(var k=0;k<b.c.length;++k)if(n=b.c[k],E.isInsideAABB(e,n)){this.addToNode(a,n,c+1);f=!0;break}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};E.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];E.prototype.splitNode=function(a){a.c=[];for(var b=[.5*(a.max[0]-a.min[0]),.5*(a.max[1]-a.min[1]),.5*(a.max[2]-a.min[2])],c=0;c<this.octree_pos_ref.length;++c){var e=
this.octree_pos_ref[c];e=[a.min[0]+b[0]*e[0],a.min[1]+b[1]*e[1],a.min[2]+b[2]*e[2]];e=new da(e,[e[0]+b[0],e[1]+b[1],e[2]+b[2]]);this.total_nodes+=1;e.faces=null;e.inside=0;a.c.push(e)}};E.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array(b),e=3;e<a.length-1;e+=3)for(var f=0;3>f;f++)b[f]>a[e+f]&&(b[f]=a[e+f]),c[f]<a[e+f]&&(c[f]=a[e+f]);return{min:b,max:c}};E.prototype.computeAABBFromIndices=function(a,b,c,e){c=c||0;e=e||b.length;for(var f=b[c],h=new Float32Array([a[3*
f],a[3*f+1],a[3*f+2]]),n=new Float32Array([a[3*f],a[3*f+1],a[3*f+2]]),l=c+1;l<c+e;++l){f=3*b[l];for(var k=0;3>k;k++)h[k]>a[f+k]&&(h[k]=a[f+k]),n[k]<a[f+k]&&(n[k]=a[f+k])}return{min:h,max:n}};E.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;for(var b=1,c=[],e=a.c,f=0;f<e.length;++f)e[f].inside&&(c.push(e[f]),b+=this.trim(e[f]));a.c=c;return b};E.prototype.testRay=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),e=vec3.create();return function(f,h,n,l,k,p){p=p||E.NEAREST;if(!this.root)throw"Error: octree not build";
a.set(f);b.set(h);c.set(this.root.min);e.set(this.root.max);n=E.hitTestBox(a,b,c,e);if(!n)return null;n=E.testRayInNode(this.root,a,b,k,p);if(null==n)return null;if(p==E.ALL)return n;h=vec3.scale(vec3.create(),h,n.t);vec3.add(h,h,f);n.pos=h;return n}}();E.testRayInNode=function(a,b,c,e,f){var h=null;if(a.faces)for(var n=0,l=a.faces.length;n<l;++n){var k=a.faces[n];var p=E.hitTestTriangle(b,c,k.subarray(0,3),k.subarray(3,6),k.subarray(6,9),e);if(null!=p){p.index=k[9];if(f==E.FIRST)return p;f==E.ALL?
(h||=[],h.push(p)):(p.face=k,h?h.mergeWith(p):h=p)}}l=vec3.create();k=vec3.create();if(a.c)for(n=0;n<a.c.length;++n){var q=a.c[n];l.set(q.min);k.set(q.max);p=E.hitTestBox(b,c,l,k);if(null!=p&&!(f!=E.ALL&&h&&p.t>h.t)&&(p=E.testRayInNode(q,b,c,e,f),null!=p)){if(f==E.FIRST)return p;f==E.ALL?(h||=[],h.push(p)):h?h.mergeWith(p):h=p}}return h};E.prototype.testSphere=function(a,b){a=vec3.clone(a);if(!this.root)throw"Error: octree not build";b*=b;return E.testSphereBox(a,b,vec3.clone(this.root.min),vec3.clone(this.root.max))?
E.testSphereInNode(this.root,a,b):!1};E.testSphereInNode=function(a,b,c){if(a.faces)for(var e=0,f=a.faces.length;e<f;++e){var h=a.faces[e];if(E.testSphereTriangle(b,c,h.subarray(0,3),h.subarray(3,6),h.subarray(6,9)))return!0}f=vec3.create();h=vec3.create();if(a.c)for(e=0;e<a.c.length;++e){var n=a.c[e];f.set(n.min);h.set(n.max);if(E.testSphereBox(b,c,f,h)&&E.testSphereInNode(n,b,c))return!0}return!1};E.prototype.findNearestPoint=function(a,b,c,e){c=c||Infinity;if(a===b)throw"findNearestPoint input point and output cannot be the same";
return E.nearestInNode(this.root,a,b,c,e)};E.nearestInNode=function(a,b,c,e,f){var h=vec3.create(),n;f&&(n=vec3.create());if(a.faces)for(var l=0,k=a.faces.length;l<k;++l){var p=a.faces[l],q=p.subarray(0,3),t=p.subarray(3,6);p=p.subarray(6,9);E.closestPointOnTriangle(b,q,t,p,h);var x=vec3.dist(h,b);x<e&&(e=x,vec3.copy(c,h),f&&geo.computeTriangleNormal(f,q,t,p))}if(!a.c)return e;for(l=0;l<a.c.length;++l)k=a.c[l],E.distanceToBox(b,k.min,k.max)>e||(x=E.nearestInNode(k,b,h,e,n),x<e&&(e=x,vec3.copy(c,h),
f&&vec3.copy(f,n)));return e};E.closestPointOnTriangle=function(){var a=new Float32Array(4),b=vec3.create(),c=vec3.create(),e=vec3.create(),f=vec3.create();return function(h,n,l,k,p){geo.planeFromTriangle(a,n,l,k);if(1E-8<vec3.length(a)&&(geo.projectPointOnPlane(h,n,a,b),geo.isPointInsideTriangle(b,n,l,k)))return vec3.copy(p,b),p;geo.closestPointToSegment(b,n,l,c);geo.closestPointToSegment(b,l,k,e);geo.closestPointToSegment(b,k,n,f);h=vec3.sqrDist(b,c);n=vec3.sqrDist(b,e);l=vec3.sqrDist(b,f);l=Math.min(h,
n,l);l===h?vec3.copy(p,c):l===n?vec3.copy(p,e):vec3.copy(p,f);return p}}();E.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?!1:!0};E.distanceToBox=function(a,b,c){var e=.5*(c[0]+b[0]),f=.5*(c[1]+b[1]);b=.5*(c[2]+b[2]);e=Math.abs(a[0]-e)-(c[0]-e);f=Math.abs(a[1]-f)-(c[1]-f);a=Math.abs(a[2]-b)-(c[2]-b);c=Math.min(Math.max(e,f,a),0);e=Math.max(e,0);f=Math.max(f,0);a=Math.max(a,0);return Math.sqrt(e*e+
f*f+a*a)+c};E.hitTestBox=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),e=vec3.create(),f=vec3.create(),h=vec3.create(),n=vec3.fromValues(1E-6,1E-6,1E-6);return function(l,k,p,q){vec3.subtract(a,p,l);vec3.subtract(b,q,l);if(0>vec3.maxValue(a)&&0<vec3.minValue(b))return new V(0,l,k);c[0]=1/k[0];c[1]=1/k[1];c[2]=1/k[2];vec3.multiply(a,a,c);vec3.multiply(b,b,c);vec3.min(e,a,b);vec3.max(f,a,b);var t=vec3.maxValue(e),x=vec3.minValue(f);return 0<t&&t<x?(l=vec3.add(vec3.create(),vec3.scale(h,
k,t),l),vec3.add(p,p,n),vec3.subtract(p,p,n),new V(t,l,vec3.fromValues((l[0]>q[0])-(l[0]<p[0]),(l[1]>q[1])-(l[1]<p[1]),(l[2]>q[2])-(l[2]<p[2])))):null}}();E.hitTestTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),e=vec3.create();return function(f,h,n,l,k,p){vec3.subtract(a,l,n);vec3.subtract(b,k,n);l=vec3.cross(vec3.create(),a,b);vec3.normalize(l,l);if(!p&&0<vec3.dot(l,h))return null;p=vec3.dot(l,vec3.subtract(e,n,f))/vec3.dot(l,h);if(0<p){h=vec3.scale(vec3.create(),h,p);vec3.add(h,
h,f);vec3.subtract(c,h,n);f=vec3.dot(b,b);n=vec3.dot(b,a);k=vec3.dot(b,c);var q=vec3.dot(a,a),t=vec3.dot(a,c),x=f*q-n*n;q=(q*k-n*t)/x;f=(f*t-n*k)/x;if(0<=q&&0<=f&&1>=q+f)return new V(p,h,l)}return null}}();E.testSphereTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),e=vec3.create(),f=vec3.create(),h=vec3.create(),n=vec3.create(),l=vec3.create();return function(k,p,q,t,x){vec3.sub(a,q,k);vec3.sub(b,t,k);vec3.sub(c,x,k);vec3.sub(e,b,a);vec3.sub(f,c,a);vec3.cross(l,e,f);k=vec3.dot(a,
l);q=vec3.dot(l,l);k=k*k>p*q;var z=vec3.dot(a,a),w=vec3.dot(a,b),r=vec3.dot(a,c),v=vec3.dot(b,b),A=vec3.dot(b,c),y=vec3.dot(c,c);q=z>p&w>z&r>z;t=v>p&w>v&A>v;x=y>p&r>y&A>y;z=w-z;w=A-v;var u=r-y;vec3.sub(h,c,b);vec3.sub(n,a,c);v=vec3.dot(e,e);y=vec3.dot(h,h);r=vec3.dot(n,n);A=vec3.scale(vec3.create(),a,v);vec3.sub(A,A,vec3.scale(vec3.create(),e,z));z=vec3.scale(vec3.create(),b,y);vec3.sub(z,z,vec3.scale(vec3.create(),h,w));w=vec3.scale(vec3.create(),c,r);vec3.sub(w,w,vec3.scale(vec3.create(),n,u));
var B=vec3.scale(vec3.create(),c,v);B=vec3.sub(B,B,A);var D=vec3.scale(vec3.create(),a,y);D=vec3.sub(D,D,z);u=vec3.scale(vec3.create(),b,r);u=vec3.sub(u,u,w);v=vec3.dot(A,A)>p*v*v&0<vec3.dot(A,B);y=vec3.dot(z,z)>p*y*y&0<vec3.dot(z,D);p=vec3.dot(w,w)>p*r*r&0<vec3.dot(w,u);return!(k|q|t|x|v|y|p)}}();E.testSphereBox=function(a,b,c,e){for(var f,h=0,n=0;3>n;++n)a[n]<c[n]?(f=a[n]-c[n],h+=f*f):a[n]>e[n]&&(f=a[n]-e[n],h+=f*f);return h<=b?!0:!1};class V{constructor(a,b,c,e){this.t=arguments.length?a:Number.MAX_VALUE;
this.hit=b;this.normal=c;this.face=null;this.index=e}}C.HitTest=m.HitTest=V;V.prototype.mergeWith=function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal,this.face=a.face,this.index=a.index)};C.Ray=m.Ray=function(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();this.t=-1;a&&this.origin.set(a);b&&this.direction.set(b)};Ray.prototype.testPlane=function(a,b){a=geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point);this.t=
geo.last_t;return a};Ray.prototype.testSphere=function(a,b,c){a=geo.testRaySphere(this.origin,this.direction,a,b,this.collision_point,c);this.t=geo.last_t;return a};Ray.prototype.testBBox=function(a,b,c,e){a=geo.testRayBBox(this.origin,this.direction,a,c,this.collision_point,b,e);this.t=geo.last_t;return a};C.Raytracer=m.Raytracer=function(a,b){this.viewport=vec4.create();this.ray00=vec3.create();this.ray10=vec3.create();this.ray01=vec3.create();this.ray11=vec3.create();this.eye=vec3.create();this.setup(a,
b)};Raytracer.prototype.setup=function(a,b){b=b||gl.viewport_data;this.viewport.set(b);var c=b[0],e=c+b[2],f=b[1],h=f+b[3];vec3.set(this.ray00,c,f,1);vec3.set(this.ray10,e,f,1);vec3.set(this.ray01,c,h,1);vec3.set(this.ray11,e,h,1);vec3.unproject(this.ray00,this.ray00,a,b);vec3.unproject(this.ray10,this.ray10,a,b);vec3.unproject(this.ray01,this.ray01,a,b);vec3.unproject(this.ray11,this.ray11,a,b);c=this.eye;vec3.unproject(c,c,a,b);vec3.subtract(this.ray00,this.ray00,c);vec3.subtract(this.ray10,this.ray10,
c);vec3.subtract(this.ray01,this.ray01,c);vec3.subtract(this.ray11,this.ray11,c)};Raytracer.prototype.getRayForPixel=function(){var a=vec3.create(),b=vec3.create();return function(c,e,f){f=f||vec3.create();c=(c-this.viewport[0])/this.viewport[2];e=1-(e-this.viewport[1])/this.viewport[3];vec3.lerp(a,this.ray00,this.ray10,c);vec3.lerp(b,this.ray01,this.ray11,c);vec3.lerp(f,a,b,e);return vec3.normalize(f,f)}}();var fa=mat4.create();Raytracer.hitTestBox=function(a,b,c,e,f){var h=new Float32Array(30);
f&&(f=mat4.invert(fa,f),a=mat4.multiplyVec3(h.subarray(3,6),f,a),b=mat4.rotateVec3(h.subarray(6,9),f,b));var n=vec3.subtract(h.subarray(9,12),c,a);vec3.divide(n,n,b);var l=vec3.subtract(h.subarray(12,15),e,a);vec3.divide(l,l,b);f=vec3.min(h.subarray(15,18),n,l);n=vec3.max(h.subarray(18,21),n,l);f=vec3.maxValue(f);n=vec3.minValue(n);return 0<f&&f<=n?(b=vec3.scale(h.subarray(21,24),b,f),vec3.add(b,a,b),vec3.addValue(h.subarray(24,27),c,1E-6),vec3.subValue(h.subarray(27,30),e,1E-6),new V(f,b,vec3.fromValues((b[0]>
e[0])-(b[0]<c[0]),(b[1]>e[1])-(b[1]<c[1]),(b[2]>e[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,e){var f=vec3.subtract(vec3.create(),a,c),h=vec3.dot(b,b),n=2*vec3.dot(b,f);f=vec3.dot(f,f)-e*e;f=n*n-4*h*f;return 0<f?(h=(-n-Math.sqrt(f))/(2*h),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,h)),new V(h,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/e))):null};Raytracer.hitTestTriangle=function(a,b,c,e,f){var h=vec3.subtract(vec3.create(),e,c),n=vec3.subtract(vec3.create(),
f,c);f=vec3.cross(vec3.create(),h,n);vec3.normalize(f,f);e=vec3.dot(f,vec3.subtract(vec3.create(),c,a))/vec3.dot(f,b);if(0<e){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,e));var l=vec3.subtract(vec3.create(),a,c);c=vec3.dot(n,n);b=vec3.dot(n,h);n=vec3.dot(n,l);var k=vec3.dot(h,h);h=vec3.dot(h,l);l=c*k-b*b;k=(k*n-b*h)/l;h=(c*h-b*n)/l;if(0<=k&&0<=h&&1>=k+h)return new V(e,a,f)}return null};Mesh.parseOBJ=function(a,b){function c(I){var K,O,U=!1;if(-1==I.indexOf("-")){var S=v.get(I);if(void 0!==
S)return S}else U=!0;N||=I.split("/");if(1==N.length)var N=O=K=parseInt(N[0]);else if(2==N.length)K=parseInt(N[0]),O=parseInt(N[1]),N=K;else if(3==N.length)K=parseInt(N[0]),O=parseInt(N[1]),N=parseInt(N[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;0>K&&(K=n.length/3+K+1);0>N&&(N=l.length/2+N+1);0>O&&(O=k.length/2+O+1);if(U&&(I=K+"/"+O+"/"+N,S=v.get(I),void 0!==S))return S;--K;--O;--N;p.push(n[3*K],n[3*K+1],n[3*K+2]);k.length&&t.push(k[2*O],k[2*O+1]);l.length&&
q.push(l[3*N],l[3*N+1],l[3*N+2]);S=A;v.set(I,S);++A;return S}function e(I){I={name:I||"",material:"",start:-1,length:-1,indices:[]};x.push(I);return I}function f(I){if(!r.material)return r.material=I+h,z[I]=r;var K=z[I];K||(K=e(w+"_"+I),K.material=I+h,z[I]=K);return r=K}b=b||{};var h=b.matextension||"",n=[],l=[],k=[],p=[],q=[],t=[],x=[],z={},w=null,r=e(),v=new Map,A=0,y=1;b.scale&&(y=b.scale);var u={v:1,vt:2,vn:3,f:4,g:5,o:6,usemtl:7,mtllib:8},B;a=a.split("\n");for(var D=a.length,G=0;G<D;++G){var F=
a[G];F=F.replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if("\\"==F[F.length-1]){G+=1;var H=a[G].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");F=(F.substr(0,F.length-1)+H).replace(/[ \t]+/g," ").replace(/\s\s*$/,"")}if("#"!=F[0]&&""!=F){H=F.split(" ");F=u[H[0]];if(3>=F){var M=parseFloat(H[1]);var T=parseFloat(H[2]);2!=F&&(B=parseFloat(H[3]))}switch(F){case 1:M*=y;T*=y;B*=y;n.push(M,T,B);break;case 2:k.push(M,T);break;case 3:l.push(M,T,B);break;case 4:if(4>H.length)continue;var Q=[];for(F=1;F<H.length;++F)Q.push(c(H[F]));
r.indices.push(Q[0],Q[1],Q[2]);for(F=2;F<Q.length-1;++F)r.indices.push(Q[0],Q[F],Q[F+1]);break;case 5:case 6:w=F=H[1];r.name?(z={},r=e(F)):r.name=F;break;case 7:f(H[1])}}}u=[];M=0;y=[];for(F=0;F<x.length;++F)r=x[F],r.indices&&(r.start=M,r.length=r.indices.length,u=u.concat(r.indices),delete r.indices,M+=r.length,y.push(r));x=y;y={};if(!n.length)return console.error("mesh without vertices"),null;if(b.flip_normals&&q.length)for(l=q,F=0;F<l.length;++F)l[F]*=-1;y.vertices=new Float32Array(p);q.length&&
(y.normals=new Float32Array(q));t.length&&(y.coords=new Float32Array(t));u&&0<u.length&&(y.triangles=new (65536<M?Uint32Array:Uint16Array)(u));y.bounding=m.Mesh.computeBoundingBox(y.vertices);u={};1<x.length&&(u.groups=x);y.info=u;if(!y.bounding)return console.log("empty mesh"),null;if(b.only_data)return y;u=null;return u=Mesh.load(y,null,b.mesh)};Mesh.parsers.obj=Mesh.parseOBJ;Mesh.encoders.obj=function(a,b){var c=a.getBuffer("vertices");if(!c)return null;b=[];b.push("# Generated with liteGL.js by Javi Agenjo\n");
for(var e=c.data,f=0;f<e.length;f+=3)b.push("v "+e[f].toFixed(4)+" "+e[f+1].toFixed(4)+" "+e[f+2].toFixed(4));if(c=a.getBuffer("normals"))for(b.push(""),c=c.data,f=0;f<c.length;f+=3)b.push("vn "+c[f].toFixed(4)+" "+c[f+1].toFixed(4)+" "+c[f+2].toFixed(4));if(c=a.getBuffer("coords"))for(b.push(""),c=c.data,f=0;f<c.length;f+=2)b.push("vt "+c[f].toFixed(4)+" "+c[f+1].toFixed(4)+"  0.0000");c=a.info.groups;if(a=a.getIndexBuffer("triangles"))for(a=a.data,c&&c.length||(c=[{start:0,length:a.length,name:"mesh"}]),
e=0;e<c.length;++e){f=c[e];b.push("g "+f.name);var h=f.material||"mat_"+e;-1!=h.indexOf(".json")&&(h=h.substr(0,h.indexOf(".json")));b.push("usemtl "+h);h=f.start;var n=h+f.length;for(f=h;f<n;f+=3)b.push("f "+(a[f]+1)+"/"+(a[f]+1)+"/"+(a[f]+1)+" "+(a[f+1]+1)+"/"+(a[f+1]+1)+"/"+(a[f+1]+1)+" "+(a[f+2]+1)+"/"+(a[f+2]+1)+"/"+(a[f+2]+1))}else for(c&&c.length||(c=[{start:0,length:e.length/3,name:"mesh"}]),e=0;e<c.length;++e)for(f=c[e],b.push("g "+f.name),b.push("usemtl "+(f.material||"mat_"+e)),h=f.start,
n=h+f.length,f=h;f<n;f+=3)b.push("f "+(f+1)+"/"+(f+1)+"/"+(f+1)+" "+(f+2)+"/"+(f+2)+"/"+(f+2)+" "+(f+3)+"/"+(f+3)+"/"+(f+3));return b.join("\n")};Mesh.parsers.mesh=function(a,b){var c={};a=a.split("\n");for(var e=0;e<a.length;++e){var f=a[e],h=f[0];f=f.substr(1).split(",");var n=f[0];if("-"==h){var l=1;h=Float32Array;if("weights"==n||"bone_indices"==n)h=Uint8Array;"weights"==n&&(l=255);var k=new h(Number(f[1]));for(h=0;h<k.length;++h)k[h]=Number(f[h+2])*l;c[n]=k}else if("*"==h){h=Uint16Array;65536<
Number(f[1])&&(h=Uint32Array);k=new h(Number(f[1]));for(h=0;h<k.length;++h)k[h]=Number(f[h+2]);c[n]=k}else if("@"==h)if("bones"==n){n=[];l=Number(f[1]);for(h=0;h<l;++h)k=f.slice(3+17*h,3+17*(h+1)-1).map(Number),n.push([f[2+17*h],k]);c.bones=n}else if("bind_matrix"==n)c.bind_matrix=f.slice(1,17).map(Number);else{if("groups"==n)for(c.info={groups:[]},n=Number(f[1]),h=0;h<n;++h)c.info.groups.push({name:f[2+4*h],material:f[4*h+3],start:Number(f[4*h+4]),length:Number(f[4*h+5])})}else console.warn("type unknown: "+
f[0])}if(b.only_data)return c;b=Mesh.load(c,null,b.mesh);b.updateBoundingBox();return b};Mesh.encoders.mesh=function(a,b){b=[];for(var c in a.vertexBuffers){var e=a.vertexBuffers[c],f=typedArrayToArray(e.data);if(e.normalize&&e.data.constructor==Uint8Array)for(var h=0;h<f.length;++h)f[h]/=255;h=["-"+c,e.data.length,e.data,f];b.push(h.join(","))}for(c in a.indexBuffers)e=a.indexBuffers[c],f=typedArrayToArray(e.data),h=["*"+c,e.data.length,e.data,f],b.push(h.join(","));a.bounding&&b.push(["@bounding",
typedArrayToArray(a.bounding.subarray(0,6))].join());if(a.info&&a.info.groups){c=[];for(h=0;h<a.info.groups.length;++h)e=a.info.groups[h],c.push(e.name,e.material,e.start,e.length);b.push(["@groups",a.info.groups.length].concat(c).join(","))}a.bones&&b.push(["@bones",a.bones.length,a.bones.flat()].join());a.bind_matrix&&b.push(["@bind_matrix",typedArrayToArray(a.bind_matrix)].join());return b.join("\n")};C.WBin&&(C.WBin.classes.Mesh=Mesh);Mesh.binary_file_formats.wbin=!0;Mesh.parsers.wbin=Mesh.fromBinary=
function(a,b){b=b||{};if(a.constructor==ArrayBuffer){if(!C.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";a=WBin.load(a,!0)}a.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",a["@classname"]);a.format&&m.Mesh.decompress(a);var c={};if(a.vertex_buffers)for(var e in a.vertex_buffers)c[a.vertex_buffers[e]]=a[a.vertex_buffers[e]];else a.vertices&&(c.vertices=a.vertices),a.normals&&(c.normals=
a.normals),a.coords&&(c.coords=a.coords),a.weights&&(c.weights=a.weights),a.bone_indices&&(c.bone_indices=a.bone_indices);var f={};if(a.index_buffers)for(e in a.index_buffers)f[a.index_buffers[e]]=a[a.index_buffers[e]];else a.triangles&&(f.triangles=a.triangles),a.wireframe&&(f.wireframe=a.wireframe);c={vertex_buffers:c,index_buffers:f,bounding:a.bounding,info:a.info};if(a.bones){c.bones=a.bones;for(e=0;e<c.bones.length;++e)c.bones[e][1]=mat4.clone(c.bones[e][1]);a.bind_matrix&&(c.bind_matrix=mat4.clone(a.bind_matrix))}a.morph_targets&&
(c.morph_targets=a.morph_targets);if(b.only_data)return c;b=b.mesh||new m.Mesh;b.configure(c);return b};Mesh.encoders.wbin=function(a,b){a.updateBoundingBox();return a.toBinary(b)};Mesh.prototype.toBinary=function(a){if(!C.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});a={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var b=[],c=0;c<this.bones.length;++c)b.push([this.bones[c][0],mat4.toArray(this.bones[c][1])]);
a.bones=b;this.bind_matrix&&(a.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox();a.bounding=this.bounding;b=[];var e=[];for(c in this.vertexBuffers){var f=this.vertexBuffers[c];a[f.name]=f.data;b.push(f.name);"vertices"==f.name&&(a.info.num_vertices=f.data.length/3)}for(c in this.indexBuffers)f=this.indexBuffers[c],a[c]=f.data,e.push(c);a.vertex_buffers=b;a.index_buffers=e;m.Mesh.enable_wbin_compression&&m.Mesh.compress(a);return WBin.create(a,"Mesh")};Mesh.compress=function(a,
b){b=b||"bounding_compressed";a.format={type:b};var c=Mesh.compressors[b];if(!c)throw"compression format not supported:"+b;return c(a)};Mesh.decompress=function(a){if(a.format){var b=Mesh.decompressors[a.format.type];if(!b)throw"decompression format not supported:"+a.format.type;return b(a)}};Mesh.compressors.bounding_compressed=function(a){if(!a.vertex_buffers)throw"buffers not found";var b=BBox.getMin(a.bounding),c=BBox.getMax(a.bounding),e=vec3.sub(vec3.create(),c,b),f=a.vertices,h=new Uint16Array(f.length);
for(c=0;c<f.length;c+=3)h[c]=(f[c]-b[0])/e[0]*65535,h[c+1]=(f[c+1]-b[1])/e[1]*65535,h[c+2]=(f[c+2]-b[2])/e[2]*65535;a.vertices=h;if(a.normals){e=a.normals;b=new Uint8Array(e.length);f=b.constructor==Uint8Array?255:65535;for(c=0;c<e.length;c+=3)b[c]=(.5*e[c]+.5)*f,b[c+1]=(.5*e[c+1]+.5)*f,b[c+2]=(.5*e[c+2]+.5)*f;a.normals=b}if(a.coords){b=a.coords;f=[1E4,1E4,-1E4,-1E4];for(c=0;c<b.length;c+=2)e=b[c],f[0]>e?f[0]=e:f[2]<e&&(f[2]=e),e=b[c+1],f[1]>e?f[1]=e:f[3]<e&&(f[3]=e);a.format.uvs_bounding=f;h=new Uint16Array(b.length);
e=[f[2]-f[0],f[3]-f[1]];for(c=0;c<b.length;c+=2)h[c]=(b[c]-f[0])/e[0]*65535,h[c+1]=(b[c+1]-f[1])/e[1]*65535;a.coords=h}if(a.weights){e=a.weights;b=new Uint16Array(e.length);f=b.constructor==Uint8Array?255:65535;for(c=0;c<e.length;c+=4)b[c]=e[c]*f,b[c+1]=e[c+1]*f,b[c+2]=e[c+2]*f,b[c+3]=e[c+3]*f;a.weights=b}};Mesh.decompressors.bounding_compressed=function(a){var b=a.bounding;if(!b)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";var c=BBox.getMin(b);
b=BBox.getMax(b);var e=vec3.sub(vec3.create(),b,c),f=a.format,h=1/255,n=1/65535,l=a.vertices,k=new Float32Array(l.length);b=0;for(var p=l.length;b<p;b+=3)k[b]=l[b]*n*e[0]+c[0],k[b+1]=l[b+1]*n*e[1]+c[1],k[b+2]=l[b+2]*n*e[2]+c[2];a.vertices=k;if(a.normals&&a.normals.constructor!=Float32Array){e=a.normals;c=new Float32Array(e.length);l=e.constructor==Uint8Array?h:n;b=0;for(p=e.length;b<p;b+=3)c[b]=e[b]*l*2-1,c[b+1]=e[b+1]*l*2-1,c[b+2]=e[b+2]*l*2-1,k=c.subarray(b,b+3),vec3.normalize(k,k);a.normals=c}if(a.coords&&
f.uvs_bounding&&a.coords.constructor!=Float32Array){c=a.coords;f=f.uvs_bounding;e=[f[2]-f[0],f[3]-f[1]];l=new Float32Array(c.length);b=0;for(p=c.length;b<p;b+=2)l[b]=c[b]*n*e[0]+f[0],l[b+1]=c[b+1]*n*e[1]+f[1];a.coords=l}if(a.weights&&a.weights.constructor!=Float32Array){f=a.weights;e=new Float32Array(f.length);h=f.constructor==Uint8Array?h:n;b=0;for(p=f.length;b<p;b+=4)e[b]=f[b]*h,e[b+1]=f[b+1]*h,e[b+2]=f[b+2]*h,e[b+3]=f[b+3]*h;a.weights=e}}})("undefined"!=typeof window?window:"undefined"!=typeof self?
self:global);
