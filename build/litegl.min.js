'use strict';(function(r){function X(){return Array.prototype.slice.call(this)}function T(g,e){if(g.constructor===e)return g;if(g.constructor!==Array)return e=e||Float32Array,new e(g);e=e||Float32Array;for(var a=g[0].length,b=new e(g.length*a),c=0;c<g.length;++c)for(var d=0;d<a;++d)b[c*a+d]=g[c][d];return b}function N(g,e,a,b,c){g=g||1024;h.debug&&console.log("GL.Mesh created");null!==c&&(this.gl=c=c||r.gl);this._context_id=c.context_id;this.vertexBuffers={};this.indexBuffers={};this.info={groups:[]};
this._bounding=BBox.create();this.resize(g)}function D(g,e,a,b){this.gl=b=b||r.gl;this._context_id=b.context_id;if(g&&g.constructor!==Array)throw"FBO textures must be an Array";this.handler=null;this.height=this.width=-1;this.color_textures=[];this.depth_texture=null;this.stencil=!!a;this._stencil_enabled=!1;this._num_binded_textures=0;this.order=null;(g&&g.length||e)&&this.setTextures(g,e);this._old_fbo_handler=null;this._old_viewport=new Float32Array(4)}var h=r.GL=r.LiteGL={};if("undefined"==typeof S){if("undefined"==
typeof self)if("undefined"==typeof window){if("undefined"===typeof SKIP_REQUIRES){console.log("importing glMatrix");r.glMatrix=require("./gl-matrix-min.js");var S=r.glMatrix,O;for(O in S)r[O]=S[O]}}else if("undefined"==typeof S)throw"litegl.js requires gl-matrix to work. It must be included before litegl.";}else if(!r.vec2)throw"litegl.js does not support gl-matrix 3.0, download 2.8 https://github.com/toji/gl-matrix/releases/tag/v2.8.1";r.requestAnimationFrame=r.requestAnimationFrame||r.mozRequestAnimationFrame||
r.webkitRequestAnimationFrame||function(g){setTimeout(g,1E3/60)};h.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};h.reverse=null;h.LEFT_MOUSE_BUTTON=0;h.MIDDLE_MOUSE_BUTTON=1;h.RIGHT_MOUSE_BUTTON=2;h.LEFT_MOUSE_BUTTON_MASK=1;h.RIGHT_MOUSE_BUTTON_MASK=2;h.MIDDLE_MOUSE_BUTTON_MASK=4;h.last_context_id=0;h.COLOR_BUFFER_BIT=16384;h.DEPTH_BUFFER_BIT=256;h.STENCIL_BUFFER_BIT=1024;h.TEXTURE_2D=3553;h.TEXTURE_CUBE_MAP=34067;h.TEXTURE_3D=32879;h.TEXTURE_MAG_FILTER=10240;h.TEXTURE_MIN_FILTER=10241;h.TEXTURE_WRAP_S=
10242;h.TEXTURE_WRAP_T=10243;h.BYTE=5120;h.UNSIGNED_BYTE=5121;h.SHORT=5122;h.UNSIGNED_SHORT=5123;h.INT=5124;h.UNSIGNED_INT=5125;h.FLOAT=5126;h.HALF_FLOAT_OES=36193;h.HALF_FLOAT=5131;h.DEPTH_COMPONENT16=33189;h.DEPTH_COMPONENT24=33190;h.DEPTH_COMPONENT32F=36012;h.FLOAT_VEC2=35664;h.FLOAT_VEC3=35665;h.FLOAT_VEC4=35666;h.INT_VEC2=35667;h.INT_VEC3=35668;h.INT_VEC4=35669;h.BOOL=35670;h.BOOL_VEC2=35671;h.BOOL_VEC3=35672;h.BOOL_VEC4=35673;h.FLOAT_MAT2=35674;h.FLOAT_MAT3=35675;h.FLOAT_MAT4=35676;h.TYPE_LENGTH=
{};h.TYPE_LENGTH[h.FLOAT]=h.TYPE_LENGTH[h.INT]=h.TYPE_LENGTH[h.BYTE]=h.TYPE_LENGTH[h.BOOL]=1;h.TYPE_LENGTH[h.FLOAT_VEC2]=h.TYPE_LENGTH[h.INT_VEC2]=h.TYPE_LENGTH[h.BOOL_VEC2]=2;h.TYPE_LENGTH[h.FLOAT_VEC3]=h.TYPE_LENGTH[h.INT_VEC3]=h.TYPE_LENGTH[h.BOOL_VEC3]=3;h.TYPE_LENGTH[h.FLOAT_VEC4]=h.TYPE_LENGTH[h.INT_VEC4]=h.TYPE_LENGTH[h.BOOL_VEC4]=4;h.TYPE_LENGTH[h.FLOAT_MAT3]=9;h.TYPE_LENGTH[h.FLOAT_MAT4]=16;h.SAMPLER_2D=35678;h.SAMPLER_3D=35679;h.SAMPLER_CUBE=35680;h.INT_SAMPLER_2D=36298;h.INT_SAMPLER_3D=
36299;h.INT_SAMPLER_CUBE=36300;h.UNSIGNED_INT_SAMPLER_2D=36306;h.UNSIGNED_INT_SAMPLER_3D=36307;h.UNSIGNED_INT_SAMPLER_CUBE=36308;h.DEPTH_COMPONENT=6402;h.ALPHA=6406;h.RGB=6407;h.RGBA=6408;h.LUMINANCE=6409;h.LUMINANCE_ALPHA=6410;h.DEPTH_STENCIL=34041;h.UNSIGNED_INT_24_8_WEBGL=34042;h.R8=33321;h.R16F=33325;h.R32F=33326;h.R8UI=33330;h.RG8=33323;h.RG16F=33327;h.RG32F=33328;h.RGB8=32849;h.SRGB8=35905;h.RGB565=36194;h.R11F_G11F_B10F=35898;h.RGB9_E5=35901;h.RGB16F=34843;h.RGB32F=34837;h.RGB8UI=36221;h.RGBA8=
32856;h.RGB5_A1=32855;h.RGBA16F=34842;h.RGBA32F=34836;h.RGBA8UI=36220;h.RGBA16I=36232;h.RGBA16UI=36214;h.RGBA32I=36226;h.RGBA32UI=36208;h.NEAREST=9728;h.LINEAR=9729;h.NEAREST_MIPMAP_NEAREST=9984;h.LINEAR_MIPMAP_NEAREST=9985;h.NEAREST_MIPMAP_LINEAR=9986;h.LINEAR_MIPMAP_LINEAR=9987;h.REPEAT=10497;h.CLAMP_TO_EDGE=33071;h.MIRRORED_REPEAT=33648;h.ZERO=0;h.ONE=1;h.SRC_COLOR=768;h.ONE_MINUS_SRC_COLOR=769;h.SRC_ALPHA=770;h.ONE_MINUS_SRC_ALPHA=771;h.DST_ALPHA=772;h.ONE_MINUS_DST_ALPHA=773;h.DST_COLOR=774;
h.ONE_MINUS_DST_COLOR=775;h.SRC_ALPHA_SATURATE=776;h.CONSTANT_COLOR=32769;h.ONE_MINUS_CONSTANT_COLOR=32770;h.CONSTANT_ALPHA=32771;h.ONE_MINUS_CONSTANT_ALPHA=32772;h.VERTEX_SHADER=35633;h.FRAGMENT_SHADER=35632;h.FRONT=1028;h.BACK=1029;h.FRONT_AND_BACK=1032;h.NEVER=512;h.LESS=513;h.EQUAL=514;h.LEQUAL=515;h.GREATER=516;h.NOTEQUAL=517;h.GEQUAL=518;h.ALWAYS=519;h.KEEP=7680;h.REPLACE=7681;h.INCR=7682;h.DECR=7683;h.INCR_WRAP=34055;h.DECR_WRAP=34056;h.INVERT=5386;h.STREAM_DRAW=35040;h.STATIC_DRAW=35044;h.DYNAMIC_DRAW=
35048;h.ARRAY_BUFFER=34962;h.ELEMENT_ARRAY_BUFFER=34963;h.POINTS=0;h.LINES=1;h.LINE_LOOP=2;h.LINE_STRIP=3;h.TRIANGLES=4;h.TRIANGLE_STRIP=5;h.TRIANGLE_FAN=6;h.CW=2304;h.CCW=2305;h.CULL_FACE=2884;h.DEPTH_TEST=2929;h.BLEND=3042;h.temp_vec3=vec3.create();h.temp2_vec3=vec3.create();h.temp_vec4=vec4.create();h.temp_quat=quat.create();h.temp_mat3=mat3.create();h.temp_mat4=mat4.create();r.DEG2RAD=0.0174532925;r.RAD2DEG=57.295779578552306;r.EPSILON=1E-6;r.isPowerOfTwo=h.isPowerOfTwo=function(g){return 0==
Math.log(g)/Math.log(2)%1};r.nearestPowerOfTwo=h.nearestPowerOfTwo=function(g){return Math.pow(2,Math.round(Math.log(g)/Math.log(2)))};r.nextPowerOfTwo=h.nextPowerOfTwo=function(g){return Math.pow(2,Math.ceil(Math.log(g)/Math.log(2)))};[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(g){g.prototype.toJSON||Object.defineProperty(g.prototype,"toJSON",{value:X,enumerable:!1,configurable:!0,writable:!0})});r.getTime="undefined"!=typeof performance?
performance.now.bind(performance):Date.now.bind(Date);h.getTime=r.getTime;r.isFunction=function(g){return!!(g&&g.constructor&&g.call&&g.apply)};r.isArray=function(g){return g&&g.constructor===Array};r.isNumber=function(g){return null!=g&&g.constructor===Number};r.getClassName=function(g){if(g){if(g.name)return g.name;if(g.toString&&(g=g.toString().match(/function\s*(\w+)/))&&2==g.length)return g[1]}};r.cloneObject=h.cloneObject=function(g,e){if(g.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";
e=e||{};for(var a in g){var b=g[a];if(null===b)e[a]=null;else switch(b.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:e[a]=new b.constructor(b);break;case Boolean:case Number:case String:e[a]=b;break;case Array:e[a]=b.concat();break;case Object:e[a]=h.cloneObject(b)}}return e};r.regexMap=function(g,e,a){for(var b;null!=(b=g.exec(e));)a(b)};r.createCanvas=h.createCanvas=function(g,e){var a=document.createElement("canvas");
a.width=g;a.height=e;return a};r.cloneCanvas=h.cloneCanvas=function(g){var e=document.createElement("canvas");e.width=g.width;e.height=g.height;e.getContext("2d").drawImage(g,0,0);return e};"undefined"!=typeof Image&&(Image.prototype.getPixels=function(){var g=document.createElement("canvas");g.width=this.width;g.height=this.height;g=g.getContext("2d");g.drawImage(this,0,0);return g.getImageData(0,0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,
"replaceAll",{value:function(g){var e=this,a;for(a in g)e=e.split(a).join(g[a]);return e},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var g=0,e,a,b;if(0==this.length)return g;e=0;for(b=this.length;e<b;++e)a=this.charCodeAt(e),g=(g<<5)-g+a,g|=0;return g},enumerable:!1});Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1});Float32Array.prototype.hasOwnProperty("clone")||
Object.defineProperty(Float32Array.prototype,"clone",{value:function(){return new Float32Array(this)},enumerable:!1});r.wipeObject=function(g){for(var e in g)g.hasOwnProperty(e)&&delete g[e]};r.extendClass=h.extendClass=function(g,e){for(var a in e)g.hasOwnProperty(a)||(g[a]=e[a]);if(e.prototype){var b=Object.getOwnPropertyNames(e.prototype);for(a=0;a<b.length;++a){var c=b[a];g.prototype.hasOwnProperty(c)||(e.prototype.__lookupGetter__(c)?g.prototype.__defineGetter__(c,e.prototype.__lookupGetter__(c)):
g.prototype[c]=e.prototype[c],e.prototype.__lookupSetter__(c)&&g.prototype.__defineSetter__(c,e.prototype.__lookupSetter__(c)))}}g.hasOwnProperty("superclass")||Object.defineProperty(g,"superclass",{get:function(){return e},enumerable:!1})};r.HttpRequest=h.request=function(g,e,a,b,c){var d=!0;c=c||{};void 0!==c.async&&(d=c.async);if(e){var f=null,f=[],k;for(k in e)f.push(k+"="+e[k]);f=f.join("&");g=g+"?"+f}var p=new XMLHttpRequest;p.open("GET",g,d);p.responseType=c.responseType||"text";p.onload=function(c){this.getResponseHeader("Content-Type");
200!=this.status?(A.trigger(p,"fail",this.status),b&&b(this.status)):(A.trigger(p,"done",this.response),a&&a(this.response))};p.onerror=function(a){A.trigger(p,"fail",a)};if(c){for(k in c)p[k]=c[k];c.binary&&(p.responseType="arraybuffer")}p.send();return p};r.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(g){A.bind(this,"done",function(e,a){g(a)});return this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||
Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(g){A.bind(this,"fail",function(e,a){g(a)});return this}}));r.getFileExtension=function(g){var e=g.indexOf("?");-1!=e&&(g=g.substr(0,e));e=g.lastIndexOf(".");return-1==e?"":g.substr(e+1).toLowerCase()};r.loadFileAtlas=h.loadFileAtlas=function(g,e,a){var b=null;HttpRequest(g,null,function(a){a=h.processFileAtlas(a);e&&e(a);b&&b(a)},alert,a);return{done:function(a){b=a}}};r.processFileAtlas=h.processFileAtlas=function(g,
e){for(var a=g.split("\n"),b={},c=[],d="",f=0,k=a.length;f<k;f++){var p=e?a[f]:a[f].trim();p.length&&("\\"!=p[0]?c.push(p):(c.length&&(b[d]=c.join("\n")),c.length=0,d=p.substr(1)))}c.length&&(b[d]=c.join("\n"));return b};r.typedArrayToArray=function(g){var e=[];e.length=g.length;for(var a=0;a<g.length;a++)e[a]=g[a];return e};r.RGBToHex=function(g,e,a){g=Math.min(255,255*g)|0;e=Math.min(255,255*e)|0;a=Math.min(255,255*a)|0;return"#"+(16777216+(g<<16)+(e<<8)+a).toString(16).slice(1)};r.HUEToRGB=function(g,
e,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?g+6*(e-g)*a:0.5>a?e:a<2/3?g+(e-g)*(2/3-a)*6:g};r.HSLToRGB=function(g,e,a,b){b=b||vec3.create();if(0==e)a=e=g=a;else{var c=0.5>a?a*(1+e):a+e-a*e,d=2*a-c;a=HUEToRGB(d,c,g+1/3);e=HUEToRGB(d,c,g);g=HUEToRGB(d,c,g-1/3)}b[0]=a;b[1]=e;b[2]=g;return b};r.hexColorToRGBA=function(){var g={white:[1,1,1],black:[0,0,0],gray:[0.501960813999176,0.501960813999176,0.501960813999176],red:[1,0,0],orange:[1,0.6470588445663452,0],pink:[1,0.7529411911964417,0.7960784435272217],
green:[0,0.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[0.9333333373069763,0.5098039507865906,0.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[0.6470588445663452,0.16470588743686676,0.16470588743686676],silver:[0.7529411911964417,0.7529411911964417,0.7529411911964417],gold:[1,0.843137264251709,0],transparent:[0,0,0,0]};return function(e,a,b){b=void 0===b?1:b;a=a||new Float32Array(4);a[3]=b;if("string"!=typeof e)return a;var c=g[e];if(void 0!==c)return a.set(c),a[3]=3==
a.length?b:a[3]*b,a;c=e.indexOf("rgba(");if(-1!=c)return e=e.substr(5,e.length-2),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a[3]=parseFloat(e[3])*b,a;c=e.indexOf("hsla(");if(-1!=c)return e=e.substr(5,e.length-2),e=e.split(","),HSLToRGB(parseInt(e[0])/360,parseInt(e[1])/100,parseInt(e[2])/100,a),a[3]=parseFloat(e[3])*b,a;a[3]=b;c=e.indexOf("rgb(");if(-1!=c)return e=e.substr(4,e.length-2),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=
parseInt(e[2])/255,a;c=e.indexOf("hsl(");if(-1!=c)return e=e.substr(4,e.length-2),e=e.split(","),HSLToRGB(parseInt(e[0])/360,parseInt(e[1])/100,parseInt(e[2])/100,a),a;e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,b,c,e){return b+b+c+c+e+e});b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!b)return a;a[0]=parseInt(b[1],16)/255;a[1]=parseInt(b[2],16)/255;a[2]=parseInt(b[3],16)/255;return a}}();r.toHalfFloat=function(){var g=new Float32Array(1),e=new Int32Array(g.buffer);return function(a){g[0]=
a;a=e[0];var b=a>>16&32768,c=(a&2147483647)+4096;if(1199570944<=c)return 1199570944<=(a&2147483647)?2139095040>c?b|31744:b|31744|(a&8388607)>>13:b|31743;if(947912704<=c)return b|c-939524096>>13;if(855638016>c)return b;c=(a&2147483647)>>23;return b|(a&8388607|8388608)+(8388608>>>c-102)>>126-c}}();var U=function(){function g(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function e(a,b,c,d){var e=new Uint16Array(4),f=new Uint16Array(c*d),g=0,k=0,l=0,p=k=g=
0,m=0,h=0,n=0,v=c/4;d/=4;for(var q=0;q<d;q++)for(var s=0;s<v;s++)l=b+4*(q*v+s),e[0]=a[l],e[1]=a[l+1],g=e[0]&31,k=e[0]&2016,p=e[0]&63488,m=e[1]&31,h=e[1]&2016,n=e[1]&63488,e[2]=5*g+3*m>>3|5*k+3*h>>3&2016|5*p+3*n>>3&63488,e[3]=5*m+3*g>>3|5*h+3*k>>3&2016|5*n+3*p>>3&63488,g=a[l+2],k=4*q*c+4*s,f[k]=e[g&3],f[k+1]=e[g>>2&3],f[k+2]=e[g>>4&3],f[k+3]=e[g>>6&3],k+=c,f[k]=e[g>>8&3],f[k+1]=e[g>>10&3],f[k+2]=e[g>>12&3],f[k+3]=e[g>>14],g=a[l+3],k+=c,f[k]=e[g&3],f[k+1]=e[g>>2&3],f[k+2]=e[g>>4&3],f[k+3]=e[g>>6&3],
k+=c,f[k]=e[g>>8&3],f[k+1]=e[g>>10&3],f[k+2]=e[g>>12&3],f[k+3]=e[g>>14];return f}function a(a){for(var b=0,c=a.length,d=0;b<c;b+=4)d=a[b],a[b]=a[b+2],a[b+2]=d}function b(b,c,d,g){var r=new Int32Array(d,0,s),z,F,G,I,H,L,P,Q,A;if(r[x]!=f)return console.error("Invalid magic number in DDS header"),0;if(!r[y]&m)return console.error("Unsupported format, must contain a FourCC code"),0;z=r[C];switch(z){case l:F=8;G=c?c.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case h:F=16;G=c?c.COMPRESSED_RGBA_S3TC_DXT3_EXT:
null;break;case q:F=16;G=c?c.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:F=4,z=null,G=b.RGBA}P=1;r[u]&k&&!1!==g&&(P=Math.max(1,r[E]));I=r[v];H=r[w];L=r[t]+4;if(r[B+1]&p)for(A=0;6>A;++A)for(I=r[v],H=r[w],Q=0;Q<P;++Q)z?(g=Math.max(4,I)/4*Math.max(4,H)/4*F,c=new Uint8Array(d,L,g),b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+A,Q,G,I,H,0,c)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),g=I*H*F,c=new Uint8Array(d,L,g),a(c),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+A,Q,G,I,H,0,b.RGBA,b.UNSIGNED_BYTE,
c)),L+=g,I*=0.5,H*=0.5;else if(c)for(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),Q=0;Q<P;++Q)z?(g=Math.max(4,I)/4*Math.max(4,H)/4*F,c=new Uint8Array(d,L,g),b.compressedTexImage2D(b.TEXTURE_2D,Q,G,I,H,0,c)):(g=I*H*F,c=new Uint8Array(d,L,g),a(c),b.texImage2D(b.TEXTURE_2D,Q,G,I,H,0,G,b.UNSIGNED_BYTE,c)),L+=g,I*=0.5,H*=0.5;else if(z==l)Math.max(4,I),Math.max(4,H),c=new Uint16Array(d),d=e(c,L/2,I,H),b.texImage2D(b.TEXTURE_2D,0,b.RGB,I,H,0,b.RGB,b.UNSIGNED_SHORT_5_6_5,d),g&&b.generateMipmap(b.TEXTURE_2D);else return console.error("No manual decoder for",
String.fromCharCode(z&255,z>>8&255,z>>16&255,z>>24&255),"and no native support"),0;return P}function c(b,c){var d=new Int32Array(b,0,s),g,r,z,F,G,I,H,L,P,A,D;if(d[x]!=f)return console.error("Invalid magic number in DDS header"),0;if(!d[y]&m)return console.error("Unsupported format, must contain a FourCC code"),0;g=d[C];switch(g){case l:r=8;z="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case h:r=16;z="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case q:r=16;z="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:r=4,z="RGBA"}P=
1;d[u]&k&&!1!==loadMipmaps&&(P=Math.max(1,d[E]));F=d[v];G=d[w];H=d[t]+4;var J=[];if(d[B+1]&p)for(D=0;6>D;++D)for(F=d[v],G=d[w],A=0;A<P;++A)g?(I=Math.max(4,F)/4*Math.max(4,G)/4*r,new Uint8Array(b,H,I),J.push({tex:"TEXTURE_CUBE_MAP",face:D,mipmap:A,internalFormat:z,width:F,height:G,offset:0,dataOffset:H,dataLength:I})):(I=F*G*r,L=new Uint8Array(b,H,I),a(L),J.push({tex:"TEXTURE_CUBE_MAP",face:D,mipmap:A,internalFormat:z,width:F,height:G,offset:0,type:"UNSIGNED_BYTE",dataOffset:H,dataLength:I})),H+=I,
F*=0.5,G*=0.5;else if(c)if(g==l)Math.max(4,F),Math.max(4,G),L=new Uint16Array(b),d=e(L,H/2,F,G),J.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:F,height:G,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:d});else return console.error("No manual decoder for",String.fromCharCode(g&255,g>>8&255,g>>16&255,g>>24&255),"and no native support"),0;else for(A=0;A<P;++A)I=Math.max(4,F)/4*Math.max(4,G)/4*r,new Uint8Array(b,H,I),J.push({tex:"TEXTURE_2D",mipmap:A,internalFormat:z,width:F,height:G,
offset:0,type:"UNSIGNED_BYTE",dataOffset:H,dataLength:I}),H+=I,F*=0.5,G*=0.5;return J}function d(a,c,d,e,f,g){var k=new XMLHttpRequest;k.open("GET",d,!0);k.responseType="arraybuffer";k.onload=function(){if(200==this.status){var d=new Int32Array(this.response,0,s),k=d[B+1]&p?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(k,e);var l=b(a,c,this.response,f);a.texParameteri(k,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(k,a.TEXTURE_MIN_FILTER,1<l?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(k,null);
e.texture_type=k;e.width=d[v];e.height=d[w]}g&&g(e)};k.send(null);return e}var f=542327876,k=131072,p=512,m=4,l=g("DXT1"),h=g("DXT3"),q=g("DXT5"),s=31,x=0,t=1,u=2,w=3,v=4,E=7,y=20,C=21,B=27;return{dxtToRgb565:e,uploadDDSLevels:b,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){var f=a.createTexture();b=a.getExtension("WEBGL_compressed_texture_s3tc");d(a,b,c,f,!0,e);return f},loadDDSTextureFromMemoryEx:function(a,c,d,e,f){var g=new Int32Array(d,0,s),k=!!(g[B+1]&p),l=k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;
a.bindTexture(l,e.handler);c=b(a,c,d,f);a.texParameteri(l,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(l,a.TEXTURE_MIN_FILTER,1<c?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);k&&(a.texParameteri(l,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(l,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));a.bindTexture(l,null);e.handler&&(e.texture_type=l,e.width=g[v],e.height=g[w]);return e},getDDSTextureFromMemoryEx:function(a){var b=new Int32Array(a,0,s),d=b[B+1]&p?"TEXTURE_CUBE_MAP":"TEXTURE_2D",e=c(a);return{type:d,buffers:e,
data:a,width:b[v],height:b[w]}}}}();"undefined"!=typeof r&&(r.DDS=U);if("undefined"==typeof S&&"undefined"!=typeof exports&&void 0!==typeof process&&exports.vec3)for(O in exports)r[O]=exports[O];Math.clamp=function(g,e,a){return e>g?e:a<g?a:g};Math.lerp=function(g,e,a){return g*(1-a)+e*a};Math.lerp01=function(g,e,a){return Math.clamp(g*(1-a)+e*a,0,1)};Math.iLerp=function(g,e,a){return(a-g)/(e-g)};Math.remap=function(g,e,a,b,c){return Math.lerp(b,c,Math.iLerp(e,a,g))};vec3.ZERO=vec3.fromValues(0,0,
0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=vec3.fromValues(1,0,0);vec2.rotate=function(g,e,a){var b=e[0];e=e[1];var c=Math.cos(a);a=Math.sin(a);g[0]=b*c-e*a;g[1]=b*a+e*c;return g};vec3.zero=function(g){g[0]=g[1]=0;return g};vec2.perpdot=function(g,e){return g[1]*e[0]+-g[0]*e[1]};vec2.computeSignedAngle=function(g,e){return Math.atan2(vec2.perpdot(g,e),vec2.dot(g,e))};vec2.random=function(g,e){e=e||1;g[0]=Math.random()*e;g[1]=Math.random()*e;return g};vec3.zero=
function(g){g[0]=g[1]=g[2]=0;return g};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.maxValue=function(g){return g[0]>g[1]&&g[0]>g[2]?g[0]:g[1]>g[2]?g[1]:g[2]};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.addValue=function(g,e,a){g[0]=e[0]+a;g[1]=e[1]+a;g[2]=e[2]+a};vec3.subValue=function(g,e,a){g[0]=e[0]-a;g[1]=e[1]-a;g[2]=e[2]-a};vec3.toArray=function(g){return[g[0],g[1],g[2]]};vec3.rotateX=function(g,e,a){var b=e[1],
c=e[2],d=Math.cos(a);a=Math.sin(a);g[0]=e[0];g[1]=b*d-c*a;g[2]=b*a+c*d;return g};vec3.rotateY=function(g,e,a){var b=e[0],c=e[2],d=Math.cos(a);a=Math.sin(a);g[0]=b*d-c*a;g[1]=e[1];g[2]=b*a+c*d;return g};vec3.rotateZ=function(g,e,a){var b=e[0],c=e[1],d=Math.cos(a);a=Math.sin(a);g[0]=b*d-c*a;g[1]=b*a+c*d;g[2]=e[2];return g};vec3.angle=function(g,e){return Math.acos(vec3.dot(g,e))};vec3.signedAngle=function(g,e,a){var b=vec3.angle(g,e);g=Math.sign(a[0]*(g[1]*e[2]-g[2]*e[1])+a[1]*(g[2]*e[0]-g[0]*e[2])+
a[2]*(g[0]*e[1]-g[1]*e[0]));return b*g};vec3.random=function(g,e){e=e||1;g[0]=Math.random()*e;g[1]=Math.random()*e;g[2]=Math.random()*e;return g};vec3.cartesianToPolar=function(g,e){g=g||vec3.create();var a=e[0],b=e[1],c=e[2];g[0]=Math.sqrt(a*a+b*b+c*c);g[1]=Math.asin(b/g[0]);g[2]=Math.atan2(a,c);return g};vec3.polarToCartesian=function(g,e){var a=e[0],b=e[1],c=e[2];g[0]=a*Math.cos(b)*Math.sin(c);g[1]=a*Math.sin(b);g[2]=a*Math.cos(b)*Math.cos(c);return g};vec3.reflect=function(g,e,a){var b=e[0],c=
e[1],d=e[2];vec3.scale(g,a,-2*vec3.dot(e,a));g[0]+=b;g[1]+=c;g[2]+=d;return g};vec4.random=function(g,e){e=e||1;g[0]=Math.random()*e;g[1]=Math.random()*e;g[2]=Math.random()*e;g[3]=Math.random()*e;return g};vec4.toArray=function(g){return[g[0],g[1],g[2],g[3]]};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(g){return[g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15]]};mat4.setUpAndOrthonormalize=function(g,e,a){e!=g&&mat4.copy(g,e);
e=g.subarray(0,3);vec3.normalize(g.subarray(4,7),a);g=g.subarray(8,11);vec3.cross(e,a,g);vec3.normalize(e,e);vec3.cross(g,e,a);vec3.normalize(g,g)};mat4.multiplyVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];g[0]=e[0]*b+e[4]*c+e[8]*a+e[12];g[1]=e[1]*b+e[5]*c+e[9]*a+e[13];g[2]=e[2]*b+e[6]*c+e[10]*a+e[14];return g};mat4.projectVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];var d=e[1]*b+e[5]*c+e[9]*a+e[13],f=e[2]*b+e[6]*c+e[10]*a+e[14],k=e[3]*b+e[7]*c+e[11]*a+e[15];g[0]=((e[0]*b+e[4]*c+e[8]*a+e[12])/k+
1)/2;g[1]=(d/k+1)/2;g[2]=(f/k+1)/2;return g};vec3.project=function(g,e,a,b){b=b||gl.viewport_data;var c=e[0],d=e[1];e=e[2];var f=a[3]*c+a[7]*d+a[11]*e+a[15],k=1-((a[1]*c+a[5]*d+a[9]*e+a[13])/f+1)/2,p=((a[2]*c+a[6]*d+a[10]*e+a[14])/f+1)/2;g[0]=((a[0]*c+a[4]*d+a[8]*e+a[12])/f+1)/2*b[2]+b[0];g[1]=k*b[3]+b[1];g[2]=p;return g};var V=mat4.create(),J=vec4.create();vec3.unproject=function(g,e,a,b){J[0]=2*(e[0]-b[0])/b[2]-1;J[1]=2*(e[1]-b[1])/b[3]-1;J[2]=2*e[2]-1;J[3]=1;if(!mat4.invert(V,a))return null;vec4.transformMat4(J,
J,V);if(0===J[3])return null;g[0]=J[0]/J[3];g[1]=J[1]/J[3];g[2]=J[2]/J[3];return g};mat4.rotateVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];g[0]=e[0]*b+e[4]*c+e[8]*a;g[1]=e[1]*b+e[5]*c+e[9]*a;g[2]=e[2]*b+e[6]*c+e[10]*a;return g};mat4.fromTranslationFrontTop=function(g,e,a,b){vec3.cross(g.subarray(0,3),a,b);g.set(b,4);g.set(a,8);g.set(e,12);return g};mat4.translationMatrix=function(g){var e=mat4.create();e[12]=g[0];e[13]=g[1];e[14]=g[2];return e};mat4.setTranslation=function(g,e){g[12]=e[0];g[13]=
e[1];g[14]=e[2];return g};mat4.getTranslation=function(g,e){g[0]=e[12];g[1]=e[13];g[2]=e[14];return g};mat4.toRotationMat4=function(g,e){mat4.copy(g,e);g[12]=g[13]=g[14]=0;return g};mat4.swapRows=function(g,e,a,b){if(g!=e)return mat4.copy(g,e),g[4*a]=e[4*b],g[4*a+1]=e[4*b+1],g[4*a+2]=e[4*b+2],g[4*a+3]=e[4*b+3],g[4*b]=e[4*a],g[4*b+1]=e[4*a+1],g[4*b+2]=e[4*a+2],g[4*b+3]=e[4*a+3],g;e=new Float32Array(matrix.subarray(4*a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(e,4*b);return g};mat4.scaleAndAdd=
function(g,e,a,b){g[0]=e[0]+a[0]*b;g[1]=e[1]+a[1]*b;g[2]=e[2]+a[2]*b;g[3]=e[3]+a[3]*b;g[4]=e[4]+a[4]*b;g[5]=e[5]+a[5]*b;g[6]=e[6]+a[6]*b;g[7]=e[7]+a[7]*b;g[8]=e[8]+a[8]*b;g[9]=e[9]+a[9]*b;g[10]=e[10]+a[10]*b;g[11]=e[11]+a[11]*b;g[12]=e[12]+a[12]*b;g[13]=e[13]+a[13]*b;g[14]=e[14]+a[14]*b;g[15]=e[15]+a[15]*b;return g};quat.fromAxisAngle=function(g,e){var a=quat.create();e*=0.5;var b=Math.sin(e);a[0]=b*g[0];a[1]=b*g[1];a[2]=b*g[2];a[3]=Math.cos(e);return a};quat.lookRotation=function(){var g=vec3.create(),
e=vec3.create(),a=vec3.create();return function(b,c,d){vec3.normalize(g,c);vec3.cross(e,d,g);vec3.normalize(e,e);vec3.cross(a,g,e);var f=e[0];c=e[1];d=e[2];var k=a[0],p=a[1],m=a[2],l=g[0],h=g[1],q=g[2],s=f+p+q;if(0<s)return f=Math.sqrt(s+1),b[3]=0.5*f,f=0.5/f,b[0]=(m-h)*f,b[1]=(l-d)*f,b[2]=(c-k)*f,b;if(f>=p&&f>=q)return f=Math.sqrt(1+f-p-q),p=0.5/f,b[0]=0.5*f,b[1]=(c+k)*p,b[2]=(d+l)*p,b[3]=(m-h)*p,b;if(p>q)return f=Math.sqrt(1+p-f-q),p=0.5/f,b[0]=(k+c)*p,b[1]=0.5*f,b[2]=(h+m)*p,b[3]=(l-d)*p,b;f=Math.sqrt(1+
q-f-p);p=0.5/f;b[0]=(l+d)*p;b[1]=(h+m)*p;b[2]=0.5*f;b[3]=(c-k)*p;return b}}();quat.toEuler=function(g,e){var a=Math.atan2(2*e[1]*e[3]-2*e[0]*e[2],1-2*e[1]*e[1]-2*e[2]*e[2]),b=Math.asin(2*e[0]*e[1]+2*e[2]*e[3]),c=Math.atan2(2*e[0]*e[3]-2*e[1]*e[2],1-2*e[0]*e[0]-2*e[2]*e[2]);g||(g=vec3.create());vec3.set(g,a,b,c);return g};quat.fromEuler=function(g,e){var a=e[0],b=e[1],c=e[2],d=Math.cos(a),f=Math.cos(b),k=Math.cos(c),a=Math.sin(a),b=Math.sin(b),c=Math.sin(c),h=0.5*Math.sqrt(1+d*f+d*k-a*b*c+f*k);0==
h&&(h=1E-6);quat.set(g,(f*c+d*c+a*b*k)/(4*h),(a*f+a*k+d*b*c)/(4*h),(-a*c+d*b*k+b)/(4*h),h);quat.normalize(g,g);return g};quat.fromMat4=function(g,e){var a=e[0]+e[5]+e[10];if(0<a){var b=Math.sqrt(a+1);g[3]=0.5*b;b=0.5/b;g[0]=(e[9]-e[6])*b;g[1]=(e[8]-e[2])*b;g[2]=(e[4]-e[1])*b}else{a=0;e[5]>e[0]&&(a=1);e[10]>e[4*a+a]&&(a=2);var c=(a+1)%3,d=(c+1)%3,b=Math.sqrt(e[4*a+a]-e[4*c+c]-e[4*d+d]+1);g[a]=0.5*b;b=0.5/b;g[3]=(e[4*d+c]-e[4*c+d])*b;g[c]=(e[4*c+a]+e[4*a+c])*b;g[d]=(e[4*d+a]+e[4*a+d])*b}quat.normalize(g,
g)};vec3.getMat3Column=function(g,e,a){g[0]=e[3*a];g[1]=e[3*a+1];g[2]=e[3*a+2];return g};mat3.setColumn=function(g,e,a){g[3*a]=e[0];g[3*a+1]=e[1];g[3*a+2]=e[2];return g};quat.fromMat3AndQuat=function(){var g=mat3.create(),e=quat.create(),a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),h=vec3.create(),m=vec3.create(),l=vec3.create(),n=vec3.create();mat3.create();return function(q,s,x){x=x||25;for(var t=0;t<x;++t){var u=mat3.fromQuat(g,q);vec3.getMat3Column(a,
u,0);vec3.getMat3Column(b,u,1);vec3.getMat3Column(c,u,2);vec3.getMat3Column(d,s,0);vec3.getMat3Column(f,s,1);vec3.getMat3Column(k,s,2);vec3.cross(h,a,d);vec3.cross(m,b,f);vec3.cross(l,c,k);vec3.add(n,h,m);vec3.add(n,n,l);u=1/Math.abs(vec3.dot(a,d)+vec3.dot(b,f)+vec3.dot(c,k))+1E-9;vec3.scale(n,n,u);u=vec3.length(n);if(1E-9>u)break;vec3.scale(n,n,1/u);quat.setAxisAngle(e,n,u);quat.mul(q,e,q);quat.normalize(q,q)}return q}}();quat.rotateToFrom=function(){var g=vec3.create();return function(e,a,b){e=
e||quat.create();var c=vec3.cross(g,a,b);a=vec3.dot(a,b);if(-0.99>a)return e[0]=0,e[1]=1,e[2]=0,e[3]=0,e;e[0]=0.5*c[0];e[1]=0.5*c[1];e[2]=0.5*c[2];e[3]=0.5*(1+a);quat.normalize(e,e);return e}}();quat.lookAt=function(){var g=vec3.create();return function(e,a,b){b=vec3.dot(vec3.FRONT,a);if(1E-6>Math.abs(b- -1))return e.set(vec3.UP),e[3]=Math.PI,e;if(1E-6>Math.abs(b-1))return quat.identity(e);b=Math.acos(b);vec3.cross(g,vec3.FRONT,a);vec3.normalize(g,g);quat.setAxisAngle(e,g,b);return e}}();h.Indexer=
function(){this.unique=[];this.indices=[];this.map={}};h.Indexer.prototype={add:function(g){var e=JSON.stringify(g);e in this.map||(this.map[e]=this.unique.length,this.unique.push(g));return this.map[e]}};h.Buffer=function(g,e,a,b,c){h.debug&&console.log("GL.Buffer created");null!==c&&(c=c||r.gl);this.gl=c;this.buffer=null;this.target=g;this.attribute=null;this.normalize=!1;this.data=e;this.spacing=a||3;this.data&&this.gl&&this.upload(b)};h.Buffer.prototype.bind=function(g,e){e=e||this.gl;e.bindBuffer(e.ARRAY_BUFFER,
this.buffer);e.enableVertexAttribArray(g);e.vertexAttribPointer(g,this.spacing,this.buffer.gl_type,this.normalize||!1,0,0)};h.Buffer.prototype.unbind=function(g,e){e=e||this.gl;e.disableVertexAttribArray(g)};h.Buffer.prototype.forEach=function(g){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b)g(e.subarray(a,a+b),a);return this};h.Buffer.prototype.applyTransform=function(g){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b){var d=e.subarray(a,a+b);vec3.transformMat4(d,d,g)}return this};
h.Buffer.prototype.upload=function(g){var e=this.spacing||3,a=this.gl;if(a){if(!this.data)throw"No data supplied";var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||a.createBuffer()){this.buffer.length=b.length;this.buffer.spacing=e;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=a.SHORT;break;case Uint16Array:this.buffer.gl_type=
a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=a.INT;break;case Uint32Array:this.buffer.gl_type=a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";}this.target!=a.ARRAY_BUFFER||this.buffer.gl_type!=a.INT&&this.buffer.gl_type!=a.UNSIGNED_INT||(console.warn("WebGL does not support UINT32 or INT32 as vertex buffer types, converting to FLOAT"),this.buffer.gl_type=a.FLOAT,b=new Float32Array(b));a.bindBuffer(this.target,this.buffer);
a.bufferData(this.target,b,g||this.stream_type||a.STATIC_DRAW)}}};h.Buffer.prototype.compile=h.Buffer.prototype.upload;h.Buffer.prototype.setData=function(g,e){if(!g.buffer)throw"Data must be typed array";e=e||0;if(this.data){if(this.data.length<g.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";if(this.data!=g)if(this.data.length==g.length)this.data.set(g),this.upload();else{var a=new Uint8Array(g.buffer,g.buffer.byteOffset,g.buffer.byteLength);(new Uint8Array(this.data.buffer)).set(a,
e);this.uploadRange(e,a.length)}}else this.data=g,this.upload()};h.Buffer.prototype.uploadRange=function(g,e){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var a=new Uint8Array(this.data.buffer,g,e),b=this.gl;b.bindBuffer(this.target,this.buffer);b.bufferSubData(this.target,g,a)};h.Buffer.prototype.clone=function(g){var e=new h.Buffer;if(g)for(var a in this)e[a]=this[a];else this.target&&(e.target=this.target),this.gl&&(e.gl=this.gl),this.spacing&&
(e.spacing=this.spacing),this.data&&(e.data=new r[this.data.constructor](this.data),e.upload());return e};h.Buffer.prototype.toJSON=function(){return this.data?{data_type:getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)};h.Buffer.prototype.fromJSON=function(g){this.data=new (r[g.data_type]||Float32Array)(g.data);this.target=g.target;this.spacing=g.spacing||3;this.attribute=
g.attribute;this.upload(h.STATIC_DRAW)};h.Buffer.prototype.delete=function(){this.gl.deleteBuffer(this.buffer);this.buffer=null};r.Mesh=h.Mesh=function(g,e,a,b){h.debug&&console.log("GL.Mesh created");null!==b&&(this.gl=b=b||r.gl);this.gl&&(this._context_id=this.gl.context_id);this.vertexBuffers={};this.indexBuffers={};this.info={groups:[]};this._bounding=BBox.create();(g||e)&&this.addBuffers(g,e,a?a.stream_type:null);if(a)for(var c in a)this[c]=a[c]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},
vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal",normalize:!0},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color",normalize:!0},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights",normalize:!0},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},
extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Object.defineProperty(Mesh.prototype,"bounding",{set:function(g){if(g){if(13>g.length)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(g)}},get:function(){return this._bounding}});Mesh.prototype.addBuffer=function(g,e){e.target==gl.ARRAY_BUFFER?this.vertexBuffers[g]=e:this.indexBuffers[g]=e;if(!e.attribute){var a=h.Mesh.common_buffers[g];
a&&(e.attribute=a.attribute)}};Mesh.prototype.addBuffers=function(g,e,a){var b=0;this.vertexBuffers.vertices&&(b=this.vertexBuffers.vertices.data.length/3);for(var c in g){var d=g[c];if(d){if(d.constructor==h.Buffer||d.data)d=d.data;else if("number"!=typeof d[0]){for(var f=[],k=0,p=1E4;k<d.length;k+=p)f=Array.prototype.concat.apply(f,d.slice(k,k+p));d=f}f=h.Mesh.common_buffers[c];d.constructor===Array&&(k=h.Mesh.default_datatype,f&&f.type&&(k=f.type),d=new k(d));"vertices"==c&&(b=d.length/3);k=d.length/
b;f&&f.spacing&&(k=f.spacing);p="a_"+c;f&&f.attribute&&(p=f.attribute);this.vertexBuffers[c]?this.updateVertexBuffer(c,p,k,d,a):this.createVertexBuffer(c,p,k,d,a)}}if(e)for(c in e)if(d=e[c]){if(d.constructor==h.Buffer||d.data)d=d.data;if("number"!=typeof d[0]){f=[];c=0;for(p=1E4;c<d.length;c+=p)f=Array.prototype.concat.apply(f,d.slice(c,c+p));d=f}d.constructor===Array&&(k=Uint16Array,65536<b&&(k=Uint32Array),d=new k(d));this.createIndexBuffer(c,d)}};Mesh.prototype.createVertexBuffer=function(g,e,
a,b,c){var d=h.Mesh.common_buffers[g];!e&&d&&(e=d.attribute);if(!e)throw"Buffer added to mesh without attribute name";!a&&d&&(a=d&&d.spacing?d.spacing:3);if(!b){b=this.getNumVertices();if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";b=new h.Mesh.default_datatype(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[g]=new h.Buffer(h.ARRAY_BUFFER,b,a,c,this.gl);a.name=g;a.attribute=e;(b.constructor==Uint8Array||b.constructor==
Int8Array||b.constructor==Uint16Array||b.constructor==Int16Array||b.constructor==Uint32Array||b.constructor==Int32Array)&&d&&d.normalize&&(a.normalize=!0);return a};Mesh.prototype.updateVertexBuffer=function(g,e,a,b,c){var d=this.vertexBuffers[g];d?b.length&&(d.attribute=e,d.spacing=a,d.data=b,d.upload(c)):console.log("buffer not found: ",g)};Mesh.prototype.removeVertexBuffer=function(g,e){var a=this.vertexBuffers[g];a&&(e&&a.delete(),delete this.vertexBuffers[g])};Mesh.prototype.getVertexBuffer=
function(g){return this.vertexBuffers[g]};Mesh.prototype.createIndexBuffer=function(g,e,a){if(e.constructor===Array){var b=Uint16Array,c=this.vertexBuffers.vertices;c&&(65536<c.data.length/3&&(b=Uint32Array),e=new b(e))}return this.indexBuffers[g]=new h.Buffer(h.ELEMENT_ARRAY_BUFFER,e,0,a,this.gl)};Mesh.prototype.getBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.getIndexBuffer=function(g){return this.indexBuffers[g]};Mesh.prototype.removeIndexBuffer=function(g,e){var a=this.indexBuffers[g];
a&&(e&&a.delete(),delete this.indexBuffers[g])};Mesh.prototype.upload=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e];a.upload(g)}for(var b in this.indexBuffers)a=this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var g in this.vertexBuffers){var e=this.vertexBuffers[g];e.delete()}this.vertexBuffers={};for(g in this.indexBuffers)e=this.indexBuffers[g],e.delete();this.indexBuffers={}};Mesh.prototype.delete=
Mesh.prototype.deleteBuffers;Mesh.prototype.bindBuffers=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=g.attributes[a.attribute||e];null!=b&&a.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.buffer.spacing,a.buffer.gl_type,a.normalize||!1,0,0))}};Mesh.prototype.unbindBuffers=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=a.attribute||e;null!=g.attributes[b]&&a.buffer&&gl.disableVertexAttribArray(g.attributes[b])}};
Mesh.prototype.clone=function(g){g=g||r.gl;var e={},a={},b;for(b in this.vertexBuffers){var c=this.vertexBuffers[b];e[b]=new c.data.constructor(c.data)}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=new c.data.constructor(c.data);return new h.Mesh(e,a,void 0,g)};Mesh.prototype.cloneShared=function(g){g=g||r.gl;return new h.Mesh(this.vertexBuffers,this.indexBuffers,void 0,g)};Mesh.prototype.toObject=function(){var g={},e={},a;for(a in this.vertexBuffers){var b=this.vertexBuffers[a];g[a]={spacing:b.spacing,
data:new b.data.constructor(b.data)}}for(a in this.indexBuffers)b=this.indexBuffers[a],e[a]={data:new b.data.constructor(b.data)};return{vertexBuffers:g,indexBuffers:e,info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()}};Mesh.prototype.toJSON=function(){var g={vertexBuffers:{},indexBuffers:{},info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()},e;for(e in this.vertexBuffers)g.vertexBuffers[e]=this.vertexBuffers[e].toJSON();for(e in this.indexBuffers)g.indexBuffers[e]=
this.indexBuffers[e].toJSON();return g};Mesh.prototype.fromJSON=function(g){this.vertexBuffers={};this.indexBuffers={};for(var e in g.vertexBuffers)if(g.vertexBuffers[e]){var a=new h.Buffer;a.fromJSON(g.vertexBuffers[e]);!a.attribute&&h.Mesh.common_buffers[e]&&(a.attribute=h.Mesh.common_buffers[e].attribute);this.vertexBuffers[e]=a}for(e in g.indexBuffers)g.indexBuffers[e]&&(a=new h.Buffer,a.fromJSON(g.indexBuffers[e]),this.indexBuffers[e]=a);g.info&&(this.info=cloneObject(g.info));g.bounding&&(this.bounding=
g.bounding)};Mesh.prototype.generateMetadata=function(){var g={},e=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;g.vertices=e.length/3;g.faces=a?a.length/3:e.length/9;g.indexed=!!this.metadata.faces;this.metadata=g};Mesh.prototype.computeWireframe=function(){var g=this.indexBuffers.triangles,e=this.vertexBuffers.vertices.data.length/3;if(g){for(var a=g.data,b=new h.Indexer,g=0;g<a.length;g+=3)for(var c=a.subarray(g,g+3),d=0;d<c.length;d++){var f=c[d],k=c[(d+1)%c.length];b.add([Math.min(f,
k),Math.max(f,k)])}a=b.unique;b=65536<e?new Uint32Array(2*a.length):new Uint16Array(2*a.length);g=0;for(e=a.length;g<e;++g)b.set(a[g],2*g)}else for(g=e/3,b=65536<e?new Uint32Array(6*g):new Uint16Array(6*g),g=0;g<e;g+=3)b[2*g]=g,b[2*g+1]=g+1,b[2*g+2]=g+1,b[2*g+3]=g+2,b[2*g+4]=g+2,b[2*g+5]=g;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.flipNormals=function(g){var e=this.vertexBuffers.normals;if(e){for(var a=e.data,b=a.length,c=0;c<b;++c)a[c]*=-1;e.upload(g);this.indexBuffers.triangles||
this.computeIndices();e=this.indexBuffers.triangles;a=e.data;b=a.length;for(c=0;c<b;c+=3){var d=a[c];a[c]=a[c+1];a[c+1]=d}e.upload(g)}};Mesh.prototype.computeIndices=function(){var g=[],e=[],a=[],b=[],c=this.vertexBuffers.normals,d=this.vertexBuffers.coords,f=this.vertexBuffers.vertices.data,k=null;c&&(k=c.data);c=null;d&&(c=d.data);for(var d={},p=f.length/3,m=0;m<p;++m){var l=f.subarray(3*m,3*(m+1)),n=1E3*l[0]|0,q=0,s=d[n];if(s)for(var x=s.length;q<x;q++)if(0.01>vec3.sqrDist(l,g[s[q]])){b.push(q);
break}s&&q!=x||(g.push(l),d[n]?d[n].push(q):d[n]=[q],k&&e.push(k.subarray(3*m,3*(m+1))),c&&a.push(c.subarray(2*m,2*(m+1))),b.push(q))}this.vertexBuffers={};this.createVertexBuffer("vertices",h.Mesh.common_buffers.vertices.attribute,3,T(g));k&&this.createVertexBuffer("normals",h.Mesh.common_buffers.normals.attribute,3,T(e));c&&this.createVertexBuffer("coords",h.Mesh.common_buffers.coords.attribute,2,T(a));this.createIndexBuffer("triangles",b)};Mesh.prototype.explodeIndices=function(g){g=g||"triangles";
var e=this.getIndexBuffer(g);if(e){var a=e.data,e={},b;for(b in this.vertexBuffers){var c=h.Mesh.common_buffers[b];e[b]=new (c.type||Float32Array)(c.spacing*a.length)}b=0;for(var d=a.length;b<d;++b){var f=a[b],k;for(k in this.vertexBuffers){var p=this.vertexBuffers[k],c=h.Mesh.common_buffers[k],c=p.spacing||c.spacing;e[k].set(p.data.subarray(f*c,f*c+c),b*c)}}for(b in e)k=this.vertexBuffers[b],this.createVertexBuffer(b,k.attribute,k.spacing,e[b]);delete this.indexBuffers[g]}};Mesh.prototype.computeNormals=
function(g){if(!this.vertexBuffers.vertices)return console.error("Cannot compute normals of a mesh without vertices");var e=this.vertexBuffers.vertices.data,a=new Float32Array(e.length),b=null;this.indexBuffers.triangles&&(b=this.indexBuffers.triangles.data);for(var c=h.temp_vec3,d=h.temp2_vec3,f,k,p,m,l,n,q=b?b.length:e.length,s=0;s<q;s+=3)b?(f=b[s],k=b[s+1],p=b[s+2],m=e.subarray(3*f,3*f+3),l=e.subarray(3*k,3*k+3),n=e.subarray(3*p,3*p+3),f=a.subarray(3*f,3*f+3),k=a.subarray(3*k,3*k+3),p=a.subarray(3*
p,3*p+3)):(m=e.subarray(3*s,3*s+3),l=e.subarray(3*s+3,3*s+6),n=e.subarray(3*s+6,3*s+9),f=a.subarray(3*s,3*s+3),k=a.subarray(3*s+3,3*s+6),p=a.subarray(3*s+6,3*s+9)),vec3.sub(c,l,m),vec3.sub(d,n,m),vec3.cross(c,c,d),vec3.normalize(c,c),vec3.add(f,f,c),vec3.add(k,k,c),vec3.add(p,p,c);if(b)for(s=0,q=a.length;s<q;s+=3)e=a.subarray(s,s+3),vec3.normalize(e,e);if(q=this.vertexBuffers.normals)q.data=a,q.upload(g);else return this.createVertexBuffer("normals",h.Mesh.common_buffers.normals.attribute,3,a);return q};
Mesh.prototype.computeTangents=function(){var g=this.vertexBuffers.vertices;if(!g)return console.error("Cannot compute tangents of a mesh without vertices");var e=this.vertexBuffers.normals;if(!e)return console.error("Cannot compute tangents of a mesh without normals");var a=this.vertexBuffers.coords;if(!a)return console.error("Cannot compute tangents of a mesh without uvs");var b=this.indexBuffers.triangles;if(!b)return console.error("Cannot compute tangents of a mesh without indices");var g=g.data,
e=e.data,c=a.data,d=b.data;if(g&&e&&c){var f=g.length/3,b=new Float32Array(4*f),a=new Float32Array(6*f),f=a.subarray(3*f),k,h,m=vec3.create(),l=vec3.create(),n=vec3.create(),q=vec3.create();k=0;for(h=d.length;k<h;k+=3){var s=d[k],x=d[k+1],t=d[k+2],u=g.subarray(3*s,3*s+3),r=g.subarray(3*x,3*x+3),v=g.subarray(3*t,3*t+3),E=c.subarray(2*s,2*s+2),y=c.subarray(2*x,2*x+2),C=c.subarray(2*t,2*t+2),B=r[0]-u[0],M=v[0]-u[0],K=r[1]-u[1],A=v[1]-u[1],r=r[2]-u[2],u=v[2]-u[2],v=y[0]-E[0],D=C[0]-E[0],y=y[1]-E[1],E=
C[1]-E[1],C=v*E-D*y,C=1E-9>Math.abs(C)?0:1/C;vec3.copy(m,[(E*B-y*M)*C,(E*K-y*A)*C,(E*r-y*u)*C]);vec3.copy(l,[(v*M-D*B)*C,(v*A-D*K)*C,(v*u-D*r)*C]);vec3.add(a.subarray(3*s,3*s+3),a.subarray(3*s,3*s+3),m);vec3.add(a.subarray(3*x,3*x+3),a.subarray(3*x,3*x+3),m);vec3.add(a.subarray(3*t,3*t+3),a.subarray(3*t,3*t+3),m);vec3.add(f.subarray(3*s,3*s+3),f.subarray(3*s,3*s+3),l);vec3.add(f.subarray(3*x,3*x+3),f.subarray(3*x,3*x+3),l);vec3.add(f.subarray(3*t,3*t+3),f.subarray(3*t,3*t+3),l)}k=0;for(h=g.length;k<
h;k+=3)g=e.subarray(k,k+3),c=a.subarray(k,k+3),vec3.subtract(n,c,vec3.scale(n,g,vec3.dot(g,c))),vec3.normalize(n,n),g=0>vec3.dot(vec3.cross(q,g,c),f.subarray(k,k+3))?-1:1,b.set([n[0],n[1],n[2],g],k/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,b)}};Mesh.prototype.computeTextureCoordinates=function(g){var e=this.vertexBuffers.vertices;if(!e)return console.error("Cannot compute uvs of a mesh without vertices");this.explodeIndices("triangles");var e=e.data,a=this.vertexBuffers.coords,
b=new Float32Array(e.length/3*2),c=this.indexBuffers.triangles,d=null;c&&(d=c.data);var c=vec3.create(),f=vec3.create(),k=vec3.create(),h=this.getBoundingBox(),m=BBox.getCenter(h),l=vec3.create();l.set(BBox.getHalfsize(h));vec3.scale(l,l,2);for(var h=d?d.length:e.length/3,n=0;n<h;n+=3){if(d)var q=d[n],s=d[n+1],x=d[n+2],t=e.subarray(3*q,3*q+3),u=e.subarray(3*s,3*s+3),r=e.subarray(3*x,3*x+3),q=b.subarray(2*q,2*q+2),s=b.subarray(2*s,2*s+2),x=b.subarray(2*x,2*x+2);else t=e.subarray(3*n,3*n+3),u=e.subarray(3*
(n+1),3*(n+1)+3),r=e.subarray(3*(n+2),3*(n+2)+3),q=b.subarray(2*n,2*n+2),s=b.subarray(2*(n+1),2*(n+1)+2),x=b.subarray(2*(n+2),2*(n+2)+2);vec3.sub(f,t,u);vec3.sub(k,t,r);vec3.cross(c,f,k);c[0]=Math.abs(c[0]);c[1]=Math.abs(c[1]);c[2]=Math.abs(c[2]);c[0]>c[1]&&c[0]>c[2]?(q[0]=(t[2]-m[2])/l[2],q[1]=(t[1]-m[1])/l[1],s[0]=(u[2]-m[2])/l[2],s[1]=(u[1]-m[1])/l[1],x[0]=(r[2]-m[2])/l[2],x[1]=(r[1]-m[1])/l[1]):c[1]>c[2]?(q[0]=(t[0]-m[0])/l[0],q[1]=(t[2]-m[2])/l[2],s[0]=(u[0]-m[0])/l[0],s[1]=(u[2]-m[2])/l[2],
x[0]=(r[0]-m[0])/l[0],x[1]=(r[2]-m[2])/l[2]):(q[0]=(t[0]-m[0])/l[0],q[1]=(t[1]-m[1])/l[1],s[0]=(u[0]-m[0])/l[0],s[1]=(u[1]-m[1])/l[1],x[0]=(r[0]-m[0])/l[0],x[1]=(r[1]-m[1])/l[1])}a?(a.data=b,a.upload(g)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,b)};Mesh.prototype.getNumVertices=function(){var g=this.vertexBuffers.vertices;return g?g.data.length/g.spacing:0};Mesh.prototype.getNumTriangles=function(){var g=this.getIndexBuffer("triangles");return g?g.data.length/3:this.getNumVertices()/
3};Mesh.computeBoundingBox=function(g,e,a){if(g){var b=0;if(a){for(var c=0;c<a.length;++c)if(a[c]){b=c;break}if(b==a.length){console.warn("mask contains only zeros, no vertices marked");return}}for(var d=vec3.clone(g.subarray(3*b,3*b+3)),f=vec3.clone(g.subarray(3*b,3*b+3)),c=3*b;c<g.length;c+=3)if(!a||a[c/3])b=g.subarray(c,c+3),vec3.min(d,b,d),vec3.max(f,b,f);if(isNaN(d[0])||isNaN(d[1])||isNaN(d[2])||isNaN(f[0])||isNaN(f[1])||isNaN(f[2]))d[0]=d[1]=d[2]=0,f[0]=f[1]=f[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices");
g=vec3.add(vec3.create(),d,f);vec3.scale(g,g,0.5);f=vec3.subtract(vec3.create(),f,g);return BBox.setCenterHalfsize(e||BBox.create(),g,f)}};Mesh.prototype.getBoundingBox=function(){if(this._bounding)return this._bounding;this.updateBoundingBox();return this._bounding};Mesh.prototype.updateBoundingBox=function(){var g=this.vertexBuffers.vertices;g&&(h.Mesh.computeBoundingBox(g.data,this._bounding),this.info&&this.info.groups&&this.info.groups.length&&this.computeGroupsBoundingBoxes())};Mesh.prototype.computeGroupsBoundingBoxes=
function(){var g=null,e=this.getIndexBuffer("triangles");e&&(g=e.data);e=this.getVertexBuffer("vertices");if(!e)return!1;e=e.data;if(!e.length)return!1;var a=this.info.groups;if(a){for(var b=0;b<a.length;++b){var c=a[b];c.bounding=c.bounding||BBox.create();var d=null;if(g){for(var d=new Uint8Array(e.length/3),f=c.start,k=0,p=c.length;k<p;k+=3)d[g[f+k]]=1,d[g[f+k+1]]=1,d[g[f+k+2]]=1;h.Mesh.computeBoundingBox(e,c.bounding,d)}else d=e.subarray(3*c.start,3*(c.start+c.length)),h.Mesh.computeBoundingBox(d,
c.bounding)}return!0}};Mesh.prototype.setBoundingBox=function(g,e){BBox.setCenterHalfsize(this._bounding,g,e)};Mesh.prototype.freeData=function(){for(var g in this.vertexBuffers)this.vertexBuffers[g].data=null,delete this[this.vertexBuffers[g].name];for(var e in this.indexBuffers)this.indexBuffers[e].data=null,delete this[this.indexBuffers[e].name]};Mesh.prototype.configure=function(g,e){var a={},b={};e=e||{};for(var c in g)if(g[c])if("vertexBuffers"==c||"vertex_buffers"==c)for(d in g[c])a[d]=g[c][d];
else if("indexBuffers"==c||"index_buffers"==c)for(d in g[c])b[d]=g[c][d];else"indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=g[c]:h.Mesh.common_buffers[c]?a[c]=g[c]:e[c]=g[c];this.addBuffers(a,b,e.stream_type);for(var d in e)this[d]=e[d];e.bounding||this.updateBoundingBox()};Mesh.prototype.totalMemory=function(){var g=0,e;for(e in this.vertexBuffers)g+=this.vertexBuffers[e].data.buffer.byteLength;for(e in this.indexBuffers)g+=this.indexBuffers[e].data.buffer.byteLength;return g};Mesh.prototype.slice=
function(g,e){var a={},b=this.indexBuffers.triangles;if(!b)return console.warn("splice in not indexed not supported yet"),null;var b=b.data,c=[],d=new Int32Array(b.length);d.fill(-1);var f=g+e;f>=b.length&&(f=b.length);for(var k=0,p=g;p<f;++p){var m=b[p];if(-1!=d[m])c.push(d[m]);else{var l=k++;d[m]=l;c.push(l);for(var n in this.vertexBuffers){var q=this.vertexBuffers[n],l=q.data,q=q.spacing;a[n]||(a[n]=[]);for(var s=a[n],x=0;x<q;++x)s.push(l[x+m*q])}}}a=new h.Mesh(a,{triangles:c},null,gl);a.updateBoundingBox();
return a};Mesh.prototype.simplify=function(){var g=this.getBoundingBox(),e=BBox.getMin(g),g=BBox.getHalfsize(g),g=vec3.scale(vec3.create(),g,2),a=new h.Mesh,b=vec3.create(),c;for(c in this.vertexBuffers){var d=this.vertexBuffers[c].data,f=new Float32Array(d.length);if("vertices"==c)for(var k=0,p=d.length;k<p;k+=3){var m=d.subarray(k,k+3);vec3.sub(b,m,e);vec3.div(b,b,g);b[0]=Math.round(256*b[0])/256;b[1]=Math.round(256*b[1])/256;b[2]=Math.round(256*b[2])/256;vec3.mul(b,b,g);vec3.add(b,b,e);f.set(b,
k)}a.addBuffer()}};Mesh.load=function(g,e,a,b){e=e||{};e.no_gl&&(b=null);a=a||new h.Mesh(null,null,null,b);a.configure(g,e);return a};Mesh.mergeMeshes=function(g,e){function a(a,b,c,d){for(c=b+c;b<c;b+=3){var e=a.subarray(b,b+3);vec3.transformMat4(e,e,d)}}function b(a,b,c,d){for(c=b+c;b<c;b+=2){var e=a.subarray(b,b+2);vec2.transformMat3(e,e,d)}}function c(a,b,c,d){if(d)for(c=b+c;b<c;++b)a[b]+=d}e=e||{};for(var d={},f={},k={},p=[],m=0,l=[],n=[],q={},s=0;s<g.length;++s){var x=g[s],t=x.mesh,u=m;p.push(u);
var r=t.vertexBuffers.vertices.data.length/3,m=m+r,v;for(v in t.vertexBuffers)d[v]=d[v]?d[v]+t.vertexBuffers[v].data.length:t.vertexBuffers[v].data.length;for(v in t.indexBuffers)f[v]=f[v]?f[v]+t.indexBuffers[v].data.length:t.indexBuffers[v].data.length;x={name:"mesh_"+s,start:u,length:r,material:""};if(t.bones){u={};for(v=0;v<t.bones.length;++v)r=t.bones[v],q[r[0]]||(q[r[0]]=n.length,n.push(r)),u[v]=q[r[0]];r=t.vertexBuffers.bone_indices.data;for(v=0;v<r.length;v+=1)r[v]=u[r[v]]}else if(n.length)throw"cannot merge meshes, one contains bones, the other doesnt";
l.push(x)}for(v in d)if(s=e[v],null===s)delete d[v];else{if(!s){if(q=t.vertexBuffers[v])q.data&&(q=q.data),q.constructor!==Array&&(s=q.constructor);s||(s=Float32Array)}d[v]=new s(d[v]);k[v]=0}for(v in f)s=65536>m?Uint16Array:Uint32Array,f[v]=new s(f[v]),k[v]=0;for(s=0;s<g.length;++s){x=g[s];t=x.mesh;r=u=0;for(v in t.vertexBuffers)d[v]&&("vertices"==v&&(r=t.vertexBuffers[v].data.length/3),d[v].set(t.vertexBuffers[v].data,k[v]),x[v+"_matrix"]&&(m=x[v+"_matrix"],16==m.length?a(d[v],k[v],t.vertexBuffers[v].data.length,
m):9==m.length&&b(d[v],k[v],t.vertexBuffers[v].data.length,m)),k[v]+=t.vertexBuffers[v].data.length);for(v in t.indexBuffers)f[v].set(t.indexBuffers[v].data,k[v]),c(f[v],k[v],t.indexBuffers[v].data.length,p[s]),k[v]+=t.indexBuffers[v].data.length}k={info:{groups:l}};n.length&&(k.bones=n);return e.only_data?{vertexBuffers:d,indexBuffers:f,info:{groups:l}}:(t=new h.Mesh(d,f,k),t.updateBoundingBox(),t)};Mesh.parsers={};Mesh.encoders={};Mesh.binary_file_formats={};Mesh.compressors={};Mesh.decompressors=
{};Mesh.fromURL=function(g,e,a,b){b=b||{};a=a||r.gl;var c=g.lastIndexOf("."),d=g.substr(c+1).toLowerCase();b.extension&&(d=b.extension);if(!h.Mesh.parsers[d.toLowerCase()])return console.error("No parser available in litegl to parse mesh of type",d),null;var f=new h.Mesh(void 0,void 0,void 0,a);f.ready=!1;b.binary=Mesh.binary_file_formats[d];HttpRequest(g,null,function(a){f.parse(a,d,b);delete f.ready;e&&e.call(f,f,g,b)},function(a){e&&e(null)},b);return f};Mesh.prototype.parse=function(g,e,a){a=
a||{};a.mesh=this;e=e.toLowerCase();var b=h.Mesh.parsers[e];if(b)return b.call(null,g,a);throw"GL.Mesh.parse: no parser found for format "+e;};Mesh.prototype.encode=function(g,e){g=g.toLowerCase();var a=h.Mesh.encoders[g];if(a)return a.call(null,this,e);throw"GL.Mesh.encode: no encoder found for format "+g;};Mesh.getScreenQuad=function(g){g=g||r.gl;var e=g.meshes[":screen_quad"];if(e)return e;var e=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]),
e=new h.Mesh({vertices:e,coords:a},void 0,void 0,g);return g.meshes[":screen_quad"]=e};h.linearizeArray=T;h.Mesh.EXTENSION="wbin";h.Mesh.enable_wbin_compression=!0;N.DEFAULT_NORMAL=vec3.fromValues(0,1,0);N.DEFAULT_COORD=vec2.fromValues(0.5,0.5);N.DEFAULT_COLOR=vec4.fromValues(1,1,1,1);N.prototype.resize=function(g){var e={};this._vertex_data=new Float32Array(3*g);e.vertices=this._vertex_data;normals&&(e.normals=this._normal_data=new Float32Array(3*g));coords&&(e.coords=this._coord_data=new Float32Array(2*
g));colors&&(e.colors=this._color_data=new Float32Array(4*g));this.addBuffers(e);this.current_pos=0;this.max_size=g;this._must_update=!0};N.prototype.clear=function(){this.current_pos=0};N.prototype.addPoint=function(g,e,a,b){if(c>=this.max_size)return console.warn("DynamicMesh: not enough space, reserve more"),!1;var c=this.current_pos++;this._vertex_data.set(g,3*c);this._normal_data&&this._normal_data.set(e||N.DEFAULT_NORMAL,3*c);this._coord_data&&this._coord_data.set(a||N.DEFAULT_COORD,2*c);this._color_data&&
this._color_data.set(b||N.DEFAULT_COLOR,4*c);return this._must_update=!0};N.prototype.update=function(g){if(!this._must_update&&!g)return this.current_pos;this._must_update=!1;this.getBuffer("vertices").upload(gl.STREAM_DRAW);this._normal_data&&this.getBuffer("normal").upload(gl.STREAM_DRAW);this._coord_data&&this.getBuffer("coord").upload(gl.STREAM_DRAW);this._color_data&&this.getBuffer("color").upload(gl.STREAM_DRAW);return this.current_pos};extendClass(N,Mesh);Mesh.plane=function(g,e){g=g||{};
g.triangles=[];var a=g.detailX||g.detail||1,b=g.detailY||g.detail||1,c=g.width||g.size||1,d=g.height||g.size||1,f=g.xz,c=0.5*c,d=0.5*d,k=[],p=[],m=[],l=[],n=vec3.fromValues(0,0,1);f&&n.set([0,1,0]);for(var q=0;q<=b;q++)for(var s=q/b,r=0;r<=a;r++){var t=r/a;f?p.push((2*t-1)*c,0,-(2*s-1)*d):p.push((2*t-1)*c,(2*s-1)*d,0);m.push(t,s);l.push(n[0],n[1],n[2]);r<a&&q<b&&(t=r+q*(a+1),f?(k.push(t+1,t+a+1,t),k.push(t+1,t+a+2,t+a+1)):(k.push(t,t+1,t+a+1),k.push(t+a+1,t+1,t+a+2)))}a=BBox.fromCenterHalfsize([0,
0,0],f?[c,0,d]:[c,d,0]);return h.Mesh.load({vertices:p,normals:l,coords:m,triangles:k},{bounding:a},e)};Mesh.plane2D=function(g,e){var a=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),b=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(g&&g.size)for(var c=0.5*g.size,d=0;d<a.length;++d)a[d]*=c;return new h.Mesh({vertices2D:a,coords:b},null,e)};Mesh.point=function(g){return new h.Mesh({vertices:[0,0,0]})};Mesh.cube=function(g,e){g=g||{};var a=0.5*(g.size||1),b={};b.vertices=new Float32Array([-1,1,-1,
-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var c=0,d=b.vertices.length;c<d;++c)b.vertices[c]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,
-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,a]);return h.Mesh.load(b,g,e)};Mesh.box=function(g,e){g=g||{};var a=g.sizex||1,b=g.sizey||1,c=g.sizez||
1,a=0.5*a,b=0.5*b,c=0.5*c,d={};d.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var f=0,k=d.vertices.length;f<k;f+=3)d.vertices[f]*=a,d.vertices[f+1]*=b,d.vertices[f+2]*=c;d.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,
0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);d.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(d.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,
0,0],[a,b,c]);return h.Mesh.load(d,g,e)};Mesh.circle=function(g,e){g=g||{};var a=g.size||g.radius||1,b=Math.ceil(g.slices||24),c=g.xz||!1,d=g.empty||!1;3>b&&(b=3);var f=2*Math.PI/b,k=vec3.create(),p=vec3.create(),m=vec3.fromValues(0,0,1),l=vec2.fromValues(0.5,0.5),n=vec2.create();c&&m.set([0,1,0]);var q=c?2:1,s=new Float32Array(3*(b+1)),r=new Float32Array(3*(b+1)),t=new Float32Array(2*(b+1)),u=null;s.set(k,0);r.set(m,0);t.set(l,0);for(k=l=u=0;k<b;++k)u=Math.sin(f*k),l=Math.cos(f*k),p[0]=u*a,p[q]=
l*a,n[0]=0.5*u+0.5,n[1]=0.5*l+0.5,s.set(p,3*k+3),r.set(m,3*k+3),t.set(n,2*k+2);if(d)s=s.subarray(3),r=s.subarray(3),t=s.subarray(2),u=null;else{u=new Uint16Array(3*b);d=2;f=1;c&&(d=1,f=2);for(k=0;k<b-1;++k)u[3*k]=0,u[3*k+1]=k+d,u[3*k+2]=k+f;u[3*k]=0;c?(u[3*k+1]=k+1,u[3*k+2]=1):(u[3*k+1]=1,u[3*k+2]=k+1)}g.bounding=BBox.fromCenterHalfsize([0,0,0],c?[a,0,a]:[a,a,0]);a={vertices:s,normals:r,coords:t,triangles:u};if(g.wireframe){c=new Uint16Array(2*b);for(k=0;k<b;k++)c[2*k]=k,c[2*k+1]=k+1;c[0]=b;a.wireframe=
c}return h.Mesh.load(a,g,e)};Mesh.ring=function(g,e){g=g||{};var a=g.size||g.radius||1,b=g.thickness||0.1*a,c=Math.ceil(g.slices||24),d=g.xz||!1,f=g.empty||!1;3>c&&(c=3);var k=2*Math.PI/c;vec3.create();var p=vec3.create(),m=vec3.create(),l=vec3.fromValues(0,0,1);vec2.fromValues(0.5,0.5);var n=vec2.create();d&&l.set([0,1,0]);for(var q=d?2:1,s=new Float32Array(3*(2*c+2)),r=new Float32Array(3*(2*c+2)),t=new Float32Array(2*(2*c+2)),u=null,w=u=0,v=0;v<=c;++v)u=Math.sin(k*v),w=Math.cos(k*v),p[0]=u*(a-b),
p[q]=w*(a-b),n[0]=v/c,n[1]=0,s.set(p,6*v),r.set(l,6*v),t.set(n,4*v),m[0]=u*(a+b),m[q]=w*(a+b),n[1]=1,s.set(m,6*v+3),r.set(l,6*v+3),t.set(n,4*v+2);if(f)s=s.subarray(3),r=s.subarray(3),t=s.subarray(2),u=null;else for(u=new Uint16Array(6*c),f=2,k=1,d&&(f=1,k=2),v=0;v<c;++v)u[6*v]=2*v,u[6*v+1]=2*v+f,u[6*v+2]=2*v+k,u[6*v+3]=2*v+k,u[6*v+4]=2*v+f,u[6*v+5]=2*v+3;g.bounding=BBox.fromCenterHalfsize([0,0,0],d?[a+b,0,a+b]:[a+b,a+b,0]);a={vertices:s,normals:r,coords:t,triangles:u};if(g.wireframe){b=new Uint16Array(4*
c);for(v=0;v<c;v++)b[4*v]=2*v,b[4*v+1]=2*v+2,b[4*v+2]=2*v+1,b[4*v+3]=2*v+3;a.wireframe=b}return h.Mesh.load(a,g,e)};Mesh.cylinder=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||64,d=new Float32Array(36*c),f=new Float32Array(36*c),k=new Float32Array(24*c),h=2*Math.PI/c,m=null,l=0;l<c;++l){var n=l*h,m=[Math.sin(n),0,Math.cos(n)];d.set([m[0]*a,0.5*b,m[2]*a],18*l);f.set(m,18*l);k.set([l/c,1],12*l);m=[Math.sin(n),0,Math.cos(n)];d.set([m[0]*a,-0.5*b,m[2]*a],
18*l+3);f.set(m,18*l+3);k.set([l/c,0],12*l+2);m=[Math.sin(n+h),0,Math.cos(n+h)];d.set([m[0]*a,-0.5*b,m[2]*a],18*l+6);f.set(m,18*l+6);k.set([(l+1)/c,0],12*l+4);m=[Math.sin(n+h),0,Math.cos(n+h)];d.set([m[0]*a,0.5*b,m[2]*a],18*l+9);f.set(m,18*l+9);k.set([(l+1)/c,1],12*l+6);m=[Math.sin(n),0,Math.cos(n)];d.set([m[0]*a,0.5*b,m[2]*a],18*l+12);f.set(m,18*l+12);k.set([l/c,1],12*l+8);m=[Math.sin(n+h),0,Math.cos(n+h)];d.set([m[0]*a,-0.5*b,m[2]*a],18*l+15);f.set(m,18*l+15);k.set([(l+1)/c,0],12*l+10)}var m=18*
l,q=12*l;if(!1===g.caps)d=d.subarray(0,m),f=f.subarray(0,m),k=k.subarray(0,q);else for(var s=vec3.fromValues(0,0.5*b,0),r=vec3.fromValues(0,-0.5*b,0),t=vec3.fromValues(0,1,0),u=vec3.fromValues(0,-1,0),l=0;l<c;++l){var n=l*h,w=vec3.fromValues(Math.sin(n),0,Math.cos(n)),n=vec3.fromValues(Math.sin(n+h),0,Math.cos(n+h));d.set([w[0]*a,0.5*b,w[2]*a],m+18*l);f.set(t,m+18*l);k.set([0.5*-w[0]+0.5,0.5*w[2]+0.5],q+12*l);d.set([n[0]*a,0.5*b,n[2]*a],m+18*l+3);f.set(t,m+18*l+3);k.set([0.5*-n[0]+0.5,0.5*n[2]+0.5],
q+12*l+2);d.set(s,m+18*l+6);f.set(t,m+18*l+6);k.set([0.5,0.5],q+12*l+4);d.set([n[0]*a,-0.5*b,n[2]*a],m+18*l+9);f.set(u,m+18*l+9);k.set([0.5*n[0]+0.5,0.5*n[2]+0.5],q+12*l+6);d.set([w[0]*a,-0.5*b,w[2]*a],m+18*l+12);f.set(u,m+18*l+12);k.set([0.5*w[0]+0.5,0.5*w[2]+0.5],q+12*l+8);d.set(r,m+18*l+15);f.set(u,m+18*l+15);k.set([0.5,0.5],q+12*l+10)}c={vertices:d,normals:f,coords:k};g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,0.5*b,a]);g.info={groups:[]};!1!==g.caps&&(g.info.groups.push({name:"side",start:0,
length:m/3}),g.info.groups.push({name:"caps",start:m/3,length:(d.length-m)/3}));return Mesh.load(c,g,e)};Mesh.cone=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||64,d=new Float32Array(18*c),f=new Float32Array(18*c),k=new Float32Array(12*c),h=2*Math.PI/c,m=null,l=a/b,n=0;n<c;++n){var q=n*h,m=[Math.sin(q+0.5*h),l,Math.cos(q+0.5*h)];vec3.normalize(m,m);d.set([0,b,0],18*n);f.set(m,18*n);k.set([n/c,1],12*n);m=[Math.sin(q),l,Math.cos(q)];d.set([m[0]*a,0,m[2]*
a],18*n+3);vec3.normalize(m,m);f.set(m,18*n+3);k.set([n/c,0],12*n+2);m=[Math.sin(q+h),l,Math.cos(q+h)];d.set([m[0]*a,0,m[2]*a],18*n+6);vec3.normalize(m,m);f.set(m,18*n+6);k.set([(n+1)/c,0],12*n+4)}m=vec3.fromValues(0,0,0);l=vec3.fromValues(0,-1,0);for(n=0;n<c;++n){var q=n*h,s=vec3.fromValues(Math.sin(q),0,Math.cos(q)),q=vec3.fromValues(Math.sin(q+h),0,Math.cos(q+h));d.set([q[0]*a,0,q[2]*a],18*n+9);f.set(l,18*n+9);k.set([0.5*q[0]+0.5,0.5*q[2]+0.5],12*n+6);d.set([s[0]*a,0,s[2]*a],18*n+12);f.set(l,18*
n+12);k.set([0.5*s[0]+0.5,0.5*s[2]+0.5],12*n+8);d.set(m,18*n+15);f.set(l,18*n+15);k.set([0.5,0.5],12*n+10)}c={vertices:d,normals:f,coords:k};g.bounding=BBox.fromCenterHalfsize([0,0.5*b,0],[a,0.5*b,a]);return Mesh.load(c,g,e)};Mesh.torus=function(g,e){g=g||{};var a=g.outerradius||g.radius||1,b=Math.ceil(g.outerslices||g.slices||24),c=g.innerradius||0.1*a,d=Math.ceil(g.innerslices||b),f=g.angle||2*Math.PI,k=2*Math.PI/d,p=f/b;vec3.create();var m=vec3.create(),l=vec3.fromValues(0,0,1);vec2.fromValues(0.5,
0.5);for(var n=vec2.create(),f=f==2*Math.PI,q=new Float32Array(3*d),s=new Float32Array(3*d),r=0,t=0,u=0;u<d;++u)r=Math.sin(k*u),t=Math.cos(k*u),m[0]=r*c,m[1]=t*c,n[0]=0.5*r+0.5,n[1]=0.5*t+0.5,q.set(m,3*u),vec3.normalize(l,m),s.set(l,3*u);var k=new Float32Array(3*b*d),n=new Float32Array(3*b*d),r=new Float32Array(2*b*d),t=null,w=mat4.create(),v=vec3.fromValues(-a,0,0),E=vec3.fromValues(0,1,0);vec3.create();for(var t=[],y=d,u=0;u<b;++u){mat4.identity(w);mat4.rotate(w,w,u*p,E);mat4.translate(w,w,v);var C=
u*d,y=d;u>=b-1&&(y=(b-1)*-d,f||(y=0));for(var B=0;B<d;++B){var M=q.subarray(3*B,3*B+3),K=s.subarray(3*B,3*B+3);mat4.multiplyVec3(m,w,M);mat4.rotateVec3(l,w,K);k.set(m,3*B+3*u*d);n.set(l,3*B+3*u*d);r.set([u/b,B/d],2*B+2*u*d);M=C+B;K=C+(B+1)%d;t.push(K,M,M+y,K,M+y,K+y)}}a=c+a;g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,c]);return h.Mesh.load({vertices:k,normals:n,coords:r,triangles:t},g,e)};Mesh.sphere=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.lat||g.subdivisions||16,c=g["long"]||
g.subdivisions||16,d=new Float32Array((b+1)*(c+1)*3),f=new Float32Array((b+1)*(c+1)*3),k=new Float32Array((b+1)*(c+1)*2),p=new Uint16Array(b*c*6),m=g.hemi?0.5*Math.PI:Math.PI,l=0,n=0,q=0;q<=b;q++)for(var s=q*m/b,r=Math.sin(s),t=Math.cos(s),s=0;s<=c;s++){var u=2*s*Math.PI/c,w=Math.sin(u),u=Math.cos(u)*r,v=t,w=w*r,E=1-s/c,y=1-q/b;d.set([a*u,a*v,a*w],l);f.set([u,v,w],l);k.set([E,y],n);l+=3;n+=2}for(q=l=0;q<b;q++)for(s=0;s<c;s++)m=q*(c+1)+s,n=m+c+1,p.set([n,m,m+1],l),p.set([n+1,n,m+1],l+3),l+=6;d={vertices:d,
normals:f,coords:k,triangles:p};if(g.wireframe){f=new Uint16Array(c*b*4);for(l=k=0;l<b;l++){for(p=0;p<c;p++)f[k]=l*(c+1)+p,f[k+1]=l*(c+1)+p+1,k+=2;f[k-2*c]=l*(c+1)+p}for(l=0;l<c;l++)for(p=0;p<b;p++)f[k]=p*(c+1)+l,f[k+1]=(p+1)*(c+1)+l,k+=2;d.wireframe=f}g.bounding=g.hemi?BBox.fromCenterHalfsize([0,0.5*a,0],[a,0.5*a,a],a):BBox.fromCenterHalfsize([0,0,0],[a,a,a],a);return h.Mesh.load(d,g,e)};Mesh.grid=function(g,e){g=g||{};var a=g.lines||11;0>a&&(a=1);for(var b=g.size||10,c=new Float32Array(12*a),d=
0.5*b,f=0,k=-d,b=b/(a-1),p=0;p<a;p++)c[f]=k,c[f+2]=-d,c[f+3]=k,c[f+5]=d,c[f+6]=d,c[f+8]=k,c[f+9]=-d,c[f+11]=k,k+=b,f+=12;return new h.Mesh({vertices:c},g,e)};Mesh.icosahedron=function(g,e){function a(a,c){var d=m[a]<m[c]?m[a]+":"+m[c]:m[c]+":"+m[a],e=t[d];if(e)return e;e=f.length/3;f.push(0.5*(f[3*m[a]]+f[3*m[c]]),0.5*(f[3*m[a]+1]+f[3*m[c]+1]),0.5*(f[3*m[a]+2]+f[3*m[c]+2]));var g=Math.sqrt(f[3*e]*f[3*e]+f[3*e+1]*f[3*e+1]+f[3*e+2]*f[3*e+2]),h=f[3*e]/g,l=f[3*e+1]/g,n=f[3*e+2]/g;k.push(h,l,n);p.push(Math.atan2(h,
n)/Math.PI*0.5,Math.acos(l)/Math.PI);f[3*e]*=b/g;f[3*e+1]*=b/g;f[3*e+2]*=b/g;return t[d]=e}g=g||{};var b=g.radius||g.size||1,c=void 0===g.subdivisions?0:g.subdivisions;6<c&&(c=6);for(var d=(1+Math.sqrt(5))/2,f=[-1,d,0,1,d,0,-1,-d,0,1,-d,0,0,-1,d,0,1,d,0,-1,-d,0,1,-d,d,0,-1,d,0,1,-d,0,-1,-d,0,1],k=[],p=[],m=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],d=f.length,l=0;l<d;l+=3){var n=Math.sqrt(f[l]*f[l]+f[l+1]*f[l+
1]+f[l+2]*f[l+2]),q=f[l]/n,s=f[l+1]/n,r=f[l+2]/n;k.push(q,s,r);p.push(Math.atan2(q,r),Math.acos(s));f[l]*=b/n;f[l+1]*=b/n;f[l+2]*=b/n}for(var t={},n=0;n<c;++n){q=[];d=m.length;for(l=0;l<d;l+=3){var s=a(l,l+1),r=a(l+1,l+2),u=a(l+2,l);q.push(m[l],s,u);q.push(m[l+1],r,s);q.push(m[l+2],u,r);q.push(s,r,u)}m=q}g.bounding=BBox.fromCenterHalfsize([0,0,0],[b,b,b],b);return new h.Mesh.load({vertices:f,coords:p,normals:k,triangles:m},g,e)};Mesh.shape=function(g,e,a){function b(a,b){var c=a[b+1];a[b+1]=a[b+2];
a[b+2]=-c}e=e||{};if("undefined"===typeof earcut)throw"To use GL.Mesh.shape you must download and include earcut.js (do not link it directly!): https://raw.githubusercontent.com/mapbox/earcut/master/src/earcut.js";if(!g||!g.length||1==g.length%2)throw"GL.Mesh.shape line missing, must be an array of 2D vertices";var c=e.extrude||0;g[0].constructor===Array&&(g=earcut.flatten(g));var d=earcut(g).reverse();console.log(d);for(var f=[],k=[],p=[],m=[g[0],g[1]],l=[g[0],g[1]],n=0;n<g.length;n+=2)m[0]=Math.min(m[0],
g[n]),m[1]=Math.max(m[1],g[n]),l[0]=Math.min(l[0],g[n+1]),l[1]=Math.max(l[1],g[n+1]);var q=m[1]-m[0],s=l[1]-l[0],r=[],t=null;if(c){for(var t=[],u=vec3.create(),w=g.length,n=0;n<g.length;n+=2){var v=g[n],E=g[n+1],y=g[(n+2)%w],C=g[(n+3)%w],B=f.length/3;f.push(v,0.5*c,E);f.push(v,-0.5*c,E);f.push(y,0.5*c,C);f.push(y,-0.5*c,C);vec3.normalize(u,vec3.cross(u,[0,1,0],[y-v,0,C-E]));k.push(u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2]);var M=(v-m[0])/q,K=(E-l[0])/s,v=(y-m[0])/q,E=(C-l[0])/s;
p.push(M,K,M,K,v,E,v,E);t.push(B,B+2,B+1,B+2,B+3,B+1)}r.push({name:"side",start:0,length:t.length});u=f.length/3;w=t.length;for(n=0;n<g.length;n+=2)v=g[n],E=g[n+1],M=(v-m[0])/q,K=(E-l[0])/s,f.push(v,0.5*c,E),f.push(v,-0.5*c,E),k.push(0,1,0,0,-1,0),p.push(M,K,M,K);for(n=0;n<d.length;n+=3)t.push(u+2*d[n],u+2*d[n+1],u+2*d[n+2]),t.push(u+2*d[n]+1,u+2*d[n+2]+1,u+2*d[n+1]+1);r.push({name:"caps",start:w,length:t.length});e.bounding=BBox.fromCenterHalfsize([0.5*(m[0]+m[1]),0,0.5*(l[0]+l[1])],[0.5*q,0.5*c,
0.5*s],vec2.len([0.5*q,0.5*c,0.5*s]))}else{for(n=0;n<g.length;n+=2)f.push(g[n],0,g[n+1]),k.push(0,1,0),p.push((g[n]-m[0])/q,(g[n+1]-l[0])/s);t=d;r.push({name:"side",start:0,length:t.length});e.bounding=BBox.fromCenterHalfsize([0.5*(m[0]+m[1]),0,0.5*(l[0]+l[1])],[0.5*q,0,0.5*s],vec2.len([0.5*q,0,0.5*s]))}if(e.xy){for(n=0;n<f.length;n+=3)b(f,n),b(k,n);e.bounding=c?BBox.fromCenterHalfsize([0.5*(m[0]+m[1]),0.5*(l[0]+l[1]),0],[0.5*q,0.5*s,0.5*c],vec2.len([0.5*q,0.5*s,0.5*c])):BBox.fromCenterHalfsize([0.5*
(m[0]+m[1]),0.5*(l[0]+l[1]),0],[0.5*q,0.5*s,0],vec2.len([0.5*q,0.5*s,0]))}e.info={groups:r};return new h.Mesh.load({vertices:f,coords:p,normals:k,triangles:t},e,a)};r.Texture=h.Texture=function e(a,b,c,d){function f(a){return a.constructor!==Array?a:k==h.FLOAT?new Float32Array(a):k==h.HALF_FLOAT_OES?new Uint16Array(a):new Uint8Array(a)}c=c||{};this.gl=d=d||r.gl;this._context_id=d.context_id;a=parseInt(a);b=parseInt(b);h.debug&&console.log("GL.Texture created: ",a,b);this.handler=d.createTexture();
this.width=a;this.height=b;c.depth&&(this.depth=c.depth);this.texture_type=c.texture_type||d.TEXTURE_2D;this.format=c.format||e.DEFAULT_FORMAT;this.internalFormat=c.internalFormat;this.type=c.type||e.DEFAULT_TYPE;this.magFilter=c.magFilter||c.filter||e.DEFAULT_MAG_FILTER;this.minFilter=c.minFilter||c.filter||e.DEFAULT_MIN_FILTER;this.wrapS=c.wrap||c.wrapS||e.DEFAULT_WRAP_S;this.wrapT=c.wrap||c.wrapT||e.DEFAULT_WRAP_T;this.data=null;e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS));
this.has_mipmaps=!1;if(this.format==d.DEPTH_COMPONENT&&1==d.webgl_version&&!d.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==d.FLOAT&&!d.extensions.OES_texture_float&&1==d.webgl_version)throw"Float Texture not supported";if(this.type==d.HALF_FLOAT_OES){if(!d.extensions.OES_texture_half_float&&1==d.webgl_version)throw"Half Float Texture extension not supported.";1<d.webgl_version&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),
this.type=this.format==d.RGB?d.RGB16F:d.RGBA16F)}if(!(isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(this.minFilter==d.NEAREST||this.minFilter==d.LINEAR)&&this.wrapS==d.CLAMP_TO_EDGE&&this.wrapT==d.CLAMP_TO_EDGE))if(c.ignore_pot)this.minFilter=this.magFilter=d.LINEAR,this.wrapS=this.wrapT=d.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(a&&b){this.internalFormat||this.computeInternalFormat();d.activeTexture(d.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-
1);d.bindTexture(this.texture_type,this.handler);d.texParameteri(this.texture_type,d.TEXTURE_MAG_FILTER,this.magFilter);d.texParameteri(this.texture_type,d.TEXTURE_MIN_FILTER,this.minFilter);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_S,this.wrapS);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_T,this.wrapT);c.anisotropic&&d.extensions.EXT_texture_filter_anisotropic&&d.texParameterf(h.TEXTURE_2D,d.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.anisotropic);var k=this.type,
p=c.pixel_data;if(p&&!p.buffer){if(this.texture_type==h.TEXTURE_CUBE_MAP)if(p[0].constructor===Number)p=f(p),p=[p,p,p,p,p,p];else for(var m=0;m<p.length;++m)p[m]=f(p[m]);else p=f(p);this.data=p}e.setUploadOptions(c);if(this.texture_type==h.TEXTURE_2D)d.texImage2D(h.TEXTURE_2D,0,this.internalFormat,a,b,0,this.format,this.type,p||null),h.isPowerOfTwo(a)&&h.isPowerOfTwo(b)&&c.minFilter&&c.minFilter!=d.NEAREST&&c.minFilter!=d.LINEAR&&(d.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==
h.TEXTURE_CUBE_MAP)for(a=a*a*(this.format==h.RGBA?4:3),m=0;6>m;++m)(b=p)&&(b.constructor===Array?b=b[m]:b.subarray(a*m,a*(m+1))),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,this.internalFormat,this.width,this.height,0,this.format,this.type,b||null);else if(this.texture_type==h.TEXTURE_3D){if(1==this.gl.webgl_version)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by passing webgl2:true to the context";if(!c.depth)throw"3d texture depth must be set in the options.depth";
d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1);d.texImage3D(h.TEXTURE_3D,0,this.internalFormat,a,b,c.depth,0,this.format,this.type,p||null)}d.bindTexture(this.texture_type,null);d.activeTexture(d.TEXTURE0)}};Texture.DEFAULT_TYPE=h.UNSIGNED_BYTE;Texture.DEFAULT_FORMAT=h.RGBA;Texture.DEFAULT_MAG_FILTER=h.LINEAR;Texture.DEFAULT_MIN_FILTER=h.LINEAR;Texture.DEFAULT_WRAP_S=h.CLAMP_TO_EDGE;Texture.DEFAULT_WRAP_T=h.CLAMP_TO_EDGE;Texture.EXTENSION="png";Texture.framebuffer=
null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.CROSS_ORIGIN_CREDENTIALS="Anonymous";Texture.prototype.computeInternalFormat=function(){this.internalFormat=this.format;if(this.format==h.DEPTH_COMPONENT)if(this.minFilter=h.NEAREST,2==gl.webgl_version)if(this.type==h.UNSIGNED_SHORT)this.internalFormat=h.DEPTH_COMPONENT16;else if(this.type==h.UNSIGNED_INT)this.internalFormat=h.DEPTH_COMPONENT24;else if(this.type==h.FLOAT)this.internalFormat=
h.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";else{if(1==gl.webgl_version){if(this.type==h.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=h.DEPTH_COMPONENT}}else this.format==gl.RGBA&&(2==gl.webgl_version?this.type==h.FLOAT?this.internalFormat=h.RGBA32F:this.type==h.HALF_FLOAT?this.internalFormat=h.RGBA16F:this.type==h.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),this.type=h.HALF_FLOAT,this.internalFormat=
h.RGBA16F):1==gl.webgl_version&&this.type==h.HALF_FLOAT&&(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=h.HALF_FLOAT_OES))};Texture.prototype.delete=function(){gl.deleteTexture(this.handler);this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.hasSameProperties=
function(e){return e?e.width==this.width&&e.height==this.height&&e.type==this.type&&e.format==this.format&&e.texture_type==this.texture_type:!1};Texture.prototype.hasSameSize=function(e){return e?e.width==this.width&&e.height==this.height:!1};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(e){void 0==e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,
this.handler);return e};Texture.prototype.unbind=function(e){void 0===e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(e,a){this.bind(0);this.gl.texParameteri(this.texture_type,e,a);switch(e){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=a;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=a;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=a;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=a}};Texture.setUploadOptions=function(e,
a){a=a||r.gl;Texture.disable_deprecated||(e?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0)));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.flipYData=function(e,a,b,c){var d=new e.constructor(a*c),f=0,k=a*(b-1)*c;b=Math.floor(0.5*b);for(var h=0;h<b;++h){var m=e.subarray(f,f+a*c),l=e.subarray(k,k+a*c);d.set(m);m.set(l);l.set(d);f+=a*c;k-=
a*c;if(f>k)break}};Texture.prototype.uploadImage=function(e,a){this.bind();var b=this.gl;if(!e)throw"uploadImage parameter must be Image";Texture.setUploadOptions(a,b);try{if(a&&a.subimage)1==b.webgl_version?b.texSubImage2D(b.TEXTURE_2D,0,0,0,this.format,this.type,e):b.texSubImage2D(b.TEXTURE_2D,0,0,0,e.videoWidth||e.width,e.videoHeight||e.height,this.format,this.type,e);else{var c=e.videoWidth||e.width,d=e.videoHeight||e.height;c==this.width&&d==this.height||1==this.width||1==this.height||console.warn("image uploaded has a different size than texture, resizing it.");
b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,e);this.width=c;this.height=d}this.data=e}catch(f){console.error(f);if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=
!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(e,a,b){a=a||{};if(!e)throw"no data passed";var c=this.gl;this.bind();Texture.setUploadOptions(a,c);var d=a.mipmap_level||0,f=this.width,k=this.height,f=f>>d,k=k>>d,p=this.internalFormat||this.format;this.type==h.HALF_FLOAT_OES&&e.constructor===Float32Array&&console.warn("cannot uploadData to a HALF_FLOAT texture from a Float32Array, must be Uint16Array. To upload it we recomment to create a FLOAT texture, upload data there and copy to your HALF_FLOAT.");
if(this.texture_type==h.TEXTURE_2D)1==c.webgl_version?e.buffer&&e.buffer.constructor==ArrayBuffer?c.texImage2D(this.texture_type,d,p,f,k,0,this.format,this.type,e):c.texImage2D(this.texture_type,d,p,this.format,this.type,e):2==c.webgl_version&&c.texImage2D(this.texture_type,d,p,f,k,0,this.format,this.type,e);else if(this.texture_type==h.TEXTURE_3D)c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),c.texImage3D(this.texture_type,d,p,f,k,this.depth>>d,0,this.format,
this.type,e);else if(this.texture_type==h.TEXTURE_CUBE_MAP)c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+(a.cubemap_face||0),d,p,f,k,0,this.format,this.type,e);else throw"cannot uploadData for this texture type";this.data=e;!b&&this.minFilter&&this.minFilter!=c.NEAREST&&this.minFilter!=c.LINEAR&&(c.generateMipmap(this.texture_type),this.has_mipmaps=!0);c.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,
0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}];Texture.prototype.drawTo=
function(e,a){function b(){6E4<=h.getTime()-this.time?(c.deleteRenderbuffer(c._renderbuffers_pool[l]),delete c._renderbuffers_pool[l]):setTimeout(b.bind(this),6E4)}var c=this.gl,d=c.getViewport(),f=h.getTime(),k=c.getParameter(c.FRAMEBUFFER_BINDING),p=c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,p);var m=null;if(Texture.use_renderbuffer_pool){c._renderbuffers_pool||(c._renderbuffers_pool={});var l=this.width+":"+this.height;c._renderbuffers_pool[l]?(m=c._renderbuffers_pool[l],
m.time=f,c.bindRenderbuffer(c.RENDERBUFFER,m)):(c._renderbuffers_pool[l]=m=c.createRenderbuffer(),m.time=f,m.width=this.width,m.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,m),setTimeout(b.bind(m),6E4))}else m=c._renderbuffer=c._renderbuffer||c.createRenderbuffer(),m.width=this.width,m.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,m);this.format===c.DEPTH_COMPONENT?c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,this.width,this.height):c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,
this.width,this.height);c.viewport(0,0,this.width,this.height);c._current_texture_drawto=this;c._current_fbo_color=p;c._current_fbo_depth=m;if(this.texture_type==c.TEXTURE_2D)this.format!==c.DEPTH_COMPONENT?(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,m)):(c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,m),c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,
c.TEXTURE_2D,this.handler,0)),e(this,a);else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(this.format!==c.DEPTH_COMPONENT?c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,m):c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,m),f=0;6>f;f++)this.format!==c.DEPTH_COMPONENT?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0):c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_CUBE_MAP_POSITIVE_X+
f,this.handler,0),e(this,f,a);this.data=null;c._current_texture_drawto=null;c._current_fbo_color=null;c._current_fbo_depth=null;c.bindFramebuffer(c.FRAMEBUFFER,k);c.bindRenderbuffer(c.RENDERBUFFER,null);c.viewport(d[0],d[1],d[2],d[3]);return this};Texture.prototype.copyTo=function(e,a,b){var c=this.gl;if(!e)throw"target_texture required";var d=c.getParameter(c.FRAMEBUFFER_BINDING),f=c.getViewport();a||(a=this.texture_type==c.TEXTURE_2D?h.Shader.getScreenShader():h.Shader.getCubemapCopyShader());c.disable(c.BLEND);
c.disable(c.DEPTH_TEST);a&&b&&a.uniforms(b);b=c.__copy_fbo;b||(b=c.__copy_fbo=c.createFramebuffer());c.bindFramebuffer(c.FRAMEBUFFER,b);c.viewport(0,0,e.width,e.height);if(this.texture_type==c.TEXTURE_2D)if(this.format!==c.DEPTH_COMPONENT&&this.format!==c.DEPTH_STENCIL)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e.handler,0),this.toViewport(a);else{a=c._color_renderbuffer=c._color_renderbuffer||c.createRenderbuffer();b=a.width=e.width;var k=a.height=e.height;c.bindRenderbuffer(c.RENDERBUFFER,
a);c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,b,k);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,a);b=e.format==c.DEPTH_STENCIL?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,e.handler,0);a=c.checkFramebufferStatus(c.FRAMEBUFFER);if(a!==c.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+a;c.enable(c.DEPTH_TEST);c.depthFunc(c.ALWAYS);c.colorMask(!1,!1,!1,!1);a=h.Shader.getCopyDepthShader();this.toViewport(a);c.colorMask(!0,
!0,!0,!0);c.disable(c.DEPTH_TEST);c.depthFunc(c.LEQUAL);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,null);c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,null,0)}else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(a.uniforms({u_texture:0}),b=h.temp_mat3,k=0;6>k;k++){c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+k,e.handler,0);var p=h.Texture.cubemap_camera_parameters[k];mat3.identity(b);b.set(p.right,0);b.set(p.up,3);b.set(p.dir,
6);this.toViewport(a,{u_rotation:b})}c.setViewport(f);c.bindFramebuffer(c.FRAMEBUFFER,d);e.minFilter&&e.minFilter!=c.NEAREST&&e.minFilter!=c.LINEAR&&(e.bind(),c.generateMipmap(e.texture_type),e.has_mipmaps=!0);e.data=null;c.bindTexture(e.texture_type,null);return this};Texture.prototype.blit=function(){var e=new Float32Array(4);return function(a,b,c){var d=this.gl;if(this.texture_type!=d.TEXTURE_2D||this.format===d.DEPTH_COMPONENT||this.format===d.DEPTH_STENCIL)throw"blit only support TEXTURE_2D of RGB or RGBA. use copyTo instead";
var f=d.getParameter(d.FRAMEBUFFER_BINDING);e.set(d.viewport_data);(b=b||h.Shader.getScreenShader())&&c&&b.uniforms(c);c=d.__copy_fbo;c||(c=d.__copy_fbo=d.createFramebuffer());d.bindFramebuffer(d.FRAMEBUFFER,c);d.viewport(0,0,a.width,a.height);d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,a.handler,0);this.bind(0);b.draw(h.Mesh.getScreenQuad(),d.TRIANGLES);d.setViewport(e);d.bindFramebuffer(d.FRAMEBUFFER,f);a.data=null;d.bindTexture(a.texture_type,null);return this}}();Texture.prototype.toViewport=
function(e,a){e=e||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);a&&e.uniforms(a);e.draw(b,gl.TRIANGLES)};Texture.prototype.fill=function(e,a){if(e.constructor===h.Shader)this.drawTo(function(){e.toViewport()});else{var b=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(e[0],e[1],e[2],e[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(b[0],b[1],b[2],b[3])}!a&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),
this.has_mipmaps=!0)};Texture.prototype.renderQuad=function(){var e=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,1,1,1);return function(d,f,k,h,m,l){a[0]=d;a[1]=f;b[0]=k;b[1]=h;m=m||Shader.getQuadShader(this.gl);d=Mesh.getScreenQuad(this.gl);this.bind(0);m.uniforms({u_texture:0,u_position:a,u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e});l&&m.uniforms(l);m.draw(d,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(e,a,b,c,d){var f=this.gl;void 0===
e&&(e=1);void 0===a&&(a=1);f.disable(f.DEPTH_TEST);f.disable(f.BLEND);c=c||this;var k=!d;if(d===c)throw"cannot use applyBlur in a texture using as temporary itself";if(c&&this.texture_type!==c.texture_type)throw"cannot use applyBlur with textures of different texture_type";var p=f.getParameter(f.FRAMEBUFFER_BINDING),m=f.getViewport(),l=f.__copy_fbo;l||(l=f.__copy_fbo=f.createFramebuffer());f.bindFramebuffer(f.FRAMEBUFFER,l);f.viewport(0,0,this.width,this.height);if(this.texture_type===f.TEXTURE_2D)l=
h.Shader.getBlurShader(),d||(d=h.Texture.getTemporary(this.width,this.height,this)),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,d.handler,0),this.toViewport(l,{u_texture:0,u_intensity:b,u_offset:[0,a/this.height]}),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,c.handler,0),f.viewport(0,0,c.width,c.height),d.toViewport(l,{u_intensity:b,u_offset:[e/d.width,0]}),k&&h.Texture.releaseTemporary(d);else if(this.texture_type===f.TEXTURE_CUBE_MAP){l=h.Shader.getCubemapBlurShader();
l.uniforms({u_texture:0,u_intensity:b,u_offset:[e/this.width,a/this.height]});this.bind(0);e=Mesh.getScreenQuad();e.bindBuffers(l);l.bind();a=null;a=d||c!=this?c:d=h.Texture.getTemporary(c.width,c.height,c);b=h.temp_mat3;for(var n=0;6>n;++n){f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+n,a.handler,0);var q=h.Texture.cubemap_camera_parameters[n];mat3.identity(b);b.set(q.right,0);b.set(q.up,3);b.set(q.dir,6);l._setUniform("u_rotation",b);f.drawArrays(f.TRIANGLES,
0,6)}e.unbindBuffers(l);d&&d.copyTo(c);d&&k&&h.Texture.releaseTemporary(d)}f.setViewport(m);f.bindFramebuffer(f.FRAMEBUFFER,p);c.data=null;c.minFilter&&c.minFilter!=f.NEAREST&&c.minFilter!=f.LINEAR&&(c.bind(),f.generateMipmap(c.texture_type),c.has_mipmaps=!0);f.bindTexture(c.texture_type,null)};Texture.fromURL=function(e,a,b,c){c=c||r.gl;a=a||{};a=Object.create(a);var d=a.texture||new h.Texture(1,1,a,c);64>e.length&&(d.url=e);d.bind();var f=a.temp_color||Texture.loading_color;c.pixelStorei(c.UNPACK_ALIGNMENT,
4);f=a.type==c.FLOAT?new Float32Array(f):new Uint8Array(f);c.texImage2D(c.TEXTURE_2D,0,d.format,d.width,d.height,0,d.format,d.type,f);c.bindTexture(d.texture_type,null);d.ready=!1;f=null;a.extension&&(f=a.extension);if(!f&&512>e.length){var k=e,p=e.indexOf("?");-1!=p&&(k=e.substr(0,p));p=k.lastIndexOf(".");-1!=p&&(f=k.substr(p+1).toLowerCase())}"dds"==f?(f=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),k=new h.Texture(0,0,a,c),U.loadDDSTextureEx(c,
f,e,k.handler,!0,function(a){d.texture_type=a.texture_type;d.handler=a;delete d.ready;b&&b(d,e)})):"tga"==f?HttpRequest(e,null,function(f){if(f=h.Texture.parseTGA(f))a.texture=d,f.flipY&&(a.no_flip=!0),"RGB"==f.format&&(d.format=c.RGB),d=h.Texture.fromMemory(f.width,f.height,f.pixels,a),delete d.ready,b&&b(d,e)},null,{binary:!0}):(f=new Image,f.src=e,f.crossOrigin=Texture.CROSS_ORIGIN_CREDENTIALS,f.onload=function(){a.texture=d;h.Texture.fromImage(this,a);delete d.ready;b&&b(d,e)},f.onerror=function(){b&&
b(null)});return d};Texture.parseTGA=function(e){if(!e||e.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";e=new Uint8Array(e);for(var a=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),b=e.subarray(0,12),c=0;c<b.length;c++)if(a[c]!=b[c])return console.error("TGA header is not valid"),null;c=e.subarray(12,18);a={};a.width=256*c[1]+c[0];a.height=256*c[3]+c[2];a.bpp=c[4];a.bytesPerPixel=a.bpp/8;a.imageSize=a.width*a.height*a.bytesPerPixel;a.pixels=e.subarray(18,18+a.imageSize);a.pixels=new Uint8Array(a.pixels);
a.flipY=0==(c[5]&32);for(c=0;c<a.imageSize;c+=a.bytesPerPixel)e=a.pixels[c],a.pixels[c]=a.pixels[c+2],a.pixels[c+2]=e;a.format=32==a.bpp?"RGBA":"RGB";return a};Texture.fromImage=function(e,a){a=a||{};var b=a.texture||new h.Texture(e.width,e.height,a);b.uploadImage(e,a);b.bind();gl.texParameteri(b.texture_type,gl.TEXTURE_MAG_FILTER,b.magFilter||h.LINEAR);gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,b.minFilter||h.LINEAR_MIPMAP_LINEAR);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,b.wrapS||
h.REPEAT);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,b.wrapT||h.REPEAT);h.isPowerOfTwo(b.width)&&h.isPowerOfTwo(b.height)||1<gl.webgl_version?a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0):(gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,h.LINEAR),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),b.has_mipmaps=!1);gl.bindTexture(b.texture_type,
null);b.data=e;a.keep_image&&(b.img=e);return b};Texture.fromVideo=function(e,a){a=a||{};var b=a.texture||new h.Texture(e.videoWidth,e.videoHeight,a);b.bind();b.uploadImage(e,a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0,b.data=e);gl.bindTexture(b.texture_type,null);return b};Texture.fromTexture=function(e,a){a=a||{};var b=new h.Texture(e.width,e.height,a);e.copyTo(b);return b};Texture.prototype.clone=function(e){var a=
this.getProperties();if(e)for(var b in e)a[b]=e[b];return Texture.fromTexture(this,a)};Texture.fromMemory=function(e,a,b,c){c=c||{};var d=c.texture||new h.Texture(e,a,c);Texture.setUploadOptions(c);d.bind();b.constructor===Array&&(b=c.type==gl.FLOAT?new Float32Array(b):c.type==h.HALF_FLOAT||c.type==h.HALF_FLOAT_OES?new Uint16Array(b):new Uint8Array(b));gl.texImage2D(gl.TEXTURE_2D,0,d.format,e,a,0,d.format,d.type,b);d.width=e;d.height=a;d.data=b;c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&
(gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);gl.bindTexture(d.texture_type,null);return d};Texture.fromDDSInMemory=function(e,a){a=a||{};var b=a.texture||new h.Texture(0,0,a);h.Texture.setUploadOptions(a);b.bind();var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");U.loadDDSTextureFromMemoryEx(gl,c,e,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=function(e,a,b,c){c=c||{};e=new h.Texture(e,a,c);e.drawTo(function(){gl.disable(gl.BLEND);
gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var a=Mesh.getScreenQuad();b.draw(a)});return e};Texture.cubemapFromImages=function(e,a){a=a||{};if(6!=e.length)throw"missing images to create cubemap";var b=e[0].width,c=e[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;var d=null;a.texture?(d=a.texture,d.width=b,d.height=c):d=new h.Texture(b,c,a);Texture.setUploadOptions(a);d.bind();try{for(b=0;6>b;b++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+b,0,d.format,d.format,d.type,e[b]);d.data=e}catch(f){if("file:"==
location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),d.has_mipmaps=!0);d.unbind();return d};Texture.cubemapFromImage=function(e,a){a=a||{};if(e.width!=e.height/6&&0!=e.height%6&&!a.faces&&!a.is_polar)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",
e.width,e.height),null;var b=e.width,c=e.height;if(a.is_polar){var d=a.size||h.nearestPowerOfTwo(e.height),f=h.Texture.fromImage(e,{ignore_pot:!0,wrap:gl.REPEAT,filter:gl.LINEAR}),b=new h.Texture(d,d,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGBA});if(a.texture){var c=a.texture,k;for(k in b)c[k]=b[k];b=c}var p=mat3.create(),m={u_texture:0,u_rotation:p};gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);var l=h.Shader.getPolarToCubemapShader();b.drawTo(function(a,b){var c=h.Texture.cubemap_camera_parameters[b];
mat3.identity(p);p.set(c.right,0);p.set(c.up,3);p.set(c.dir,6);f.toViewport(l,m)});a.keep_image&&(b.img=e);return b}void 0!==a.is_cross?(a.faces=Texture.generateCubemapCrossFacesInfo(e.width,a.is_cross),b=c=e.width/4):a.faces?(b=a.width||a.faces[0].width,c=a.height||a.faces[0].height):c/=6;if(b!=c)return console.log("Texture not valid, width and height for every face must be square"),null;d=b;a.no_flip=!0;var n=[];for(k=0;6>k;k++){var q=createCanvas(d,d),s=q.getContext("2d");a.faces?s.drawImage(e,
a.faces[k].x,a.faces[k].y,a.faces[k].width||d,a.faces[k].height||d,0,0,d,d):s.drawImage(e,0,c*k,b,c,0,0,d,d);n.push(q)}k=Texture.cubemapFromImages(n,a);a.keep_image&&(k.img=e);return k};Texture.generateCubemapCrossFacesInfo=function(e,a){void 0===a&&(a=1);var b=e/4;return[{x:2*b,y:b,width:b,height:b},{x:0,y:b,width:b,height:b},{x:a*b,y:0,width:b,height:b},{x:a*b,y:2*b,width:b,height:b},{x:b,y:b,width:b,height:b},{x:3*b,y:b,width:b,height:b}]};Texture.cubemapFromURL=function(e,a,b){a=a||{};a=Object.create(a);
a.texture_type=gl.TEXTURE_CUBE_MAP;var c=a.texture||new h.Texture(1,1,a);c.bind();Texture.setUploadOptions(a);for(var d=a.temp_color||[0,0,0,255],d=a.type==gl.FLOAT?new Float32Array(d):new Uint8Array(d),f=0;6>f;f++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,c.format,1,1,0,c.format,c.type,d);gl.bindTexture(c.texture_type,null);c.ready=!1;d=new Image;d.src=e;d.onload=function(){a.texture=c;(c=h.Texture.cubemapFromImage(this,a))&&delete c.ready;b&&b(c)};return c};Texture.prototype.getPixels=function(e,
a){a=a||0;var b=this.gl,c=b.getViewport(),d=b.getParameter(b.FRAMEBUFFER_BINDING);if(this.format==b.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";b.disable(b.DEPTH_TEST);var f=b.__copy_fbo;f||(f=b.__copy_fbo=b.createFramebuffer());b.bindFramebuffer(b.FRAMEBUFFER,f);var f=null,k=this.width>>a,p=this.height>>a;b.viewport(0,0,k,p);this.texture_type==b.TEXTURE_2D?b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.handler,a):this.texture_type==b.TEXTURE_CUBE_MAP&&
b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+(e||0),this.handler,a);var m=this.format==b.RGB?3:4,m=4,l=this.type,f=l==b.UNSIGNED_BYTE?new Uint8Array(k*p*m):l==h.HALF_FLOAT||l==h.HALF_FLOAT_OES?new Uint16Array(k*p*m):new Float32Array(k*p*m);b.readPixels(0,0,k,p,3==m?b.RGB:b.RGBA,l,f);b.bindFramebuffer(b.FRAMEBUFFER,d);b.viewport(c[0],c[1],c[2],c[3]);return f};Texture.prototype.setPixels=function(e,a,b,c){a={no_flip:a};c&&(a.cubemap_face=c);this.uploadData(e,
a,b)};Texture.prototype.getCubemapPixels=function(){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap";return[this.getPixels(0),this.getPixels(1),this.getPixels(2),this.getPixels(3),this.getPixels(4),this.getPixels(5)]};Texture.prototype.setCubemapPixels=function(e,a){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap, it should be created with { texture_type: gl.TEXTURE_CUBE_MAP }";for(var b=0;6>b;++b)this.setPixels(e[b],a,5!=b,b)};Texture.prototype.toCanvas=
function(e,a,b){b=b||8192;var c=this.gl,d=Math.min(this.width,b),f=Math.min(this.height,b);this.texture_type==c.TEXTURE_CUBE_MAP&&(d*=4,f*=3);e=e||createCanvas(d,f);e.width!=d&&(e.width=d);e.height!=f&&(e.height=f);var k=null;if(this.texture_type==c.TEXTURE_2D)this.width!=d||this.height!=f||this.type!=c.UNSIGNED_BYTE?(k=new h.Texture(d,f,{format:c.RGBA,filter:c.NEAREST}),this.copyTo(k),k=k.getPixels()):k=this.getPixels(),b=e.getContext("2d"),c=b.getImageData(0,0,d,f),c.data.set(k),b.putImageData(c,
0,0),a&&(k=createCanvas(d,f),a=k.getContext("2d"),a.translate(0,k.height),a.scale(1,-1),a.drawImage(e,0,0,k.width,k.height),b.clearRect(0,0,b.canvas.width,b.canvas.height),b.drawImage(k,0,0));else if(this.texture_type==c.TEXTURE_CUBE_MAP){d=createCanvas(this.width,this.height);a=d.getContext("2d");f=h.Texture.generateCubemapCrossFacesInfo(e.width,1);b=e.getContext("2d");b.fillStyle="black";b.fillRect(0,0,e.width,e.height);var p=this;this.type!=c.UNSIGNED_BYTE&&(p=new h.Texture(this.width,this.height,
{format:c.RGBA,texture_type:c.TEXTURE_CUBE_MAP,filter:c.NEAREST,type:c.UNSIGNED_BYTE}),this.copyTo(p));for(var m=0;6>m;m++)c=a.getImageData(0,0,d.width,d.height),k=p.getPixels(m),c.data.set(k),a.putImageData(c,0,0),b.drawImage(d,f[m].x,f[m].y,d.width,d.height)}return e};Texture.binary_extension="png";Texture.prototype.toBinary=function(e,a){for(var b=this.toCanvas(null,e).toDataURL(a),c=b.indexOf(","),b=b.substr(c+1),b=atob(b),c=b.length,d=new Uint8Array(c),f=0;f<c;++f)d[f]=b.charCodeAt(f);return d};
Texture.prototype.toBlob=function(e,a){var b=this.toBinary(e);return new Blob([b],{type:a||"image/png"})};Texture.prototype.toBlobAsync=function(e,a,b){var c=this.toCanvas(null,e);c.toBlob?c.toBlob(b,a):(e=this.toBlob(e,a),b&&b(e))};Texture.prototype.toBase64=function(e){var a=this.width,b=this.height,c=this.getPixels(),d=createCanvas(a,b),f=d.getContext("2d"),k=f.getImageData(0,0,a,b);k.data.set(c);f.putImageData(k,0,0);e&&(e=createCanvas(a,b),a=e.getContext("2d"),a.translate(0,b),a.scale(1,-1),
a.drawImage(d,0,0),d=e);return d.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var e={};e.width=this.width;e.height=this.height;this.metadata=e};Texture.compareFormats=function(e,a){return e&&a?e==a?!0:e.width!=a.width||e.height!=a.height||e.type!=a.type||e.format!=a.format||e.texture_type!=a.texture_type?!1:!0:!1};Texture.blend=function(e,a,b,c){if(!e||!a)return!1;if(e==a)return c?e.copyTo(c):e.toViewport(),!0;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);
var d=h.Shader.getBlendShader(),f=h.Mesh.getScreenQuad();a.bind(1);d.uniforms({u_texture:0,u_texture2:1,u_factor:b});if(c)return c.drawTo(function(){if(e==c||a==c)throw"Blend output cannot be the same as the input";e.bind(0);d.draw(f,gl.TRIANGLES)}),!0;e.bind(0);d.draw(f,gl.TRIANGLES);return!0};Texture.cubemapToTexture2D=function(e,a,b,c,d){if(!e||e.texture_type!=gl.TEXTURE_CUBE_MAP)throw"No cubemap in convert";a=a||e.width;c=c?e.type:gl.UNSIGNED_BYTE;d=d||0;b||(b=new h.Texture(2*a,a,{minFilter:gl.NEAREST,
type:c}));var f=gl.shaders.cubemap_to_texture2D;f||(f=gl.shaders.cubemap_to_texture2D=new h.Shader(h.Shader.SCREEN_VERTEX_SHADER,"\t\tprecision mediump float;\n\t\t#define PI 3.14159265358979323846264\n\t\tuniform samplerCube texture;\t\tvarying vec2 v_coord;\t\tuniform float u_yaw;\n\t\tvoid main() {\t\t\tfloat alpha = ((1.0 - v_coord.x) * 2.0) * PI + u_yaw;\t\t\tfloat beta = (v_coord.y * 2.0 - 1.0) * PI * 0.5;\t\t\tvec3 N = vec3( -cos(alpha) * cos(beta), sin(beta), sin(alpha) * cos(beta) );\t\t\tgl_FragColor = textureCube(texture,N);\t\t}"));
f.setUniform("u_yaw",d);b.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);e.toViewport(f)});return b};Texture.getWhiteTexture=function(e){e=e||r.gl;var a=e.textures[":white"];if(a)return a;a=new Uint8Array([255,255,255,255]);return e.textures[":white"]=new h.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(e){e=e||r.gl;var a=e.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,255]);return e.textures[":black"]=new h.Texture(1,1,{pixel_data:a})};
Texture.getTemporary=function(e,a,b,c){c=c||r.gl;c._texture_pool||(c._texture_pool=[]);var d=h.TEXTURE_2D,f=Texture.DEFAULT_TYPE,k=Texture.DEFAULT_FORMAT;b&&(b.texture_type&&(d=b.texture_type),b.type&&(f=b.type),b.format&&(k=b.format));b=d+":"+f+":"+e+"x"+a+":"+k;for(var p=c._texture_pool,m=0;m<p.length;++m){var l=p[m];if(l._key==b)return p.splice(m,1),l._pool=0,l}l=new h.Texture(e,a,{type:f,texture_type:d,format:k,filter:c.LINEAR});l._key=b;l._pool=0;return l};Texture.releaseTemporary=function(e,
a){a=a||r.gl;a._texture_pool||(a._texture_pool=[]);0<e._pool&&console.warn("this texture is already in the textures pool");var b=a._texture_pool;b||(b=a._texture_pool=[]);e._pool=getTime();b.push(e);20<b.length&&(b.sort(function(a,b){return b._pool-a._pool}),e=b.pop(),e._pool=0,e.delete())};Texture.nextPOT=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))};h.FBO=D;D.prototype.setTextures=function(e,a,b){if(a&&a.constructor===h.Texture){if(a.format!==h.DEPTH_COMPONENT&&a.format!==h.DEPTH_STENCIL&&
a.format!==h.DEPTH_COMPONENT16&&a.format!==h.DEPTH_COMPONENT24&&a.format!==h.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";if(a.type!=h.UNSIGNED_SHORT&&a.type!=h.UNSIGNED_INT&&a.type!=h.UNSIGNED_INT_24_8_WEBGL&&a.type!=h.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL";}var c=this.depth_texture==a;if(c&&e){if(e.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";
if(e.length==this.color_textures.length)for(var d=0;d<e.length;++d){if(e[d]!=this.color_textures[d]){c=!1;break}}else c=!1}this._stencil_enabled!==this.stencil&&(c=!1);if(!c){this.color_textures.length=e?e.length:0;if(e)for(d=0;d<e.length;++d)this.color_textures[d]=e[d];this.depth_texture=a;this.update(b)}};D.prototype.update=function(e){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler||(this.handler=gl.createFramebuffer());var a=-1,b=-1,c=null,d=null,f=this.color_textures,
k=this.depth_texture;if(f&&f.length)for(var p=0;p<f.length;p++){var m=f[p];if(m.constructor!==h.Texture)throw"FBO can only bind instances of GL.Texture";if(-1==a)a=m.width;else if(a!=m.width)throw"Cannot bind textures with different dimensions";if(-1==b)b=m.height;else if(b!=m.height)throw"Cannot bind textures with different dimensions";if(null==c)c=m.type,d=m.format;else if(c!=m.type)throw"Cannot bind textures to a FBO with different pixel formats";if(m.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO";
}else a=k.width,b=k.height;this.width=a;this.height=b;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var l=gl.extensions.WEBGL_draw_buffers;if(1==gl.webgl_version&&!l&&f&&1<f.length)throw"Rendering to several textures not supported by your browser";var n=1==gl.webgl_version?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;gl.framebufferRenderbuffer(n,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null);gl.framebufferRenderbuffer(n,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null);if(k&&k.constructor===h.Texture){if(1==gl.webgl_version&&
!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&k.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format");k.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(n,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,k.handler,0):gl.framebufferTexture2D(n,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,k.handler,0)}else p=null,k&&k.constructor===WebGLRenderbuffer&&k.width==a&&k.height==b?p=this._depth_renderbuffer=
k:(p=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),p.width=a,p.height=b),gl.bindRenderbuffer(gl.RENDERBUFFER,p),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,a,b),gl.framebufferRenderbuffer(n,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,p)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b),gl.framebufferRenderbuffer(n,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,p));if(f&&f.length)for(this.order=[],p=0;p<f.length;p++)m=f[p],gl.framebufferTexture2D(n,
gl.COLOR_ATTACHMENT0+p,gl.TEXTURE_2D,m.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+p);else k=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer(),k.width=a,k.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,k),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,b),gl.framebufferRenderbuffer(n,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,k);for(p=a=f?f.length:0;p<this._num_binded_textures;++p)gl.framebufferTexture2D(n,gl.COLOR_ATTACHMENT0+p,gl.TEXTURE_2D,null,0);this._num_binded_textures=
a;this._stencil_enabled=this.stencil;f&&1<f.length&&(l?l.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));f=gl.checkFramebufferStatus(n);if(f!==gl.FRAMEBUFFER_COMPLETE)throw d!=h.RGB||c!=h.FLOAT&&c!=h.HALF_FLOAT_OES||console.error("Tip: Firefox does not support RGB channel float/half_float textures, you must use RGBA"),"FBO not complete: "+f;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);e||gl.bindFramebuffer(n,this._old_fbo_handler)};D.prototype.bind=function(e){if(this.multi_sample)this._old_fbo_handler=
gl.getParameter(gl.FRAMEBUFFER_BINDING),this._old_viewport.set(gl.viewport_data),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer);else{if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo_handler=e?gl.getParameter(gl.FRAMEBUFFER_BINDING):
null;this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0)}gl.viewport(0,0,this.width,this.height);D.current=this};D.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport);for(var e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=
!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);D.current=null};D.prototype.switchTo=function(e){e._old_fbo_handler=this._old_fbo_handler;e._old_viewport.set(this._old_viewport);gl.bindFramebuffer(gl.FRAMEBUFFER,e.handler);this._old_fbo_handler=null;gl.viewport(0,0,this.width,this.height);for(var a=0;a<this.color_textures.length;++a)this.color_textures[a]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(a=0;a<e.color_textures.length;++a)e.color_textures[a]._in_current_fbo=
!0;e.depth_texture&&(e.depth_texture._in_current_fbo=!0);D.current=e};D.prototype.delete=function(){gl.deleteFramebuffer(this.handler);this.handler=null};D.supported={};D.testSupport=function(e,a){var b=e+":"+a;if(null!=D.supported[b])return D.supported[b];var c=new h.Texture(1,1,{format:a,type:e});try{new h.FBO([c])}catch(d){return console.warn("This browser WEBGL implementation doesn't support this FBO format: "+h.reverse[e]+" "+h.reverse[a]),D.supported[b]=!1}return D.supported[b]=!0};D.prototype.toSingle=
function(e){e=e||0;if(!(2>this.color_textures.length)){var a=gl.extensions.WEBGL_draw_buffers;a?a.drawBuffersWEBGL([this.order[e]]):gl.drawBuffers([this.order[e]])}};D.prototype.toMulti=function(){if(!(2>this.color_textures.length)){var e=gl.extensions.WEBGL_draw_buffers;e?e.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}};D.prototype.clearSecondary=function(e){if(this.order&&!(2>this.order.length)){for(var a=gl.extensions.WEBGL_draw_buffers,b=[gl.NONE],c=1;c<this.order.length;++c)b.push(this.order[c]);
a?a.drawBuffersWEBGL(b):gl.drawBuffers(b);gl.clearColor(e[0],e[1],e[2],e[3]);gl.clear(gl.COLOR_BUFFER_BIT);a?a.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}};D.prototype.makeMultiSample=function(e,a,b,c){if(1==this.gl.webgl_version)throw"cannot use makeMultiSample in webgl 1.0";this.width=e;this.height=a;b=b||4;c=c||{};e=c.format||gl.RGBA8;a=gl.DEPTH_COMPONENT16;this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,
this.handler);this.colorRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.colorRenderbuffer);gl.renderbufferStorageMultisample(gl.RENDERBUFFER,b,e,this.width,this.height);this.depthRenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthRenderbuffer);gl.renderbufferStorageMultisample(gl.RENDERBUFFER,b,a,this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,
this.colorRenderbuffer);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;this.multi_sample=!0};D.prototype.blitMultisample=function(e){if(!e||e.constructor!==h.FBO)throw"parameter must be GL.FBO";gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this.handler);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,e.handler);gl.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,
gl.COLOR_BUFFER_BIT,gl.LINEAR);gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport)};r.Shader=h.Shader=function a(b,c,d){h.debug&&console.log("GL.Shader created");if(!b||!c)throw"GL.Shader source code parameter missing";this._context_id=r.gl.context_id;var f=this.gl=r.gl,k=a.expandMacros(d);d=b.constructor===String?a.injectCode(k,b,f):b;k=c.constructor===
String?a.injectCode(k,c,f):c;this.program=f.createProgram();b=b.constructor===String?h.Shader.compileSource(f.VERTEX_SHADER,d):b;c=c.constructor===String?h.Shader.compileSource(f.FRAGMENT_SHADER,k):c;f.attachShader(this.program,b,f);f.attachShader(this.program,c,f);f.linkProgram(this.program);this.vs_shader=b;this.fs_shader=c;this.attributes={};this.uniformInfo={};this.samplers={};a.use_async?this._first_use=!0:this.checkLink()};Shader.use_async=!0;Shader.expandMacros=function(a){var b="";if(a)for(var c in a)b+=
"#define "+c+" "+(a[c]?a[c]:"")+"\n";return b};Shader.injectCode=function(a,b,c){var d=b.indexOf("\n");c=c?"#define WEBGL"+c.webgl_version+"\n":"";var f=b.substr(0,d).trim();return-1==f.indexOf("#version")?c+a+b:f+"\n"+c+a+b.substr(d)};Shader.compileSource=function(a,b,c,d){c=c||r.gl;d=d||c.createShader(a);c.shaderSource(d,b);c.compileShader(d);return d};Shader.parseError=function(a,b,c){if(!a)return null;var d=a.split(" "),f=d[5].split(":");return{type:d[0],line_number:parseInt(f[1]),line_pos:parseInt(f[0]),
line_code:("Fragment"==d[0]?c:b).split("\n")[parseInt(f[1])],err:a}};Shader.prototype.delete=function(){this.program&&this.gl.deleteProgram(this.program);this.vs_shader&&this.gl.deleteShader(this.vs_shader);this.fs_shader&&this.gl.deleteShader(this.fs_shader);this.gl=null;this.attributes={};this.uniformInfo={};this.samplers={}};Shader.prototype.updateShader=function(a,b,c){var d=this.gl||r.gl,f=Shader.expandMacros(c);this.program?(d.detachShader(this.program,this.vs_shader),d.detachShader(this.program,
this.fs_shader)):this.program=d.createProgram();f=Shader.expandMacros(c);c=a.constructor===String?Shader.injectCode(f,a,d):a;f=b.constructor===String?Shader.injectCode(f,b,d):b;a=a.constructor===String?h.Shader.compileSource(d.VERTEX_SHADER,c):a;b=b.constructor===String?h.Shader.compileSource(d.FRAGMENT_SHADER,f):b;d.attachShader(this.program,a,d);d.attachShader(this.program,b,d);d.linkProgram(this.program);this.vs_shader=a;this.fs_shader=b;this.attributes={};this.uniformInfo={};this.samplers={};
Shader.use_async?this._first_use=!0:this.checkLink()};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS),c=0;c<b;++c){var d=a.getActiveUniform(this.program,c);if(!d)break;var f=d.name,k=f.indexOf("[");-1!=k&&-1==f.indexOf("].")&&(f=f.substr(0,k));if(d.type==h.SAMPLER_2D||d.type==h.SAMPLER_CUBE||d.type==h.SAMPLER_3D||d.type==h.INT_SAMPLER_2D||d.type==h.INT_SAMPLER_CUBE||d.type==h.INT_SAMPLER_3D||d.type==h.UNSIGNED_INT_SAMPLER_2D||
d.type==h.UNSIGNED_INT_SAMPLER_CUBE||d.type==h.UNSIGNED_INT_SAMPLER_3D)this.samplers[f]=d.type;var k=Shader.getUniformFunc(d),p=!1;if(d.type==a.FLOAT_MAT2||d.type==a.FLOAT_MAT3||d.type==a.FLOAT_MAT4)p=!0;var m=h.TYPE_LENGTH[d.type]||1;this.uniformInfo[f]={type:d.type,func:k,size:d.size,type_length:m,is_matrix:p,loc:a.getUniformLocation(this.program,f),data:new Float32Array(m*d.size)}}c=0;for(b=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);c<b;++c){d=a.getActiveAttrib(this.program,c);if(!d)break;
k=Shader.getUniformFunc(d);m=h.TYPE_LENGTH[d.type]||1;this.uniformInfo[d.name]={type:d.type,func:k,type_length:m,size:d.size,loc:null};this.attributes[d.name]=a.getAttribLocation(this.program,d.name)}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){var b=null;switch(a.type){case h.FLOAT:b=1==a.size?gl.uniform1f:gl.uniform1fv;break;case h.FLOAT_MAT2:b=gl.uniformMatrix2fv;break;
case h.FLOAT_MAT3:b=gl.uniformMatrix3fv;break;case h.FLOAT_MAT4:b=gl.uniformMatrix4fv;break;case h.FLOAT_VEC2:b=gl.uniform2fv;break;case h.FLOAT_VEC3:b=gl.uniform3fv;break;case h.FLOAT_VEC4:b=gl.uniform4fv;break;case h.UNSIGNED_INT:case h.INT:b=1==a.size?gl.uniform1i:gl.uniform1iv;break;case h.INT_VEC2:b=gl.uniform2iv;break;case h.INT_VEC3:b=gl.uniform3iv;break;case h.INT_VEC4:b=gl.uniform4iv;break;case h.SAMPLER_2D:case h.SAMPLER_3D:case h.SAMPLER_CUBE:case h.INT_SAMPLER_2D:case h.INT_SAMPLER_3D:case h.INT_SAMPLER_CUBE:case h.UNSIGNED_INT_SAMPLER_2D:case h.UNSIGNED_INT_SAMPLER_3D:case h.UNSIGNED_INT_SAMPLER_CUBE:b=
gl.uniform1i;break;default:b=gl.uniform1f}return b};Shader.fromURL=function(a,b,c){function d(){var a=new h.Shader(k,p),b;for(b in a)f[b]=a[b];f.ready=!0}var f=new h.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");f.ready=!1;var k=null,p=
null;HttpRequest(a,null,function(a){k=a;p&&d()});HttpRequest(b,null,function(a){p=a;k&&d()});return f};Shader.prototype.checkLink=function(){this._first_use=!1;if(!gl.getShaderParameter(this.vs_shader,gl.COMPILE_STATUS))throw"Vertex shader compile error: "+gl.getShaderInfoLog(this.vs_shader);if(!gl.getShaderParameter(this.fs_shader,gl.COMPILE_STATUS))throw"Fragment shader compile error: "+gl.getShaderInfoLog(this.fs_shader);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+
gl.getProgramInfoLog(this.program);this.extractShaderInfo()};Shader.prototype.bind=function(){var a=this.gl;Shader.use_async&&this._first_use&&(this.checkLink(),this._first_use=!1);a.useProgram(this.program);a._current_shader=this};Shader.prototype.getLocation=function(a){return this.uniformInfo[a]?this.uniformInfo[a].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;this._first_use&&this.checkLink();b.useProgram(this.program);b._current_shader=
this;for(var c in a)this.uniformInfo[c]&&this._setUniform(c,a[c]);return this};Shader.prototype.uniformsArray=function(a){var b=this.gl;this._first_use&&this.checkLink();b.useProgram(this.program);b._current_shader=this;for(var b=0,c=a.length;b<c;++b){var d=a[b],f;for(f in d)this._setUniform(f,d[f])}return this};Shader.prototype.setUniform=function(){return function(a,b){this.gl._current_shader!=this&&this.bind();var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(c.data.set(b),
b=c.data),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))}}();Shader.prototype._setUniform=function(){return function(a,b){this._first_use&&this.checkLink();var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(c.data.set(b),b=c.data),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))}}();Shader.prototype.draw=function(a,b,c){c=void 0===c?b==gl.LINES?"lines":"triangles":c;this.drawBuffers(a.vertexBuffers,c?a.indexBuffers[c]:null,
2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,d,f){f=void 0===f?b==gl.LINES?"lines":"triangles":f;this.drawBuffers(a.vertexBuffers,f?a.indexBuffers[f]:null,b,c,d)};var R=new Uint8Array(16),W=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,d,f){if(0!=f){var k=this.gl;this._first_use&&this.checkLink();k.useProgram(this.program);var h=0;R.set(W);for(var m in a){var l=a[m],n=l.attribute||m,q=this.attributes[n];null!=q&&l.buffer&&(R[q]=1,k.bindBuffer(k.ARRAY_BUFFER,
l.buffer),k.enableVertexAttribArray(q),k.vertexAttribPointer(q,l.buffer.spacing,l.buffer.gl_type,l.normalize,0,0),h=l.buffer.length/l.buffer.spacing)}a=0;0<d&&(a=d);b&&(h=b.buffer.length-a);0<f&&f<h&&(h=f);a*=b&&b.data?b.data.constructor.BYTES_PER_ELEMENT:1;for(n in this.attributes)q=this.attributes[n],R[q]||k.disableVertexAttribArray(this.attributes[n]);!h||b&&!b.buffer||(b?(k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,b.buffer),k.drawElements(c,h,b.buffer.gl_type,a),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null)):
k.drawArrays(c,a,h),k.draw_calls++);return this}};Shader._instancing_arrays=[];Shader.prototype.drawInstanced=function(a,b,c,d,f,k,p){if(0!==k){var m=this.gl;if(1==m.webgl_version&&!m.extensions.ANGLE_instanced_arrays)throw"instancing not supported";this._first_use&&this.checkLink();m.useProgram(this.program);var l=0;R.set(W);var n=a.vertexBuffers,q;for(q in n){var s=n[q],r=s.attribute||q,t=this.attributes[r];null!=t&&s.buffer&&(R[t]=1,m.bindBuffer(m.ARRAY_BUFFER,s.buffer),m.enableVertexAttribArray(t),
m.vertexAttribPointer(t,s.buffer.spacing,s.buffer.gl_type,s.normalize,0,0),l=s.buffer.length/s.buffer.spacing)}n=null;c&&(c.constructor===String?n=a.getIndexBuffer(c):c.constructor===h.Buffer&&(n=c));a=0;0<f&&(a=f);n&&(l=n.buffer.length-a);0<k&&k<l&&(l=k);a*=n&&n.data?n.data.constructor.BYTES_PER_ELEMENT:1;for(r in this.attributes)t=this.attributes[r],R[t]||m.disableVertexAttribArray(this.attributes[r]);f=m.extensions.ANGLE_instanced_arrays;k=t=0;for(var u in d){q=d[u];t=q.length;r=this.attributes[u];
if(null==r)return;var w=c=0;q.constructor===Array?(c=q[0].constructor===Number?1:q[0].length,w=c*q.length):(c=this.uniformInfo[u].type_length,w=q.length,t=w/c);s=Shader._instancing_arrays[k];if(!s||s.data.length<w)s=Shader._instancing_arrays[k]={data:new Float32Array(w),buffer:m.createBuffer()};s.uniform=u;s.element_size=c;if(q.constructor===Array)for(w=0;w<q.length;++w)s.data.set(q[w],w*c);else s.data.set(q);m.bindBuffer(m.ARRAY_BUFFER,s.buffer);m.bufferData(m.ARRAY_BUFFER,s.data,m.STREAM_DRAW);
if(16==c)for(c=0;4>c;++c)m.enableVertexAttribArray(r+c),m.vertexAttribPointer(r+c,4,m.FLOAT,!1,64,16*c),f?f.vertexAttribDivisorANGLE(r+c,1):m.vertexAttribDivisor(r+c,1);else m.enableVertexAttribArray(r),m.vertexAttribPointer(r,c,m.FLOAT,!1,4*c,0),f?f.vertexAttribDivisorANGLE(r,1):m.vertexAttribDivisor(r,1);k+=1}p&&(t=p);f?n?(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,n.buffer),f.drawElementsInstancedANGLE(b,l,n.buffer.gl_type,a,t),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null)):f.drawArraysInstancedANGLE(b,a,
l,t):n?(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,n.buffer),m.drawElementsInstanced(b,l,n.buffer.gl_type,a,t),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null)):m.drawArraysInstanced(b,a,l,t);for(b=0;b<k;++b)if(d=Shader._instancing_arrays[b],r=this.attributes[d.uniform],c=d.element_size,16==c)for(c=0;4>c;++c)m.disableVertexAttribArray(r+c),f?f.vertexAttribDivisorANGLE(r+c,0):m.vertexAttribDivisor(r+c,0);else m.enableVertexAttribArray(r),f?f.vertexAttribDivisorANGLE(r,0):m.vertexAttribDivisor(r,0);return this}};
Shader.expandImports=function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";return a.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,function(a){a=a.split('"')[1];if(c[a])return"//already imported: "+a+"\n";var f=b[a];c[a]=!0;return f?f+"\n":"//import code not found: "+a+"\n"})};Shader.dumpErrorToConsole=function(a,b,c){console.error(a);var d=null,d=-1!=a.indexOf("Fragment")?c:b;a=d.split("\n");for(var f in a)a[f]=f+"| "+a[f];console.groupCollapsed("Shader code");
console.log(a.join("\n"));console.groupEnd()};Shader.convertTo100=function(a,b){};Shader.convertTo300=function(a,b){};Shader.validateValue=function(a,b){if(null===a||void 0===a)return!1;switch(b.type){case h.INT:case h.FLOAT:case h.SAMPLER_2D:case h.SAMPLER_3D:case h.SAMPLER_CUBE:case h.INT_SAMPLER_2D:case h.INT_SAMPLER_3D:case h.INT_SAMPLER_CUBE:case h.UNSIGNED_INT_SAMPLER_2D:case h.UNSIGNED_INT_SAMPLER_3D:case h.UNSIGNED_INT_SAMPLER_CUBE:return isNumber(a);case h.INT_VEC2:case h.FLOAT_VEC2:return 2===
a.length;case h.INT_VEC3:case h.FLOAT_VEC3:return 3===a.length;case h.INT_VEC4:case h.FLOAT_VEC4:case h.FLOAT_MAT2:return 4===a.length;case h.FLOAT_MAT3:return 8===a.length;case h.FLOAT_MAT4:return 16===a.length}return!0};Shader.DEFAULT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec3 v_position;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t";Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.SCREEN_FLAT_FRAGMENT_SHADER=Shader.FLAT_FRAGMENT_SHADER;Shader.createFX=function(a,b,c){a=h.Shader.removeComments(a,!0);b=h.Shader.removeComments(b,!0);a={FX_CODE:a,FX_UNIFORMS:b||""};if(!c)return new h.Shader(h.Shader.SCREEN_VERTEX_SHADER,h.Shader.SCREEN_FRAGMENT_FX,a);c.updateShader(h.Shader.SCREEN_VERTEX_SHADER,h.Shader.SCREEN_FRAGMENT_FX,
a);return c};Shader.replaceCodeUsingContext=function(a,b){return a.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(a){a=a.replace(/[\{\}]/g,"");return b[a]||""})};Shader.removeComments=function(a,b){if(!a)return"";a=a.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,"");for(var c=a.split("\n"),d=[],f=0;f<c.length;++f){var k=c[f],h=k.indexOf("//");-1!=h&&(k=c[f].substr(0,h));k=k.trim();k.length&&d.push(k)}return d.join(b?"":"\n")};Shader.prototype.toViewport=function(a){var b=h.Mesh.getScreenQuad();
a&&this.uniforms(a);this.draw(b)};Shader.getScreenShader=function(a){a=a||r.gl;var b=a.shaders[":screen"];if(b)return b;b=a.shaders[":screen"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return b.uniforms({u_texture:0})};Shader.getFlatScreenShader=function(a){a=a||r.gl;var b=a.shaders[":flat_screen"];if(b)return b;b=a.shaders[":flat_screen"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);return b.uniforms({u_color:[1,1,1,1]})};Shader.getColoredScreenShader=
function(a){a=a||r.gl;var b=a.shaders[":colored_screen"];if(b)return b;b=a.shaders[":colored_screen"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return b.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new h.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad2"];return b?
b:a.shaders[":quad2"]=new h.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlendShader=function(a){a=a||r.gl;var b=a.shaders[":blend"];return b?b:a.shaders[":blend"]=new h.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER)};Shader.getBlurShader=function(a){a=a||r.gl;var b=a.shaders[":blur"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.getCopyDepthShader=function(a){a=a||r.gl;var b=a.shaders[":copy_depth"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_EXT_frag_depth : enable\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;\n\t\t\t   gl_FragColor = vec4(1.0);\n\t\t\t}\n\t\t\t");return a.shaders[":copy_depth"]=b};Shader.getCubemapShowShader=
function(a){a=a||r.gl;var b=a.shaders[":show_cubemap"];if(b)return b;b=new h.Shader(Shader.DEFAULT_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = textureCube( u_texture, v_normal );\n\t\t\t}\n\t\t\t");b.uniforms({u_texture:0});return a.shaders[":show_cubemap"]=b};Shader.getPolarToCubemapShader=function(a){a=a||r.gl;var b=a.shaders[":polar_to_cubemap"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,
"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = normalize( vec3( uv - vec2(0.5), 0.5 ));\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t\tfloat u = atan(dir.x,dir.z) / 6.28318531;\n\t\t\t\tfloat v = (asin(dir.y) / 1.57079633) * 0.5 + 0.5;\n\t\t\t\tu = mod(u,1.0);\n\t\t\t\tv = mod(v,1.0);\n\t\t\t   gl_FragColor = texture2D( u_texture, vec2(u,v) );\n\t\t\t}\n\t\t\t");
return a.shaders[":polar_to_cubemap"]=b};Shader.getCubemapCopyShader=function(a){a=a||r.gl;var b=a.shaders[":copy_cubemap"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t");
return a.shaders[":copy_cubemap"]=b};Shader.getCubemapBlurShader=function(a){a=a||r.gl;var b=a.shaders[":blur_cubemap"];if(b)return b;b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur_cubemap"]=b};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t/* fragCoord MUST BE IN PIXELS */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\t//return vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(a){a=a||r.gl;var b=a.shaders[":fxaa"];if(b)return b;var b=new h.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t"),c=vec2.fromValues(a.viewport_data[2],a.viewport_data[3]),d=vec2.fromValues(1/a.viewport_data[2],1/a.viewport_data[3]);b.setup=
function(){c[0]=a.viewport_data[2];c[1]=a.viewport_data[3];d[0]=1/a.viewport_data[2];d[1]=1/a.viewport_data[3];this.uniforms({u_viewportSize:c,u_iViewportSize:d})};return a.shaders[":fxaa"]=b};Shader.getFlatShader=function(a){a=a||r.gl;var b=a.shaders[":flat"];if(b)return b;b=new h.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);b.uniforms({u_color:[1,1,1,1]});return a.shaders[":flat"]=b};h.create=function(a){function b(a){if(!l.ignore_events){var c=l.mouse.buttons;h.augmentEvent(a,
k);a.eventType=a.eventType||a.type;var d=getTime();s.dragging=a.dragging;s.position[0]=a.canvasx;s.position[1]=a.canvasy;s.x=a.canvasx;s.y=a.canvasy;s.mousex=a.mousex;s.mousey=a.mousey;s.canvasx=a.canvasx;s.canvasy=a.canvasy;s.clientx=a.mousex;s.clienty=a.mousey;s.buttons=a.buttons;s.left_button=!!(s.buttons&h.LEFT_MOUSE_BUTTON_MASK);s.middle_button=!!(s.buttons&h.MIDDLE_MOUSE_BUTTON_MASK);s.right_button=!!(s.buttons&h.RIGHT_MOUSE_BUTTON_MASK);if("mousedown"==a.eventType){0==c&&(k.removeEventListener("mousemove",
b),c=k.ownerDocument,c.addEventListener("mousemove",b),c.addEventListener("mouseup",b));q=d;if(l.onmousedown)l.onmousedown(a);A.trigger(l,"mousedown")}else if("mousemove"==a.eventType){if(l.onmousemove)l.onmousemove(a);A.trigger(l,"mousemove",a)}else if("mouseup"==a.eventType){0==l.mouse.buttons&&(k.addEventListener("mousemove",b),c=k.ownerDocument,c.removeEventListener("mousemove",b),c.removeEventListener("mouseup",b));a.click_time=d-q;if(l.onmouseup)l.onmouseup(a);A.trigger(l,"mouseup",a)}else if("mousewheel"==
a.eventType||"wheel"==a.eventType||"DOMMouseScroll"==a.eventType){a.eventType="mousewheel";a.wheel="wheel"==a.type?-a.deltaY:null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;a.delta=void 0!==a.wheelDelta?a.wheelDelta/40:a.deltaY?-a.deltaY/3:0;if(l.onmousewheel)l.onmousewheel(a);A.trigger(l,"mousewheel",a)}else if("dragstart"==a.eventType){if(l.ondragstart)l.ondragstart(a);A.trigger(l,"dragstart",a)}if(l.onmouse)l.onmouse(a);if(!a.skip_preventDefault)return"mousemove"!=a.eventType&&a.stopPropagation(),
a.preventDefault(),!1}}function c(a){var b=a.srcEvent,c=document.createEvent("MouseEvent");c.initMouseEvent("wheel",!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);c.originalEvent=c;c.is_touch=!0;var d=!1;"pinchin"===a.additionalEvent?(c.deltaY=1,d=!0):"pinchout"===a.additionalEvent&&(c.deltaY=-1,d=!0);d&&(c.pinchScaling=0.0312*a.distance,b.target.dispatchEvent(c));b.preventDefault()}function d(a){var b=a.changedTouches,c=b[0],d="";if(!(l.ontouch&&!0===l.ontouch(a)||!0===
A.trigger(l,a.type,a)||!t||a.touches.length&&a.changedTouches[0].identifier!==a.touches[0].identifier||1<b)){switch(a.type){case "touchstart":d="mousedown";break;case "touchmove":d="mousemove";break;case "touchend":d="mouseup";break;default:return}b=document.createEvent("MouseEvent");b.initMouseEvent(d,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null);b.originalEvent=b;b.is_touch=!0;c.target.dispatchEvent(b);a.preventDefault()}}function f(a){a.eventType=a.type;l.ongesture&&
!1===l.ongesture(a)||!1!==A.trigger(l,a.type,a)&&a.preventDefault()}a=a||{};var k=null;if(a.canvas)if("string"==typeof a.canvas){if(k=document.getElementById(a.canvas),!k)throw"Canvas element not found: "+a.canvas;}else k=a.canvas;else{var p=null;a.container&&(p=a.container.constructor===String?document.querySelector(a.container):a.container);if(p&&!a.width){var m=p.getBoundingClientRect();a.width=m.width;a.height=m.height}k=createCanvas(a.width||800,a.height||600);p&&p.appendChild(k)}"alpha"in a||
(a.alpha=!1);var l=null,p=null;2==a.version?p=["webgl2","experimental-webgl2"]:1==a.version||void 0===a.version?p=["webgl","experimental-webgl"]:0===a.version&&(p=["webgl2","experimental-webgl2","webgl","experimental-webgl"]);if(!p)throw"Incorrect WebGL version, must be 1 or 2";m={alpha:void 0===a.alpha?!0:a.alpha,depth:void 0===a.depth?!0:a.depth,stencil:void 0===a.stencil?!0:a.stencil,antialias:void 0===a.antialias?!0:a.antialias,premultipliedAlpha:void 0===a.premultipliedAlpha?!0:a.premultipliedAlpha,
preserveDrawingBuffer:void 0===a.preserveDrawingBuffer?!0:a.preserveDrawingBuffer};for(a=0;a<p.length;++a){try{l=k.getContext(p[a],m)}catch(n){}if(l)break}if(!l){if(k.getContext("webgl"))throw"WebGL supported but not with those parameters";throw"WebGL not supported";}l.webgl_version="WebGL2RenderingContext"===l.constructor.name?2:1;r.gl=l;k.is_webgl=!0;k.gl=l;l.context_id=this.last_context_id++;l.extensions={};p=l.getSupportedExtensions();for(a=0;a<p.length;++a)l.extensions[p[a]]=l.getExtension(p[a]);
l.HIGH_PRECISION_FORMAT=1==l.webgl_version?l.extensions.OES_texture_half_float?h.HALF_FLOAT_OES:l.extensions.OES_texture_float?h.FLOAT:h.UNSIGNED_BYTE:h.HALF_FLOAT_OES;l.max_texture_units=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS);l._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):(l._viewport_func=l.viewport,l.viewport_data=new Float32Array([0,0,l.canvas.width,l.canvas.height]),l.viewport=function(a,b,c,d){var f=this.viewport_data;f[0]=a|0;f[1]=b|0;f[2]=c|0;f[3]=d|
0;this._viewport_func(a,b,c,d)},l.getViewport=function(a){return a?(a[0]=l.viewport_data[0],a[1]=l.viewport_data[1],a[2]=l.viewport_data[2],a[3]=l.viewport_data[3],a):new Float32Array(l.viewport_data)},l.setViewport=function(a,b){l.viewport_data.set(a);b&&(l.viewport_data[1]=this.drawingBufferHeight-a[1]-a[3]);this._viewport_func(a[0],l.viewport_data[1],a[2],a[3])});if(!h.reverse)for(a in h.reverse={},l)l[a]&&l[a].constructor===Number&&(h.reverse[l[a]]=a);if(void 0==window.glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";
var q=0;l.shaders={};l.textures={};l.meshes={};l.draw_calls=0;l.makeCurrent=function(){r.gl=this};l.execute=function(a){var b=r.gl;r.gl=this;a();r.gl=b};l.animate=function(a){function b(){if(!l.destroyed){f._requestFrame_id=c(b);var a=getTime(),h=0.001*(a-d);f.mouse&&(f.mouse.last_buttons=k);k=f.mouse.buttons;if(f.onupdate)f.onupdate(h);A.trigger(f,"update",h);f.ondraw&&(h=r.gl,r.gl=f,f.ondraw(),A.trigger(f,"draw"),r.gl=h);d=a}}if(!1===a)r.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=
null;else{var c=r.requestAnimationFrame,d=getTime(),f=this,k=0;this._requestFrame_id=c(b)}};l.destroy=function(){u&&(document.removeEventListener("keydown",u),document.removeEventListener("keyup",u));x&&(this.canvas.removeEventListener("mousedown",x),this.canvas.removeEventListener("mousemove",x),this.canvas.removeEventListener("mouseup",x),this.canvas.addEventListener("drag",x),this.canvas.addEventListener("dragstart",x),this.canvas.addEventListener("wheel",x));for(var a in this.shaders)this.shaders[a].delete(),
this.shaders[a]=null;this.shaders={};for(a in this.meshes)this.meshes[a].deleteBuffers(),this.meshes[a]=null;this.meshes={};for(a in this.textures)this.textures[a].delete(),this.textures[a]=null;this.textures={};this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;r.gl==this&&(r.gl=null)};var s=l.mouse={buttons:0,last_buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(a,
b,c,d,f){var k=this.y;f&&(k=l.canvas.height-k);return this.x>a&&this.x<a+c&&k>b&&k<b+d?!0:!1},isButtonPressed:function(a){if(a==h.LEFT_MOUSE_BUTTON)return this.buttons&h.LEFT_MOUSE_BUTTON_MASK;if(a==h.MIDDLE_MOUSE_BUTTON)return this.buttons&h.MIDDLE_MOUSE_BUTTON_MASK;if(a==h.RIGHT_MOUSE_BUTTON)return this.buttons&h.RIGHT_MOUSE_BUTTON_MASK},wasButtonPressed:function(a){var b=0;a==h.LEFT_MOUSE_BUTTON?b=h.LEFT_MOUSE_BUTTON_MASK:a==h.MIDDLE_MOUSE_BUTTON?b=h.MIDDLE_MOUSE_BUTTON_MASK:a==h.RIGHT_MOUSE_BUTTON&&
(b=h.RIGHT_MOUSE_BUTTON_MASK);return this.buttons&b&&!(this.last_buttons&b)}};l.captureMouse=function(a,c){k.addEventListener("mousedown",b);k.addEventListener("mousemove",b);k.addEventListener("drag",b);k.addEventListener("dragstart",b);a&&(k.addEventListener("mousewheel",b,!1),k.addEventListener("wheel",b,!1));k.addEventListener("contextmenu",function(a){a.preventDefault();return!1});c&&this.captureTouch(!0)};var x=b,t=!1;"undefined"!==typeof Hammer&&(a=new Hammer.Manager(k),p=new Hammer.Pinch({threshold:0.3}),
a&&p&&(a.add(p),a.on("pinch",c)));l.captureTouch=function(a){t=a;k.addEventListener("touchstart",d,!0);k.addEventListener("touchmove",d,!0);k.addEventListener("touchend",d,!0);k.addEventListener("touchcancel",d,!0);k.addEventListener("gesturestart",f);k.addEventListener("gesturechange",f);k.addEventListener("gestureend",f)};l.keys={};var u=null;l.captureKeys=function(a,b){function c(b){var d=a;b.eventType=b.type;var f=b.target.nodeName.toLowerCase();if("input"!==f&&"textarea"!==f&&"select"!==f&&"true"!==
b.target.contentEditable){b.character=String.fromCharCode(b.keyCode).toLowerCase();var f=!1,k=h.mapKeyCode(b.keyCode);k||(k=b.character);var m=b.altKey||b.ctrlKey||b.metaKey;m||(k&&(l.keys[k]="keydown"==b.type),f=l.keys[b.keyCode],l.keys[b.keyCode]="keydown"==b.type);if(f!=l.keys[b.keyCode]||m){if("keydown"==b.type&&l.onkeydown)l.onkeydown(b);else if("keyup"==b.type&&l.onkeyup)l.onkeyup(b);A.trigger(l,b.type,b)}if(l.onkey)l.onkey(b);d&&(b.isChar||h.blockable_keys[b.keyIdentifier||b.key])&&b.preventDefault()}}
u||(l.keys={},document.addEventListener("keydown",c),document.addEventListener("keyup",c),u=c)};l.gamepads=null;l.captureGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator))};l.getGamepads=function(a){var b=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(b){b=b.call(navigator);this.gamepads||(this.gamepads=[]);for(var c=0;4>c;c++){var d=b[c];if(d&&!a){var f=d,k=f.xbox||{axes:[],buttons:{},
hat:""};k.axes.lx=f.axes[0];k.axes.ly=f.axes[1];k.axes.rx=f.axes[2];k.axes.ry=f.axes[3];k.axes.triggers=f.axes[4];for(var h=0;h<f.buttons.length;h++)switch(h){case 0:k.buttons.a=f.buttons[h].pressed;break;case 1:k.buttons.b=f.buttons[h].pressed;break;case 2:k.buttons.x=f.buttons[h].pressed;break;case 3:k.buttons.y=f.buttons[h].pressed;break;case 4:k.buttons.lb=f.buttons[h].pressed;break;case 5:k.buttons.rb=f.buttons[h].pressed;break;case 6:k.buttons.lt=f.buttons[h].pressed;break;case 7:k.buttons.rt=
f.buttons[h].pressed;break;case 8:k.buttons.back=f.buttons[h].pressed;break;case 9:k.buttons.start=f.buttons[h].pressed;break;case 10:k.buttons.ls=f.buttons[h].pressed;break;case 11:k.buttons.rs=f.buttons[h].pressed;break;case 12:f.buttons[h].pressed&&(k.hat+="up");break;case 13:f.buttons[h].pressed&&(k.hat+="down");break;case 14:f.buttons[h].pressed&&(k.hat+="left");break;case 15:f.buttons[h].pressed&&(k.hat+="right");break;case 16:k.buttons.home=f.buttons[h].pressed}f.xbox=k}if(d&&!d.prev_buttons){d.prev_buttons=
new Uint8Array(32);f=new CustomEvent("gamepadconnected");f.eventType=f.type;f.gamepad=d;if(this.ongamepadconnected)this.ongamepadconnected(f);A.trigger(l,"gamepadconnected",f)}if(d)for(k=0;k<d.buttons.length;++k){h=d.buttons[k];h.was_pressed=!1;if(h.pressed&&!d.prev_buttons[k]){h.was_pressed=!0;f=new CustomEvent("gamepadButtonDown");f.eventType=f.type;f.button=h;f.which=k;f.gamepad=d;if(l.onbuttondown)l.onbuttondown(f);A.trigger(l,"buttondown",f)}else if(!h.pressed&&d.prev_buttons[k]){f=new CustomEvent("gamepadButtonUp");
f.eventType=f.type;f.button=h;f.which=k;f.gamepad=d;if(l.onbuttondown)l.onbuttondown(f);A.trigger(l,"buttonup",f)}d.prev_buttons[k]=h.pressed?1:0}}return this.gamepads=b}};l.fullscreen=function(){var a=this.canvas;a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.error("Fullscreen not supported")};l.snapshot=function(a,b,c,d,f){var k=createCanvas(c,d),h=k.getContext("2d"),m=h.getImageData(0,0,k.width,
k.height),p=new Uint8Array(c*d*4);l.readPixels(a,b,k.width,k.height,l.RGBA,l.UNSIGNED_BYTE,p);m.data.set(p);h.putImageData(m,0,0);if(f)return k;a=createCanvas(c,d);h=a.getContext("2d");h.translate(0,d);h.scale(1,-1);h.drawImage(k,0,0);return a};var w={};l.loadTexture=function(a,b,c){if(this.textures[a])return this.textures[a];if(w[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=h.Texture.fromImage(this,b);a.img=this;l.textures[this.url]=a;delete w[this.url];c&&c(a)};d.src=a;w[a]=
!0;return null};l.drawTexture=function(){var a=mat3.create(),b=vec2.create(),c=vec2.create(),d=vec4.create(),f=vec4.fromValues(1,1,1,1),k=vec2.create(),h={u_texture:0,u_position:b,u_color:f,u_size:c,u_texture_area:d,u_viewport:k,u_transform:a};return function(a,f,m,p,n,q,s,r,v,t,u){b[0]=f;b[1]=m;void 0===p&&(p=a.width);void 0===n&&(n=a.height);c[0]=p;c[1]=n;void 0===q&&(q=0);void 0===s&&(s=0);void 0===r&&(r=a.width);void 0===v&&(v=a.height);d[0]=q/a.width;d[1]=s/a.height;d[2]=(q+r)/a.width;d[3]=(s+
v)/a.height;k[0]=this.viewport_data[2];k[1]=this.viewport_data[3];t=t||Shader.getPartialQuadShader(this);f=Mesh.getScreenQuad(this);a.bind(0);t.uniforms(h);u&&t.uniforms(u);t.draw(f,l.TRIANGLES)}}();l.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault();l.context_lost=!0;if(l.onlosecontext)l.onlosecontext(a)},!1);l.reset=function(){l.viewport(0,0,this.canvas.width,this.canvas.height);l.disable(l.BLEND);l.disable(l.CULL_FACE);l.disable(l.DEPTH_TEST);l.frontFace(l.CCW);l._current_texture_drawto=
null;l._current_fbo_color=null;l._current_fbo_depth=null};l.dump=function(){console.log("userAgent: ",navigator.userAgent);console.log("Supported extensions:");var a=l.getSupportedExtensions();console.log(a.join(","));a="VENDOR VERSION MAX_VERTEX_ATTRIBS MAX_VARYING_VECTORS MAX_VERTEX_UNIFORM_VECTORS MAX_VERTEX_TEXTURE_IMAGE_UNITS MAX_FRAGMENT_UNIFORM_VECTORS MAX_TEXTURE_SIZE MAX_TEXTURE_IMAGE_UNITS".split(" ");console.log("WebGL info:");for(var b in a)console.log(" * "+a[b]+": "+l.getParameter(l[a[b]]));
console.log("*************************************************")};l.reset();return l};h.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",33:"PAGEUP",34:"PAGEDOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};h.dragging=!1;h.last_pos=[0,0];h.augmentEvent=function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.clientX-c.left;a.mousey=a.clientY-c.top;
a.canvasx=a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;a.is_touch&&(gl.mouse.buttons=a.which);document.pointerLockElement===b&&(a.canvasx=a.mousex=0.5*c.width,a.canvasy=a.mousey=0.5*c.height);"mousedown"==a.type?this.dragging=!0:"mousemove"!=a.type&&"mouseup"==a.type&&0==a.buttons&&(this.dragging=!1);void 0===a.movementX||a.is_touch||h.isMobile()?(a.deltax=a.mousex-this.last_pos[0],a.deltay=a.mousey-this.last_pos[1]):(a.deltax=a.movementX,a.deltay=a.movementY);this.last_pos[0]=a.mousex;
this.last_pos[1]=a.mousey;a.dragging=this.dragging;a.leftButton=!!(gl.mouse.buttons&h.LEFT_MOUSE_BUTTON_MASK);a.middleButton=!!(gl.mouse.buttons&h.MIDDLE_MOUSE_BUTTON_MASK);a.rightButton=!!(gl.mouse.buttons&h.RIGHT_MOUSE_BUTTON_MASK);a.buttons_mask=0;a.leftButton&&(a.buttons_mask=1);a.middleButton&&(a.buttons_mask|=2);a.rightButton&&(a.buttons_mask|=4);a.isButtonPressed=function(a){return this.buttons_mask&1<<a}};h.isMobile=function(){return void 0!==this.mobile?this.mobile:r.navigator?navigator.userAgent.match(/iPhone/i)||
navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/SamsungBrowser/i)||navigator.userAgent.match(/Mobile\ VR/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1};var A=r.LEvent=h.LEvent={bind:function(a,b,c,d){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";var f=a.__levents;f||(Object.defineProperty(a,"__levents",{value:{},
enumerable:!1}),f=a.__levents);f.hasOwnProperty(b)?f[b].push([c,d]):f[b]=[[c,d]];if(a.onLEventBinded)a.onLEventBinded(b,c,d)},unbind:function(a,b,c,d){if(!a)throw"cannot unbind event to null";if(!c)throw"cannot unbind from null callback";if(a.constructor===String)throw"cannot bind event to a string";var f=a.__levents;if(f&&f.hasOwnProperty(b)){for(var k=0,h=f[b].length;k<h;++k){var m=f[b][k];if(m[0]===c&&m[1]===d){f[b].splice(k,1);break}}0==f[b].length&&delete f[b];if(a.onLEventUnbinded)a.onLEventUnbinded(b,
c,d)}},unbindAll:function(a,b,c){if(!a)throw"cannot unbind events in null";var d=a.__levents;if(d){if(a.onLEventUnbindAll)a.onLEventUnbindAll(b,c);if(b)for(var f in d){a=d[f];for(var k=a.length-1;0<=k;--k)a[k][1]!=b||c&&c!==a[k][0]||a.splice(k,1)}else delete a.__levents}},unbindAllEvent:function(a,b){if(!a)throw"cannot unbind events in null";var c=a.__levents;if(c&&(delete c[b],a.onLEventUnbindAll))a.onLEventUnbindAll(b,target_instance,callback)},isBind:function(a,b,c,d){if(!a)throw"LEvent cannot have null as instance";
if(a=a.__levents){if(!a.hasOwnProperty(b))return!1;for(var f=0,k=a[b].length;f<k;++f){var h=a[b][f];if(h[0]===c&&h[1]===d)return!0}return!1}},hasBind:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;return c&&c.hasOwnProperty(b)&&c[b].length?!0:!1},hasBindTo:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;if(!c)return!1;for(var d in c)for(var f=c[d],k=0;k<f.length;++k)if(f[k][1]===b)return!0;return!1},trigger:function(a,b,c,d,f){if(!a)throw"cannot trigger event from null";
if(a.constructor===String)throw"cannot bind event to a string";a=a.__levents;if(!a||!a.hasOwnProperty(b))return!1;a=a[b];if(d)for(d=a.length-1;0<=d;--d){var k=a[d];if(f){if(k&&!0===k[0].apply(k[1],c))return!0}else if(k&&!0===k[0].call(k[1],b,c))return!0}else{d=0;for(var h=a.length;d<h;++d)if(k=a[d],f){if(k&&!0===k[0].apply(k[1],c))return!0}else if(k&&!0===k[0].call(k[1],b,c))return!0}return!1},triggerArray:function(a,b,c,d,f){for(var k=!1,h=0,m=a.length;h<m;++h){var l=a[h];if(!l)throw"cannot trigger event from null";
if(l.constructor===String)throw"cannot bind event to a string";if((l=l.__levents)&&l.hasOwnProperty(b))if(d)for(var n=l[b].length-1;0<=n;--n){var q=l[b][n];if(f){if(!0===q[0].apply(q[1],c)){k=!0;break}}else if(!0===q[0].call(q[1],b,c)){k=!0;break}}else for(var n=0,s=l[b].length;n<s;++n)if(q=l[b][n],f){if(!0===q[0].apply(q[1],c)){k=!0;break}}else if(!0===q[0].call(q[1],b,c)){k=!0;break}}return k},extendObject:function(a){a.bind=function(a,c,d){return A.bind(this,a,c,d)};a.trigger=function(a,c){return A.trigger(this,
a,c)};a.unbind=function(a,c,d){return A.unbind(this,a,c,instance)};a.unbindAll=function(a,c){return A.unbindAll(this,a,c)}},extendClass:function(a){this.extendObject(a.prototype)}};r.CLIP_INSIDE=h.CLIP_INSIDE=0;r.CLIP_OUTSIDE=h.CLIP_OUTSIDE=1;r.CLIP_OVERLAP=h.CLIP_OVERLAP=2;r.geo={last_t:-1,createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},planeFromTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(d,f,k,h){vec3.sub(a,k,f);vec3.sub(b,
h,f);vec3.cross(c,a,b);vec3.normalize(c,c);d[0]=c[0];d[1]=c[1];d[2]=c[2];d[3]=-vec3.dot(f,c);return d}}(),computeTriangleNormal:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(d,f,k,h){vec3.sub(a,k,f);vec3.sub(b,h,f);vec3.cross(c,a,b);vec3.normalize(c,c);d[0]=c[0];d[1]=c[1];d[2]=c[2];return d}}(),distancePointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*
b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnLine:function(){var a=vec3.create(),b=vec3.create();return function(c,d,f,k){k=k||vec3.create();vec3.sub(a,c,d);vec3.sub(b,f,d);c=vec3.dot(a,b)/vec3.dot(b,b);k[0]=d[0]+c*b[0];k[1]=d[1]+c*b[1];k[2]=d[2]+c*b[2];return k}}(),project2DPointOnLine:function(a,b,c,d){d=d||vec2.create();a=vec2.fromValues(a[0]-b[0],a[1]-b[1]);c=vec2.fromValues(c[0]-b[0],c[1]-b[1]);a=vec2.dot(a,c)/vec2.dot(c,c);d[0]=b[0]+a*c[0];d[1]=b[1]+a*c[1];return d},closestPointToSegment:function(){var a=
vec3.create(),b=vec3.create();return function(c,d,f,k){k=k||vec3.create();vec3.sub(a,c,d);vec3.sub(b,f,d);c=vec3.dot(a,b)/vec3.dot(b,b);c=Math.min(1,Math.max(0,c));k[0]=d[0]+c*b[0];k[1]=d[1]+c*b[1];k[2]=d[2]+c*b[2];return k}}(),projectPointOnPlane:function(){var a=vec3.create();return function(b,c,d,f){f=f||vec3.create();vec3.sub(a,b,c);c=vec3.dot(a,d);vec3.scale(a,d,c);return vec3.sub(f,b,a)}}(),isPointInsideTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),
f=vec3.create(),k=vec3.create();return function(h,m,l,n){vec3.sub(a,m,h);vec3.sub(b,l,h);vec3.sub(c,n,h);vec3.cross(d,b,c);vec3.cross(f,c,a);vec3.cross(k,a,b);return 0>vec3.dot(d,f)||0>vec3.dot(d,k)?!1:!0}}(),reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,d,f){c=vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,b);if(Math.abs(d)<
EPSILON)return!1;d=this.last_t=c/d;if(0>d)return!1;f&&vec3.add(f,a,vec3.scale(f,b,d));return!0},testSegmentPlane:function(){var a=vec3.create();return function(b,c,d,f,k){d=vec3.dot(d,f)-vec3.dot(f,b);c=vec3.sub(a,c,b);f=vec3.dot(f,c);if(Math.abs(f)<EPSILON)return!1;f=this.last_t=d/f;if(0>f||1<f)return!1;k&&vec3.add(k,b,vec3.scale(k,c,f));return!0}}(),testRaySphere:function(){var a=vec3.create();return function(b,c,d,f,k,h){var m=vec3.subtract(a,b,d),l=c[0]*c[0]+c[1]*c[1]+c[2]*c[2];d=2*m[0]*c[0]+
2*m[1]*c[1]+2*m[2]*c[2];f=d*d-4*l*(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]-f*f);if(0>f)return!1;if(k){f=Math.sqrt(f);m=1/(2*l);l=(-d+f)*m;d=(-d-f)*m;d=l<d?l:d;if(void 0!==h&&d>h)return!1;this.last_t=d;vec3.add(k,b,vec3.scale(k,c,d))}return!0}}(),hitTestTriangle:function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create();return function(k,h,m,l,n,q){vec3.subtract(a,l,m);vec3.subtract(b,n,m);vec3.cross(c,a,b);vec3.normalize(c,c);l=vec3.dot(c,vec3.subtract(d,m,k))/vec3.dot(c,
h);if(0<l){vec3.add(f,k,vec3.scale(d,h,l));var s=vec3.subtract(d,d,m);m=vec3.dot(b,b);n=vec3.dot(b,a);var r=vec3.dot(b,s),t=vec3.dot(a,a),s=vec3.dot(a,s),u=m*t-n*n,t=(t*r-n*s)/u;m=(m*s-n*r)/u;if(0<=t&&0<=m&&1>=t+m)return this.last_t=l,q&&vec3.add(q,k,vec3.scale(d,h,l)),!0}return!1}}(),testRayCylinder:function(a,b,c,d,f,k){var h=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));var m=0;b=vec3.subtract(vec3.create(),d,c);var l=vec3.subtract(vec3.create(),h,c);c=vec3.subtract(vec3.create(),
a,h);d=vec3.dot(l,b);a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>d&&0>d+a||d>b&&d+a>b)return!1;var n=vec3.dot(c,c),q=vec3.dot(l,c),m=b*n-a*a;f=vec3.dot(l,l)-f*f;var s=b*f-d*d;if(Math.abs(m)<EPSILON){if(0<s)return!1;k&&vec3.add(k,h,vec3.scale(k,c,0>d?-q/n:d>b?(a-q)/n:0));return!0}l=b*q-a*d;s=l*l-m*s;if(0>s)return!1;m=(-l-Math.sqrt(s))/m;if(0>m||1<m)return!1;if(0>d+m*a){if(0>=a)return!1;m=-d/a;k&&vec3.add(k,h,vec3.scale(k,c,m));return 0>=f+2*m*(q+m*n)}if(d+m*a>b){if(0<=a)return!1;m=(b-d)/a;k&&vec3.add(k,h,
vec3.scale(k,c,m));return 0>=f+b-2*d+m*(2*(q-a)+m*n)}this.last_t=m;k&&vec3.add(k,h,vec3.scale(k,c,m));return!0},testRayBox:function(){var a=new Float32Array(3),b=new Float32Array(3),c=new Float32Array(3);return function(d,f,k,h,m,l){l=l||Number.MAX_VALUE;var n=!0,q=0;a.fill(0);c.fill(0);b.fill(0);for(q=0;3>q;++q)d[q]<k[q]?(a[q]=1,b[q]=k[q],n=!1):d[q]>h[q]?(a[q]=0,b[q]=h[q],n=!1):a[q]=2;if(n)return this.last_t=0,m&&vec3.copy(m,d),!0;for(q=0;3>q;++q)c[q]=2!=a[q]&&0!=f[q]?(b[q]-d[q])/f[q]:-1;n=0;for(q=
1;3>q;q++)c[n]<c[q]&&(n=q);if(0>c[n]||c[n]>l)return!1;this.last_t=c[n];for(q=0;3>q;++q)if(n!=q){l=d[q]+c[n]*f[q];if(l<k[q]||l>h[q])return!1;m&&(m[q]=l)}else m&&(m[q]=b[q]);return!0}}(),testRayBBox:function(){var a=mat4.create(),b=vec3.create(),c=vec3.create();return function(d,f,k,h,m,l,n){if(!d||!f||!k)throw"parameters missing";h&&(mat4.invert(a,h),vec3.add(b,d,f),d=vec3.transformMat4(c,d,a),vec3.transformMat4(b,b,a),vec3.sub(b,b,d),f=vec3.normalize(b,b));d=this.testRayBox(d,f,k.subarray(6,9),k.subarray(9,
12),m,l);!n&&h&&m&&vec3.transformMat4(m,m,h);return d}}(),testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(c=BBox.getMax(b),geo.testPointBBox(c,a));return!0},testSphereBBox:function(a,b,c){for(var d=0,f=BBox.getMin(c),k=BBox.getMax(c),h=0;3>h;++h)a[h]<f[h]?(c=a[h]-
f[h],d+=c*c):a[h]>k[h]&&(c=a[h]-k[h],d+=c*c);return d<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,d,f,k){b=vec3.subtract(vec3.create(),b,a);d=vec3.subtract(vec3.create(),d,c);var h=vec3.subtract(vec3.create(),a,c),m=vec3.dot(b,b),l=vec3.dot(b,d),n=vec3.dot(d,d),q=vec3.dot(b,h),s=vec3.dot(d,h),r=m*n-l*l,t;r<EPSILON?(t=0,m=l>n?q/l:s/n):(t=(l*s-n*q)/r,m=(m*s-l*q)/r);f&&vec3.add(f,a,vec3.scale(vec3.create(),b,t));k&&vec3.add(k,c,vec3.scale(vec3.create(),d,m));a=vec3.add(vec3.create(),h,vec3.subtract(vec3.create(),
vec3.scale(vec3.create(),b,t),vec3.scale(vec3.create(),d,m)));return vec3.length(a)},extractPlanes:function(a,b){function c(a){var c=b.subarray(a,a+3),c=vec3.length(c);0!==c&&(c=1/c,b[a]*=c,b[a+1]*=c,b[a+2]*=c,b[a+3]*=c)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],12);c(12);b.set([a[3]-a[2],
a[7]-a[6],a[11]-a[10],a[15]-a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,b){var c=0,d=0,c=planeBoxOverlap(a.subarray(0,4),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(4,8),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(8,12),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(12,16),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(16,
20),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(20,24),b);return c==CLIP_OUTSIDE?CLIP_OUTSIDE:0==d+c?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,b,c){var d,f=!1;d=distanceToPlane(a.subarray(0,4),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(4,8),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(8,12),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(12,16),b);if(d<
-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(16,20),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(20,24),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);return f?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,b){for(var c=!1,d=-1,f=a.length,k=f-1;++d<f;k=d)(a[d][1]<=b[1]&&b[1]<a[k][1]||a[k][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[k][0]-a[d][0])*(b[1]-a[d][1])/(a[k][1]-a[d][1])+a[d][0]&&(c=!c);return c}};r.BBox=h.BBox={center:0,halfsize:3,
min:6,max:9,radius:12,data_length:13,corners:[vec3.fromValues(1,1,1),vec3.fromValues(1,1,-1),vec3.fromValues(1,-1,1),vec3.fromValues(1,-1,-1),vec3.fromValues(-1,1,1),vec3.fromValues(-1,1,-1),vec3.fromValues(-1,-1,1),vec3.fromValues(-1,-1,-1)],create:function(){return new Float32Array(13)},clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},fromMinMax:function(a,b){var c=this.create();
this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,b){var c=this.create();this.setCenterHalfsize(c,a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=a.subarray(6,9),d=a.subarray(9,12);c[0]=b[0];c[1]=b[1];c[2]=b[2];d.set(c);for(var f=3,k=b.length;f<k;f+=3){var h=b[f],m=b[f+1],l=b[f+2];h<c[0]?c[0]=h:h>d[0]&&(d[0]=h);m<c[1]?c[1]=m:m>d[1]&&(d[1]=m);l<c[2]?c[2]=l:l>d[2]&&(d[2]=l)}a[0]=0.5*(c[0]+d[0]);a[1]=0.5*(c[1]+
d[1]);a[2]=0.5*(c[2]+d[2]);a[3]=d[0]-a[0];a[4]=d[1]-a[1];a[5]=d[2]-a[2];a[12]=Math.sqrt(a[3]*a[3]+a[4]*a[4]+a[5]*a[5]);return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];var d=a.subarray(3,6);vec3.sub(d,c,b);vec3.scale(d,d,0.5);a[0]=c[0]-d[0];a[1]=c[1]-d[1];a[2]=c[2]-d[2];a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,d){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];a[6]=a[0]-a[3];a[7]=a[1]-a[4];a[8]=a[2]-
a[5];a[9]=a[0]+a[3];a[10]=a[1]+a[4];a[11]=a[2]+a[5];a[12]=d?d:vec3.length(c);return a},transformMat4:function(){for(var a=0,b=0,c=0,d=new Float32Array(24),f=[],k=0;24>k;k+=3)f.push(d.subarray(k,k+3));return function(k,h,l){var n=h[0],q=h[1],s=h[2];a=h[3];b=h[4];c=h[5];h=this.corners;for(var r=0;8>r;++r){var t=h[r],u=f[r];u[0]=a*t[0]+n;u[1]=b*t[1]+q;u[2]=c*t[2]+s;mat4.multiplyVec3(u,l,u)}return this.setFromPoints(k,d)}}(),getCorners:function(a,b){var c=a.subarray(3,6),d=null;b?(b.set(this.corners),
d=b):d=new Float32Array(this.corners);for(var f=0;8>f;++f){var k=d.subarray(3*f,3*f+3);vec3.multiply(k,c,k);vec3.add(k,k,a)}return d},merge:function(a,b,c){var d=a.subarray(6,9),f=a.subarray(9,12);vec3.min(d,b.subarray(6,9),c.subarray(6,9));vec3.max(f,b.subarray(9,12),c.subarray(9,12));return BBox.setMinMax(a,d,f)},extendToPoint:function(a,b){b[0]<a[6]?a[6]=b[0]:b[0]>a[9]&&(a[9]=b[0]);b[1]<a[7]?a[7]=b[1]:b[1]>a[10]&&(a[10]=b[1]);b[2]<a[8]?a[8]=b[2]:b[2]>a[11]&&(a[11]=b[2]);var c=a.subarray(6,9),d=
a.subarray(9,12),c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},clampPoint:function(a,b,c){a[0]=Math.clamp(c[0],b[0]-b[3],b[0]+b[3]);a[1]=Math.clamp(c[1],b[1]-b[4],b[1]+b[4]);a[2]=Math.clamp(c[2],b[2]-b[5],b[2]+b[5])},isPointInside:function(a,b){return a[0]-a[3]>b[0]||a[1]-a[4]>b[1]||a[2]-a[5]>b[2]||a[0]+a[3]<b[0]||a[1]+a[4]<b[1]||a[2]+a[5]<b[2]?!1:!0},getCenter:function(a){return a.subarray(0,3)},getHalfsize:function(a){return a.subarray(3,
6)},getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,12)},getRadius:function(a){return a[12]}};r.distanceToPlane=h.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};r.planeBoxOverlap=h.planeBoxOverlap=function(a,b){var c=a[3],d=Math.abs(b[3]*a[0])+Math.abs(b[4]*a[1])+Math.abs(b[5]*a[2]),c=vec3.dot(a,b)+c;return c<=-d?CLIP_OUTSIDE:c<=d?CLIP_OVERLAP:CLIP_INSIDE};r.Octree=h.Octree=function(a,b,c){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a,
b,c),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=0.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=0.01;Octree.OCTREE_MIN_MARGIN=0.1;Octree.NEAREST=0;Octree.FIRST=1;Octree.ALL=2;Octree.prototype.buildFromMesh=function(a,b,c){this.total_nodes=this.total_depth=0;b=b||0;var d=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=a.data;c||(c=a?a.length:d.length/3);var f=null;this.root=f=a?this.computeAABBFromIndices(d,a,b,c):this.computeAABB(d);this.total_nodes=
1;this.total_triangles=a?a.length/3:d.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var k=vec3.create();vec3.scale(k,f.size,Octree.OCTREE_MARGIN_RATIO);k[0]<Octree.OCTREE_MIN_MARGIN&&(k[0]=Octree.OCTREE_MIN_MARGIN);k[1]<Octree.OCTREE_MIN_MARGIN&&(k[1]=Octree.OCTREE_MIN_MARGIN);k[2]<Octree.OCTREE_MIN_MARGIN&&(k[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(f.min,f.min,k);vec3.add(f.max,f.max,k);f.faces=[];f.inside=0;k=b+c;if(a)for(;b<k;b+=3){var h=new Float32Array([d[3*
a[b]],d[3*a[b]+1],d[3*a[b]+2],d[3*a[b+1]],d[3*a[b+1]+1],d[3*a[b+1]+2],d[3*a[b+2]],d[3*a[b+2]+1],d[3*a[b+2]+2],b/3]);Octree.isValidFace(h)&&this.addToNode(h,f,0)}else for(b*=3;b<3*c;b+=9)h=new Float32Array(10),h.set(d.subarray(b,b+9)),h[9]=b/9,Octree.isValidFace(h)&&this.addToNode(h,f,0);return f};Octree.isValidFace=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create();return function(d){var f=d.subarray(0,3),k=d.subarray(3,6);d=d.subarray(6,9);vec3.sub(a,k,f);vec3.sub(b,d,f);vec3.cross(c,
a,b);return 0<vec3.length(c)}}();Octree.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){for(var d=this.computeAABB(a),f=!1,k=0;k<b.c.length;++k){var h=b.c[k];if(Octree.isInsideAABB(d,h)){this.addToNode(a,h,c+1);f=!0;break}}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<Octree.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var m=b.faces.concat();b.faces=null;for(k=
0;k<m.length;++k){a=m[k];for(var d=this.computeAABB(a),f=!1,l=0;l<b.c.length;++l)if(h=b.c[l],Octree.isInsideAABB(d,h)){this.addToNode(a,h,c+1);f=!0;break}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(a){a.c=[];for(var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-a.min[1]),0.5*(a.max[2]-a.min[2])],c=0;c<this.octree_pos_ref.length;++c){var d=this.octree_pos_ref[c],
f={};this.total_nodes+=1;f.min=[a.min[0]+b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];f.max=[f.min[0]+b[0],f.min[1]+b[1],f.min[2]+b[2]];f.faces=null;f.inside=0;a.c.push(f)}};Octree.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array(b),d=3;d<a.length-1;d+=3)for(var f=0;3>f;f++)b[f]>a[d+f]&&(b[f]=a[d+f]),c[f]<a[d+f]&&(c[f]=a[d+f]);return{min:b,max:c,size:vec3.sub(vec3.create(),c,b)}};Octree.prototype.computeAABBFromIndices=function(a,b,c,d){c=c||0;
d=d||b.length;for(var f=b[c],k=new Float32Array([a[3*f],a[3*f+1],a[3*f+2]]),h=new Float32Array([a[3*f],a[3*f+1],a[3*f+2]]),m=c+1;m<c+d;++m)for(var f=3*b[m],l=0;3>l;l++)k[l]>a[f+l]&&(k[l]=a[f+l]),h[l]<a[f+l]&&(h[l]=a[f+l]);return{min:k,max:h,size:vec3.sub(vec3.create(),h,k)}};Octree.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;for(var b=1,c=[],d=a.c,f=0;f<d.length;++f)d[f].inside&&(c.push(d[f]),b+=this.trim(d[f]));a.c=c;return b};Octree.prototype.testRay=function(){var a=vec3.create(),
b=vec3.create(),c=vec3.create(),d=vec3.create();return function(f,k,h,m,l,n){n=n||Octree.NEAREST;if(!this.root)throw"Error: octree not build";a.set(f);b.set(k);c.set(this.root.min);d.set(this.root.max);h=Octree.hitTestBox(a,b,c,d);if(!h)return null;h=Octree.testRayInNode(this.root,a,b,l,n);if(null==h)return null;if(n==Octree.ALL)return h;k=vec3.scale(vec3.create(),k,h.t);vec3.add(k,k,f);h.pos=k;return h}}();Octree.testRayInNode=function(a,b,c,d,f){var k=null,h=null;if(a.faces)for(var m=0,l=a.faces.length;m<
l;++m){var n=a.faces[m],k=Octree.hitTestTriangle(b,c,n.subarray(0,3),n.subarray(3,6),n.subarray(6,9),d);if(null!=k){if(f==Octree.FIRST)return k;f==Octree.ALL?(h||(h=[]),h.push(k)):(k.face=n,h?h.mergeWith(k):h=k)}}var l=vec3.create(),n=vec3.create(),q;if(a.c)for(m=0;m<a.c.length;++m)if(q=a.c[m],l.set(q.min),n.set(q.max),k=Octree.hitTestBox(b,c,l,n),null!=k&&!(f!=Octree.ALL&&h&&k.t>h.t)&&(k=Octree.testRayInNode(q,b,c,d,f),null!=k)){if(f==Octree.FIRST)return k;f==Octree.ALL?(h||(h=[]),h.push(k)):h?h.mergeWith(k):
h=k}return h};Octree.prototype.testSphere=function(a,b){a=vec3.clone(a);if(!this.root)throw"Error: octree not build";var c=b*b;return Octree.testSphereBox(a,c,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,a,c):!1};Octree.testSphereInNode=function(a,b,c){if(a.faces)for(var d=0,f=a.faces.length;d<f;++d){var k=a.faces[d];if(Octree.testSphereTriangle(b,c,k.subarray(0,3),k.subarray(3,6),k.subarray(6,9)))return!0}var f=vec3.create(),k=vec3.create(),h;if(a.c)for(d=
0;d<a.c.length;++d)if(h=a.c[d],f.set(h.min),k.set(h.max),Octree.testSphereBox(b,c,f,k)&&Octree.testSphereInNode(h,b,c))return!0;return!1};Octree.prototype.findNearestPoint=function(a,b,c,d){c=c||Infinity;if(a===b)throw"findNearestPoint input point and output cannot be the same";return Octree.nearestInNode(this.root,a,b,c,d)};Octree.nearestInNode=function(a,b,c,d,f){var k=vec3.create(),h;f&&(h=vec3.create());if(a.faces)for(var m=0,l=a.faces.length;m<l;++m){var n=a.faces[m],q=n.subarray(0,3),s=n.subarray(3,
6),n=n.subarray(6,9);Octree.closestPointOnTriangle(b,q,s,n,k);var r=vec3.dist(k,b);r<d&&(d=r,vec3.copy(c,k),f&&geo.computeTriangleNormal(f,q,s,n))}if(!a.c)return d;for(m=0;m<a.c.length;++m)l=a.c[m],Octree.distanceToBox(b,l.min,l.max)>d||(r=Octree.nearestInNode(l,b,k,d,h),r<d&&(d=r,vec3.copy(c,k),f&&vec3.copy(f,h)));return d};Octree.closestPointOnTriangle=function(){var a=new Float32Array(4),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create();return function(k,h,m,l,n){geo.planeFromTriangle(a,
h,m,l);if(1E-8<vec3.length(a)&&(geo.projectPointOnPlane(k,h,a,b),geo.isPointInsideTriangle(b,h,m,l)))return vec3.copy(n,b),n;geo.closestPointToSegment(b,h,m,c);geo.closestPointToSegment(b,m,l,d);geo.closestPointToSegment(b,l,h,f);k=vec3.sqrDist(b,c);h=vec3.sqrDist(b,d);m=vec3.sqrDist(b,f);m=Math.min(k,h,m);m===k?vec3.copy(n,c):m===h?vec3.copy(n,d):vec3.copy(n,f);return n}}();Octree.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>
b.max[1]||a.max[2]>b.max[2]?!1:!0};Octree.distanceToBox=function(a,b,c){var d=0.5*(c[0]+b[0]),f=0.5*(c[1]+b[1]);b=0.5*(c[2]+b[2]);var k=c[0]-d,h=c[1]-f;c=c[2]-b;d=Math.abs(a[0]-d)-k;f=Math.abs(a[1]-f)-h;a=Math.abs(a[2]-b)-c;b=Math.min(Math.max(d,f,a),0);d=Math.max(d,0);f=Math.max(f,0);a=Math.max(a,0);return Math.sqrt(d*d+f*f+a*a)+b};Octree.hitTestBox=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),h=vec3.fromValues(1E-6,1E-6,1E-6);return function(m,
l,n,q){vec3.subtract(a,n,m);vec3.subtract(b,q,m);if(0>vec3.maxValue(a)&&0<vec3.minValue(b))return new HitTest(0,m,l);c[0]=1/l[0];c[1]=1/l[1];c[2]=1/l[2];vec3.multiply(a,a,c);vec3.multiply(b,b,c);vec3.min(d,a,b);vec3.max(f,a,b);var r=vec3.maxValue(d),x=vec3.minValue(f);return 0<r&&r<x?(m=vec3.add(vec3.create(),vec3.scale(k,l,r),m),vec3.add(n,n,h),vec3.subtract(n,n,h),new HitTest(r,m,vec3.fromValues((m[0]>q[0])-(m[0]<n[0]),(m[1]>q[1])-(m[1]<n[1]),(m[2]>q[2])-(m[2]<n[2])))):null}}();Octree.hitTestTriangle=
function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(f,k,h,m,l,n){vec3.subtract(a,m,h);vec3.subtract(b,l,h);m=vec3.cross(vec3.create(),a,b);vec3.normalize(m,m);if(!n&&0<vec3.dot(m,k))return null;n=vec3.dot(m,vec3.subtract(d,h,f))/vec3.dot(m,k);if(0<n){k=vec3.scale(vec3.create(),k,n);vec3.add(k,k,f);vec3.subtract(c,k,h);f=vec3.dot(b,b);h=vec3.dot(b,a);l=vec3.dot(b,c);var q=vec3.dot(a,a),r=vec3.dot(a,c),x=f*q-h*h,q=(q*l-h*r)/x;f=(f*r-h*l)/x;if(0<=q&&0<=f&&1>=
q+f)return new HitTest(n,k,m)}return null}}();Octree.testSphereTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),h=vec3.create(),m=vec3.create();return function(l,n,q,r,x){vec3.sub(a,q,l);vec3.sub(b,r,l);vec3.sub(c,x,l);vec3.sub(d,b,a);vec3.sub(f,c,a);vec3.cross(m,d,f);l=vec3.dot(a,m);q=vec3.dot(m,m);l=l*l>n*q;var t=vec3.dot(a,a),u=vec3.dot(a,b),w=vec3.dot(a,c),v=vec3.dot(b,b),E=vec3.dot(b,c),y=vec3.dot(c,c);q=t>n&u>t&w>t;r=v>n&
u>v&E>v;x=y>n&w>y&E>y;var t=u-t,u=E-v,C=w-y;vec3.sub(k,c,b);vec3.sub(h,a,c);v=vec3.dot(d,d);y=vec3.dot(k,k);w=vec3.dot(h,h);E=vec3.scale(vec3.create(),a,v);vec3.sub(E,E,vec3.scale(vec3.create(),d,t));t=vec3.scale(vec3.create(),b,y);vec3.sub(t,t,vec3.scale(vec3.create(),k,u));u=vec3.scale(vec3.create(),c,w);vec3.sub(u,u,vec3.scale(vec3.create(),h,C));var B=vec3.scale(vec3.create(),c,v),B=vec3.sub(B,B,E),A=vec3.scale(vec3.create(),a,y),A=vec3.sub(A,A,t),C=vec3.scale(vec3.create(),b,w),C=vec3.sub(C,
C,u),v=vec3.dot(E,E)>n*v*v&0<vec3.dot(E,B),y=vec3.dot(t,t)>n*y*y&0<vec3.dot(t,A);n=vec3.dot(u,u)>n*w*w&0<vec3.dot(u,C);return!(l|q|r|x|v|y|n)}}();Octree.testSphereBox=function(a,b,c,d){for(var f,k=0,h=0;3>h;++h)a[h]<c[h]?(f=a[h]-c[h],k+=f*f):a[h]>d[h]&&(f=a[h]-d[h],k+=f*f);return k<=b?!0:!1};r.HitTest=h.HitTest=function(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c;this.face=null};HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=
a.normal,this.face=a.face)}};r.Ray=h.Ray=function(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();this.t=-1;a&&this.origin.set(a);b&&this.direction.set(b)};Ray.prototype.testPlane=function(a,b){var c=geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point);this.t=geo.last_t;return c};Ray.prototype.testSphere=function(a,b,c){a=geo.testRaySphere(this.origin,this.direction,a,b,this.collision_point,c);this.t=geo.last_t;return a};Ray.prototype.testBBox=
function(a,b,c,d){a=geo.testRayBBox(this.origin,this.direction,a,c,this.collision_point,b,d);this.t=geo.last_t;return a};r.Raytracer=h.Raytracer=function(a,b){this.viewport=vec4.create();this.ray00=vec3.create();this.ray10=vec3.create();this.ray01=vec3.create();this.ray11=vec3.create();this.eye=vec3.create();this.setup(a,b)};Raytracer.prototype.setup=function(a,b){b=b||gl.viewport_data;this.viewport.set(b);var c=b[0],d=c+b[2],f=b[1],k=f+b[3];vec3.set(this.ray00,c,f,1);vec3.set(this.ray10,d,f,1);vec3.set(this.ray01,
c,k,1);vec3.set(this.ray11,d,k,1);vec3.unproject(this.ray00,this.ray00,a,b);vec3.unproject(this.ray10,this.ray10,a,b);vec3.unproject(this.ray01,this.ray01,a,b);vec3.unproject(this.ray11,this.ray11,a,b);c=this.eye;vec3.unproject(c,c,a,b);vec3.subtract(this.ray00,this.ray00,c);vec3.subtract(this.ray10,this.ray10,c);vec3.subtract(this.ray01,this.ray01,c);vec3.subtract(this.ray11,this.ray11,c)};Raytracer.prototype.getRayForPixel=function(){var a=vec3.create(),b=vec3.create();return function(c,d,f){f=
f||vec3.create();c=(c-this.viewport[0])/this.viewport[2];d=1-(d-this.viewport[1])/this.viewport[3];vec3.lerp(a,this.ray00,this.ray10,c);vec3.lerp(b,this.ray01,this.ray11,c);vec3.lerp(f,a,b,d);return vec3.normalize(f,f)}}();var Y=mat4.create();Raytracer.hitTestBox=function(a,b,c,d,f){var k=new Float32Array(30);f&&(f=mat4.invert(Y,f),a=mat4.multiplyVec3(k.subarray(3,6),f,a),b=mat4.rotateVec3(k.subarray(6,9),f,b));var h=vec3.subtract(k.subarray(9,12),c,a);vec3.divide(h,h,b);var m=vec3.subtract(k.subarray(12,
15),d,a);vec3.divide(m,m,b);f=vec3.min(k.subarray(15,18),h,m);h=vec3.max(k.subarray(18,21),h,m);f=vec3.maxValue(f);h=vec3.minValue(h);return 0<f&&f<=h?(b=vec3.scale(k.subarray(21,24),b,f),vec3.add(b,a,b),vec3.addValue(k.subarray(24,27),c,1E-6),vec3.subValue(k.subarray(27,30),d,1E-6),new HitTest(f,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,d){var f=vec3.subtract(vec3.create(),a,c),k=vec3.dot(b,b),h=2*vec3.dot(b,
f),f=vec3.dot(f,f)-d*d,f=h*h-4*k*f;return 0<f?(k=(-h-Math.sqrt(f))/(2*k),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,k)),new HitTest(k,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};Raytracer.hitTestTriangle=function(a,b,c,d,f){var k=vec3.subtract(vec3.create(),d,c),h=vec3.subtract(vec3.create(),f,c);f=vec3.cross(vec3.create(),k,h);vec3.normalize(f,f);d=vec3.dot(f,vec3.subtract(vec3.create(),c,a))/vec3.dot(f,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),
b,d));var m=vec3.subtract(vec3.create(),a,c);c=vec3.dot(h,h);b=vec3.dot(h,k);var h=vec3.dot(h,m),l=vec3.dot(k,k),k=vec3.dot(k,m),m=c*l-b*b,l=(l*h-b*k)/m,k=(c*k-b*h)/m;if(0<=l&&0<=k&&1>=l+k)return new HitTest(d,a,f)}return null};Mesh.parseOBJ=function(a,b){function c(a){var b,c,d,f=!1;if(-1==a.indexOf("-")){var k=v.get(a);if(void 0!==k)return k}else f=!0;d||(d=a.split("/"));if(1==d.length)d=c=b=parseInt(d[0]);else if(2==d.length)b=parseInt(d[0]),c=parseInt(d[1]),d=b;else if(3==d.length)b=parseInt(d[0]),
c=parseInt(d[1]),d=parseInt(d[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;0>b&&(b=p.length/3+b+1);0>d&&(d=m.length/2+d+1);0>c&&(c=l.length/2+c+1);if(f&&(a=b+"/"+c+"/"+d,k=v.get(a),void 0!==k))return k;b-=1;c-=1;d-=1;n.push(p[3*b+0],p[3*b+1],p[3*b+2]);l.length&&r.push(l[2*c+0],l[2*c+1]);m.length&&q.push(m[3*d+0],m[3*d+1],m[3*d+2]);k=A;v.set(a,k);++A;return k}function d(a){a={name:a||"",material:"",start:-1,length:-1,indices:[]};x.push(a);return a}function f(a){if(!w.material)return w.material=
a+k,t[a]=w;var b=t[a];b||(b=d(u+"_"+a),b.material=a+k,t[a]=b);return w=b}b=b||{};var k=b.matextension||"",p=[],m=[],l=[],n=[],q=[],r=[],x=[],t={},u=null,w=d(),v=new Map,A=0,y=1;b.scale&&(y=b.scale);for(var C={v:1,vt:2,vn:3,f:4,g:5,o:6,usemtl:7,mtllib:8},B,D,K,J=a.split("\n"),N=J.length,O=0;O<N;++O){var z=J[O],z=z.replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if("\\"==z[z.length-1])var O=O+1,F=J[O].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),z=(z.substr(0,z.length-1)+F).replace(/[ \t]+/g," ").replace(/\s\s*$/,
"");if("#"!=z[0]&&""!=z)switch(F=z.split(" "),z=C[F[0]],3>=z&&(B=parseFloat(F[1]),D=parseFloat(F[2]),2!=z&&(K=parseFloat(F[3]))),z){case 1:B*=y;D*=y;K*=y;p.push(B,D,K);break;case 2:l.push(B,D);break;case 3:m.push(B,D,K);break;case 4:if(4>F.length)continue;for(var G=[],z=1;z<F.length;++z)G.push(c(F[z]));w.indices.push(G[0],G[1],G[2]);for(z=2;z<G.length-1;++z)w.indices.push(G[0],G[z],G[z+1]);break;case 5:case 6:u=z=F[1];w.name?(t={},w=d(z)):w.name=z;break;case 7:f(F[1])}}C=[];B=0;y=[];for(z=0;z<x.length;++z)w=
x[z],w.indices&&(w.start=B,w.length=w.indices.length,C=C.concat(w.indices),delete w.indices,B+=w.length,y.push(w));x=y;y={};if(!p.length)return console.error("mesh without vertices"),null;if(b.flip_normals&&q.length)for(m=q,z=0;z<m.length;++z)m[z]*=-1;y.vertices=new Float32Array(n);q.length&&(y.normals=new Float32Array(q));r.length&&(y.coords=new Float32Array(r));C&&0<C.length&&(y.triangles=new (65536<B?Uint32Array:Uint16Array)(C));y.bounding=h.Mesh.computeBoundingBox(y.vertices);C={};1<x.length&&
(C.groups=x);y.info=C;if(!y.bounding)return console.log("empty mesh"),null;if(b.only_data)return y;C=null;return C=Mesh.load(y,null,b.mesh)};Mesh.parsers.obj=Mesh.parseOBJ;Mesh.encoders.obj=function(a,b){var c=a.getBuffer("vertices");if(!c)return null;var d=[];d.push("# Generated with liteGL.js by Javi Agenjo\n");for(var f=c.data,k=0;k<f.length;k+=3)d.push("v "+f[k].toFixed(4)+" "+f[k+1].toFixed(4)+" "+f[k+2].toFixed(4));if(c=a.getBuffer("normals"))for(d.push(""),c=c.data,k=0;k<c.length;k+=3)d.push("vn "+
c[k].toFixed(4)+" "+c[k+1].toFixed(4)+" "+c[k+2].toFixed(4));if(c=a.getBuffer("coords"))for(d.push(""),c=c.data,k=0;k<c.length;k+=2)d.push("vt "+c[k].toFixed(4)+" "+c[k+1].toFixed(4)+"  0.0000");c=a.info.groups;if(k=a.getIndexBuffer("triangles")){f=k.data;c&&c.length||(c=[{start:0,length:f.length,name:"mesh"}]);for(var h=0;h<c.length;++h){k=c[h];d.push("g "+k.name);var m=k.material||"mat_"+h;-1!=m.indexOf(".json")&&(m=m.substr(0,m.indexOf(".json")));d.push("usemtl "+m);for(var m=k.start,l=m+k.length,
k=m;k<l;k+=3)d.push("f "+(f[k]+1)+"/"+(f[k]+1)+"/"+(f[k]+1)+" "+(f[k+1]+1)+"/"+(f[k+1]+1)+"/"+(f[k+1]+1)+" "+(f[k+2]+1)+"/"+(f[k+2]+1)+"/"+(f[k+2]+1))}}else for(c&&c.length||(c=[{start:0,length:f.length/3,name:"mesh"}]),h=0;h<c.length;++h)for(k=c[h],d.push("g "+k.name),d.push("usemtl "+(k.material||"mat_"+h)),m=k.start,l=m+k.length,k=m;k<l;k+=3)d.push("f "+(k+1)+"/"+(k+1)+"/"+(k+1)+" "+(k+2)+"/"+(k+2)+"/"+(k+2)+" "+(k+3)+"/"+(k+3)+"/"+(k+3));return d.join("\n")};Mesh.parsers.mesh=function(a,b){for(var c=
{},d=a.split("\n"),f=0;f<d.length;++f){var k=d[f],h=k[0],k=k.substr(1).split(","),m=k[0];if("-"==h){var l=1,h=Float32Array;if("weights"==m||"bone_indices"==m)h=Uint8Array;"weights"==m&&(l=255);for(var n=new h(Number(k[1])),h=0;h<n.length;++h)n[h]=Number(k[h+2])*l;c[m]=n}else if("*"==h){h=Uint16Array;65536<Number(k[1])&&(h=Uint32Array);n=new h(Number(k[1]));for(h=0;h<n.length;++h)n[h]=Number(k[h+2]);c[m]=n}else if("@"==h)if("bones"==m){m=[];l=Number(k[1]);for(h=0;h<l;++h)n=k.slice(3+17*h,3+17*(h+1)-
1).map(Number),m.push([k[2+17*h],n]);c.bones=m}else if("bind_matrix"==m)c.bind_matrix=k.slice(1,17).map(Number);else{if("groups"==m)for(c.info={groups:[]},m=Number(k[1]),h=0;h<m;++h)c.info.groups.push({name:k[2+4*h],material:k[4*h+3],start:Number(k[4*h+4]),length:Number(k[4*h+5])})}else console.warn("type unknown: "+k[0])}if(b.only_data)return c;d=null;d=Mesh.load(c,null,b.mesh);d.updateBoundingBox();return d};Mesh.encoders.mesh=function(a,b){var c=[],d;for(d in a.vertexBuffers){var f=a.vertexBuffers[d],
h=typedArrayToArray(f.data);if(f.normalize&&f.data.constructor==Uint8Array)for(var p=0;p<h.length;++p)h[p]/=255;p=["-"+d,f.data.length,f.data,h];c.push(p.join(","))}for(d in a.indexBuffers)f=a.indexBuffers[d],h=typedArrayToArray(f.data),p=["*"+d,f.data.length,f.data,h],c.push(p.join(","));a.bounding&&c.push(["@bounding",typedArrayToArray(a.bounding.subarray(0,6))].join());if(a.info&&a.info.groups){d=[];for(p=0;p<a.info.groups.length;++p)f=a.info.groups[p],d.push(f.name,f.material,f.start,f.length);
c.push(["@groups",a.info.groups.length].concat(d).join(","))}a.bones&&c.push(["@bones",a.bones.length,a.bones.flat()].join());a.bind_matrix&&c.push(["@bind_matrix",typedArrayToArray(a.bind_matrix)].join());return c.join("\n")};r.WBin&&(r.WBin.classes.Mesh=Mesh);Mesh.binary_file_formats.wbin=!0;Mesh.parsers.wbin=Mesh.fromBinary=function(a,b){b=b||{};var c=null;if(a.constructor==ArrayBuffer){if(!r.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";
c=WBin.load(a,!0)}else c=a;c.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",c["@classname"]);c.format&&h.Mesh.decompress(c);var d={};if(c.vertex_buffers)for(var f in c.vertex_buffers)d[c.vertex_buffers[f]]=c[c.vertex_buffers[f]];else c.vertices&&(d.vertices=c.vertices),c.normals&&(d.normals=c.normals),c.coords&&(d.coords=c.coords),c.weights&&(d.weights=c.weights),c.bone_indices&&(d.bone_indices=c.bone_indices);var k={};if(c.index_buffers)for(f in c.index_buffers)k[c.index_buffers[f]]=
c[c.index_buffers[f]];else c.triangles&&(k.triangles=c.triangles),c.wireframe&&(k.wireframe=c.wireframe);d={vertex_buffers:d,index_buffers:k,bounding:c.bounding,info:c.info};if(c.bones){d.bones=c.bones;for(f=0;f<d.bones.length;++f)d.bones[f][1]=mat4.clone(d.bones[f][1]);c.bind_matrix&&(d.bind_matrix=mat4.clone(c.bind_matrix))}c.morph_targets&&(d.morph_targets=c.morph_targets);if(b.only_data)return d;c=b.mesh||new h.Mesh;c.configure(d);return c};Mesh.encoders.wbin=function(a,b){a.updateBoundingBox();
return a.toBinary(b)};Mesh.prototype.toBinary=function(a){if(!r.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});a={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var b=[],c=0;c<this.bones.length;++c)b.push([this.bones[c][0],mat4.toArray(this.bones[c][1])]);a.bones=b;this.bind_matrix&&(a.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox();a.bounding=this.bounding;var b=[],d=[];for(c in this.vertexBuffers){var f=
this.vertexBuffers[c];a[f.name]=f.data;b.push(f.name);"vertices"==f.name&&(a.info.num_vertices=f.data.length/3)}for(c in this.indexBuffers)f=this.indexBuffers[c],a[c]=f.data,d.push(c);a.vertex_buffers=b;a.index_buffers=d;h.Mesh.enable_wbin_compression&&h.Mesh.compress(a);return WBin.create(a,"Mesh")};Mesh.compress=function(a,b){b=b||"bounding_compressed";a.format={type:b};var c=Mesh.compressors[b];if(!c)throw"compression format not supported:"+b;return c(a)};Mesh.decompress=function(a){if(a.format){var b=
Mesh.decompressors[a.format.type];if(!b)throw"decompression format not supported:"+a.format.type;return b(a)}};Mesh.compressors.bounding_compressed=function(a){if(!a.vertex_buffers)throw"buffers not found";for(var b=BBox.getMin(a.bounding),c=BBox.getMax(a.bounding),d=vec3.sub(vec3.create(),c,b),f=a.vertices,h=new Uint16Array(f.length),c=0;c<f.length;c+=3)h[c]=(f[c]-b[0])/d[0]*65535,h[c+1]=(f[c+1]-b[1])/d[1]*65535,h[c+2]=(f[c+2]-b[2])/d[2]*65535;a.vertices=h;if(a.normals){d=a.normals;b=new Uint8Array(d.length);
f=b.constructor==Uint8Array?255:65535;for(c=0;c<d.length;c+=3)b[c]=(0.5*d[c]+0.5)*f,b[c+1]=(0.5*d[c+1]+0.5)*f,b[c+2]=(0.5*d[c+2]+0.5)*f;a.normals=b}if(a.coords){b=a.coords;f=[1E4,1E4,-1E4,-1E4];for(c=0;c<b.length;c+=2)d=b[c],f[0]>d?f[0]=d:f[2]<d&&(f[2]=d),d=b[c+1],f[1]>d?f[1]=d:f[3]<d&&(f[3]=d);a.format.uvs_bounding=f;h=new Uint16Array(b.length);d=[f[2]-f[0],f[3]-f[1]];for(c=0;c<b.length;c+=2)h[c]=(b[c]-f[0])/d[0]*65535,h[c+1]=(b[c+1]-f[1])/d[1]*65535;a.coords=h}if(a.weights){d=a.weights;b=new Uint16Array(d.length);
f=b.constructor==Uint8Array?255:65535;for(c=0;c<d.length;c+=4)b[c]=d[c]*f,b[c+1]=d[c+1]*f,b[c+2]=d[c+2]*f,b[c+3]=d[c+3]*f;a.weights=b}};Mesh.decompressors.bounding_compressed=function(a){var b=a.bounding;if(!b)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";for(var c=BBox.getMin(b),b=BBox.getMax(b),d=vec3.sub(vec3.create(),b,c),f=a.format,h=1/255,p=1/65535,m=a.vertices,l=new Float32Array(m.length),b=0,n=m.length;b<n;b+=3)l[b]=m[b]*p*d[0]+c[0],l[b+
1]=m[b+1]*p*d[1]+c[1],l[b+2]=m[b+2]*p*d[2]+c[2];a.vertices=l;if(a.normals&&a.normals.constructor!=Float32Array){d=a.normals;c=new Float32Array(d.length);m=d.constructor==Uint8Array?h:p;b=0;for(n=d.length;b<n;b+=3)c[b]=d[b]*m*2-1,c[b+1]=d[b+1]*m*2-1,c[b+2]=d[b+2]*m*2-1,l=c.subarray(b,b+3),vec3.normalize(l,l);a.normals=c}if(a.coords&&f.uvs_bounding&&a.coords.constructor!=Float32Array){c=a.coords;f=f.uvs_bounding;d=[f[2]-f[0],f[3]-f[1]];m=new Float32Array(c.length);b=0;for(n=c.length;b<n;b+=2)m[b]=c[b]*
p*d[0]+f[0],m[b+1]=c[b+1]*p*d[1]+f[1];a.coords=m}if(a.weights&&a.weights.constructor!=Float32Array){f=a.weights;d=new Float32Array(f.length);h=f.constructor==Uint8Array?h:p;b=0;for(n=f.length;b<n;b+=4)d[b]=f[b]*h,d[b+1]=f[b+1]*h,d[b+2]=f[b+2]*h,d[b+3]=f[b+3]*h;a.weights=d}}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
